<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>第 4 章 构建模型 | 基于 R 的数据处理流程指南</title>
  <meta name="description" content="R快速查询工具指南" />
  <meta name="generator" content="bookdown 0.29 and GitBook 2.6.7" />

  <meta property="og:title" content="第 4 章 构建模型 | 基于 R 的数据处理流程指南" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="R快速查询工具指南" />
  <meta name="github-repo" content="nicheerfeng/git_book_ftidy" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="第 4 章 构建模型 | 基于 R 的数据处理流程指南" />
  
  <meta name="twitter:description" content="R快速查询工具指南" />
  

<meta name="author" content="Teague Tian" />


<meta name="date" content="2022-09-29" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="Data-preprocessing.html"/>
<link rel="next" href="Model-performance.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">R Data Workflow</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>前言</a></li>
<li class="chapter" data-level="" data-path="author.html"><a href="author.html"><i class="fa fa-check"></i>作者简介</a>
<ul>
<li class="chapter" data-level="" data-path="author.html"><a href="author.html#学业及工作经历"><i class="fa fa-check"></i>学业及工作经历：</a></li>
<li class="chapter" data-level="" data-path="author.html"><a href="author.html#研究兴趣"><i class="fa fa-check"></i>研究兴趣：</a></li>
<li class="chapter" data-level="" data-path="author.html"><a href="author.html#已完成和正在研究的项目"><i class="fa fa-check"></i>已完成和正在研究的项目</a>
<ul>
<li class="chapter" data-level="" data-path="author.html"><a href="author.html#医学领域"><i class="fa fa-check"></i>医学领域：</a></li>
<li class="chapter" data-level="" data-path="author.html"><a href="author.html#生态学领域"><i class="fa fa-check"></i>生态学领域：</a></li>
<li class="chapter" data-level="" data-path="author.html"><a href="author.html#r工具开发"><i class="fa fa-check"></i>R工具开发：</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="1" data-path="Establish-analysis-objectives.html"><a href="Establish-analysis-objectives.html"><i class="fa fa-check"></i><b>1</b> 确立分析目标</a>
<ul>
<li class="chapter" data-level="1.1" data-path="Establish-analysis-objectives.html"><a href="Establish-analysis-objectives.html#基本逻辑"><i class="fa fa-check"></i><b>1.1</b> 基本逻辑</a></li>
<li class="chapter" data-level="1.2" data-path="Establish-analysis-objectives.html"><a href="Establish-analysis-objectives.html#数据分析的基本流程"><i class="fa fa-check"></i><b>1.2</b> 数据分析的基本流程</a></li>
<li class="chapter" data-level="1.3" data-path="Establish-analysis-objectives.html"><a href="Establish-analysis-objectives.html#工作处理经验"><i class="fa fa-check"></i><b>1.3</b> 工作处理经验</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="Establish-analysis-objectives.html"><a href="Establish-analysis-objectives.html#ppt汇报经验"><i class="fa fa-check"></i><b>1.3.1</b> PPT汇报经验：</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>数据准备</b></span></li>
<li class="chapter" data-level="2" data-path="Data-extraction.html"><a href="Data-extraction.html"><i class="fa fa-check"></i><b>2</b> 数据提取</a>
<ul>
<li class="chapter" data-level="2.1" data-path="Data-extraction.html"><a href="Data-extraction.html#数据提取的基本范式"><i class="fa fa-check"></i><b>2.1</b> 数据提取的基本范式</a></li>
<li class="chapter" data-level="2.2" data-path="Data-extraction.html"><a href="Data-extraction.html#数据导入与导出"><i class="fa fa-check"></i><b>2.2</b> 数据导入与导出</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="Data-extraction.html"><a href="Data-extraction.html#剪切板中处理数据"><i class="fa fa-check"></i><b>2.2.1</b> 剪切板中处理数据</a></li>
<li class="chapter" data-level="2.2.2" data-path="Data-extraction.html"><a href="Data-extraction.html#读取excle文件"><i class="fa fa-check"></i><b>2.2.2</b> 读取excle文件</a></li>
<li class="chapter" data-level="2.2.3" data-path="Data-extraction.html"><a href="Data-extraction.html#加速读取及导出常用数据"><i class="fa fa-check"></i><b>2.2.3</b> 加速读取及导出常用数据</a></li>
<li class="chapter" data-level="2.2.4" data-path="Data-extraction.html"><a href="Data-extraction.html#office格式及图片导出"><i class="fa fa-check"></i><b>2.2.4</b> OFFICE格式及图片导出</a></li>
<li class="chapter" data-level="2.2.5" data-path="Data-extraction.html"><a href="Data-extraction.html#在r中使用sql"><i class="fa fa-check"></i><b>2.2.5</b> 在R中使用sql</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="Data-preprocessing.html"><a href="Data-preprocessing.html"><i class="fa fa-check"></i><b>3</b> 数据预处理</a>
<ul>
<li class="chapter" data-level="3.1" data-path="Data-preprocessing.html"><a href="Data-preprocessing.html#数据抽取"><i class="fa fa-check"></i><b>3.1</b> 数据抽取</a></li>
<li class="chapter" data-level="3.2" data-path="Data-preprocessing.html"><a href="Data-preprocessing.html#数据清洗"><i class="fa fa-check"></i><b>3.2</b> 数据清洗</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="Data-preprocessing.html"><a href="Data-preprocessing.html#选择数据子集"><i class="fa fa-check"></i><b>3.2.1</b> 选择数据子集</a></li>
<li class="chapter" data-level="3.2.2" data-path="Data-preprocessing.html"><a href="Data-preprocessing.html#数据去重"><i class="fa fa-check"></i><b>3.2.2</b> 数据去重</a></li>
<li class="chapter" data-level="3.2.3" data-path="Data-preprocessing.html"><a href="Data-preprocessing.html#缺失值处理"><i class="fa fa-check"></i><b>3.2.3</b> 缺失值处理</a></li>
<li class="chapter" data-level="3.2.4" data-path="Data-preprocessing.html"><a href="Data-preprocessing.html#一致化处理-1"><i class="fa fa-check"></i><b>3.2.4</b> 一致化处理</a></li>
<li class="chapter" data-level="3.2.5" data-path="Data-preprocessing.html"><a href="Data-preprocessing.html#异常值处理-1"><i class="fa fa-check"></i><b>3.2.5</b> 异常值处理</a></li>
<li class="chapter" data-level="3.2.6" data-path="Data-preprocessing.html"><a href="Data-preprocessing.html#插值填补"><i class="fa fa-check"></i><b>3.2.6</b> 插值填补</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="Data-preprocessing.html"><a href="Data-preprocessing.html#数据重组与转换"><i class="fa fa-check"></i><b>3.3</b> 数据重组与转换</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="Data-preprocessing.html"><a href="Data-preprocessing.html#数据修改-数据增加与删除"><i class="fa fa-check"></i><b>3.3.1</b> 数据修改-数据增加与删除</a></li>
<li class="chapter" data-level="3.3.2" data-path="Data-preprocessing.html"><a href="Data-preprocessing.html#数据值重编码非列名"><i class="fa fa-check"></i><b>3.3.2</b> 数据值重编码（非列名）</a></li>
<li class="chapter" data-level="3.3.3" data-path="Data-preprocessing.html"><a href="Data-preprocessing.html#数据塑形"><i class="fa fa-check"></i><b>3.3.3</b> 数据塑形</a></li>
<li class="chapter" data-level="3.3.4" data-path="Data-preprocessing.html"><a href="Data-preprocessing.html#数据提取"><i class="fa fa-check"></i><b>3.3.4</b> 数据提取</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>模型拟合</b></span></li>
<li class="chapter" data-level="4" data-path="Model-building.html"><a href="Model-building.html"><i class="fa fa-check"></i><b>4</b> 构建模型</a>
<ul>
<li class="chapter" data-level="4.1" data-path="Model-building.html"><a href="Model-building.html#描述统计模型"><i class="fa fa-check"></i><b>4.1</b> 描述统计模型</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="Model-building.html"><a href="Model-building.html#快速构建描述性统计"><i class="fa fa-check"></i><b>4.1.1</b> 快速构建描述性统计</a></li>
<li class="chapter" data-level="4.1.2" data-path="Model-building.html"><a href="Model-building.html#高级分组统计"><i class="fa fa-check"></i><b>4.1.2</b> 高级分组统计</a></li>
<li class="chapter" data-level="4.1.3" data-path="Model-building.html"><a href="Model-building.html#常用统计函数"><i class="fa fa-check"></i><b>4.1.3</b> 常用统计函数</a></li>
<li class="chapter" data-level="4.1.4" data-path="Model-building.html"><a href="Model-building.html#批处理函数"><i class="fa fa-check"></i><b>4.1.4</b> 批处理函数</a></li>
<li class="chapter" data-level="4.1.5" data-path="Model-building.html"><a href="Model-building.html#broom优雅输出"><i class="fa fa-check"></i><b>4.1.5</b> BROOM优雅输出</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="Model-building.html"><a href="Model-building.html#复杂统计模型"><i class="fa fa-check"></i><b>4.2</b> 复杂统计模型</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="Model-building.html"><a href="Model-building.html#变量筛选"><i class="fa fa-check"></i><b>4.2.1</b> 变量筛选</a></li>
<li class="chapter" data-level="4.2.2" data-path="Model-building.html"><a href="Model-building.html#线性统计回归"><i class="fa fa-check"></i><b>4.2.2</b> 线性统计回归</a></li>
<li class="chapter" data-level="4.2.3" data-path="Model-building.html"><a href="Model-building.html#方差检验"><i class="fa fa-check"></i><b>4.2.3</b> 方差检验</a></li>
<li class="chapter" data-level="4.2.4" data-path="Model-building.html"><a href="Model-building.html#相关统计r包资源"><i class="fa fa-check"></i><b>4.2.4</b> 相关统计R包资源：</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="Model-building.html"><a href="Model-building.html#临床统计模型"><i class="fa fa-check"></i><b>4.3</b> 临床统计模型</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="Model-building.html"><a href="Model-building.html#平衡匹配"><i class="fa fa-check"></i><b>4.3.1</b> 平衡匹配</a></li>
<li class="chapter" data-level="4.3.2" data-path="Model-building.html"><a href="Model-building.html#生存分析"><i class="fa fa-check"></i><b>4.3.2</b> 生存分析</a></li>
<li class="chapter" data-level="4.3.3" data-path="Model-building.html"><a href="Model-building.html#补充r包"><i class="fa fa-check"></i><b>4.3.3</b> 补充R包</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="Model-building.html"><a href="Model-building.html#构造模型的辅助函数或参数"><i class="fa fa-check"></i><b>4.4</b> 构造模型的辅助函数或参数</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="Model-building.html"><a href="Model-building.html#常用参数"><i class="fa fa-check"></i><b>4.4.1</b> 常用参数</a></li>
<li class="chapter" data-level="4.4.2" data-path="Model-building.html"><a href="Model-building.html#查询线性模型结果"><i class="fa fa-check"></i><b>4.4.2</b> 查询线性模型结果</a></li>
<li class="chapter" data-level="4.4.3" data-path="Model-building.html"><a href="Model-building.html#r语言笔记.formula"><i class="fa fa-check"></i><b>4.4.3</b> R语言笔记.formula</a></li>
<li class="chapter" data-level="4.4.4" data-path="Model-building.html"><a href="Model-building.html#特征工程"><i class="fa fa-check"></i><b>4.4.4</b> 特征工程</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="Model-building.html"><a href="Model-building.html#深度学习"><i class="fa fa-check"></i><b>4.5</b> 深度学习</a>
<ul>
<li class="chapter" data-level="4.5.1" data-path="Model-building.html"><a href="Model-building.html#r-中执行keras"><i class="fa fa-check"></i><b>4.5.1</b> R 中执行keras</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="Model-building.html"><a href="Model-building.html#机器学习"><i class="fa fa-check"></i><b>4.6</b> 机器学习</a>
<ul>
<li class="chapter" data-level="4.6.1" data-path="Model-building.html"><a href="Model-building.html#机器学习--mlr3包"><i class="fa fa-check"></i><b>4.6.1</b> 机器学习 -mlr3包</a></li>
<li class="chapter" data-level="4.6.2" data-path="Model-building.html"><a href="Model-building.html#常规机器学习"><i class="fa fa-check"></i><b>4.6.2</b> 常规机器学习</a></li>
<li class="chapter" data-level="4.6.3" data-path="Model-building.html"><a href="Model-building.html#朴素贝叶斯"><i class="fa fa-check"></i><b>4.6.3</b> 朴素贝叶斯</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="Model-performance.html"><a href="Model-performance.html"><i class="fa fa-check"></i><b>5</b> 模型评估</a>
<ul>
<li class="chapter" data-level="5.1" data-path="Model-performance.html"><a href="Model-performance.html#模型评估辅助"><i class="fa fa-check"></i><b>5.1</b> 模型评估辅助：</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="Model-performance.html"><a href="Model-performance.html#purrr包的pluck函数字符提取"><i class="fa fa-check"></i><b>5.1.1</b> purrr包的pluck()函数字符提取</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="Model-performance.html"><a href="Model-performance.html#常用模型辅助评估r包"><i class="fa fa-check"></i><b>5.2</b> 常用模型辅助评估R包：</a></li>
</ul></li>
<li class="part"><span><b>模型展示</b></span></li>
<li class="chapter" data-level="6" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html"><i class="fa fa-check"></i><b>6</b> 模型发布与应用</a>
<ul>
<li class="chapter" data-level="6.1" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#flexboard"><i class="fa fa-check"></i><b>6.1</b> flexboard</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#安装工作环境"><i class="fa fa-check"></i><b>6.1.1</b> 安装工作环境</a></li>
<li class="chapter" data-level="6.1.2" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#多级导航模块"><i class="fa fa-check"></i><b>6.1.2</b> 多级导航模块</a></li>
<li class="chapter" data-level="6.1.3" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#超级链接表"><i class="fa fa-check"></i><b>6.1.3</b> 超级链接表</a></li>
<li class="chapter" data-level="6.1.4" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#给导航栏添加social-links"><i class="fa fa-check"></i><b>6.1.4</b> 给导航栏添加Social Links</a></li>
<li class="chapter" data-level="6.1.5" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#给导航栏添加source-code"><i class="fa fa-check"></i><b>6.1.5</b> 给导航栏添加Source Code</a></li>
<li class="chapter" data-level="6.1.6" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#给导航栏添加一个about"><i class="fa fa-check"></i><b>6.1.6</b> 给导航栏添加一个<code>about</code></a></li>
<li class="chapter" data-level="6.1.7" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#布局参数"><i class="fa fa-check"></i><b>6.1.7</b> 布局参数</a></li>
<li class="chapter" data-level="6.1.8" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#功能块参数"><i class="fa fa-check"></i><b>6.1.8</b> 功能块参数</a></li>
<li class="chapter" data-level="6.1.9" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#故事版"><i class="fa fa-check"></i><b>6.1.9</b> 故事版</a></li>
<li class="chapter" data-level="6.1.10" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#辅助dashboard展示参数"><i class="fa fa-check"></i><b>6.1.10</b> 辅助dashboard展示参数</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#shinydashboard"><i class="fa fa-check"></i><b>6.2</b> shinydashboard</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#基本框架和流程"><i class="fa fa-check"></i><b>6.2.1</b> 基本框架和流程</a></li>
<li class="chapter" data-level="6.2.2" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#仪表板的结构"><i class="fa fa-check"></i><b>6.2.2</b> 仪表板的结构</a></li>
<li class="chapter" data-level="6.2.3" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#布局参数-1"><i class="fa fa-check"></i><b>6.2.3</b> 布局参数</a></li>
<li class="chapter" data-level="6.2.4" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#在dashboard中使用css技巧"><i class="fa fa-check"></i><b>6.2.4</b> 在dashboard中使用css技巧</a></li>
<li class="chapter" data-level="6.2.5" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#适配于shiny的特殊函数"><i class="fa fa-check"></i><b>6.2.5</b> 适配于shiny的特殊函数</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#rmarkdown使用进阶"><i class="fa fa-check"></i><b>6.3</b> Rmarkdown使用进阶</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#参考书目"><i class="fa fa-check"></i><b>6.3.1</b> 参考书目</a></li>
<li class="chapter" data-level="6.3.2" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#title和autherymal"><i class="fa fa-check"></i><b>6.3.2</b> title和auther/YMAL</a></li>
<li class="chapter" data-level="6.3.3" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#字体与格式"><i class="fa fa-check"></i><b>6.3.3</b> 字体与格式</a></li>
<li class="chapter" data-level="6.3.4" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#辅助标记"><i class="fa fa-check"></i><b>6.3.4</b> 辅助标记</a></li>
<li class="chapter" data-level="6.3.5" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#常用代码标签"><i class="fa fa-check"></i><b>6.3.5</b> 常用代码标签</a></li>
<li class="chapter" data-level="6.3.6" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#非常用代码标签"><i class="fa fa-check"></i><b>6.3.6</b> 非常用代码标签</a></li>
<li class="chapter" data-level="6.3.7" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#快捷键"><i class="fa fa-check"></i><b>6.3.7</b> 快捷键</a></li>
<li class="chapter" data-level="6.3.8" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#标题修改"><i class="fa fa-check"></i><b>6.3.8</b> 标题修改</a></li>
<li class="chapter" data-level="6.3.9" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#图片处理"><i class="fa fa-check"></i><b>6.3.9</b> 图片处理</a></li>
<li class="chapter" data-level="6.3.10" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#表格输出"><i class="fa fa-check"></i><b>6.3.10</b> 表格输出</a></li>
<li class="chapter" data-level="6.3.11" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#结果输出"><i class="fa fa-check"></i><b>6.3.11</b> 结果输出</a></li>
<li class="chapter" data-level="6.3.12" data-path="id_06-Model-release-and-application.html"><a href="id_06-Model-release-and-application.html#补充知识点"><i class="fa fa-check"></i><b>6.3.12</b> 补充知识点</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="Visualization-Tables-Figures.html"><a href="Visualization-Tables-Figures.html"><i class="fa fa-check"></i><b>7</b> 可视化（表与图）</a>
<ul>
<li class="chapter" data-level="7.1" data-path="Visualization-Tables-Figures.html"><a href="Visualization-Tables-Figures.html#表格可视化"><i class="fa fa-check"></i><b>7.1</b> 表格可视化</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="Visualization-Tables-Figures.html"><a href="Visualization-Tables-Figures.html#快速图表可视化"><i class="fa fa-check"></i><b>7.1.1</b> 快速图表可视化</a></li>
<li class="chapter" data-level="7.1.2" data-path="Visualization-Tables-Figures.html"><a href="Visualization-Tables-Figures.html#编辑表"><i class="fa fa-check"></i><b>7.1.2</b> 编辑表</a></li>
<li class="chapter" data-level="7.1.3" data-path="Visualization-Tables-Figures.html"><a href="Visualization-Tables-Figures.html#静态表格优化展示"><i class="fa fa-check"></i><b>7.1.3</b> 静态表格优化展示</a></li>
<li class="chapter" data-level="7.1.4" data-path="Visualization-Tables-Figures.html"><a href="Visualization-Tables-Figures.html#动态表格优化展示"><i class="fa fa-check"></i><b>7.1.4</b> 动态表格优化展示</a></li>
<li class="chapter" data-level="7.1.5" data-path="Visualization-Tables-Figures.html"><a href="Visualization-Tables-Figures.html#描述性统计表格分析"><i class="fa fa-check"></i><b>7.1.5</b> 描述性统计表格分析</a></li>
<li class="chapter" data-level="7.1.6" data-path="Visualization-Tables-Figures.html"><a href="Visualization-Tables-Figures.html#统计结果表格可视化"><i class="fa fa-check"></i><b>7.1.6</b> 统计结果表格可视化</a></li>
<li class="chapter" data-level="7.1.7" data-path="Visualization-Tables-Figures.html"><a href="Visualization-Tables-Figures.html#补充表格包"><i class="fa fa-check"></i><b>7.1.7</b> 补充表格包</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="Visualization-Tables-Figures.html"><a href="Visualization-Tables-Figures.html#图形可视化"><i class="fa fa-check"></i><b>7.2</b> 图形可视化</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="Visualization-Tables-Figures.html"><a href="Visualization-Tables-Figures.html#画图参考网站"><i class="fa fa-check"></i><b>7.2.1</b> 画图参考网站</a></li>
<li class="chapter" data-level="7.2.2" data-path="Visualization-Tables-Figures.html"><a href="Visualization-Tables-Figures.html#免代码绘制"><i class="fa fa-check"></i><b>7.2.2</b> 免代码绘制</a></li>
<li class="chapter" data-level="7.2.3" data-path="Visualization-Tables-Figures.html"><a href="Visualization-Tables-Figures.html#统计辅助绘图"><i class="fa fa-check"></i><b>7.2.3</b> 统计辅助绘图</a></li>
<li class="chapter" data-level="7.2.4" data-path="Visualization-Tables-Figures.html"><a href="Visualization-Tables-Figures.html#base-plotggplot2"><i class="fa fa-check"></i><b>7.2.4</b> base-plot()/ggplot2()</a></li>
<li class="chapter" data-level="7.2.5" data-path="Visualization-Tables-Figures.html"><a href="Visualization-Tables-Figures.html#绘图"><i class="fa fa-check"></i><b>7.2.5</b> 绘图</a></li>
<li class="chapter" data-level="7.2.6" data-path="Visualization-Tables-Figures.html"><a href="Visualization-Tables-Figures.html#统计图形代码"><i class="fa fa-check"></i><b>7.2.6</b> 统计图形代码</a></li>
<li class="chapter" data-level="7.2.7" data-path="Visualization-Tables-Figures.html"><a href="Visualization-Tables-Figures.html#医学分析图"><i class="fa fa-check"></i><b>7.2.7</b> 医学分析图</a></li>
<li class="chapter" data-level="7.2.8" data-path="Visualization-Tables-Figures.html"><a href="Visualization-Tables-Figures.html#补充图形库"><i class="fa fa-check"></i><b>7.2.8</b> 补充图形库</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>工具箱</b></span></li>
<li class="chapter" data-level="8" data-path="Common-statistical-R-code.html"><a href="Common-statistical-R-code.html"><i class="fa fa-check"></i><b>8</b> 常用统计R代码</a>
<ul>
<li class="chapter" data-level="8.1" data-path="Common-statistical-R-code.html"><a href="Common-statistical-R-code.html#r-系统功能"><i class="fa fa-check"></i><b>8.1</b> R-系统功能</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="Common-statistical-R-code.html"><a href="Common-statistical-R-code.html#常用r系统代码"><i class="fa fa-check"></i><b>8.1.1</b> 常用R系统代码</a></li>
<li class="chapter" data-level="8.1.2" data-path="Common-statistical-R-code.html"><a href="Common-statistical-R-code.html#辅助r包"><i class="fa fa-check"></i><b>8.1.2</b> 辅助R包：</a></li>
<li class="chapter" data-level="8.1.3" data-path="Common-statistical-R-code.html"><a href="Common-statistical-R-code.html#常用系统脚本"><i class="fa fa-check"></i><b>8.1.3</b> 常用系统脚本</a></li>
<li class="chapter" data-level="8.1.4" data-path="Common-statistical-R-code.html"><a href="Common-statistical-R-code.html#s3和s4事件"><i class="fa fa-check"></i><b>8.1.4</b> S3和S4事件</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="Common-statistical-R-code.html"><a href="Common-statistical-R-code.html#r报错机制学习"><i class="fa fa-check"></i><b>8.2</b> R报错机制学习</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="Common-statistical-R-code.html"><a href="Common-statistical-R-code.html#常见异常处理函数"><i class="fa fa-check"></i><b>8.2.1</b> 1 常见异常处理函数</a></li>
<li class="chapter" data-level="8.2.2" data-path="Common-statistical-R-code.html"><a href="Common-statistical-R-code.html#stop"><i class="fa fa-check"></i><b>8.2.2</b> 2 STOP</a></li>
<li class="chapter" data-level="8.2.3" data-path="Common-statistical-R-code.html"><a href="Common-statistical-R-code.html#warning"><i class="fa fa-check"></i><b>8.2.3</b> 3 WARNING</a></li>
<li class="chapter" data-level="8.2.4" data-path="Common-statistical-R-code.html"><a href="Common-statistical-R-code.html#捕捉错误"><i class="fa fa-check"></i><b>8.2.4</b> 4 捕捉错误</a></li>
<li class="chapter" data-level="8.2.5" data-path="Common-statistical-R-code.html"><a href="Common-statistical-R-code.html#代码错误调试"><i class="fa fa-check"></i><b>8.2.5</b> 5 代码错误调试</a></li>
<li class="chapter" data-level="8.2.6" data-path="Common-statistical-R-code.html"><a href="Common-statistical-R-code.html#代码时间消耗跟踪"><i class="fa fa-check"></i><b>8.2.6</b> 6 代码时间消耗跟踪</a></li>
<li class="chapter" data-level="8.2.7" data-path="Common-statistical-R-code.html"><a href="Common-statistical-R-code.html#补充案例"><i class="fa fa-check"></i><b>8.2.7</b> 7 补充案例</a></li>
<li class="chapter" data-level="8.2.8" data-path="Common-statistical-R-code.html"><a href="Common-statistical-R-code.html#相关资料"><i class="fa fa-check"></i><b>8.2.8</b> 8 相关资料</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="Common-statistical-R-code.html"><a href="Common-statistical-R-code.html#常用快捷命令"><i class="fa fa-check"></i><b>8.3</b> 常用快捷命令</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="Common-statistical-R-code.html"><a href="Common-statistical-R-code.html#高效管道符号"><i class="fa fa-check"></i><b>8.3.1</b> 高效管道符号</a></li>
<li class="chapter" data-level="8.3.2" data-path="Common-statistical-R-code.html"><a href="Common-statistical-R-code.html#常用辅助函数"><i class="fa fa-check"></i><b>8.3.2</b> 常用辅助函数：</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="Common-statistical-R-code.html"><a href="Common-statistical-R-code.html#正则表达式"><i class="fa fa-check"></i><b>8.4</b> 正则表达式</a>
<ul>
<li class="chapter" data-level="8.4.1" data-path="Common-statistical-R-code.html"><a href="Common-statistical-R-code.html#常用正则表达式命令-1"><i class="fa fa-check"></i><b>8.4.1</b> 常用正则表达式命令-1</a></li>
<li class="chapter" data-level="8.4.2" data-path="Common-statistical-R-code.html"><a href="Common-statistical-R-code.html#常用正则表达式命令-2"><i class="fa fa-check"></i><b>8.4.2</b> 常用正则表达式命令-2</a></li>
<li class="chapter" data-level="8.4.3" data-path="Common-statistical-R-code.html"><a href="Common-statistical-R-code.html#量词"><i class="fa fa-check"></i><b>8.4.3</b> 量词</a></li>
<li class="chapter" data-level="8.4.4" data-path="Common-statistical-R-code.html"><a href="Common-statistical-R-code.html#捕获分组"><i class="fa fa-check"></i><b>8.4.4</b> 捕获分组</a></li>
<li class="chapter" data-level="8.4.5" data-path="Common-statistical-R-code.html"><a href="Common-statistical-R-code.html#python使用编译"><i class="fa fa-check"></i><b>8.4.5</b> python使用编译</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="Statistical-flow-of-clinical-medicine.html"><a href="Statistical-flow-of-clinical-medicine.html"><i class="fa fa-check"></i><b>9</b> 临床医学统计流</a>
<ul>
<li class="chapter" data-level="9.1" data-path="Statistical-flow-of-clinical-medicine.html"><a href="Statistical-flow-of-clinical-medicine.html#common.r"><i class="fa fa-check"></i><b>9.1</b> COMMON.R</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="Statistical-flow-of-clinical-medicine.html"><a href="Statistical-flow-of-clinical-medicine.html#加载r包和配置全局环境"><i class="fa fa-check"></i><b>9.1.1</b> 加载R包和配置全局环境</a></li>
<li class="chapter" data-level="9.1.2" data-path="Statistical-flow-of-clinical-medicine.html"><a href="Statistical-flow-of-clinical-medicine.html#使用officer来启动函数参数"><i class="fa fa-check"></i><b>9.1.2</b> 使用officer来启动函数参数：</a></li>
<li class="chapter" data-level="9.1.3" data-path="Statistical-flow-of-clinical-medicine.html"><a href="Statistical-flow-of-clinical-medicine.html#table-of-content"><i class="fa fa-check"></i><b>9.1.3</b> Table of content</a></li>
<li class="chapter" data-level="9.1.4" data-path="Statistical-flow-of-clinical-medicine.html"><a href="Statistical-flow-of-clinical-medicine.html#cover-template--封面"><i class="fa fa-check"></i><b>9.1.4</b> Cover template -封面</a></li>
<li class="chapter" data-level="9.1.5" data-path="Statistical-flow-of-clinical-medicine.html"><a href="Statistical-flow-of-clinical-medicine.html#快捷辅助函数"><i class="fa fa-check"></i><b>9.1.5</b> 快捷辅助函数：</a></li>
<li class="chapter" data-level="9.1.6" data-path="Statistical-flow-of-clinical-medicine.html"><a href="Statistical-flow-of-clinical-medicine.html#快捷统计函数"><i class="fa fa-check"></i><b>9.1.6</b> 快捷统计函数：</a></li>
<li class="chapter" data-level="9.1.7" data-path="Statistical-flow-of-clinical-medicine.html"><a href="Statistical-flow-of-clinical-medicine.html#描述性分析统计函数"><i class="fa fa-check"></i><b>9.1.7</b> 描述性分析统计函数</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="Statistical-flow-of-clinical-medicine.html"><a href="Statistical-flow-of-clinical-medicine.html#rawdata-cleaning-pipeline"><i class="fa fa-check"></i><b>9.2</b> Rawdata cleaning pipeline</a></li>
<li class="chapter" data-level="9.3" data-path="Statistical-flow-of-clinical-medicine.html"><a href="Statistical-flow-of-clinical-medicine.html#target_groups"><i class="fa fa-check"></i><b>9.3</b> target_groups</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="Statistical-flow-of-clinical-medicine.html"><a href="Statistical-flow-of-clinical-medicine.html#加载集成数据集"><i class="fa fa-check"></i><b>9.3.1</b> 加载集成数据集</a></li>
<li class="chapter" data-level="9.3.2" data-path="Statistical-flow-of-clinical-medicine.html"><a href="Statistical-flow-of-clinical-medicine.html#保存数据集"><i class="fa fa-check"></i><b>9.3.2</b> 保存数据集</a></li>
<li class="chapter" data-level="9.3.3" data-path="Statistical-flow-of-clinical-medicine.html"><a href="Statistical-flow-of-clinical-medicine.html#患者平衡匹配前后信息比较"><i class="fa fa-check"></i><b>9.3.3</b> 患者平衡匹配前后信息比较</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="Statistical-flow-of-clinical-medicine.html"><a href="Statistical-flow-of-clinical-medicine.html#dataset_for_analysis"><i class="fa fa-check"></i><b>9.4</b> dataset_for_analysis</a></li>
<li class="chapter" data-level="9.5" data-path="Statistical-flow-of-clinical-medicine.html"><a href="Statistical-flow-of-clinical-medicine.html#final_analysis"><i class="fa fa-check"></i><b>9.5</b> final_analysis</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="Statistical-books.html"><a href="Statistical-books.html"><i class="fa fa-check"></i><b>10</b> 统计书籍</a>
<ul>
<li class="chapter" data-level="10.1" data-path="Statistical-books.html"><a href="Statistical-books.html#r-统计书籍"><i class="fa fa-check"></i><b>10.1</b> R-统计书籍</a>
<ul>
<li class="chapter" data-level="10.1.1" data-path="Statistical-books.html"><a href="Statistical-books.html#tidyverse相关"><i class="fa fa-check"></i><b>10.1.1</b> tidyverse相关</a></li>
<li class="chapter" data-level="10.1.2" data-path="Statistical-books.html"><a href="Statistical-books.html#ggplo2相关-网站"><i class="fa fa-check"></i><b>10.1.2</b> ggplo2相关-网站</a></li>
<li class="chapter" data-level="10.1.3" data-path="Statistical-books.html"><a href="Statistical-books.html#绘图指南"><i class="fa fa-check"></i><b>10.1.3</b> 绘图指南</a></li>
<li class="chapter" data-level="10.1.4" data-path="Statistical-books.html"><a href="Statistical-books.html#绘图相关的博客"><i class="fa fa-check"></i><b>10.1.4</b> 绘图相关的博客</a></li>
<li class="chapter" data-level="10.1.5" data-path="Statistical-books.html"><a href="Statistical-books.html#医学指南相关"><i class="fa fa-check"></i><b>10.1.5</b> 医学指南相关</a></li>
<li class="chapter" data-level="10.1.6" data-path="Statistical-books.html"><a href="Statistical-books.html#医学统计r包"><i class="fa fa-check"></i><b>10.1.6</b> 医学统计R包</a></li>
<li class="chapter" data-level="10.1.7" data-path="Statistical-books.html"><a href="Statistical-books.html#医学统计相关博客"><i class="fa fa-check"></i><b>10.1.7</b> 医学统计相关博客</a></li>
<li class="chapter" data-level="10.1.8" data-path="Statistical-books.html"><a href="Statistical-books.html#统计指南-r代码实现"><i class="fa fa-check"></i><b>10.1.8</b> 统计指南-R代码实现</a></li>
<li class="chapter" data-level="10.1.9" data-path="Statistical-books.html"><a href="Statistical-books.html#数据建模相关"><i class="fa fa-check"></i><b>10.1.9</b> 数据建模相关</a></li>
<li class="chapter" data-level="10.1.10" data-path="Statistical-books.html"><a href="Statistical-books.html#整合流程"><i class="fa fa-check"></i><b>10.1.10</b> 整合流程</a></li>
<li class="chapter" data-level="10.1.11" data-path="Statistical-books.html"><a href="Statistical-books.html#博客社区"><i class="fa fa-check"></i><b>10.1.11</b> 博客社区</a></li>
<li class="chapter" data-level="10.1.12" data-path="Statistical-books.html"><a href="Statistical-books.html#rmarkdown"><i class="fa fa-check"></i><b>10.1.12</b> Rmarkdown</a></li>
<li class="chapter" data-level="10.1.13" data-path="Statistical-books.html"><a href="Statistical-books.html#r-rstudio"><i class="fa fa-check"></i><b>10.1.13</b> R-Rstudio</a></li>
<li class="chapter" data-level="10.1.14" data-path="Statistical-books.html"><a href="Statistical-books.html#shiny"><i class="fa fa-check"></i><b>10.1.14</b> shiny</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="Statistical-books.html"><a href="Statistical-books.html#使用gitbook写书"><i class="fa fa-check"></i><b>10.2</b> 使用gitbook写书</a></li>
<li class="chapter" data-level="10.3" data-path="Statistical-books.html"><a href="Statistical-books.html#使用bookdwon写书"><i class="fa fa-check"></i><b>10.3</b> 使用bookdwon写书</a>
<ul>
<li class="chapter" data-level="10.3.1" data-path="Statistical-books.html"><a href="Statistical-books.html#常用功能标记"><i class="fa fa-check"></i><b>10.3.1</b> 常用功能标记</a></li>
<li class="chapter" data-level="10.3.2" data-path="Statistical-books.html"><a href="Statistical-books.html#r代码的构建"><i class="fa fa-check"></i><b>10.3.2</b> R代码的构建</a></li>
<li class="chapter" data-level="10.3.3" data-path="Statistical-books.html"><a href="Statistical-books.html#动态r代码"><i class="fa fa-check"></i><b>10.3.3</b> 动态r代码</a></li>
<li class="chapter" data-level="10.3.4" data-path="Statistical-books.html"><a href="Statistical-books.html#引入shiny应用"><i class="fa fa-check"></i><b>10.3.4</b> 引入shiny应用</a></li>
<li class="chapter" data-level="10.3.5" data-path="Statistical-books.html"><a href="Statistical-books.html#指定输出和解析的文件"><i class="fa fa-check"></i><b>10.3.5</b> 指定输出和解析的文件</a></li>
<li class="chapter" data-level="10.3.6" data-path="Statistical-books.html"><a href="Statistical-books.html#文件最后修改时间"><i class="fa fa-check"></i><b>10.3.6</b> 文件最后修改时间</a></li>
<li class="chapter" data-level="10.3.7" data-path="Statistical-books.html"><a href="Statistical-books.html#添加指定序号"><i class="fa fa-check"></i><b>10.3.7</b> 添加指定序号</a></li>
<li class="chapter" data-level="10.3.8" data-path="Statistical-books.html"><a href="Statistical-books.html#辅助知识-"><i class="fa fa-check"></i><b>10.3.8</b> 辅助知识：—-</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="Statistics-and-Research-Design.html"><a href="Statistics-and-Research-Design.html"><i class="fa fa-check"></i><b>11</b> 统计与研究设计</a>
<ul>
<li class="chapter" data-level="11.1" data-path="Statistics-and-Research-Design.html"><a href="Statistics-and-Research-Design.html#常用参数释义"><i class="fa fa-check"></i><b>11.1</b> 常用参数释义</a>
<ul>
<li class="chapter" data-level="11.1.1" data-path="Statistics-and-Research-Design.html"><a href="Statistics-and-Research-Design.html#因果回归参数"><i class="fa fa-check"></i><b>11.1.1</b> 因果回归参数</a></li>
<li class="chapter" data-level="11.1.2" data-path="Statistics-and-Research-Design.html"><a href="Statistics-and-Research-Design.html#生存分析参数"><i class="fa fa-check"></i><b>11.1.2</b> 生存分析参数</a></li>
<li class="chapter" data-level="11.1.3" data-path="Statistics-and-Research-Design.html"><a href="Statistics-and-Research-Design.html#方差分析参数解释"><i class="fa fa-check"></i><b>11.1.3</b> 方差分析参数解释</a></li>
<li class="chapter" data-level="11.1.4" data-path="Statistics-and-Research-Design.html"><a href="Statistics-and-Research-Design.html#回归分析中常用参数释义"><i class="fa fa-check"></i><b>11.1.4</b> 回归分析中常用参数释义</a></li>
<li class="chapter" data-level="11.1.5" data-path="Statistics-and-Research-Design.html"><a href="Statistics-and-Research-Design.html#常用分布描述"><i class="fa fa-check"></i><b>11.1.5</b> 常用分布描述</a></li>
<li class="chapter" data-level="11.1.6" data-path="Statistics-and-Research-Design.html"><a href="Statistics-and-Research-Design.html#其他统计参数释义"><i class="fa fa-check"></i><b>11.1.6</b> 其他统计参数释义</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="Statistics-and-Research-Design.html"><a href="Statistics-and-Research-Design.html#临床研究中常用的统计方法和常见问题"><i class="fa fa-check"></i><b>11.2</b> 临床研究中常用的统计方法和常见问题</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="Statistics-and-Research-Design.html"><a href="Statistics-and-Research-Design.html#统计推断与区间估计"><i class="fa fa-check"></i><b>11.2.1</b> 统计推断与区间估计</a></li>
<li class="chapter" data-level="11.2.2" data-path="Statistics-and-Research-Design.html"><a href="Statistics-and-Research-Design.html#统计方法选择"><i class="fa fa-check"></i><b>11.2.2</b> 统计方法选择：</a></li>
<li class="chapter" data-level="11.2.3" data-path="Statistics-and-Research-Design.html"><a href="Statistics-and-Research-Design.html#统计分析中的常见问题"><i class="fa fa-check"></i><b>11.2.3</b> 统计分析中的常见问题</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="Statistics-and-Research-Design.html"><a href="Statistics-and-Research-Design.html#差异分析"><i class="fa fa-check"></i><b>11.3</b> 差异分析</a>
<ul>
<li class="chapter" data-level="11.3.1" data-path="Statistics-and-Research-Design.html"><a href="Statistics-and-Research-Design.html#方差检验与t检验的选择"><i class="fa fa-check"></i><b>11.3.1</b> 方差检验与T检验的选择</a></li>
<li class="chapter" data-level="11.3.2" data-path="Statistics-and-Research-Design.html"><a href="Statistics-and-Research-Design.html#z-分布t检验f检验和卡方检验"><i class="fa fa-check"></i><b>11.3.2</b> Z 分布、T检验、F检验和卡方检验</a></li>
<li class="chapter" data-level="11.3.3" data-path="Statistics-and-Research-Design.html"><a href="Statistics-and-Research-Design.html#t检验"><i class="fa fa-check"></i><b>11.3.3</b> T检验</a></li>
<li class="chapter" data-level="11.3.4" data-path="Statistics-and-Research-Design.html"><a href="Statistics-and-Research-Design.html#方差分析"><i class="fa fa-check"></i><b>11.3.4</b> 方差分析</a></li>
<li class="chapter" data-level="11.3.5" data-path="Statistics-and-Research-Design.html"><a href="Statistics-and-Research-Design.html#卡方检验"><i class="fa fa-check"></i><b>11.3.5</b> 卡方检验</a></li>
</ul></li>
<li class="chapter" data-level="11.4" data-path="Statistics-and-Research-Design.html"><a href="Statistics-and-Research-Design.html#多元线性回归"><i class="fa fa-check"></i><b>11.4</b> 多元线性回归</a>
<ul>
<li class="chapter" data-level="11.4.1" data-path="Statistics-and-Research-Design.html"><a href="Statistics-and-Research-Design.html#多元线性回归的概念和基础公式"><i class="fa fa-check"></i><b>11.4.1</b> 多元线性回归的概念和基础公式</a></li>
<li class="chapter" data-level="11.4.2" data-path="Statistics-and-Research-Design.html"><a href="Statistics-and-Research-Design.html#多元线性回归的本质"><i class="fa fa-check"></i><b>11.4.2</b> 多元线性回归的本质</a></li>
<li class="chapter" data-level="11.4.3" data-path="Statistics-and-Research-Design.html"><a href="Statistics-and-Research-Design.html#回归方程的参数解释"><i class="fa fa-check"></i><b>11.4.3</b> 回归方程的参数解释：</a></li>
<li class="chapter" data-level="11.4.4" data-path="Statistics-and-Research-Design.html"><a href="Statistics-and-Research-Design.html#回归方程的评价指标"><i class="fa fa-check"></i><b>11.4.4</b> 回归方程的评价指标</a></li>
<li class="chapter" data-level="11.4.5" data-path="Statistics-and-Research-Design.html"><a href="Statistics-and-Research-Design.html#回归解释相关参数"><i class="fa fa-check"></i><b>11.4.5</b> 回归解释相关参数：</a></li>
<li class="chapter" data-level="11.4.6" data-path="Statistics-and-Research-Design.html"><a href="Statistics-and-Research-Design.html#回归解释相关补充"><i class="fa fa-check"></i><b>11.4.6</b> 回归解释相关补充：</a></li>
</ul></li>
<li class="chapter" data-level="11.5" data-path="Statistics-and-Research-Design.html"><a href="Statistics-and-Research-Design.html#相关检验"><i class="fa fa-check"></i><b>11.5</b> 相关检验</a>
<ul>
<li class="chapter" data-level="11.5.1" data-path="Statistics-and-Research-Design.html"><a href="Statistics-and-Research-Design.html#相关检验和系数"><i class="fa fa-check"></i><b>11.5.1</b> 相关检验和系数</a></li>
</ul></li>
<li class="chapter" data-level="11.6" data-path="Statistics-and-Research-Design.html"><a href="Statistics-and-Research-Design.html#医疗相关检验"><i class="fa fa-check"></i><b>11.6</b> 医疗相关检验</a>
<ul>
<li class="chapter" data-level="11.6.1" data-path="Statistics-and-Research-Design.html"><a href="Statistics-and-Research-Design.html#log-rank检验"><i class="fa fa-check"></i><b>11.6.1</b> Log-rank检验</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="id_-Build-R-package.html"><a href="id_-Build-R-package.html"><i class="fa fa-check"></i><b>12</b> 构筑R package</a>
<ul>
<li class="chapter" data-level="12.1" data-path="id_-Build-R-package.html"><a href="id_-Build-R-package.html#构筑r-package相关参数配置"><i class="fa fa-check"></i><b>12.1</b> 构筑R package相关参数配置</a>
<ul>
<li class="chapter" data-level="12.1.1" data-path="id_-Build-R-package.html"><a href="id_-Build-R-package.html#创建本地环境并使用renv初始化本地安装环境"><i class="fa fa-check"></i><b>12.1.1</b> 创建本地环境并使用renv初始化本地安装环境</a></li>
<li class="chapter" data-level="12.1.2" data-path="id_-Build-R-package.html"><a href="id_-Build-R-package.html#常用配置"><i class="fa fa-check"></i><b>12.1.2</b> 常用配置</a></li>
<li class="chapter" data-level="12.1.3" data-path="id_-Build-R-package.html"><a href="id_-Build-R-package.html#构建函数"><i class="fa fa-check"></i><b>12.1.3</b> 构建函数</a></li>
<li class="chapter" data-level="12.1.4" data-path="id_-Build-R-package.html"><a href="id_-Build-R-package.html#函数测试"><i class="fa fa-check"></i><b>12.1.4</b> 函数测试</a></li>
<li class="chapter" data-level="12.1.5" data-path="id_-Build-R-package.html"><a href="id_-Build-R-package.html#添加项目内置数据集"><i class="fa fa-check"></i><b>12.1.5</b> 添加项目内置数据集</a></li>
<li class="chapter" data-level="12.1.6" data-path="id_-Build-R-package.html"><a href="id_-Build-R-package.html#添加辅助描述文件"><i class="fa fa-check"></i><b>12.1.6</b> 添加辅助描述文件</a></li>
<li class="chapter" data-level="12.1.7" data-path="id_-Build-R-package.html"><a href="id_-Build-R-package.html#r包整体测试"><i class="fa fa-check"></i><b>12.1.7</b> R包整体测试</a></li>
<li class="chapter" data-level="12.1.8" data-path="id_-Build-R-package.html"><a href="id_-Build-R-package.html#构建及安装r包"><i class="fa fa-check"></i><b>12.1.8</b> 构建及安装R包</a></li>
<li class="chapter" data-level="12.1.9" data-path="id_-Build-R-package.html"><a href="id_-Build-R-package.html#构建后上传到github多平台检查"><i class="fa fa-check"></i><b>12.1.9</b> 构建后上传到github多平台检查</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://bookdown.org" target="blank">本书由bookdown驱动</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">基于 R 的数据处理流程指南</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="Model-building" class="section level1 hasAnchor" number="4">
<h1><span class="header-section-number">第 4 章</span> 构建模型<a href="Model-building.html#Model-building" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="描述统计模型" class="section level2 hasAnchor" number="4.1">
<h2><span class="header-section-number">4.1</span> 描述统计模型<a href="Model-building.html#描述统计模型" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="快速构建描述性统计" class="section level3 hasAnchor" number="4.1.1">
<h3><span class="header-section-number">4.1.1</span> 快速构建描述性统计<a href="Model-building.html#快速构建描述性统计" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="summariseacross" class="section level4 hasAnchor" number="4.1.1.1">
<h4><span class="header-section-number">4.1.1.1</span> summarise/across<a href="Model-building.html#summariseacross" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="Model-building.html#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="do">### 关键的两个函数：</span></span>
<span id="cb59-2"><a href="Model-building.html#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="do">## summarise()</span></span>
<span id="cb59-3"><a href="Model-building.html#cb59-3" aria-hidden="true" tabindex="-1"></a>支持分组后统计，内部参数较为麻烦，可以直接在help中检索summarise（）</span>
<span id="cb59-4"><a href="Model-building.html#cb59-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-5"><a href="Model-building.html#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="do">## 指定函数构造统计：</span></span>
<span id="cb59-6"><a href="Model-building.html#cb59-6" aria-hidden="true" tabindex="-1"></a>summary_table <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span>                                        <span class="co"># </span></span>
<span id="cb59-7"><a href="Model-building.html#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(hospital) <span class="sc">%&gt;%</span>                                             <span class="co"># </span></span>
<span id="cb59-8"><a href="Model-building.html#cb59-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(                                                         <span class="co"># </span></span>
<span id="cb59-9"><a href="Model-building.html#cb59-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">cases       =</span> <span class="fu">n</span>(),                                                <span class="co"># </span></span>
<span id="cb59-10"><a href="Model-building.html#cb59-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">delay_max   =</span> <span class="fu">max</span>(days_onset_hosp, <span class="at">na.rm =</span> T),                    <span class="co"># </span></span>
<span id="cb59-11"><a href="Model-building.html#cb59-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">delay_mean  =</span> <span class="fu">round</span>(<span class="fu">mean</span>(days_onset_hosp, <span class="at">na.rm=</span>T), <span class="at">digits =</span> <span class="dv">1</span>),  <span class="co"># </span></span>
<span id="cb59-12"><a href="Model-building.html#cb59-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">delay_sd    =</span> <span class="fu">round</span>(<span class="fu">sd</span>(days_onset_hosp, <span class="at">na.rm =</span> T), <span class="at">digits =</span> <span class="dv">1</span>),  <span class="co"># </span></span>
<span id="cb59-13"><a href="Model-building.html#cb59-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">delay_3     =</span> <span class="fu">sum</span>(days_onset_hosp <span class="sc">&gt;=</span> <span class="dv">3</span>, <span class="at">na.rm =</span> T),               <span class="co"># </span></span>
<span id="cb59-14"><a href="Model-building.html#cb59-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_delay_3 =</span> scales<span class="sc">::</span><span class="fu">percent</span>(delay_3 <span class="sc">/</span> cases)                    <span class="co"># </span></span>
<span id="cb59-15"><a href="Model-building.html#cb59-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb59-16"><a href="Model-building.html#cb59-16" aria-hidden="true" tabindex="-1"></a>summary_table  <span class="co"># print</span></span>
<span id="cb59-17"><a href="Model-building.html#cb59-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-18"><a href="Model-building.html#cb59-18" aria-hidden="true" tabindex="-1"></a><span class="do">## 条件统计：</span></span>
<span id="cb59-19"><a href="Model-building.html#cb59-19" aria-hidden="true" tabindex="-1"></a><span class="do">## 形式1： 在内部筛选：</span></span>
<span id="cb59-20"><a href="Model-building.html#cb59-20" aria-hidden="true" tabindex="-1"></a>linelist <span class="sc">%&gt;%</span> </span>
<span id="cb59-21"><a href="Model-building.html#cb59-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(hospital) <span class="sc">%&gt;%</span> </span>
<span id="cb59-22"><a href="Model-building.html#cb59-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb59-23"><a href="Model-building.html#cb59-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_temp_fvr =</span> <span class="fu">max</span>(temp[fever <span class="sc">==</span> <span class="st">&quot;yes&quot;</span>], <span class="at">na.rm =</span> T),</span>
<span id="cb59-24"><a href="Model-building.html#cb59-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_temp_no =</span> <span class="fu">max</span>(temp[fever <span class="sc">==</span> <span class="st">&quot;no&quot;</span>], <span class="at">na.rm =</span> T)</span>
<span id="cb59-25"><a href="Model-building.html#cb59-25" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb59-26"><a href="Model-building.html#cb59-26" aria-hidden="true" tabindex="-1"></a><span class="do">## 形式2：在外部筛选：</span></span>
<span id="cb59-27"><a href="Model-building.html#cb59-27" aria-hidden="true" tabindex="-1"></a>mtcars <span class="sc">%&gt;%</span> </span>
<span id="cb59-28"><a href="Model-building.html#cb59-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">model=</span><span class="fu">rownames</span>(mtcars), </span>
<span id="cb59-29"><a href="Model-building.html#cb59-29" aria-hidden="true" tabindex="-1"></a>         <span class="at">vs=</span><span class="fu">ifelse</span>(vs<span class="sc">==</span><span class="dv">0</span>, <span class="st">&quot;vshaped&quot;</span>, <span class="st">&quot;straight&quot;</span>),</span>
<span id="cb59-30"><a href="Model-building.html#cb59-30" aria-hidden="true" tabindex="-1"></a>         <span class="at">am=</span><span class="fu">ifelse</span>(am<span class="sc">==</span><span class="dv">0</span>, <span class="st">&quot;auto&quot;</span>, <span class="st">&quot;manual&quot;</span>), </span>
<span id="cb59-31"><a href="Model-building.html#cb59-31" aria-hidden="true" tabindex="-1"></a>         <span class="fu">across</span>(<span class="fu">c</span>(<span class="st">&quot;cyl&quot;</span>, <span class="st">&quot;gear&quot;</span>), factor),</span>
<span id="cb59-32"><a href="Model-building.html#cb59-32" aria-hidden="true" tabindex="-1"></a>         <span class="at">.before=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>()</span>
<span id="cb59-33"><a href="Model-building.html#cb59-33" aria-hidden="true" tabindex="-1"></a><span class="do">## 形式3：直接条件匹配：</span></span>
<span id="cb59-34"><a href="Model-building.html#cb59-34" aria-hidden="true" tabindex="-1"></a>mtcars <span class="sc">%&gt;%</span> </span>
<span id="cb59-35"><a href="Model-building.html#cb59-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(cyl) <span class="sc">%&gt;%</span></span>
<span id="cb59-36"><a href="Model-building.html#cb59-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise_mean</span>(<span class="fu">where</span>(is.numeric))</span>
<span id="cb59-37"><a href="Model-building.html#cb59-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-38"><a href="Model-building.html#cb59-38" aria-hidden="true" tabindex="-1"></a><span class="co">#  形式4： 指定字符后匹配，与形式1相似：</span></span>
<span id="cb59-39"><a href="Model-building.html#cb59-39" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(class,sex ) <span class="sc">%&gt;%</span> </span>
<span id="cb59-40"><a href="Model-building.html#cb59-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">contains</span>(<span class="st">&quot;h&quot;</span>),mean,<span class="at">na.rm=</span> <span class="cn">TRUE</span>))</span>
<span id="cb59-41"><a href="Model-building.html#cb59-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-42"><a href="Model-building.html#cb59-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-43"><a href="Model-building.html#cb59-43" aria-hidden="true" tabindex="-1"></a><span class="do">## 结合across()构造批处理- 支持指定列和批函数：</span></span>
<span id="cb59-44"><a href="Model-building.html#cb59-44" aria-hidden="true" tabindex="-1"></a>支持批量处理列数据，支持.col和<span class="fu">.fun</span>()</span>
<span id="cb59-45"><a href="Model-building.html#cb59-45" aria-hidden="true" tabindex="-1"></a>具体参考：</span>
<span id="cb59-46"><a href="Model-building.html#cb59-46" aria-hidden="true" tabindex="-1"></a>https<span class="sc">:</span><span class="er">//</span>www.tidyverse.org<span class="sc">/</span>blog<span class="sc">/</span><span class="dv">2020</span><span class="sc">/</span><span class="dv">04</span><span class="sc">/</span>dplyr<span class="dv">-1-0-0</span><span class="sc">-</span>colwise<span class="sc">/</span></span>
<span id="cb59-47"><a href="Model-building.html#cb59-47" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb59-48"><a href="Model-building.html#cb59-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(g1, g2) <span class="sc">%&gt;%</span> </span>
<span id="cb59-49"><a href="Model-building.html#cb59-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(a<span class="sc">:</span>d, mean))</span>
<span id="cb59-50"><a href="Model-building.html#cb59-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-51"><a href="Model-building.html#cb59-51" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb59-52"><a href="Model-building.html#cb59-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(g1, g2) <span class="sc">%&gt;%</span>  <span class="do">## 注意这里的n= n()是内置的count()函数；</span></span>
<span id="cb59-53"><a href="Model-building.html#cb59-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), mean),<span class="at">n=</span> <span class="fu">n</span>()) </span>
<span id="cb59-54"><a href="Model-building.html#cb59-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-55"><a href="Model-building.html#cb59-55" aria-hidden="true" tabindex="-1"></a><span class="co"># summarise和across()的完整形式：</span></span>
<span id="cb59-56"><a href="Model-building.html#cb59-56" aria-hidden="true" tabindex="-1"></a>linelist <span class="sc">%&gt;%</span> </span>
<span id="cb59-57"><a href="Model-building.html#cb59-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(outcome) <span class="sc">%&gt;%</span> </span>
<span id="cb59-58"><a href="Model-building.html#cb59-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">c</span>(age_years, temp, wt_kg, ht_cm),  </span>
<span id="cb59-59"><a href="Model-building.html#cb59-59" aria-hidden="true" tabindex="-1"></a>                   <span class="at">.fns =</span> mean,                               </span>
<span id="cb59-60"><a href="Model-building.html#cb59-60" aria-hidden="true" tabindex="-1"></a>                   <span class="at">na.rm=</span>T))        </span>
<span id="cb59-61"><a href="Model-building.html#cb59-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-62"><a href="Model-building.html#cb59-62" aria-hidden="true" tabindex="-1"></a><span class="do">## 对同一数据指定多组函数：</span></span>
<span id="cb59-63"><a href="Model-building.html#cb59-63" aria-hidden="true" tabindex="-1"></a>df_grp <span class="ot">=</span> df <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(class) <span class="sc">%&gt;%</span></span>
<span id="cb59-64"><a href="Model-building.html#cb59-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(class) <span class="sc">%&gt;%</span></span>
<span id="cb59-65"><a href="Model-building.html#cb59-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric),</span>
<span id="cb59-66"><a href="Model-building.html#cb59-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">sum=</span>sum,<span class="at">mean =</span>mean,<span class="at">min=</span> min),<span class="at">na.rm=</span><span class="cn">TRUE</span>))</span>
<span id="cb59-67"><a href="Model-building.html#cb59-67" aria-hidden="true" tabindex="-1"></a>df_grp  </span></code></pre></div>
</div>
<div id="mutateacross" class="section level4 hasAnchor" number="4.1.1.2">
<h4><span class="header-section-number">4.1.1.2</span> mutate/across<a href="Model-building.html#mutateacross" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="Model-building.html#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="do">## mutate和 across 常用案例说明：添加新列</span></span>
<span id="cb60-2"><a href="Model-building.html#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 指定条件后添加函数：</span></span>
<span id="cb60-3"><a href="Model-building.html#cb60-3" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">mutate_if</span>(is.numeric, mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb60-4"><a href="Model-building.html#cb60-4" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb60-5"><a href="Model-building.html#cb60-5" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">mutate_at</span>(<span class="fu">vars</span>(x, <span class="fu">starts_with</span>(<span class="st">&quot;y&quot;</span>)), mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb60-6"><a href="Model-building.html#cb60-6" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(x, <span class="fu">starts_with</span>(<span class="st">&quot;y&quot;</span>)), mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb60-7"><a href="Model-building.html#cb60-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-8"><a href="Model-building.html#cb60-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 利用.col和.fus 来构造函数批处理体：   </span></span>
<span id="cb60-9"><a href="Model-building.html#cb60-9" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb60-10"><a href="Model-building.html#cb60-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">c</span>(temp, ht_cm, wt_kg), <span class="at">.fns =</span> as.character))</span>
<span id="cb60-11"><a href="Model-building.html#cb60-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-12"><a href="Model-building.html#cb60-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-13"><a href="Model-building.html#cb60-13" aria-hidden="true" tabindex="-1"></a><span class="do">## 指定所有条案后批函数处理：</span></span>
<span id="cb60-14"><a href="Model-building.html#cb60-14" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">mutate_all</span>(mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb60-15"><a href="Model-building.html#cb60-15" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
</div>
</div>
<div id="高级分组统计" class="section level3 hasAnchor" number="4.1.2">
<h3><span class="header-section-number">4.1.2</span> 高级分组统计<a href="Model-building.html#高级分组统计" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="数据分组统计" class="section level4 hasAnchor" number="4.1.2.1">
<h4><span class="header-section-number">4.1.2.1</span> 数据分组统计：<a href="Model-building.html#数据分组统计" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div id="基础分组统计" class="section level5 hasAnchor" number="4.1.2.1.1">
<h5><span class="header-section-number">4.1.2.1.1</span> 基础分组统计<a href="Model-building.html#基础分组统计" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="Model-building.html#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 基于base R的数据分组统计：</span></span>
<span id="cb61-2"><a href="Model-building.html#cb61-2" aria-hidden="true" tabindex="-1"></a>data_split <span class="ot">=</span> <span class="fu">split</span>(iris[,<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>],iris<span class="sc">$</span>Species)</span>
<span id="cb61-3"><a href="Model-building.html#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="do">## 基于 base with by的分组统计：</span></span>
<span id="cb61-4"><a href="Model-building.html#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(UScrime,<span class="fu">by</span>(Prob,So,median)) </span>
<span id="cb61-5"><a href="Model-building.html#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="do">## 基于tapply()</span></span>
<span id="cb61-6"><a href="Model-building.html#cb61-6" aria-hidden="true" tabindex="-1"></a>(f <span class="ot">&lt;-</span> <span class="fu">gl</span>(<span class="dv">2</span>,<span class="dv">5</span>, <span class="at">labels=</span><span class="fu">c</span>(<span class="st">&quot;CK&quot;</span>, <span class="st">&quot;T&quot;</span>)))</span>
<span id="cb61-7"><a href="Model-building.html#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">tapply</span>(x, f, sum)</span>
<span id="cb61-8"><a href="Model-building.html#cb61-8" aria-hidden="true" tabindex="-1"></a>CK  T </span>
<span id="cb61-9"><a href="Model-building.html#cb61-9" aria-hidden="true" tabindex="-1"></a><span class="dv">15</span> <span class="dv">40</span> </span>
<span id="cb61-10"><a href="Model-building.html#cb61-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-11"><a href="Model-building.html#cb61-11" aria-hidden="true" tabindex="-1"></a><span class="do">## 将数据框分组按列表转化：</span></span>
<span id="cb61-12"><a href="Model-building.html#cb61-12" aria-hidden="true" tabindex="-1"></a>ir <span class="ot">&lt;-</span> iris <span class="sc">%&gt;%</span></span>
<span id="cb61-13"><a href="Model-building.html#cb61-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(Species)   <span class="do">## 将数据按分类数据分组</span></span>
<span id="cb61-14"><a href="Model-building.html#cb61-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_split</span>(ir)  <span class="do">## 将分组数据转为各类列表</span></span>
<span id="cb61-15"><a href="Model-building.html#cb61-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-16"><a href="Model-building.html#cb61-16" aria-hidden="true" tabindex="-1"></a><span class="do">## 基于函数来使用tidy的快速分组处理数据：</span></span>
<span id="cb61-17"><a href="Model-building.html#cb61-17" aria-hidden="true" tabindex="-1"></a>hh <span class="sc">%&gt;%</span> <span class="fu">subset</span>(.,aa<span class="sc">==</span><span class="st">&#39;种子&#39;</span> ) <span class="sc">%&gt;%</span>   </span>
<span id="cb61-18"><a href="Model-building.html#cb61-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cc,dd)  <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">mfv =</span> <span class="fu">mean</span>(hh)) <span class="sc">%&gt;%</span> <span class="fu">data.frame</span>()  <span class="ot">-&gt;</span>zz</span>
<span id="cb61-19"><a href="Model-building.html#cb61-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-20"><a href="Model-building.html#cb61-20" aria-hidden="true" tabindex="-1"></a><span class="do">## MAP映射运算</span></span>
<span id="cb61-21"><a href="Model-building.html#cb61-21" aria-hidden="true" tabindex="-1"></a>mtcars <span class="sc">%&gt;%</span>  <span class="fu">split</span>(.<span class="sc">$</span>cyl) <span class="sc">%&gt;%</span>  <span class="do">## 这一步是构建分组函数来讲所有数据分组后构建数据框；</span></span>
<span id="cb61-22"><a href="Model-building.html#cb61-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="sc">~</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> wt,<span class="at">data=</span> .x)) <span class="co"># 构建函数体；</span></span>
<span id="cb61-23"><a href="Model-building.html#cb61-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-24"><a href="Model-building.html#cb61-24" aria-hidden="true" tabindex="-1"></a><span class="do">### 分组数据使用tally()计数;</span></span>
<span id="cb61-25"><a href="Model-building.html#cb61-25" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(<span class="at">math_level =</span><span class="fu">cut</span>(math,<span class="at">breaks =</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">60</span>,<span class="dv">75</span>,<span class="dv">80</span>,<span class="dv">100</span>),</span>
<span id="cb61-26"><a href="Model-building.html#cb61-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">right =</span><span class="cn">FALSE</span>)) <span class="sc">%&gt;%</span> <span class="fu">tally</span>()</span></code></pre></div>
</div>
<div id="stby分组进阶统计" class="section level5 hasAnchor" number="4.1.2.1.2">
<h5><span class="header-section-number">4.1.2.1.2</span> stby/分组进阶统计<a href="Model-building.html#stby分组进阶统计" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="Model-building.html#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(summarytools)</span>
<span id="cb62-2"><a href="Model-building.html#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="do">##参见：https://cran.r-project.org/web/packages/summarytools/vignettes/introduction.html#header</span></span>
<span id="cb62-3"><a href="Model-building.html#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="do">## 分组统计：</span></span>
<span id="cb62-4"><a href="Model-building.html#cb62-4" aria-hidden="true" tabindex="-1"></a>(iris_stats_by_species <span class="ot">&lt;-</span> <span class="fu">stby</span>(<span class="at">data      =</span> iris, </span>
<span id="cb62-5"><a href="Model-building.html#cb62-5" aria-hidden="true" tabindex="-1"></a>                               <span class="at">INDICES   =</span> iris<span class="sc">$</span>Species, </span>
<span id="cb62-6"><a href="Model-building.html#cb62-6" aria-hidden="true" tabindex="-1"></a>                               <span class="at">FUN       =</span> descr, </span>
<span id="cb62-7"><a href="Model-building.html#cb62-7" aria-hidden="true" tabindex="-1"></a>                               <span class="at">stats     =</span> <span class="st">&quot;common&quot;</span>, </span>
<span id="cb62-8"><a href="Model-building.html#cb62-8" aria-hidden="true" tabindex="-1"></a>                               <span class="at">transpose =</span> <span class="cn">TRUE</span>))</span>
<span id="cb62-9"><a href="Model-building.html#cb62-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 添加with的分组统计：</span></span>
<span id="cb62-10"><a href="Model-building.html#cb62-10" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(tobacco, </span>
<span id="cb62-11"><a href="Model-building.html#cb62-11" aria-hidden="true" tabindex="-1"></a>     <span class="fu">stby</span>(<span class="at">data    =</span> BMI, </span>
<span id="cb62-12"><a href="Model-building.html#cb62-12" aria-hidden="true" tabindex="-1"></a>          <span class="at">INDICES =</span> age.gr, </span>
<span id="cb62-13"><a href="Model-building.html#cb62-13" aria-hidden="true" tabindex="-1"></a>          <span class="at">FUN     =</span> descr,</span>
<span id="cb62-14"><a href="Model-building.html#cb62-14" aria-hidden="true" tabindex="-1"></a>          <span class="at">stats   =</span> <span class="fu">c</span>(<span class="st">&quot;mean&quot;</span>, <span class="st">&quot;sd&quot;</span>, <span class="st">&quot;min&quot;</span>, <span class="st">&quot;med&quot;</span>, <span class="st">&quot;max&quot;</span>))</span>
<span id="cb62-15"><a href="Model-building.html#cb62-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb62-16"><a href="Model-building.html#cb62-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-17"><a href="Model-building.html#cb62-17" aria-hidden="true" tabindex="-1"></a><span class="do">## 使用group_by()的分组统计：</span></span>
<span id="cb62-18"><a href="Model-building.html#cb62-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb62-19"><a href="Model-building.html#cb62-19" aria-hidden="true" tabindex="-1"></a>tobacco<span class="sc">$</span>gender <span class="sc">%&lt;&gt;%</span> forcats<span class="sc">::</span><span class="fu">fct_explicit_na</span>()</span>
<span id="cb62-20"><a href="Model-building.html#cb62-20" aria-hidden="true" tabindex="-1"></a>tobacco <span class="sc">%&gt;%</span> </span>
<span id="cb62-21"><a href="Model-building.html#cb62-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(gender) <span class="sc">%&gt;%</span> </span>
<span id="cb62-22"><a href="Model-building.html#cb62-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">descr</span>(<span class="at">stats =</span> <span class="st">&quot;fivenum&quot;</span>)</span></code></pre></div>
</div>
</div>
<div id="构造函数处理流" class="section level4 hasAnchor" number="4.1.2.2">
<h4><span class="header-section-number">4.1.2.2</span> 构造函数处理流<a href="Model-building.html#构造函数处理流" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="Model-building.html#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="do">################# 构建函数处理流： ####################</span></span>
<span id="cb63-2"><a href="Model-building.html#cb63-2" aria-hidden="true" tabindex="-1"></a>count_data <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb63-3"><a href="Model-building.html#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(hospital, date_hospitalisation) <span class="sc">%&gt;%</span> </span>
<span id="cb63-4"><a href="Model-building.html#cb63-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n_cases =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb63-5"><a href="Model-building.html#cb63-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(date_hospitalisation <span class="sc">&gt;</span> <span class="fu">as.Date</span>(<span class="st">&quot;2013-06-01&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb63-6"><a href="Model-building.html#cb63-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb63-7"><a href="Model-building.html#cb63-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-8"><a href="Model-building.html#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="do">## summarise()的复杂用法：</span></span>
<span id="cb63-9"><a href="Model-building.html#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="co"># &quot;Roll-up&quot; values into one row per group (per &quot;personID&quot;) </span></span>
<span id="cb63-10"><a href="Model-building.html#cb63-10" aria-hidden="true" tabindex="-1"></a>cases_rolled <span class="ot">&lt;-</span> obs <span class="sc">%&gt;%</span> </span>
<span id="cb63-11"><a href="Model-building.html#cb63-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(personID) <span class="sc">%&gt;%</span> </span>
<span id="cb63-12"><a href="Model-building.html#cb63-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date, <span class="at">.by_group =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span>  <span class="do">## 这里是排序的意思</span></span>
<span id="cb63-13"><a href="Model-building.html#cb63-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(  </span>
<span id="cb63-14"><a href="Model-building.html#cb63-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">everything</span>(),   <span class="do">## 记住across()来指定对应的函数类型；           </span></span>
<span id="cb63-15"><a href="Model-building.html#cb63-15" aria-hidden="true" tabindex="-1"></a>           <span class="sc">~</span><span class="fu">paste0</span>(<span class="fu">na.omit</span>(.x), <span class="at">collapse =</span> <span class="st">&quot;; &quot;</span>))) <span class="co"># function is defined which combines non-NA values</span></span></code></pre></div>
</div>
</div>
<div id="常用统计函数" class="section level3 hasAnchor" number="4.1.3">
<h3><span class="header-section-number">4.1.3</span> 常用统计函数<a href="Model-building.html#常用统计函数" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="常用描述性统计函数" class="section level4 hasAnchor" number="4.1.3.1">
<h4><span class="header-section-number">4.1.3.1</span> 常用描述性统计函数：<a href="Model-building.html#常用描述性统计函数" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="Model-building.html#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 计算标准差函数：</span></span>
<span id="cb64-2"><a href="Model-building.html#cb64-2" aria-hidden="true" tabindex="-1"></a>std <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">sd</span>(x)<span class="sc">/</span><span class="fu">sqrt</span>(<span class="fu">length</span>(x))</span>
<span id="cb64-3"><a href="Model-building.html#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-4"><a href="Model-building.html#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="do">## 数学运算：</span></span>
<span id="cb64-5"><a href="Model-building.html#cb64-5" aria-hidden="true" tabindex="-1"></a>cumsum 累加和</span>
<span id="cb64-6"><a href="Model-building.html#cb64-6" aria-hidden="true" tabindex="-1"></a>cumprod 累加积</span>
<span id="cb64-7"><a href="Model-building.html#cb64-7" aria-hidden="true" tabindex="-1"></a>cummin 累加最小值</span>
<span id="cb64-8"><a href="Model-building.html#cb64-8" aria-hidden="true" tabindex="-1"></a>cummax 累加最大值</span>
<span id="cb64-9"><a href="Model-building.html#cb64-9" aria-hidden="true" tabindex="-1"></a>cummean 累加均值</span>
<span id="cb64-10"><a href="Model-building.html#cb64-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-11"><a href="Model-building.html#cb64-11" aria-hidden="true" tabindex="-1"></a><span class="co"># use the appropriate rounding function for your work</span></span>
<span id="cb64-12"><a href="Model-building.html#cb64-12" aria-hidden="true" tabindex="-1"></a>危险： <span class="fu">round</span>()使用“银行家四舍五入法”，仅当上限为偶数时才从 <span class="fl">0.5</span> 向上舍入。使用<span class="fu">round_half_up</span>()from janitor始终将一半四舍五入到最接近的整数。看到这个解释</span>
<span id="cb64-13"><a href="Model-building.html#cb64-13" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">c</span>(<span class="fl">2.5</span>, <span class="fl">3.5</span>))</span>
<span id="cb64-14"><a href="Model-building.html#cb64-14" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 2 4</span></span>
<span id="cb64-15"><a href="Model-building.html#cb64-15" aria-hidden="true" tabindex="-1"></a>janitor<span class="sc">::</span><span class="fu">round_half_up</span>(<span class="fu">c</span>(<span class="fl">2.5</span>, <span class="fl">3.5</span>))</span>
<span id="cb64-16"><a href="Model-building.html#cb64-16" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 3 4</span></span></code></pre></div>
</div>
<div id="中级统计函数" class="section level4 hasAnchor" number="4.1.3.2">
<h4><span class="header-section-number">4.1.3.2</span> 中级统计函数<a href="Model-building.html#中级统计函数" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div id="base-r中的统计函数" class="section level5 hasAnchor" number="4.1.3.2.1">
<h5><span class="header-section-number">4.1.3.2.1</span> base R中的统计函数：<a href="Model-building.html#base-r中的统计函数" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="Model-building.html#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="do">## t统计：</span></span>
<span id="cb65-2"><a href="Model-building.html#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="fu">t.test</span>(age_years <span class="sc">~</span> gender, <span class="at">data =</span> linelist)</span>
<span id="cb65-3"><a href="Model-building.html#cb65-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-4"><a href="Model-building.html#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="do">## 夏皮罗-威尔克测试-检验数据是否来自正态分布总体：</span></span>
<span id="cb65-5"><a href="Model-building.html#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="fu">shapiro.test</span>(linelist<span class="sc">$</span>age_years)</span>
<span id="cb65-6"><a href="Model-building.html#cb65-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-7"><a href="Model-building.html#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 秩和检验-wilcoxon:</span></span>
<span id="cb65-8"><a href="Model-building.html#cb65-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 确定两个数值样本是否来自同一分布，当它们的总体不是正态分布或方差不等时。 %&gt;% </span></span>
<span id="cb65-9"><a href="Model-building.html#cb65-9" aria-hidden="true" tabindex="-1"></a><span class="fu">wilcox.test</span>(age_years <span class="sc">~</span> outcome, <span class="at">data =</span> linelist)</span>
<span id="cb65-10"><a href="Model-building.html#cb65-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-11"><a href="Model-building.html#cb65-11" aria-hidden="true" tabindex="-1"></a><span class="do">## Kruskal-Wallis 检验</span></span>
<span id="cb65-12"><a href="Model-building.html#cb65-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 是 Wilcoxon 秩和检验的扩展，可用于检验两个以上样本分布的差异</span></span>
<span id="cb65-13"><a href="Model-building.html#cb65-13" aria-hidden="true" tabindex="-1"></a><span class="fu">kruskal.test</span>(age_years <span class="sc">~</span> outcome, linelist)</span>
<span id="cb65-14"><a href="Model-building.html#cb65-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-15"><a href="Model-building.html#cb65-15" aria-hidden="true" tabindex="-1"></a><span class="do">##卡方检验-用于检验分类变量的统计显著性：</span></span>
<span id="cb65-16"><a href="Model-building.html#cb65-16" aria-hidden="true" tabindex="-1"></a><span class="do">## 注意卡方检验在tidy系列中分析时，必须首先构建交叉表：</span></span>
<span id="cb65-17"><a href="Model-building.html#cb65-17" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb65-18"><a href="Model-building.html#cb65-18" aria-hidden="true" tabindex="-1"></a>linelist <span class="sc">%&gt;%</span> </span>
<span id="cb65-19"><a href="Model-building.html#cb65-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tabyl</span>(gender,outcome) <span class="sc">%&gt;%</span>  <span class="do">## tabyl()用于生成交叉表；</span></span>
<span id="cb65-20"><a href="Model-building.html#cb65-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb65-21"><a href="Model-building.html#cb65-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">chisq_test</span>()</span>
<span id="cb65-22"><a href="Model-building.html#cb65-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-23"><a href="Model-building.html#cb65-23" aria-hidden="true" tabindex="-1"></a><span class="fu">chisq.test</span>(linelist<span class="sc">$</span>gender, linelist<span class="sc">$</span>outcome)</span></code></pre></div>
</div>
<div id="tidy流中的统计函数流" class="section level5 hasAnchor" number="4.1.3.2.2">
<h5><span class="header-section-number">4.1.3.2.2</span> tidy流中的统计函数流<a href="Model-building.html#tidy流中的统计函数流" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div id="描述性回归tbl_summary" class="section level6 hasAnchor" number="4.1.3.2.2.1">
<h6><span class="header-section-number">4.1.3.2.2.1</span> 描述性回归/tbl_summary<a href="Model-building.html#描述性回归tbl_summary" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="Model-building.html#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 使用gtsummary()来优化统计结果输出：</span></span>
<span id="cb66-2"><a href="Model-building.html#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 卡方：</span></span>
<span id="cb66-3"><a href="Model-building.html#cb66-3" aria-hidden="true" tabindex="-1"></a>linelist <span class="sc">%&gt;%</span> </span>
<span id="cb66-4"><a href="Model-building.html#cb66-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(gender, outcome) <span class="sc">%&gt;%</span>    <span class="co"># keep variables of interest</span></span>
<span id="cb66-5"><a href="Model-building.html#cb66-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_summary</span>(<span class="at">by =</span> outcome) <span class="sc">%&gt;%</span>  <span class="co"># produce summary table and specify grouping variable</span></span>
<span id="cb66-6"><a href="Model-building.html#cb66-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_p</span>()                        <span class="co"># 默认为卡方检验；</span></span>
<span id="cb66-7"><a href="Model-building.html#cb66-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-8"><a href="Model-building.html#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="do">## t检验：</span></span>
<span id="cb66-9"><a href="Model-building.html#cb66-9" aria-hidden="true" tabindex="-1"></a>linelist <span class="sc">%&gt;%</span> </span>
<span id="cb66-10"><a href="Model-building.html#cb66-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(age_years, outcome) <span class="sc">%&gt;%</span>           </span>
<span id="cb66-11"><a href="Model-building.html#cb66-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_summary</span>(                               </span>
<span id="cb66-12"><a href="Model-building.html#cb66-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">statistic =</span> age_years <span class="sc">~</span> <span class="st">&quot;{mean} ({sd})&quot;</span>, </span>
<span id="cb66-13"><a href="Model-building.html#cb66-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> outcome) <span class="sc">%&gt;%</span>                       </span>
<span id="cb66-14"><a href="Model-building.html#cb66-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_p</span>(age_years <span class="sc">~</span> <span class="st">&quot;t.test&quot;</span>) </span>
<span id="cb66-15"><a href="Model-building.html#cb66-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-16"><a href="Model-building.html#cb66-16" aria-hidden="true" tabindex="-1"></a>  <span class="do">## wilcoxon秩和检验；</span></span>
<span id="cb66-17"><a href="Model-building.html#cb66-17" aria-hidden="true" tabindex="-1"></a>linelist <span class="sc">%&gt;%</span> </span>
<span id="cb66-18"><a href="Model-building.html#cb66-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(age_years, outcome) <span class="sc">%&gt;%</span>                      </span>
<span id="cb66-19"><a href="Model-building.html#cb66-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_summary</span>(                                         </span>
<span id="cb66-20"><a href="Model-building.html#cb66-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">statistic =</span> age_years <span class="sc">~</span> <span class="st">&quot;{median} ({p25}, {p75})&quot;</span>, </span>
<span id="cb66-21"><a href="Model-building.html#cb66-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> outcome) <span class="sc">%&gt;%</span>                                </span>
<span id="cb66-22"><a href="Model-building.html#cb66-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_p</span>(age_years <span class="sc">~</span> <span class="st">&quot;wilcox.test&quot;</span>)      </span>
<span id="cb66-23"><a href="Model-building.html#cb66-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-24"><a href="Model-building.html#cb66-24" aria-hidden="true" tabindex="-1"></a><span class="do">## 复杂形式：</span></span>
<span id="cb66-25"><a href="Model-building.html#cb66-25" aria-hidden="true" tabindex="-1"></a>linelist <span class="sc">%&gt;%</span> </span>
<span id="cb66-26"><a href="Model-building.html#cb66-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(age_years, gender, outcome, fever, temp, hospital) <span class="sc">%&gt;%</span> <span class="co"># keep only columns of interest</span></span>
<span id="cb66-27"><a href="Model-building.html#cb66-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_summary</span>(     </span>
<span id="cb66-28"><a href="Model-building.html#cb66-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> outcome,    <span class="do">## 按组进行划分；   </span></span>
<span id="cb66-29"><a href="Model-building.html#cb66-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">statistic =</span> <span class="fu">list</span>(<span class="fu">all_continuous</span>() <span class="sc">~</span> <span class="st">&quot;{mean} ({sd})&quot;</span>, <span class="st">&quot;       </span></span>
<span id="cb66-30"><a href="Model-building.html#cb66-30" aria-hidden="true" tabindex="-1"></a><span class="st">                     all_categorical() ~ &quot;</span>{n} <span class="sc">/</span> {N} ({p}%)<span class="st">&quot;),   </span></span>
<span id="cb66-31"><a href="Model-building.html#cb66-31" aria-hidden="true" tabindex="-1"></a><span class="st">    digits = all_continuous() ~ 1,   ## 四舍五入                          # rounding for continuous columns</span></span>
<span id="cb66-32"><a href="Model-building.html#cb66-32" aria-hidden="true" tabindex="-1"></a><span class="st">    type   = all_categorical() ~ &quot;</span>categorical<span class="st">&quot;,  ## 两种指定类型；       </span></span>
<span id="cb66-33"><a href="Model-building.html#cb66-33" aria-hidden="true" tabindex="-1"></a><span class="st">    label  = list(                                              # display labels for column names</span></span>
<span id="cb66-34"><a href="Model-building.html#cb66-34" aria-hidden="true" tabindex="-1"></a><span class="st">      outcome   ~ &quot;</span>Outcome<span class="st">&quot;,                           </span></span>
<span id="cb66-35"><a href="Model-building.html#cb66-35" aria-hidden="true" tabindex="-1"></a><span class="st">      age_years ~ &quot;</span><span class="fu">Age</span> (years)<span class="st">&quot;,</span></span>
<span id="cb66-36"><a href="Model-building.html#cb66-36" aria-hidden="true" tabindex="-1"></a><span class="st">      gender    ~ &quot;</span>Gender<span class="st">&quot;,</span></span>
<span id="cb66-37"><a href="Model-building.html#cb66-37" aria-hidden="true" tabindex="-1"></a><span class="st">      temp      ~ &quot;</span>Temperature<span class="st">&quot;,</span></span>
<span id="cb66-38"><a href="Model-building.html#cb66-38" aria-hidden="true" tabindex="-1"></a><span class="st">      hospital  ~ &quot;</span>Hospital<span class="st">&quot;),</span></span>
<span id="cb66-39"><a href="Model-building.html#cb66-39" aria-hidden="true" tabindex="-1"></a><span class="st">    missing_text = &quot;</span>Missing<span class="st">&quot;                                   </span></span>
<span id="cb66-40"><a href="Model-building.html#cb66-40" aria-hidden="true" tabindex="-1"></a><span class="st">  )</span></span>
<span id="cb66-41"><a href="Model-building.html#cb66-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-42"><a href="Model-building.html#cb66-42" aria-hidden="true" tabindex="-1"></a><span class="st">## 补充：</span></span>
<span id="cb66-43"><a href="Model-building.html#cb66-43" aria-hidden="true" tabindex="-1"></a><span class="st">1、type还有更详细的写法：</span></span>
<span id="cb66-44"><a href="Model-building.html#cb66-44" aria-hidden="true" tabindex="-1"></a><span class="st">  type = all_continuous() ~ &#39;continuous2&#39;,</span></span>
<span id="cb66-45"><a href="Model-building.html#cb66-45" aria-hidden="true" tabindex="-1"></a><span class="st">              statistic = all_continuous()~c(</span></span>
<span id="cb66-46"><a href="Model-building.html#cb66-46" aria-hidden="true" tabindex="-1"></a><span class="st">                &quot;</span>{mean} ({sd})<span class="st">&quot;,</span></span>
<span id="cb66-47"><a href="Model-building.html#cb66-47" aria-hidden="true" tabindex="-1"></a><span class="st">                &quot;</span>{median} ({p25}, {p75})<span class="st">&quot;),</span></span></code></pre></div>
</div>
<div id="参数回归tbl_uvregression" class="section level6 hasAnchor" number="4.1.3.2.2.2">
<h6><span class="header-section-number">4.1.3.2.2.2</span> 参数回归/tbl_uvregression()<a href="Model-building.html#参数回归tbl_uvregression" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="Model-building.html#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 使用gtsummary中的tbl_uvregression()来进行参数回归：</span></span>
<span id="cb67-2"><a href="Model-building.html#cb67-2" aria-hidden="true" tabindex="-1"></a>univ_tab <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb67-3"><a href="Model-building.html#cb67-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(explanatory_vars, outcome) <span class="sc">%&gt;%</span> </span>
<span id="cb67-4"><a href="Model-building.html#cb67-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_uvregression</span>(                         </span>
<span id="cb67-5"><a href="Model-building.html#cb67-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> glm,                           </span>
<span id="cb67-6"><a href="Model-building.html#cb67-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> outcome,                           </span>
<span id="cb67-7"><a href="Model-building.html#cb67-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">method.args =</span> <span class="fu">list</span>(<span class="at">family =</span> binomial),  </span>
<span id="cb67-8"><a href="Model-building.html#cb67-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">exponentiate =</span> <span class="cn">TRUE</span>                    </span>
<span id="cb67-9"><a href="Model-building.html#cb67-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb67-10"><a href="Model-building.html#cb67-10" aria-hidden="true" tabindex="-1"></a><span class="do">## view univariate results table </span></span>
<span id="cb67-11"><a href="Model-building.html#cb67-11" aria-hidden="true" tabindex="-1"></a>univ_tab</span>
<span id="cb67-12"><a href="Model-building.html#cb67-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-13"><a href="Model-building.html#cb67-13" aria-hidden="true" tabindex="-1"></a><span class="do">## run a regression with all variables of interest </span></span>
<span id="cb67-14"><a href="Model-building.html#cb67-14" aria-hidden="true" tabindex="-1"></a>mv_reg <span class="ot">&lt;-</span> explanatory_vars <span class="sc">%&gt;%</span>  <span class="do">## begin with vector of explanatory column names</span></span>
<span id="cb67-15"><a href="Model-building.html#cb67-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_c</span>(<span class="at">collapse =</span> <span class="st">&quot;+&quot;</span>) <span class="sc">%&gt;%</span>     <span class="do">## combine all names of the variables of interest separated by a plus</span></span>
<span id="cb67-16"><a href="Model-building.html#cb67-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_c</span>(<span class="st">&quot;outcome ~ &quot;</span>, .) <span class="sc">%&gt;%</span>    <span class="do">## combine the names of variables of interest with outcome in formula style</span></span>
<span id="cb67-17"><a href="Model-building.html#cb67-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glm</span>(<span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>,      <span class="do">## define type of glm as logistic,</span></span>
<span id="cb67-18"><a href="Model-building.html#cb67-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> linelist)          <span class="do">## define your dataset</span></span>
<span id="cb67-19"><a href="Model-building.html#cb67-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-20"><a href="Model-building.html#cb67-20" aria-hidden="true" tabindex="-1"></a>final_mv_reg <span class="ot">&lt;-</span> mv_reg <span class="sc">%&gt;%</span></span>
<span id="cb67-21"><a href="Model-building.html#cb67-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step</span>(<span class="at">direction =</span> <span class="st">&quot;forward&quot;</span>, <span class="at">trace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb67-22"><a href="Model-building.html#cb67-22" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">scipen=</span><span class="dv">999</span>)  <span class="do">## 关闭科学计数法</span></span>
<span id="cb67-23"><a href="Model-building.html#cb67-23" aria-hidden="true" tabindex="-1"></a><span class="do">## show results table of final regression </span></span>
<span id="cb67-24"><a href="Model-building.html#cb67-24" aria-hidden="true" tabindex="-1"></a>mv_tab <span class="ot">&lt;-</span> <span class="fu">tbl_regression</span>(final_mv_reg, <span class="at">exponentiate =</span> <span class="cn">TRUE</span>)</span>
<span id="cb67-25"><a href="Model-building.html#cb67-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-26"><a href="Model-building.html#cb67-26" aria-hidden="true" tabindex="-1"></a><span class="do">## 合并建模结果：  </span></span>
<span id="cb67-27"><a href="Model-building.html#cb67-27" aria-hidden="true" tabindex="-1"></a><span class="fu">tbl_merge</span>(</span>
<span id="cb67-28"><a href="Model-building.html#cb67-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">tbls =</span> <span class="fu">list</span>(univ_tab, mv_tab),                          <span class="co"># combine</span></span>
<span id="cb67-29"><a href="Model-building.html#cb67-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">tab_spanner =</span> <span class="fu">c</span>(<span class="st">&quot;**Univariate**&quot;</span>, <span class="st">&quot;**Multivariable**&quot;</span>)) <span class="co"># set header names</span></span>
<span id="cb67-30"><a href="Model-building.html#cb67-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-31"><a href="Model-building.html#cb67-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-32"><a href="Model-building.html#cb67-32" aria-hidden="true" tabindex="-1"></a><span class="do">## 模型比较：</span></span>
<span id="cb67-33"><a href="Model-building.html#cb67-33" aria-hidden="true" tabindex="-1"></a>model1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(outcome <span class="sc">~</span> age_cat, <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> linelist)</span>
<span id="cb67-34"><a href="Model-building.html#cb67-34" aria-hidden="true" tabindex="-1"></a>model2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(outcome <span class="sc">~</span> age_cat <span class="sc">+</span> gender, <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> linelist)</span>
<span id="cb67-35"><a href="Model-building.html#cb67-35" aria-hidden="true" tabindex="-1"></a>lmtest<span class="sc">::</span><span class="fu">lrtest</span>(model1, model2)</span></code></pre></div>
</div>
</div>
</div>
</div>
<div id="批处理函数" class="section level3 hasAnchor" number="4.1.4">
<h3><span class="header-section-number">4.1.4</span> 批处理函数<a href="Model-building.html#批处理函数" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="apply函数族" class="section level4 hasAnchor" number="4.1.4.1">
<h4><span class="header-section-number">4.1.4.1</span> apply函数族<a href="Model-building.html#apply函数族" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="Model-building.html#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="do">## APPLY:</span></span>
<span id="cb68-2"><a href="Model-building.html#cb68-2" aria-hidden="true" tabindex="-1"></a>这个函数的使用格式为：<span class="fu">apply</span>(X, MARGIN, FUN, ...)。它应用的数据类型是数组或矩阵，返回值类型由FUN函数结果的长度确定。</span>
<span id="cb68-3"><a href="Model-building.html#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 举例：</span></span>
<span id="cb68-4"><a href="Model-building.html#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(a, <span class="at">MARGIN=</span><span class="dv">1</span>, <span class="at">FUN=</span>quantile, <span class="at">probs=</span><span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>, <span class="fl">0.25</span>))</span>
<span id="cb68-5"><a href="Model-building.html#cb68-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-6"><a href="Model-building.html#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="do">## lapply、sapply和vapply函数：</span></span>
<span id="cb68-7"><a href="Model-building.html#cb68-7" aria-hidden="true" tabindex="-1"></a>它们应用的数据类型都是列表，对每一个列表元素应用FUN函数</span>
<span id="cb68-8"><a href="Model-building.html#cb68-8" aria-hidden="true" tabindex="-1"></a><span class="co"># lappy是最基本的原型函数，sapply和vapply都是lapply的改进版。</span></span>
<span id="cb68-9"><a href="Model-building.html#cb68-9" aria-hidden="true" tabindex="-1"></a>sapply返回的结果比较“友好”，如果结果很整齐，就会得到向量或矩阵或数组</span>
<span id="cb68-10"><a href="Model-building.html#cb68-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-11"><a href="Model-building.html#cb68-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-12"><a href="Model-building.html#cb68-12" aria-hidden="true" tabindex="-1"></a><span class="do">## mapply:相当于sapply的多变量版本；</span></span>
<span id="cb68-13"><a href="Model-building.html#cb68-13" aria-hidden="true" tabindex="-1"></a>mapply应用的数据类型为向量或列表，FUN函数对每个数据元素应用FUN函数；如果参数长度为1，得到的结果和sapply是一样的；但如果参数长度不是1，FUN函数将按向量顺序和循环规则（短向量重复）逐个取参数应用到对应数据元素：</span>
<span id="cb68-14"><a href="Model-building.html#cb68-14" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">sapply</span>(<span class="at">X=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">FUN=</span>rep, <span class="at">times=</span><span class="dv">4</span>)</span>
<span id="cb68-15"><a href="Model-building.html#cb68-15" aria-hidden="true" tabindex="-1"></a>     [,<span class="dv">1</span>] [,<span class="dv">2</span>] [,<span class="dv">3</span>] [,<span class="dv">4</span>]</span>
<span id="cb68-16"><a href="Model-building.html#cb68-16" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>,]    <span class="dv">1</span>    <span class="dv">2</span>    <span class="dv">3</span>    <span class="dv">4</span></span>
<span id="cb68-17"><a href="Model-building.html#cb68-17" aria-hidden="true" tabindex="-1"></a>[<span class="dv">2</span>,]    <span class="dv">1</span>    <span class="dv">2</span>    <span class="dv">3</span>    <span class="dv">4</span></span>
<span id="cb68-18"><a href="Model-building.html#cb68-18" aria-hidden="true" tabindex="-1"></a>[<span class="dv">3</span>,]    <span class="dv">1</span>    <span class="dv">2</span>    <span class="dv">3</span>    <span class="dv">4</span></span>
<span id="cb68-19"><a href="Model-building.html#cb68-19" aria-hidden="true" tabindex="-1"></a>[<span class="dv">4</span>,]    <span class="dv">1</span>    <span class="dv">2</span>    <span class="dv">3</span>    <span class="dv">4</span></span>
<span id="cb68-20"><a href="Model-building.html#cb68-20" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">mapply</span>(rep, <span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">times=</span><span class="dv">4</span>)</span>
<span id="cb68-21"><a href="Model-building.html#cb68-21" aria-hidden="true" tabindex="-1"></a>     [,<span class="dv">1</span>] [,<span class="dv">2</span>] [,<span class="dv">3</span>] [,<span class="dv">4</span>]</span>
<span id="cb68-22"><a href="Model-building.html#cb68-22" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>,]    <span class="dv">1</span>    <span class="dv">2</span>    <span class="dv">3</span>    <span class="dv">4</span></span>
<span id="cb68-23"><a href="Model-building.html#cb68-23" aria-hidden="true" tabindex="-1"></a>[<span class="dv">2</span>,]    <span class="dv">1</span>    <span class="dv">2</span>    <span class="dv">3</span>    <span class="dv">4</span></span>
<span id="cb68-24"><a href="Model-building.html#cb68-24" aria-hidden="true" tabindex="-1"></a>[<span class="dv">3</span>,]    <span class="dv">1</span>    <span class="dv">2</span>    <span class="dv">3</span>    <span class="dv">4</span></span>
<span id="cb68-25"><a href="Model-building.html#cb68-25" aria-hidden="true" tabindex="-1"></a>[<span class="dv">4</span>,]    <span class="dv">1</span>    <span class="dv">2</span>    <span class="dv">3</span>    <span class="dv">4</span></span>
<span id="cb68-26"><a href="Model-building.html#cb68-26" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">mapply</span>(rep, <span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">times=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)</span>
<span id="cb68-27"><a href="Model-building.html#cb68-27" aria-hidden="true" tabindex="-1"></a>[[<span class="dv">1</span>]]</span>
<span id="cb68-28"><a href="Model-building.html#cb68-28" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">1</span></span>
<span id="cb68-29"><a href="Model-building.html#cb68-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-30"><a href="Model-building.html#cb68-30" aria-hidden="true" tabindex="-1"></a>[[<span class="dv">2</span>]]</span>
<span id="cb68-31"><a href="Model-building.html#cb68-31" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">2</span> <span class="dv">2</span></span>
<span id="cb68-32"><a href="Model-building.html#cb68-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-33"><a href="Model-building.html#cb68-33" aria-hidden="true" tabindex="-1"></a>[[<span class="dv">3</span>]]</span>
<span id="cb68-34"><a href="Model-building.html#cb68-34" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">3</span> <span class="dv">3</span> <span class="dv">3</span></span>
<span id="cb68-35"><a href="Model-building.html#cb68-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-36"><a href="Model-building.html#cb68-36" aria-hidden="true" tabindex="-1"></a>[[<span class="dv">4</span>]]</span>
<span id="cb68-37"><a href="Model-building.html#cb68-37" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">4</span> <span class="dv">4</span> <span class="dv">4</span> <span class="dv">4</span></span>
<span id="cb68-38"><a href="Model-building.html#cb68-38" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb68-39"><a href="Model-building.html#cb68-39" aria-hidden="true" tabindex="-1"></a><span class="do">## tapply和by(with)函数：</span></span>
<span id="cb68-40"><a href="Model-building.html#cb68-40" aria-hidden="true" tabindex="-1"></a>tapply是table()函数的进阶版本；</span>
<span id="cb68-41"><a href="Model-building.html#cb68-41" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> (x <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb68-42"><a href="Model-building.html#cb68-42" aria-hidden="true" tabindex="-1"></a> [<span class="dv">1</span>]  <span class="dv">1</span>  <span class="dv">2</span>  <span class="dv">3</span>  <span class="dv">4</span>  <span class="dv">5</span>  <span class="dv">6</span>  <span class="dv">7</span>  <span class="dv">8</span>  <span class="dv">9</span> <span class="dv">10</span></span>
<span id="cb68-43"><a href="Model-building.html#cb68-43" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> (f <span class="ot">&lt;-</span> <span class="fu">gl</span>(<span class="dv">2</span>,<span class="dv">5</span>, <span class="at">labels=</span><span class="fu">c</span>(<span class="st">&quot;CK&quot;</span>, <span class="st">&quot;T&quot;</span>)))</span>
<span id="cb68-44"><a href="Model-building.html#cb68-44" aria-hidden="true" tabindex="-1"></a> [<span class="dv">1</span>] CK CK CK CK CK T  T  T  T  T </span>
<span id="cb68-45"><a href="Model-building.html#cb68-45" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">table</span>(f)</span>
<span id="cb68-46"><a href="Model-building.html#cb68-46" aria-hidden="true" tabindex="-1"></a>f</span>
<span id="cb68-47"><a href="Model-building.html#cb68-47" aria-hidden="true" tabindex="-1"></a>CK  T </span>
<span id="cb68-48"><a href="Model-building.html#cb68-48" aria-hidden="true" tabindex="-1"></a> <span class="dv">5</span>  <span class="dv">5</span> </span>
<span id="cb68-49"><a href="Model-building.html#cb68-49" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">tapply</span>(x, f, sum)</span>
<span id="cb68-50"><a href="Model-building.html#cb68-50" aria-hidden="true" tabindex="-1"></a>CK  T </span>
<span id="cb68-51"><a href="Model-building.html#cb68-51" aria-hidden="true" tabindex="-1"></a><span class="dv">15</span> <span class="dv">40</span> </span>
<span id="cb68-52"><a href="Model-building.html#cb68-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-53"><a href="Model-building.html#cb68-53" aria-hidden="true" tabindex="-1"></a><span class="do">##  by和with函数：</span></span>
<span id="cb68-54"><a href="Model-building.html#cb68-54" aria-hidden="true" tabindex="-1"></a><span class="co"># 工作原理类似于加载数据，分组后经分类按函数运算；</span></span>
<span id="cb68-55"><a href="Model-building.html#cb68-55" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(iris,<span class="fu">by</span>(sp1,sp2,sum))</span>
<span id="cb68-56"><a href="Model-building.html#cb68-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-57"><a href="Model-building.html#cb68-57" aria-hidden="true" tabindex="-1"></a><span class="do">#### aggregate:  ####</span></span>
<span id="cb68-58"><a href="Model-building.html#cb68-58" aria-hidden="true" tabindex="-1"></a>首先将数据进行分组（按行），然后对每一组数据进行函数统计，最后把结果组合成一个比较nice的表格返回。</span>
<span id="cb68-59"><a href="Model-building.html#cb68-59" aria-hidden="true" tabindex="-1"></a><span class="co"># 第一种实现思路是：加载，构建分组，函数运算；</span></span>
<span id="cb68-60"><a href="Model-building.html#cb68-60" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">aggregate</span>(mtcars, <span class="at">by=</span><span class="fu">list</span>(cyl, gear), <span class="at">FUN=</span>mean)</span>
<span id="cb68-61"><a href="Model-building.html#cb68-61" aria-hidden="true" tabindex="-1"></a><span class="co"># 第二种思路是构建数据框内的函数体系：</span></span>
<span id="cb68-62"><a href="Model-building.html#cb68-62" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">aggregate</span>(<span class="fu">cbind</span>(mpg,hp) <span class="sc">~</span> cyl<span class="sc">+</span>gear, <span class="at">FUN=</span>mean)</span>
<span id="cb68-63"><a href="Model-building.html#cb68-63" aria-hidden="true" tabindex="-1"></a> 表示使用 cyl 和 gear 的因子组合对 <span class="fu">cbind</span>(mpg,hp) 数据进行操作。</span></code></pre></div>
</div>
<div id="maptidy函数映射式批建模" class="section level4 hasAnchor" number="4.1.4.2">
<h4><span class="header-section-number">4.1.4.2</span> map/tidy函数映射式批建模<a href="Model-building.html#maptidy函数映射式批建模" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div id="批量构造模型" class="section level5 hasAnchor" number="4.1.4.2.1">
<h5><span class="header-section-number">4.1.4.2.1</span> 批量构造模型：<a href="Model-building.html#批量构造模型" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="Model-building.html#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 直接读取形式：</span></span>
<span id="cb69-2"><a href="Model-building.html#cb69-2" aria-hidden="true" tabindex="-1"></a>lm_results <span class="ot">&lt;-</span> <span class="fu">lm</span>(ht_cm <span class="sc">~</span> age, <span class="at">data =</span> linelist)</span>
<span id="cb69-3"><a href="Model-building.html#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm_results)</span>
<span id="cb69-4"><a href="Model-building.html#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(lm_results)</span>
<span id="cb69-5"><a href="Model-building.html#cb69-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-6"><a href="Model-building.html#cb69-6" aria-hidden="true" tabindex="-1"></a><span class="do">## 使用tidy整理统计检验结果-流形式</span></span>
<span id="cb69-7"><a href="Model-building.html#cb69-7" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">glm</span>(outcome <span class="sc">~</span> age_cat, <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">data =</span> linelist) <span class="sc">%&gt;%</span> </span>
<span id="cb69-8"><a href="Model-building.html#cb69-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy</span>(<span class="at">exponentiate =</span> <span class="cn">TRUE</span>, <span class="at">conf.int =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span>       </span>
<span id="cb69-9"><a href="Model-building.html#cb69-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), round, <span class="at">digits =</span> <span class="dv">2</span>)) </span>
<span id="cb69-10"><a href="Model-building.html#cb69-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-11"><a href="Model-building.html#cb69-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-12"><a href="Model-building.html#cb69-12" aria-hidden="true" tabindex="-1"></a><span class="do">## 使用map和bind_rows()来批量生成对应数据：</span></span>
<span id="cb69-13"><a href="Model-building.html#cb69-13" aria-hidden="true" tabindex="-1"></a>models <span class="ot">&lt;-</span> explanatory_vars <span class="sc">%&gt;%</span>       <span class="co"># begin with variables of interest</span></span>
<span id="cb69-14"><a href="Model-building.html#cb69-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_c</span>(<span class="st">&quot;outcome ~ &quot;</span>, .) <span class="sc">%&gt;%</span>         <span class="co"># combine each variable into formula (&quot;outcome ~ variable of interest&quot;)</span></span>
<span id="cb69-15"><a href="Model-building.html#cb69-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># iterate through each univariate formula</span></span>
<span id="cb69-16"><a href="Model-building.html#cb69-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(                               </span>
<span id="cb69-17"><a href="Model-building.html#cb69-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span><span class="fu">glm</span>(                      </span>
<span id="cb69-18"><a href="Model-building.html#cb69-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">formula =</span> <span class="fu">as.formula</span>(.x),     </span>
<span id="cb69-19"><a href="Model-building.html#cb69-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>,           <span class="co"># specify type of glm (logistic)</span></span>
<span id="cb69-20"><a href="Model-building.html#cb69-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> linelist)) <span class="sc">%&gt;%</span>          <span class="co"># dataset</span></span>
<span id="cb69-21"><a href="Model-building.html#cb69-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb69-22"><a href="Model-building.html#cb69-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tidy up each of the glm regression outputs from above</span></span>
<span id="cb69-23"><a href="Model-building.html#cb69-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(</span>
<span id="cb69-24"><a href="Model-building.html#cb69-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span><span class="fu">tidy</span>(</span>
<span id="cb69-25"><a href="Model-building.html#cb69-25" aria-hidden="true" tabindex="-1"></a>      .x, </span>
<span id="cb69-26"><a href="Model-building.html#cb69-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">exponentiate =</span> <span class="cn">TRUE</span>,           </span>
<span id="cb69-27"><a href="Model-building.html#cb69-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">conf.int =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span>        </span>
<span id="cb69-28"><a href="Model-building.html#cb69-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb69-29"><a href="Model-building.html#cb69-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># collapse the list of regression outputs in to one data frame</span></span>
<span id="cb69-30"><a href="Model-building.html#cb69-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb69-31"><a href="Model-building.html#cb69-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb69-32"><a href="Model-building.html#cb69-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># round all numeric columns</span></span>
<span id="cb69-33"><a href="Model-building.html#cb69-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), round, <span class="at">digits =</span> <span class="dv">2</span>))</span></code></pre></div>
</div>
<div id="批量构造简单统计" class="section level5 hasAnchor" number="4.1.4.2.2">
<h5><span class="header-section-number">4.1.4.2.2</span> 批量构造简单统计<a href="Model-building.html#批量构造简单统计" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="Model-building.html#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="do">### 借助map函数变体来构造统计：</span></span>
<span id="cb70-2"><a href="Model-building.html#cb70-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="cn">NA</span>))</span>
<span id="cb70-3"><a href="Model-building.html#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="fu">map_dbl</span>(x, <span class="sc">~</span> <span class="fu">mean</span>(.x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb70-4"><a href="Model-building.html#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 3.0 5.5</span></span></code></pre></div>
</div>
<div id="tidyrnestbroomtidy" class="section level5 hasAnchor" number="4.1.4.2.3">
<h5><span class="header-section-number">4.1.4.2.3</span> tidyr::nest/broom:tidy<a href="Model-building.html#tidyrnestbroomtidy" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="Model-building.html#cb71-1" aria-hidden="true" tabindex="-1"></a>mtcars <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(mtcars)  <span class="co"># to play nicely with list-cols</span></span>
<span id="cb71-2"><a href="Model-building.html#cb71-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-3"><a href="Model-building.html#cb71-3" aria-hidden="true" tabindex="-1"></a>nest_mtcars <span class="ot">&lt;-</span> mtcars <span class="sc">%&gt;%</span></span>
<span id="cb71-4"><a href="Model-building.html#cb71-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="fu">c</span>(<span class="sc">-</span>am))  <span class="do">## 这里是将非am列以外的数据套叠；</span></span>
<span id="cb71-5"><a href="Model-building.html#cb71-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-6"><a href="Model-building.html#cb71-6" aria-hidden="true" tabindex="-1"></a>nest_mtcars </span>
<span id="cb71-7"><a href="Model-building.html#cb71-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 输出形式如下：</span></span>
<span id="cb71-8"><a href="Model-building.html#cb71-8" aria-hidden="true" tabindex="-1"></a>am data              </span>
<span id="cb71-9"><a href="Model-building.html#cb71-9" aria-hidden="true" tabindex="-1"></a>  <span class="sc">&lt;</span>dbl<span class="sc">&gt;</span> <span class="er">&lt;</span>list<span class="sc">&gt;</span>            </span>
<span id="cb71-10"><a href="Model-building.html#cb71-10" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span>     <span class="dv">1</span> <span class="sc">&lt;</span>tibble [<span class="dv">13</span> x <span class="dv">10</span>]<span class="sc">&gt;</span></span>
<span id="cb71-11"><a href="Model-building.html#cb71-11" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span>     <span class="dv">0</span> <span class="sc">&lt;</span>tibble [<span class="dv">19</span> x <span class="dv">10</span>]<span class="sc">&gt;</span></span>
<span id="cb71-12"><a href="Model-building.html#cb71-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-13"><a href="Model-building.html#cb71-13" aria-hidden="true" tabindex="-1"></a><span class="do">## 根据套叠来输出可行的结果：</span></span>
<span id="cb71-14"><a href="Model-building.html#cb71-14" aria-hidden="true" tabindex="-1"></a>nest_mtcars <span class="sc">%&gt;%</span> </span>
<span id="cb71-15"><a href="Model-building.html#cb71-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>( <span class="do">## 这里会默认返回线性折叠结果，并依据am分组统计：</span></span>
<span id="cb71-16"><a href="Model-building.html#cb71-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">fit =</span> <span class="fu">map</span>(data, <span class="sc">~</span> <span class="fu">lm</span>(wt <span class="sc">~</span> mpg <span class="sc">+</span> qsec <span class="sc">+</span> gear, <span class="at">data =</span> .x)),  <span class="co"># S3 list-col</span></span>
<span id="cb71-17"><a href="Model-building.html#cb71-17" aria-hidden="true" tabindex="-1"></a>      <span class="do">## 来自broom包的tidy函数，自动整理fit拟合的结果；</span></span>
<span id="cb71-18"><a href="Model-building.html#cb71-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">tidied =</span> <span class="fu">map</span>(fit, tidy)</span>
<span id="cb71-19"><a href="Model-building.html#cb71-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb71-20"><a href="Model-building.html#cb71-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(tidied) <span class="sc">%&gt;%</span> </span>
<span id="cb71-21"><a href="Model-building.html#cb71-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>data, <span class="sc">-</span>fit)</span></code></pre></div>
</div>
</div>
</div>
<div id="broom优雅输出" class="section level3 hasAnchor" number="4.1.5">
<h3><span class="header-section-number">4.1.5</span> BROOM优雅输出<a href="Model-building.html#broom优雅输出" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="base-r中常用的统计解析" class="section level4 hasAnchor" number="4.1.5.1">
<h4><span class="header-section-number">4.1.5.1</span> base r中常用的统计解析<a href="Model-building.html#base-r中常用的统计解析" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<table>
<thead>
<tr class="header">
<th>函数</th>
<th>功能用途</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>summary()</td>
<td>展示拟合模型的详细结果</td>
</tr>
<tr class="even">
<td>coefficients()</td>
<td>展示拟合模型的模型参数</td>
</tr>
<tr class="odd">
<td>fitted()</td>
<td>列出拟合模型的预测值</td>
</tr>
<tr class="even">
<td>residuals()</td>
<td>列出拟合模型的残差值</td>
</tr>
<tr class="odd">
<td>anova()</td>
<td>生成拟合模型的方差分析表</td>
</tr>
<tr class="even">
<td>AIC()</td>
<td>输出赤池系数（评价模型好坏）</td>
</tr>
<tr class="odd">
<td>confint()</td>
<td>提供模型参数的知心区间(默认0.95）</td>
</tr>
<tr class="even">
<td>plot()</td>
<td>生成评价模型的诊断图</td>
</tr>
<tr class="odd">
<td>predict()</td>
<td>通过模型对新的数据集变量预测</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="Model-building.html#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(women)</span>
<span id="cb72-2"><a href="Model-building.html#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="do">##   height weight</span></span>
<span id="cb72-3"><a href="Model-building.html#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="do">## 1     58    115</span></span>
<span id="cb72-4"><a href="Model-building.html#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="do">## 2     59    117</span></span>
<span id="cb72-5"><a href="Model-building.html#cb72-5" aria-hidden="true" tabindex="-1"></a><span class="do">## 3     60    120</span></span>
<span id="cb72-6"><a href="Model-building.html#cb72-6" aria-hidden="true" tabindex="-1"></a><span class="do">## 4     61    123</span></span>
<span id="cb72-7"><a href="Model-building.html#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 5     62    126</span></span>
<span id="cb72-8"><a href="Model-building.html#cb72-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 6     63    129</span></span>
<span id="cb72-9"><a href="Model-building.html#cb72-9" aria-hidden="true" tabindex="-1"></a>fit<span class="ot">&lt;-</span><span class="fu">lm</span>(weight<span class="sc">~</span>height,<span class="at">data =</span> women) </span>
<span id="cb72-10"><a href="Model-building.html#cb72-10" aria-hidden="true" tabindex="-1"></a><span class="fu">fitted</span>(fit) <span class="co">#列出拟合模型的预测值</span></span>
<span id="cb72-11"><a href="Model-building.html#cb72-11" aria-hidden="true" tabindex="-1"></a><span class="do">##        1        2        3        4        5        6        7        8 </span></span>
<span id="cb72-12"><a href="Model-building.html#cb72-12" aria-hidden="true" tabindex="-1"></a><span class="do">## 112.5833 116.0333 119.4833 122.9333 126.3833 129.8333 133.2833 136.7333 </span></span>
<span id="cb72-13"><a href="Model-building.html#cb72-13" aria-hidden="true" tabindex="-1"></a><span class="do">##        9       10       11       12       13       14       15 </span></span>
<span id="cb72-14"><a href="Model-building.html#cb72-14" aria-hidden="true" tabindex="-1"></a><span class="do">## 140.1833 143.6333 147.0833 150.5333 153.9833 157.4333 160.8833</span></span>
<span id="cb72-15"><a href="Model-building.html#cb72-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-16"><a href="Model-building.html#cb72-16" aria-hidden="true" tabindex="-1"></a><span class="fu">residuals</span>(fit) <span class="co">#列出拟合模型的残差值</span></span>
<span id="cb72-17"><a href="Model-building.html#cb72-17" aria-hidden="true" tabindex="-1"></a><span class="do">##           1           2           3           4           5           6 </span></span>
<span id="cb72-18"><a href="Model-building.html#cb72-18" aria-hidden="true" tabindex="-1"></a><span class="do">##  2.41666667  0.96666667  0.51666667  0.06666667 -0.38333333 -0.83333333 </span></span>
<span id="cb72-19"><a href="Model-building.html#cb72-19" aria-hidden="true" tabindex="-1"></a><span class="do">##           7           8           9          10          11          12 </span></span>
<span id="cb72-20"><a href="Model-building.html#cb72-20" aria-hidden="true" tabindex="-1"></a><span class="do">## -1.28333333 -1.73333333 -1.18333333 -1.63333333 -1.08333333 -0.53333333 </span></span>
<span id="cb72-21"><a href="Model-building.html#cb72-21" aria-hidden="true" tabindex="-1"></a><span class="do">##          13          14          15 </span></span>
<span id="cb72-22"><a href="Model-building.html#cb72-22" aria-hidden="true" tabindex="-1"></a><span class="do">##  0.01666667  1.56666667  3.11666667</span></span>
<span id="cb72-23"><a href="Model-building.html#cb72-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-24"><a href="Model-building.html#cb72-24" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(fit) <span class="co">#通过模型对新的数据集变量预测</span></span>
<span id="cb72-25"><a href="Model-building.html#cb72-25" aria-hidden="true" tabindex="-1"></a><span class="do">##        1        2        3        4        5        6        7        8 </span></span>
<span id="cb72-26"><a href="Model-building.html#cb72-26" aria-hidden="true" tabindex="-1"></a><span class="do">## 112.5833 116.0333 119.4833 122.9333 126.3833 129.8333 133.2833 136.7333 </span></span>
<span id="cb72-27"><a href="Model-building.html#cb72-27" aria-hidden="true" tabindex="-1"></a><span class="do">##        9       10       11       12       13       14       15 </span></span>
<span id="cb72-28"><a href="Model-building.html#cb72-28" aria-hidden="true" tabindex="-1"></a><span class="do">## 140.1833 143.6333 147.0833 150.5333 153.9833 157.4333 160.8833</span></span></code></pre></div>
</div>
<div id="broom包中的优雅解析" class="section level4 hasAnchor" number="4.1.5.2">
<h4><span class="header-section-number">4.1.5.2</span> Broom包中的优雅解析<a href="Model-building.html#broom包中的优雅解析" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="Model-building.html#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb73-2"><a href="Model-building.html#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 关键是broom体系适配于tidy体系：</span></span>
<span id="cb73-3"><a href="Model-building.html#cb73-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-4"><a href="Model-building.html#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="co">#返回模型系数估计及其统计量</span></span>
<span id="cb73-5"><a href="Model-building.html#cb73-5" aria-hidden="true" tabindex="-1"></a>fit<span class="ot">&lt;-</span><span class="fu">lm</span>(weight<span class="sc">~</span>height,<span class="at">data =</span> women)</span>
<span id="cb73-6"><a href="Model-building.html#cb73-6" aria-hidden="true" tabindex="-1"></a>fit <span class="sc">%&gt;%</span> <span class="fu">tidy</span>() </span>
<span id="cb73-7"><a href="Model-building.html#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 2 x 5</span></span>
<span id="cb73-8"><a href="Model-building.html#cb73-8" aria-hidden="true" tabindex="-1"></a><span class="do">##   term        estimate std.error statistic  p.value</span></span>
<span id="cb73-9"><a href="Model-building.html#cb73-9" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span id="cb73-10"><a href="Model-building.html#cb73-10" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 (Intercept)   -87.5     5.94       -14.7 1.71e- 9</span></span>
<span id="cb73-11"><a href="Model-building.html#cb73-11" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 height          3.45    0.0911      37.9 1.09e-14</span></span>
<span id="cb73-12"><a href="Model-building.html#cb73-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-13"><a href="Model-building.html#cb73-13" aria-hidden="true" tabindex="-1"></a><span class="co">#返回模型诊断信息</span></span>
<span id="cb73-14"><a href="Model-building.html#cb73-14" aria-hidden="true" tabindex="-1"></a>fit<span class="ot">&lt;-</span><span class="fu">lm</span>(weight<span class="sc">~</span>height,<span class="at">data =</span> women)</span>
<span id="cb73-15"><a href="Model-building.html#cb73-15" aria-hidden="true" tabindex="-1"></a>fit  <span class="sc">%&gt;%</span>  <span class="fu">glance</span>(fit) </span>
<span id="cb73-16"><a href="Model-building.html#cb73-16" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 1 x 12</span></span>
<span id="cb73-17"><a href="Model-building.html#cb73-17" aria-hidden="true" tabindex="-1"></a><span class="do">##   r.squared adj.r.squared sigma statistic  p.value    df logLik   AIC   BIC</span></span>
<span id="cb73-18"><a href="Model-building.html#cb73-18" aria-hidden="true" tabindex="-1"></a><span class="do">##       &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb73-19"><a href="Model-building.html#cb73-19" aria-hidden="true" tabindex="-1"></a><span class="do">## 1     0.991         0.990  1.53     1433. 1.09e-14     1  -26.5  59.1  61.2</span></span>
<span id="cb73-20"><a href="Model-building.html#cb73-20" aria-hidden="true" tabindex="-1"></a><span class="do">## # ... with 3 more variables: deviance &lt;dbl&gt;, df.residual &lt;int&gt;, nobs &lt;int&gt;</span></span>
<span id="cb73-21"><a href="Model-building.html#cb73-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-22"><a href="Model-building.html#cb73-22" aria-hidden="true" tabindex="-1"></a><span class="co">#augment函数返回预测值,残差等模型结果的原始值</span></span>
<span id="cb73-23"><a href="Model-building.html#cb73-23" aria-hidden="true" tabindex="-1"></a>fit<span class="ot">&lt;-</span><span class="fu">lm</span>(weight<span class="sc">~</span>height,<span class="at">data =</span> women)</span>
<span id="cb73-24"><a href="Model-building.html#cb73-24" aria-hidden="true" tabindex="-1"></a>fit<span class="sc">%&gt;%</span> <span class="fu">augment</span>() </span></code></pre></div>
</div>
</div>
</div>
<div id="复杂统计模型" class="section level2 hasAnchor" number="4.2">
<h2><span class="header-section-number">4.2</span> 复杂统计模型<a href="Model-building.html#复杂统计模型" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="变量筛选" class="section level3 hasAnchor" number="4.2.1">
<h3><span class="header-section-number">4.2.1</span> 变量筛选<a href="Model-building.html#变量筛选" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="变量筛选的基本流程" class="section level4 hasAnchor" number="4.2.1.1">
<h4><span class="header-section-number">4.2.1.1</span> 变量筛选的基本流程<a href="Model-building.html#变量筛选的基本流程" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="Model-building.html#cb74-1" aria-hidden="true" tabindex="-1"></a>模型构建中第一个问题就是变量筛选：最常规的办法是先单后多（先进行单因素分析，单因素有意义的再一起纳入多因素模型中）；</span>
<span id="cb74-2"><a href="Model-building.html#cb74-2" aria-hidden="true" tabindex="-1"></a>但如果变量数目过多，变量间存在共线性或存在较多缺失值而又不愿舍弃含缺失值的样本时，先单后多就存在很多局限性。 </span>
<span id="cb74-3"><a href="Model-building.html#cb74-3" aria-hidden="true" tabindex="-1"></a>此时可以使用具有变量筛选功能的方法： <span class="sc">-</span>共线性问题：岭回归(Ridge Regression)，LASSO回归，弹性网络(Elastic Net Regression) <span class="sc">-</span>缺失值情况：随机森林模型</span>
<span id="cb74-4"><a href="Model-building.html#cb74-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-5"><a href="Model-building.html#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="do">## 常见的筛选变量方法</span></span>
<span id="cb74-6"><a href="Model-building.html#cb74-6" aria-hidden="true" tabindex="-1"></a>正则技术（岭回归、LASSO回归、弹性网络）</span>
<span id="cb74-7"><a href="Model-building.html#cb74-7" aria-hidden="true" tabindex="-1"></a>支持向量机</span>
<span id="cb74-8"><a href="Model-building.html#cb74-8" aria-hidden="true" tabindex="-1"></a>逐步回归（向前法、向后法、向前向后法）</span>
<span id="cb74-9"><a href="Model-building.html#cb74-9" aria-hidden="true" tabindex="-1"></a>最优子集（Best Subset Select）</span>
<span id="cb74-10"><a href="Model-building.html#cb74-10" aria-hidden="true" tabindex="-1"></a>树模型（使用的较少）</span>
<span id="cb74-11"><a href="Model-building.html#cb74-11" aria-hidden="true" tabindex="-1"></a>随机森林模型</span>
<span id="cb74-12"><a href="Model-building.html#cb74-12" aria-hidden="true" tabindex="-1"></a>主成分分析（提取多个自变量的主成分，将主成分得分作为最终的自变量）</span>
<span id="cb74-13"><a href="Model-building.html#cb74-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-14"><a href="Model-building.html#cb74-14" aria-hidden="true" tabindex="-1"></a><span class="do">## 常见的模型评价指标</span></span>
<span id="cb74-15"><a href="Model-building.html#cb74-15" aria-hidden="true" tabindex="-1"></a>拟合优度检验（卡方值<span class="sc">&amp;</span>P值）</span>
<span id="cb74-16"><a href="Model-building.html#cb74-16" aria-hidden="true" tabindex="-1"></a>ROC（AUC、sen、spe、accuracy等）</span>
<span id="cb74-17"><a href="Model-building.html#cb74-17" aria-hidden="true" tabindex="-1"></a>calibration（C<span class="sc">-</span>index）</span>
<span id="cb74-18"><a href="Model-building.html#cb74-18" aria-hidden="true" tabindex="-1"></a>MSE</span>
<span id="cb74-19"><a href="Model-building.html#cb74-19" aria-hidden="true" tabindex="-1"></a>rmse</span>
<span id="cb74-20"><a href="Model-building.html#cb74-20" aria-hidden="true" tabindex="-1"></a>模型验证是为了防止过拟合情况（所构建的模型对于本次数据有很好的效果，但是对全新的数据效果不理想）</span>
<span id="cb74-21"><a href="Model-building.html#cb74-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-22"><a href="Model-building.html#cb74-22" aria-hidden="true" tabindex="-1"></a><span class="do">## 常见的模型验证方法</span></span>
<span id="cb74-23"><a href="Model-building.html#cb74-23" aria-hidden="true" tabindex="-1"></a>cross validation（简单交叉，K<span class="sc">-</span>fold cross validation，N<span class="sc">-</span>fold cross validation）</span>
<span id="cb74-24"><a href="Model-building.html#cb74-24" aria-hidden="true" tabindex="-1"></a>bootstrap</span>
<span id="cb74-25"><a href="Model-building.html#cb74-25" aria-hidden="true" tabindex="-1"></a>cross validation <span class="sc">+</span> bootstrap（目前最常用）</span>
<span id="cb74-26"><a href="Model-building.html#cb74-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 交叉验证（cv）和bootstrap的区别：</span></span>
<span id="cb74-27"><a href="Model-building.html#cb74-27" aria-hidden="true" tabindex="-1"></a>.Bootstrap重抽样和交叉验证的区别。其相同之处，都是在数据集较小的时候常用的方法，提高结果的稳定性。不同之处，其一，两者的目的不同。CV主要用于模型选择上，例如KNN中选多大的K，使得估计的误差比较小。而Bootstrap主要用来看选定的模型的不确定性，例如参数的标准差多大。其二，两者的resample方法不同。在k fold CV中，把原始数据集分成k等分（各等分之间没交集），每一次验证中，把其中一份作为验证集，剩余的作为训练集。而在Bootstrap中，并不区分验证集和训练集，并且在resample中，是可放回抽样的，即同一个样本可以重复出现。</span>
<span id="cb74-28"><a href="Model-building.html#cb74-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-29"><a href="Model-building.html#cb74-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-30"><a href="Model-building.html#cb74-30" aria-hidden="true" tabindex="-1"></a><span class="do">## 变量筛选原则~~先单后多</span></span>
<span id="cb74-31"><a href="Model-building.html#cb74-31" aria-hidden="true" tabindex="-1"></a>如果某个变量单因素分析时P <span class="sc">&lt;</span> <span class="fl">0.05</span>（这个标准可以根据实际案例设置成0<span class="fl">.1</span>或者更严格的0<span class="fl">.01</span>），就纳入多因素模型。 单因素分析可以用t检验，卡方检验，秩和检验，Logistic回归等。</span>
<span id="cb74-32"><a href="Model-building.html#cb74-32" aria-hidden="true" tabindex="-1"></a>因变量：Group，1表示疾病，0表示对照 自变量：连续变量和分类变量都有（将分类变量处理成factor<span class="sc">--</span>2分类是否处理成因子不影响结果，多分类必须处理成因子）</span></code></pre></div>
</div>
<div id="变量筛选的实施方法" class="section level4 hasAnchor" number="4.2.1.2">
<h4><span class="header-section-number">4.2.1.2</span> 变量筛选的实施方法：<a href="Model-building.html#变量筛选的实施方法" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="Model-building.html#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fl">2.1</span> 参与评估的变量过多，通过数据的时间尺度来去除非因果耦联因子；</span>
<span id="cb75-2"><a href="Model-building.html#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 方法：</span></span>
<span id="cb75-3"><a href="Model-building.html#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="do">############ 子集选择法（Subset Selection）：</span></span>
<span id="cb75-4"><a href="Model-building.html#cb75-4" aria-hidden="true" tabindex="-1"></a>子集选择法分为最优子集选择、逐步筛选法等，这部分方法依赖于下述模型评判指标：</span>
<span id="cb75-5"><a href="Model-building.html#cb75-5" aria-hidden="true" tabindex="-1"></a>此外，还有考虑数据的共线性问题：包括pearson相关性分析和方差膨胀分析；</span>
<span id="cb75-6"><a href="Model-building.html#cb75-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-7"><a href="Model-building.html#cb75-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-8"><a href="Model-building.html#cb75-8" aria-hidden="true" tabindex="-1"></a><span class="do">############ 系数压缩法（Shrinkage）:</span></span>
<span id="cb75-9"><a href="Model-building.html#cb75-9" aria-hidden="true" tabindex="-1"></a>适用于岭回归和LASSO；两种方法可以用于自变量相关性非常强时，在进行线性回归进行参数估计时，会导致解不可逆，并且十分不稳定。岭回归由于使用L2范数作为限制，所以只能将估计的参数进行压缩，使得模型更加稳定，但不能对变量进行筛选。</span>
<span id="cb75-10"><a href="Model-building.html#cb75-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-11"><a href="Model-building.html#cb75-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-12"><a href="Model-building.html#cb75-12" aria-hidden="true" tabindex="-1"></a><span class="do">##########    降维法（Dimension Reduction）。</span></span>
<span id="cb75-13"><a href="Model-building.html#cb75-13" aria-hidden="true" tabindex="-1"></a>主成分回归以及偏最小二乘回归。主成分回归法主要是先对自变量进行主成分分析，然后挑选变化后的，较为重要的一些新变量进行回归。这部分新变量的构造不依赖于因变量，相当于无监督学习。而偏最小二乘回归相当于在主成分回归的基础上再进行适当的添加，新变量的构造不仅依赖于原本的自变量，还受因变量的影响。</span>
<span id="cb75-14"><a href="Model-building.html#cb75-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-15"><a href="Model-building.html#cb75-15" aria-hidden="true" tabindex="-1"></a><span class="do">## 前后筛选和后向筛选的区别;</span></span>
<span id="cb75-16"><a href="Model-building.html#cb75-16" aria-hidden="true" tabindex="-1"></a>以向后（backward）为例，其原理是，假设有N个自变量或预测指标，先将这N个合并在一起进行一个总的回归，每个自变量会有一个p值，将p<span class="sc">&gt;</span><span class="fl">0.05</span>的变量中p值最大的去掉，剩下N<span class="sc">-</span>1个自变量，再重复上述过程，直到剩下的自变量都是显著性的。</span>
<span id="cb75-17"><a href="Model-building.html#cb75-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-18"><a href="Model-building.html#cb75-18" aria-hidden="true" tabindex="-1"></a>向前（forward）是另一种算法：先进行N次单因素回归（每个自变量分别进行单因素回归），选出其中SSq（sum of square）最大的那个（设为A），留在回归方程；然后将A和剩下的N<span class="sc">-</span>1个自变量分别组合，形成N<span class="sc">-</span>1个两因素回归，再选取其中SSq最大的，留下（此时为两个自变量了），和剩下的N<span class="sc">-</span>2个去组合<span class="sc">~</span><span class="er">~~</span>以此类推，直到自变量总的SSq不比残差的SSq大，就截止。 </span></code></pre></div>
</div>
<div id="变量筛选的重要性评估方法" class="section level4 hasAnchor" number="4.2.1.3">
<h4><span class="header-section-number">4.2.1.3</span> 变量筛选的重要性评估方法：<a href="Model-building.html#变量筛选的重要性评估方法" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="Model-building.html#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="do">########## 基于机器学习的方法：</span></span>
<span id="cb76-2"><a href="Model-building.html#cb76-2" aria-hidden="true" tabindex="-1"></a>随机森林分类模型以及对重要变量的选择</span>
<span id="cb76-3"><a href="Model-building.html#cb76-3" aria-hidden="true" tabindex="-1"></a>gx.rf<span class="ot">&lt;-</span><span class="fu">randomForest</span>(gdp<span class="sc">~</span>.,<span class="at">data=</span>gxdata_without_x,<span class="at">importance=</span><span class="cn">TRUE</span>, <span class="at">ntree=</span><span class="dv">1000</span>)</span>
<span id="cb76-4"><a href="Model-building.html#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="fu">importance</span>(gx.rf)</span>
<span id="cb76-5"><a href="Model-building.html#cb76-5" aria-hidden="true" tabindex="-1"></a><span class="fu">varImpPlot</span>(gx.rf)</span>
<span id="cb76-6"><a href="Model-building.html#cb76-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-7"><a href="Model-building.html#cb76-7" aria-hidden="true" tabindex="-1"></a><span class="do">#########  标准化回归系数</span></span>
<span id="cb76-8"><a href="Model-building.html#cb76-8" aria-hidden="true" tabindex="-1"></a>文章的部分分析中，作者采用多元回归模型，定量分析了海拔、土壤养分、物种多样性、功能多样性和性状组成等在不同气候区对地上生物量影响的相对重要性。简单来说，首先每个非生物或生物变量（作为自变量）都标准化到均值0标准差1，随后拟合了它们与地上生物量（作为因变量）的多元线性回归。并在模型优化后（包括变量选择，去除共线性等），最终通过比较每个自变量的标准化回归系数，确定各类非生物或生物因素对影响地上生物量的相对重要性。<span class="sc">--</span> 这里是对称森林图；</span>
<span id="cb76-9"><a href="Model-building.html#cb76-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-10"><a href="Model-building.html#cb76-10" aria-hidden="true" tabindex="-1"></a>这里既可以使用线性模型，也可以使用非线性模型来构建对应的函数；</span>
<span id="cb76-11"><a href="Model-building.html#cb76-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-12"><a href="Model-building.html#cb76-12" aria-hidden="true" tabindex="-1"></a><span class="do">############ 相对权重方法：</span></span>
<span id="cb76-13"><a href="Model-building.html#cb76-13" aria-hidden="true" tabindex="-1"></a>原理：它是对所有可能子模型添加一个自变量引起的R2平均增加量的一个近似值。</span>
<span id="cb76-14"><a href="Model-building.html#cb76-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-15"><a href="Model-building.html#cb76-15" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(fish<span class="sc">~</span>acre<span class="sc">+</span>do2<span class="sc">+</span>depth<span class="sc">+</span>no3<span class="sc">+</span>so4<span class="sc">+</span>temp, <span class="at">data =</span> dat)</span>
<span id="cb76-16"><a href="Model-building.html#cb76-16" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit)  <span class="co">#展示拟合回归的简单统计</span></span>
<span id="cb76-17"><a href="Model-building.html#cb76-17" aria-hidden="true" tabindex="-1"></a>rel.weights <span class="ot">&lt;-</span> <span class="fu">relweights</span>(fit)</span>
<span id="cb76-18"><a href="Model-building.html#cb76-18" aria-hidden="true" tabindex="-1"></a>rel.weights</span>
<span id="cb76-19"><a href="Model-building.html#cb76-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-20"><a href="Model-building.html#cb76-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-21"><a href="Model-building.html#cb76-21" aria-hidden="true" tabindex="-1"></a><span class="do">################### 基于方差分解的多种方法：</span></span>
<span id="cb76-22"><a href="Model-building.html#cb76-22" aria-hidden="true" tabindex="-1"></a><span class="do">### 使用R包：relaimpo</span></span>
<span id="cb76-23"><a href="Model-building.html#cb76-23" aria-hidden="true" tabindex="-1"></a>它针对多元线性回归模型提供了评估变量相对重要性的多种指标。R语言中，线性回归通常通过<span class="fu">lm</span>()函数实现，<span class="fu">lm</span>()的拟合结果可直接作为relaimpo包的输入，relaimpo包中的函数将在此基础上，计算已构建好的回归模型中各个自变量对R2（代表自变量对响应变量总方差的解释程度）的贡献，实现定量分析相对重要性的目的。您也可以将它近似理解为方差分解的原理。</span>
<span id="cb76-24"><a href="Model-building.html#cb76-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-25"><a href="Model-building.html#cb76-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(relaimpo)</span>
<span id="cb76-26"><a href="Model-building.html#cb76-26" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb76-27"><a href="Model-building.html#cb76-27" aria-hidden="true" tabindex="-1"></a><span class="co">#使用函数 calc.relimp() 评估模型中各个自变量的相对重要性，详情 ?calc.relimp</span></span>
<span id="cb76-28"><a href="Model-building.html#cb76-28" aria-hidden="true" tabindex="-1"></a><span class="co">#可以将上述 lm() 拟合的多元线性回归模型直接输入到 calc.relimp()</span></span>
<span id="cb76-29"><a href="Model-building.html#cb76-29" aria-hidden="true" tabindex="-1"></a>crf <span class="ot">&lt;-</span> <span class="fu">calc.relimp</span>(fit_lm, <span class="at">rela =</span> <span class="cn">TRUE</span>, </span>
<span id="cb76-30"><a href="Model-building.html#cb76-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="fu">c</span>(<span class="st">&#39;lmg&#39;</span>, <span class="st">&#39;last&#39;</span>, <span class="st">&#39;first&#39;</span>, <span class="st">&#39;betasq&#39;</span>, <span class="st">&#39;pratt&#39;</span>, <span class="st">&#39;genizi&#39;</span>, <span class="st">&#39;car&#39;</span>))  <span class="do">## 这里标红色为多种评估变量重要性的指标；</span></span>
<span id="cb76-31"><a href="Model-building.html#cb76-31" aria-hidden="true" tabindex="-1"></a>crf</span>
<span id="cb76-32"><a href="Model-building.html#cb76-32" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(crf)</span></code></pre></div>
</div>
<div id="多元回归中变量筛选的方法" class="section level4 hasAnchor" number="4.2.1.4">
<h4><span class="header-section-number">4.2.1.4</span> 多元回归中变量筛选的方法：<a href="Model-building.html#多元回归中变量筛选的方法" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div id="前向后向混合暴力破解aicbic" class="section level5 hasAnchor" number="4.2.1.4.1">
<h5><span class="header-section-number">4.2.1.4.1</span> 前向、后向、混合、暴力破解(AIC/BIC)<a href="Model-building.html#前向后向混合暴力破解aicbic" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="Model-building.html#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load processed data set from previous section</span></span>
<span id="cb77-2"><a href="Model-building.html#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">url</span>(<span class="st">&quot;https://userpage.fu-berlin.de/soga/300/30100_data_sets/dwd_30200.RData&quot;</span>))</span>
<span id="cb77-3"><a href="Model-building.html#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="co"># load helper functions from previous section</span></span>
<span id="cb77-4"><a href="Model-building.html#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">url</span>(<span class="st">&quot;https://userpage.fu-berlin.de/soga/300/30100_data_sets/helper_functions_30200.RData&quot;</span>))</span>
<span id="cb77-5"><a href="Model-building.html#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="co"># load list object from previous section</span></span>
<span id="cb77-6"><a href="Model-building.html#cb77-6" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">url</span>(<span class="st">&quot;https://userpage.fu-berlin.de/soga/300/30100_data_sets/model_outcome_I_30200.RData&quot;</span>))</span>
<span id="cb77-7"><a href="Model-building.html#cb77-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-8"><a href="Model-building.html#cb77-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 均方根误差</span></span>
<span id="cb77-9"><a href="Model-building.html#cb77-9" aria-hidden="true" tabindex="-1"></a>rmse <span class="ot">=</span> <span class="cf">function</span>(model){</span>
<span id="cb77-10"><a href="Model-building.html#cb77-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sqrt</span>(<span class="fu">sum</span>((model<span class="sc">$</span>residual)<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span><span class="fu">nrow</span>(model<span class="sc">$</span>model))}</span>
<span id="cb77-11"><a href="Model-building.html#cb77-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-12"><a href="Model-building.html#cb77-12" aria-hidden="true" tabindex="-1"></a><span class="co"># build the model</span></span>
<span id="cb77-13"><a href="Model-building.html#cb77-13" aria-hidden="true" tabindex="-1"></a>m.multi.interact <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="at">formula =</span> MEAN.ANNUAL.RAINFALL <span class="sc">~</span> </span>
<span id="cb77-14"><a href="Model-building.html#cb77-14" aria-hidden="true" tabindex="-1"></a>                         ALTITUDE <span class="sc">+</span> </span>
<span id="cb77-15"><a href="Model-building.html#cb77-15" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">log</span>(ALTITUDE) <span class="sc">+</span></span>
<span id="cb77-16"><a href="Model-building.html#cb77-16" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">I</span>(ALTITUDE<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb77-17"><a href="Model-building.html#cb77-17" aria-hidden="true" tabindex="-1"></a>                         MAX.RAINFALL <span class="sc">+</span></span>
<span id="cb77-18"><a href="Model-building.html#cb77-18" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">log</span>(MAX.RAINFALL) <span class="sc">+</span></span>
<span id="cb77-19"><a href="Model-building.html#cb77-19" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">I</span>(MAX.RAINFALL<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb77-20"><a href="Model-building.html#cb77-20" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">I</span>(MAX.RAINFALL<span class="sc">*</span>ALTITUDE), </span>
<span id="cb77-21"><a href="Model-building.html#cb77-21" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> train.set)    </span>
<span id="cb77-22"><a href="Model-building.html#cb77-22" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate rmse on training set</span></span>
<span id="cb77-23"><a href="Model-building.html#cb77-23" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">&#39;RMSE on training set:&#39;</span>, <span class="fu">rmse</span>(m.multi.interact)))</span>
<span id="cb77-24"><a href="Model-building.html#cb77-24" aria-hidden="true" tabindex="-1"></a><span class="co"># prediction</span></span>
<span id="cb77-25"><a href="Model-building.html#cb77-25" aria-hidden="true" tabindex="-1"></a>m.multi.interact.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(m.multi.interact, <span class="at">newdata =</span> test.set)</span>
<span id="cb77-26"><a href="Model-building.html#cb77-26" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate RMSE for the test data set</span></span>
<span id="cb77-27"><a href="Model-building.html#cb77-27" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">&#39;RMSE on test set:&#39;</span>, <span class="fu">rmse2</span>(y.test, m.multi.interact.pred)))</span>
<span id="cb77-28"><a href="Model-building.html#cb77-28" aria-hidden="true" tabindex="-1"></a><span class="co"># store model object and results of rmse in the `list` object named `model.outcome`</span></span>
<span id="cb77-29"><a href="Model-building.html#cb77-29" aria-hidden="true" tabindex="-1"></a>model.outcome[[<span class="st">&#39;multi.interact&#39;</span>]] <span class="ot">=</span> <span class="fu">list</span>(<span class="st">&#39;model&#39;</span> <span class="ot">=</span> m.multi.interact, </span>
<span id="cb77-30"><a href="Model-building.html#cb77-30" aria-hidden="true" tabindex="-1"></a>                                         <span class="st">&#39;rmse&#39;</span> <span class="ot">=</span>  <span class="fu">data.frame</span>(<span class="st">&#39;name&#39;</span><span class="ot">=</span> <span class="st">&#39;multiple interactions&#39;</span>,</span>
<span id="cb77-31"><a href="Model-building.html#cb77-31" aria-hidden="true" tabindex="-1"></a>                                                              <span class="st">&#39;train.RMSE&#39;</span> <span class="ot">=</span> <span class="fu">rmse</span>(m.multi.interact),</span>
<span id="cb77-32"><a href="Model-building.html#cb77-32" aria-hidden="true" tabindex="-1"></a>                                                              <span class="st">&#39;test.RMSE&#39;</span> <span class="ot">=</span> <span class="fu">rmse2</span>(y.test, m.multi.interact.pred)))</span>
<span id="cb77-33"><a href="Model-building.html#cb77-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-34"><a href="Model-building.html#cb77-34" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m.multi.interact)</span>
<span id="cb77-35"><a href="Model-building.html#cb77-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-36"><a href="Model-building.html#cb77-36" aria-hidden="true" tabindex="-1"></a><span class="do">##################### 引入前向和后向选择 ##########################</span></span>
<span id="cb77-37"><a href="Model-building.html#cb77-37" aria-hidden="true" tabindex="-1"></a><span class="co"># the Akaike information criterion (AIC) and </span></span>
<span id="cb77-38"><a href="Model-building.html#cb77-38" aria-hidden="true" tabindex="-1"></a><span class="co"># the Bayesian information criterion (BIC).</span></span>
<span id="cb77-39"><a href="Model-building.html#cb77-39" aria-hidden="true" tabindex="-1"></a><span class="do">################### 前向选择 ##############################</span></span>
<span id="cb77-40"><a href="Model-building.html#cb77-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-41"><a href="Model-building.html#cb77-41" aria-hidden="true" tabindex="-1"></a><span class="co"># define (empty) model</span></span>
<span id="cb77-42"><a href="Model-building.html#cb77-42" aria-hidden="true" tabindex="-1"></a>test.model <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="at">formula =</span> MEAN.ANNUAL.RAINFALL <span class="sc">~</span> <span class="dv">1</span>,<span class="at">data =</span> train.set)</span>
<span id="cb77-43"><a href="Model-building.html#cb77-43" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb77-44"><a href="Model-building.html#cb77-44" aria-hidden="true" tabindex="-1"></a><span class="co"># define scope, which features to include</span></span>
<span id="cb77-45"><a href="Model-building.html#cb77-45" aria-hidden="true" tabindex="-1"></a>test.scope <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">lm</span>(MEAN.ANNUAL.RAINFALL <span class="sc">~</span> ALTITUDE <span class="sc">+</span>  MAX.RAINFALL <span class="sc">+</span> MEAN.CLOUD.COVER <span class="sc">+</span>  MEAN.ANNUAL.AIR.TEMP,  <span class="at">data =</span> train.set))</span>
<span id="cb77-46"><a href="Model-building.html#cb77-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-47"><a href="Model-building.html#cb77-47" aria-hidden="true" tabindex="-1"></a><span class="co"># call the step function\</span></span>
<span id="cb77-48"><a href="Model-building.html#cb77-48" aria-hidden="true" tabindex="-1"></a><span class="do">## 注意前向选择模型的构建方式：，先设置空白模型，然后比对复杂模型；</span></span>
<span id="cb77-49"><a href="Model-building.html#cb77-49" aria-hidden="true" tabindex="-1"></a><span class="fu">step</span>(test.model, <span class="at">scope =</span> test.scope, <span class="at">direction =</span> <span class="st">&#39;forward&#39;</span>)</span>
<span id="cb77-50"><a href="Model-building.html#cb77-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-51"><a href="Model-building.html#cb77-51" aria-hidden="true" tabindex="-1"></a><span class="co"># build the model</span></span>
<span id="cb77-52"><a href="Model-building.html#cb77-52" aria-hidden="true" tabindex="-1"></a>m.forward.test <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="at">formula =</span> MEAN.ANNUAL.RAINFALL <span class="sc">~</span> MAX.RAINFALL <span class="sc">+</span> MEAN.ANNUAL.AIR.TEMP,</span>
<span id="cb77-53"><a href="Model-building.html#cb77-53" aria-hidden="true" tabindex="-1"></a>                     <span class="at">data =</span> train.set)</span>
<span id="cb77-54"><a href="Model-building.html#cb77-54" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate rmse on training set</span></span>
<span id="cb77-55"><a href="Model-building.html#cb77-55" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">&#39;RMSE on training set:&#39;</span>, <span class="fu">rmse</span>(m.forward.test )))</span>
<span id="cb77-56"><a href="Model-building.html#cb77-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-57"><a href="Model-building.html#cb77-57" aria-hidden="true" tabindex="-1"></a><span class="co"># prediction</span></span>
<span id="cb77-58"><a href="Model-building.html#cb77-58" aria-hidden="true" tabindex="-1"></a>m.forward.test.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(m.forward.test , <span class="at">newdata =</span> test.set)</span>
<span id="cb77-59"><a href="Model-building.html#cb77-59" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate RMSE for the test data set</span></span>
<span id="cb77-60"><a href="Model-building.html#cb77-60" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">&#39;RMSE on test set:&#39;</span>, <span class="fu">rmse2</span>(y.test, m.forward.test.pred)))</span>
<span id="cb77-61"><a href="Model-building.html#cb77-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-62"><a href="Model-building.html#cb77-62" aria-hidden="true" tabindex="-1"></a><span class="do">## 空模型和前向选择模型比较：</span></span>
<span id="cb77-63"><a href="Model-building.html#cb77-63" aria-hidden="true" tabindex="-1"></a><span class="co"># define (empty) model</span></span>
<span id="cb77-64"><a href="Model-building.html#cb77-64" aria-hidden="true" tabindex="-1"></a>m.forward.full.baseline <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="at">formula =</span> MEAN.ANNUAL.RAINFALL <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> train.set)</span>
<span id="cb77-65"><a href="Model-building.html#cb77-65" aria-hidden="true" tabindex="-1"></a><span class="co"># define scope, which features to include</span></span>
<span id="cb77-66"><a href="Model-building.html#cb77-66" aria-hidden="true" tabindex="-1"></a>m.forward.full.scope <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">lm</span>(MEAN.ANNUAL.RAINFALL <span class="sc">~</span>., <span class="at">data =</span> train.set))</span>
<span id="cb77-67"><a href="Model-building.html#cb77-67" aria-hidden="true" tabindex="-1"></a><span class="co"># call the step function</span></span>
<span id="cb77-68"><a href="Model-building.html#cb77-68" aria-hidden="true" tabindex="-1"></a>m.forward.full <span class="ot">&lt;-</span> <span class="fu">step</span>(m.forward.full.baseline, </span>
<span id="cb77-69"><a href="Model-building.html#cb77-69" aria-hidden="true" tabindex="-1"></a>                       <span class="at">scope =</span> m.forward.full.scope, </span>
<span id="cb77-70"><a href="Model-building.html#cb77-70" aria-hidden="true" tabindex="-1"></a>                       <span class="at">direction =</span> <span class="st">&#39;forward&#39;</span>, </span>
<span id="cb77-71"><a href="Model-building.html#cb77-71" aria-hidden="true" tabindex="-1"></a>                       <span class="at">trace =</span> <span class="dv">0</span>)</span>
<span id="cb77-72"><a href="Model-building.html#cb77-72" aria-hidden="true" tabindex="-1"></a>m.forward.full</span>
<span id="cb77-73"><a href="Model-building.html#cb77-73" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate rmse on training set</span></span>
<span id="cb77-74"><a href="Model-building.html#cb77-74" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">&#39;RMSE on training set:&#39;</span>, <span class="fu">rmse</span>(m.forward.full)))</span>
<span id="cb77-75"><a href="Model-building.html#cb77-75" aria-hidden="true" tabindex="-1"></a><span class="co"># prediction</span></span>
<span id="cb77-76"><a href="Model-building.html#cb77-76" aria-hidden="true" tabindex="-1"></a>m.forward.full.test.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(m.forward.full, <span class="at">newdata =</span> test.set)</span>
<span id="cb77-77"><a href="Model-building.html#cb77-77" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate RMSE for the test data set</span></span>
<span id="cb77-78"><a href="Model-building.html#cb77-78" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">&#39;RMSE on test set:&#39;</span>, <span class="fu">rmse2</span>(y.test, m.forward.full.test.pred)))</span>
<span id="cb77-79"><a href="Model-building.html#cb77-79" aria-hidden="true" tabindex="-1"></a><span class="co"># store model object and results of rmse in the `list` object named `model.outcome`</span></span>
<span id="cb77-80"><a href="Model-building.html#cb77-80" aria-hidden="true" tabindex="-1"></a>model.outcome[[<span class="st">&#39;forward.full&#39;</span>]] <span class="ot">=</span> <span class="fu">list</span>(<span class="st">&#39;model&#39;</span> <span class="ot">=</span> m.forward.full, </span>
<span id="cb77-81"><a href="Model-building.html#cb77-81" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">&#39;rmse&#39;</span> <span class="ot">=</span>  <span class="fu">data.frame</span>(<span class="st">&#39;name&#39;</span><span class="ot">=</span> <span class="st">&#39;forward model&#39;</span>,</span>
<span id="cb77-82"><a href="Model-building.html#cb77-82" aria-hidden="true" tabindex="-1"></a>                                                            <span class="st">&#39;train.RMSE&#39;</span> <span class="ot">=</span> <span class="fu">rmse</span>(m.forward.full),</span>
<span id="cb77-83"><a href="Model-building.html#cb77-83" aria-hidden="true" tabindex="-1"></a>                                                            <span class="st">&#39;test.RMSE&#39;</span> <span class="ot">=</span> <span class="fu">rmse2</span>(y.test, m.forward.full.test.pred)))</span>
<span id="cb77-84"><a href="Model-building.html#cb77-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-85"><a href="Model-building.html#cb77-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-86"><a href="Model-building.html#cb77-86" aria-hidden="true" tabindex="-1"></a><span class="do">###################### 后向选择 ##############################</span></span>
<span id="cb77-87"><a href="Model-building.html#cb77-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-88"><a href="Model-building.html#cb77-88" aria-hidden="true" tabindex="-1"></a><span class="co"># define (sophisticated) model</span></span>
<span id="cb77-89"><a href="Model-building.html#cb77-89" aria-hidden="true" tabindex="-1"></a>test.model <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="at">formula =</span> MEAN.ANNUAL.RAINFALL <span class="sc">~</span> ALTITUDE <span class="sc">+</span> MAX.RAINFALL <span class="sc">+</span> MEAN.CLOUD.COVER <span class="sc">+</span> MEAN.ANNUAL.AIR.TEMP, </span>
<span id="cb77-90"><a href="Model-building.html#cb77-90" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> train.set)</span>
<span id="cb77-91"><a href="Model-building.html#cb77-91" aria-hidden="true" tabindex="-1"></a><span class="co"># call the step function</span></span>
<span id="cb77-92"><a href="Model-building.html#cb77-92" aria-hidden="true" tabindex="-1"></a><span class="fu">step</span>(test.model, <span class="at">direction =</span> <span class="st">&#39;backward&#39;</span>)</span>
<span id="cb77-93"><a href="Model-building.html#cb77-93" aria-hidden="true" tabindex="-1"></a><span class="co"># define (empty) model</span></span>
<span id="cb77-94"><a href="Model-building.html#cb77-94" aria-hidden="true" tabindex="-1"></a>m.backward.full.baseline <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="at">formula =</span> MEAN.ANNUAL.RAINFALL <span class="sc">~</span>. , <span class="at">data =</span> train.set)</span>
<span id="cb77-95"><a href="Model-building.html#cb77-95" aria-hidden="true" tabindex="-1"></a><span class="co"># call the step function</span></span>
<span id="cb77-96"><a href="Model-building.html#cb77-96" aria-hidden="true" tabindex="-1"></a>m.backward.full <span class="ot">&lt;-</span> <span class="fu">step</span>(m.backward.full.baseline, </span>
<span id="cb77-97"><a href="Model-building.html#cb77-97" aria-hidden="true" tabindex="-1"></a>                        <span class="at">direction =</span> <span class="st">&#39;backward&#39;</span>,  <span class="at">trace =</span> <span class="dv">0</span>)</span>
<span id="cb77-98"><a href="Model-building.html#cb77-98" aria-hidden="true" tabindex="-1"></a>                       </span>
<span id="cb77-99"><a href="Model-building.html#cb77-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-100"><a href="Model-building.html#cb77-100" aria-hidden="true" tabindex="-1"></a><span class="do">################## 混合选择 ###########################</span></span>
<span id="cb77-101"><a href="Model-building.html#cb77-101" aria-hidden="true" tabindex="-1"></a><span class="co"># define model</span></span>
<span id="cb77-102"><a href="Model-building.html#cb77-102" aria-hidden="true" tabindex="-1"></a>m.both.full.baseline <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="at">formula =</span> MEAN.ANNUAL.RAINFALL <span class="sc">~</span>., </span>
<span id="cb77-103"><a href="Model-building.html#cb77-103" aria-hidden="true" tabindex="-1"></a>                           <span class="at">data =</span> train.set)</span>
<span id="cb77-104"><a href="Model-building.html#cb77-104" aria-hidden="true" tabindex="-1"></a><span class="co"># call the step function</span></span>
<span id="cb77-105"><a href="Model-building.html#cb77-105" aria-hidden="true" tabindex="-1"></a>m.both.full <span class="ot">&lt;-</span> <span class="fu">step</span>(m.both.full.baseline, <span class="at">direction =</span> <span class="st">&#39;both&#39;</span>,<span class="at">trace =</span> <span class="dv">0</span>)    </span>
<span id="cb77-106"><a href="Model-building.html#cb77-106" aria-hidden="true" tabindex="-1"></a>m.both.full</span>
<span id="cb77-107"><a href="Model-building.html#cb77-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-108"><a href="Model-building.html#cb77-108" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate rmse on training set</span></span>
<span id="cb77-109"><a href="Model-building.html#cb77-109" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">&#39;RMSE on training set:&#39;</span>, <span class="fu">rmse</span>(m.both.full)))</span>
<span id="cb77-110"><a href="Model-building.html#cb77-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-111"><a href="Model-building.html#cb77-111" aria-hidden="true" tabindex="-1"></a><span class="do">#########################</span></span>
<span id="cb77-112"><a href="Model-building.html#cb77-112" aria-hidden="true" tabindex="-1"></a><span class="do">### Brute force - BIC </span><span class="al">###</span><span class="do"> ###########难怪称之为 蛮力破解的BIC</span></span>
<span id="cb77-113"><a href="Model-building.html#cb77-113" aria-hidden="true" tabindex="-1"></a><span class="do">#########################</span></span>
<span id="cb77-114"><a href="Model-building.html#cb77-114" aria-hidden="true" tabindex="-1"></a><span class="co"># encode log-transformation</span></span>
<span id="cb77-115"><a href="Model-building.html#cb77-115" aria-hidden="true" tabindex="-1"></a>features <span class="ot">&lt;-</span> <span class="fu">colnames</span>(train.set)[<span class="sc">!</span>(<span class="fu">colnames</span>(train.set)  <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;MEAN.ANNUAL.RAINFALL&#39;</span>, <span class="st">&#39;MIN.AIR.TEMP&#39;</span>))]</span>
<span id="cb77-116"><a href="Model-building.html#cb77-116" aria-hidden="true" tabindex="-1"></a>log_transform <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="fu">paste0</span>(<span class="st">&#39;log(&#39;</span>,features,<span class="st">&#39;)&#39;</span>), <span class="at">collapse=</span><span class="st">&quot; + &quot;</span>)</span>
<span id="cb77-117"><a href="Model-building.html#cb77-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-118"><a href="Model-building.html#cb77-118" aria-hidden="true" tabindex="-1"></a><span class="do">## 这个公式牛逼：加上所有的log选择，加上所有的二次项，加上所有的交互项；</span></span>
<span id="cb77-119"><a href="Model-building.html#cb77-119" aria-hidden="true" tabindex="-1"></a><span class="do">### 这种模型的构建方式值得选择</span></span>
<span id="cb77-120"><a href="Model-building.html#cb77-120" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">=</span> <span class="fu">as.formula</span>(<span class="fu">paste0</span>(<span class="st">&#39;MEAN.ANNUAL.RAINFALL ~ . +&#39;</span>, log_transform ,<span class="st">&#39;+ .^2 + .*.&#39;</span>))</span>
<span id="cb77-121"><a href="Model-building.html#cb77-121" aria-hidden="true" tabindex="-1"></a><span class="co"># define model</span></span>
<span id="cb77-122"><a href="Model-building.html#cb77-122" aria-hidden="true" tabindex="-1"></a>m.both.force.BIC.baseline <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="at">formula =</span> formula, <span class="at">data =</span> train.set)</span>
<span id="cb77-123"><a href="Model-building.html#cb77-123" aria-hidden="true" tabindex="-1"></a><span class="co"># call the step function</span></span>
<span id="cb77-124"><a href="Model-building.html#cb77-124" aria-hidden="true" tabindex="-1"></a>m.both.force.BIC <span class="ot">&lt;-</span> <span class="fu">step</span>(m.both.force.BIC.baseline,<span class="at">direction =</span> <span class="st">&#39;both&#39;</span>, <span class="at">trace =</span> <span class="dv">0</span>,</span>
<span id="cb77-125"><a href="Model-building.html#cb77-125" aria-hidden="true" tabindex="-1"></a>                         <span class="at">k=</span> <span class="fu">log</span>(<span class="fu">nrow</span>(train.set)))</span>
<span id="cb77-126"><a href="Model-building.html#cb77-126" aria-hidden="true" tabindex="-1"></a><span class="co"># clculate rmse on training set</span></span>
<span id="cb77-127"><a href="Model-building.html#cb77-127" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">&#39;RMSE on training set:&#39;</span>, <span class="fu">rmse</span>(m.both.force.BIC)))</span></code></pre></div>
</div>
<div id="stepreg复杂筛选" class="section level5 hasAnchor" number="4.2.1.4.2">
<h5><span class="header-section-number">4.2.1.4.2</span> StepReg复杂筛选<a href="Model-building.html#stepreg复杂筛选" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="Model-building.html#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="do">## select = c(&quot;AIC&quot;, &quot;AICc&quot;, &quot;BIC&quot;, &quot;CP&quot;, &quot;HQ&quot;, &quot;HQc&quot;, &quot;Rsq&quot;, &quot;adjRsq&quot;, &quot;SL&quot;, &quot;SBC&quot;):</span></span>
<span id="cb78-2"><a href="Model-building.html#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 基于前向、后向和双向,实现多条件、多参数检验筛选函数条件：</span></span>
<span id="cb78-3"><a href="Model-building.html#cb78-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-4"><a href="Model-building.html#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="do">## 支持一般线性模型的参数变量选择：</span></span>
<span id="cb78-5"><a href="Model-building.html#cb78-5" aria-hidden="true" tabindex="-1"></a><span class="fu">stepwise</span>(</span>
<span id="cb78-6"><a href="Model-building.html#cb78-6" aria-hidden="true" tabindex="-1"></a>formula,</span>
<span id="cb78-7"><a href="Model-building.html#cb78-7" aria-hidden="true" tabindex="-1"></a>data,</span>
<span id="cb78-8"><a href="Model-building.html#cb78-8" aria-hidden="true" tabindex="-1"></a><span class="at">include =</span> <span class="cn">NULL</span>, <span class="do">## 支持选定变量强制参与最终统计建模：</span></span>
<span id="cb78-9"><a href="Model-building.html#cb78-9" aria-hidden="true" tabindex="-1"></a><span class="at">selection =</span> <span class="fu">c</span>(<span class="st">&quot;forward&quot;</span>, <span class="st">&quot;backward&quot;</span>, <span class="st">&quot;bidirection&quot;</span>, <span class="st">&quot;score&quot;</span>),</span>
<span id="cb78-10"><a href="Model-building.html#cb78-10" aria-hidden="true" tabindex="-1"></a><span class="at">select =</span> <span class="fu">c</span>(<span class="st">&quot;AIC&quot;</span>, <span class="st">&quot;AICc&quot;</span>, <span class="st">&quot;BIC&quot;</span>, <span class="st">&quot;CP&quot;</span>, <span class="st">&quot;HQ&quot;</span>, <span class="st">&quot;HQc&quot;</span>, <span class="st">&quot;Rsq&quot;</span>, <span class="st">&quot;adjRsq&quot;</span>, <span class="st">&quot;SL&quot;</span>, <span class="st">&quot;SBC&quot;</span>),</span>
<span id="cb78-11"><a href="Model-building.html#cb78-11" aria-hidden="true" tabindex="-1"></a><span class="at">sle =</span> <span class="fl">0.15</span>,</span>
<span id="cb78-12"><a href="Model-building.html#cb78-12" aria-hidden="true" tabindex="-1"></a><span class="at">sls =</span> <span class="fl">0.15</span>,</span>
<span id="cb78-13"><a href="Model-building.html#cb78-13" aria-hidden="true" tabindex="-1"></a><span class="at">multivarStat =</span> <span class="fu">c</span>(<span class="st">&quot;Pillai&quot;</span>, <span class="st">&quot;Wilks&quot;</span>, <span class="st">&quot;Hotelling-Lawley&quot;</span>, <span class="st">&quot;Roy&quot;</span>),</span>
<span id="cb78-14"><a href="Model-building.html#cb78-14" aria-hidden="true" tabindex="-1"></a><span class="at">weights =</span> <span class="cn">NULL</span>,</span>
<span id="cb78-15"><a href="Model-building.html#cb78-15" aria-hidden="true" tabindex="-1"></a><span class="at">best =</span> <span class="cn">NULL</span>)</span>
<span id="cb78-16"><a href="Model-building.html#cb78-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-17"><a href="Model-building.html#cb78-17" aria-hidden="true" tabindex="-1"></a><span class="do">## 支持cox回归的参数变量选择：</span></span>
<span id="cb78-18"><a href="Model-building.html#cb78-18" aria-hidden="true" tabindex="-1"></a><span class="fu">stepwiseCox</span>(</span>
<span id="cb78-19"><a href="Model-building.html#cb78-19" aria-hidden="true" tabindex="-1"></a>formula,</span>
<span id="cb78-20"><a href="Model-building.html#cb78-20" aria-hidden="true" tabindex="-1"></a>data,</span>
<span id="cb78-21"><a href="Model-building.html#cb78-21" aria-hidden="true" tabindex="-1"></a><span class="at">include =</span> <span class="cn">NULL</span>,</span>
<span id="cb78-22"><a href="Model-building.html#cb78-22" aria-hidden="true" tabindex="-1"></a><span class="at">selection =</span> <span class="fu">c</span>(<span class="st">&quot;forward&quot;</span>, <span class="st">&quot;backward&quot;</span>, <span class="st">&quot;bidirection&quot;</span>, <span class="st">&quot;score&quot;</span>),</span>
<span id="cb78-23"><a href="Model-building.html#cb78-23" aria-hidden="true" tabindex="-1"></a><span class="at">select =</span> <span class="fu">c</span>(<span class="st">&quot;SL&quot;</span>, <span class="st">&quot;AIC&quot;</span>, <span class="st">&quot;AICc&quot;</span>, <span class="st">&quot;SBC&quot;</span>, <span class="st">&quot;HQ&quot;</span>, <span class="st">&quot;HQc&quot;</span>, <span class="st">&quot;IC(3/2)&quot;</span>, <span class="st">&quot;IC(1)&quot;</span>),</span>
<span id="cb78-24"><a href="Model-building.html#cb78-24" aria-hidden="true" tabindex="-1"></a><span class="at">sle =</span> <span class="fl">0.15</span>,</span>
<span id="cb78-25"><a href="Model-building.html#cb78-25" aria-hidden="true" tabindex="-1"></a><span class="at">sls =</span> <span class="fl">0.15</span>,</span>
<span id="cb78-26"><a href="Model-building.html#cb78-26" aria-hidden="true" tabindex="-1"></a><span class="at">method =</span> <span class="fu">c</span>(<span class="st">&quot;efron&quot;</span>, <span class="st">&quot;breslow&quot;</span>, <span class="st">&quot;exact&quot;</span>),</span>
<span id="cb78-27"><a href="Model-building.html#cb78-27" aria-hidden="true" tabindex="-1"></a><span class="at">weights =</span> <span class="cn">NULL</span>,</span>
<span id="cb78-28"><a href="Model-building.html#cb78-28" aria-hidden="true" tabindex="-1"></a><span class="at">best =</span> <span class="cn">NULL</span>)</span>
<span id="cb78-29"><a href="Model-building.html#cb78-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-30"><a href="Model-building.html#cb78-30" aria-hidden="true" tabindex="-1"></a><span class="do">## 支持逻辑回归的变量筛选：</span></span>
<span id="cb78-31"><a href="Model-building.html#cb78-31" aria-hidden="true" tabindex="-1"></a><span class="fu">stepwiseLogit</span>(</span>
<span id="cb78-32"><a href="Model-building.html#cb78-32" aria-hidden="true" tabindex="-1"></a>formula,</span>
<span id="cb78-33"><a href="Model-building.html#cb78-33" aria-hidden="true" tabindex="-1"></a>data,</span>
<span id="cb78-34"><a href="Model-building.html#cb78-34" aria-hidden="true" tabindex="-1"></a><span class="at">include =</span> <span class="cn">NULL</span>,</span>
<span id="cb78-35"><a href="Model-building.html#cb78-35" aria-hidden="true" tabindex="-1"></a><span class="at">selection =</span> <span class="fu">c</span>(<span class="st">&quot;forward&quot;</span>, <span class="st">&quot;backward&quot;</span>, <span class="st">&quot;bidirection&quot;</span>, <span class="st">&quot;score&quot;</span>),</span>
<span id="cb78-36"><a href="Model-building.html#cb78-36" aria-hidden="true" tabindex="-1"></a><span class="at">select =</span> <span class="fu">c</span>(<span class="st">&quot;SL&quot;</span>, <span class="st">&quot;AIC&quot;</span>, <span class="st">&quot;AICc&quot;</span>, <span class="st">&quot;SBC&quot;</span>, <span class="st">&quot;HQ&quot;</span>, <span class="st">&quot;HQc&quot;</span>, <span class="st">&quot;IC(3/2)&quot;</span>, <span class="st">&quot;IC(1)&quot;</span>),</span>
<span id="cb78-37"><a href="Model-building.html#cb78-37" aria-hidden="true" tabindex="-1"></a><span class="at">sle =</span> <span class="fl">0.15</span>,</span>
<span id="cb78-38"><a href="Model-building.html#cb78-38" aria-hidden="true" tabindex="-1"></a>stepwiseLogit <span class="dv">9</span></span>
<span id="cb78-39"><a href="Model-building.html#cb78-39" aria-hidden="true" tabindex="-1"></a><span class="at">sls =</span> <span class="fl">0.15</span>,</span>
<span id="cb78-40"><a href="Model-building.html#cb78-40" aria-hidden="true" tabindex="-1"></a><span class="at">sigMethod =</span> <span class="fu">c</span>(<span class="st">&quot;Rao&quot;</span>, <span class="st">&quot;LRT&quot;</span>),</span>
<span id="cb78-41"><a href="Model-building.html#cb78-41" aria-hidden="true" tabindex="-1"></a><span class="at">weights =</span> <span class="cn">NULL</span>,</span>
<span id="cb78-42"><a href="Model-building.html#cb78-42" aria-hidden="true" tabindex="-1"></a><span class="at">best =</span> <span class="cn">NULL</span>)</span></code></pre></div>
</div>
<div id="逻辑回归筛选变量" class="section level5 hasAnchor" number="4.2.1.4.3">
<h5><span class="header-section-number">4.2.1.4.3</span> 逻辑回归筛选变量<a href="Model-building.html#逻辑回归筛选变量" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="Model-building.html#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse) <span class="co"># 加载数据处理包</span></span>
<span id="cb79-2"><a href="Model-building.html#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 读取数据</span></span>
<span id="cb79-3"><a href="Model-building.html#cb79-3" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&#39;Clinical/Clinical.RocData.Modified.csv&#39;</span>,<span class="at">show_col_types =</span> F)</span>
<span id="cb79-4"><a href="Model-building.html#cb79-4" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(data) <span class="co"># 查看数据类型</span></span>
<span id="cb79-5"><a href="Model-building.html#cb79-5" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data) <span class="co"># 查看变量名称</span></span>
<span id="cb79-6"><a href="Model-building.html#cb79-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 将分类变量处理成因子</span></span>
<span id="cb79-7"><a href="Model-building.html#cb79-7" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>Group <span class="ot">&lt;-</span> <span class="fu">factor</span>(data<span class="sc">$</span>Group, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&#39;0&#39;</span>,<span class="st">&#39;1&#39;</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&#39;Con&#39;</span>, <span class="st">&#39;AD&#39;</span>))</span>
<span id="cb79-8"><a href="Model-building.html#cb79-8" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>EducationLevel <span class="ot">&lt;-</span> <span class="fu">factor</span>(data<span class="sc">$</span>EducationLevel, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&#39;1&#39;</span>,<span class="st">&#39;2&#39;</span>,<span class="st">&#39;3&#39;</span>,<span class="st">&#39;4&#39;</span>,<span class="st">&#39;5&#39;</span>),</span>
<span id="cb79-9"><a href="Model-building.html#cb79-9" aria-hidden="true" tabindex="-1"></a>                              <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&#39;小学&#39;</span>, <span class="st">&#39;初中&#39;</span>, <span class="st">&#39;高中&#39;</span>, <span class="st">&#39;大学&#39;</span>, <span class="st">&#39;研究生&#39;</span>))</span>
<span id="cb79-10"><a href="Model-building.html#cb79-10" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>Gender <span class="ot">&lt;-</span> <span class="fu">factor</span>(data<span class="sc">$</span>Gender, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&#39;0&#39;</span>,<span class="st">&#39;1&#39;</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&#39;Female&#39;</span>, <span class="st">&#39;Male&#39;</span>))</span>
<span id="cb79-11"><a href="Model-building.html#cb79-11" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data) <span class="co"># 查看各变量的基本统计信息</span></span>
<span id="cb79-12"><a href="Model-building.html#cb79-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-13"><a href="Model-building.html#cb79-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 连续型自变量</span></span>
<span id="cb79-14"><a href="Model-building.html#cb79-14" aria-hidden="true" tabindex="-1"></a>x1 <span class="ot">&lt;-</span> <span class="fu">colnames</span>(data)[<span class="dv">4</span><span class="sc">:</span><span class="dv">60</span>]</span>
<span id="cb79-15"><a href="Model-building.html#cb79-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 分类自变量</span></span>
<span id="cb79-16"><a href="Model-building.html#cb79-16" aria-hidden="true" tabindex="-1"></a>x2 <span class="ot">&lt;-</span> <span class="fu">colnames</span>(data)[<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>]</span>
<span id="cb79-17"><a href="Model-building.html#cb79-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-18"><a href="Model-building.html#cb79-18" aria-hidden="true" tabindex="-1"></a><span class="co"># t检验--数据符合正态分布</span></span>
<span id="cb79-19"><a href="Model-building.html#cb79-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tableone)</span>
<span id="cb79-20"><a href="Model-building.html#cb79-20" aria-hidden="true" tabindex="-1"></a>table1 <span class="ot">&lt;-</span> <span class="fu">CreateTableOne</span>(<span class="at">vars =</span> <span class="fu">c</span>(x1, x2), <span class="co"># 指定对哪些变量进行分析</span></span>
<span id="cb79-21"><a href="Model-building.html#cb79-21" aria-hidden="true" tabindex="-1"></a>                         <span class="at">data =</span> data,</span>
<span id="cb79-22"><a href="Model-building.html#cb79-22" aria-hidden="true" tabindex="-1"></a>                         <span class="at">factorVars =</span> x2, <span class="co"># 指定分类变量</span></span>
<span id="cb79-23"><a href="Model-building.html#cb79-23" aria-hidden="true" tabindex="-1"></a>                         <span class="at">strata =</span> <span class="st">&#39;Group&#39;</span>, <span class="co"># 指定分组</span></span>
<span id="cb79-24"><a href="Model-building.html#cb79-24" aria-hidden="true" tabindex="-1"></a>                         <span class="co"># 是否对总样本进行分析</span></span>
<span id="cb79-25"><a href="Model-building.html#cb79-25" aria-hidden="true" tabindex="-1"></a>                         <span class="at">addOverall =</span> T)</span>
<span id="cb79-26"><a href="Model-building.html#cb79-26" aria-hidden="true" tabindex="-1"></a>result1 <span class="ot">&lt;-</span> <span class="fu">print</span>(table1, </span>
<span id="cb79-27"><a href="Model-building.html#cb79-27" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># 是否对分类变量全部展示</span></span>
<span id="cb79-28"><a href="Model-building.html#cb79-28" aria-hidden="true" tabindex="-1"></a>                 <span class="at">showAllLevels =</span> T) </span>
<span id="cb79-29"><a href="Model-building.html#cb79-29" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(result1, <span class="st">&#39;Clinical/单因素分析-t检验.csv&#39;</span>)</span>
<span id="cb79-30"><a href="Model-building.html#cb79-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-31"><a href="Model-building.html#cb79-31" aria-hidden="true" tabindex="-1"></a><span class="co"># 秩和检验</span></span>
<span id="cb79-32"><a href="Model-building.html#cb79-32" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tableone)</span>
<span id="cb79-33"><a href="Model-building.html#cb79-33" aria-hidden="true" tabindex="-1"></a>table2 <span class="ot">&lt;-</span> <span class="fu">CreateTableOne</span>(<span class="at">vars =</span> <span class="fu">c</span>(x1, x2), <span class="co"># 指定对哪些变量进行分析</span></span>
<span id="cb79-34"><a href="Model-building.html#cb79-34" aria-hidden="true" tabindex="-1"></a>                         <span class="at">data =</span> data,</span>
<span id="cb79-35"><a href="Model-building.html#cb79-35" aria-hidden="true" tabindex="-1"></a>                         <span class="at">factorVars =</span> x2, <span class="co"># 指定分类变量</span></span>
<span id="cb79-36"><a href="Model-building.html#cb79-36" aria-hidden="true" tabindex="-1"></a>                         <span class="at">strata =</span> <span class="st">&#39;Group&#39;</span>, <span class="co"># 指定分组</span></span>
<span id="cb79-37"><a href="Model-building.html#cb79-37" aria-hidden="true" tabindex="-1"></a>                         <span class="co"># 是否对总样本进行分析</span></span>
<span id="cb79-38"><a href="Model-building.html#cb79-38" aria-hidden="true" tabindex="-1"></a>                         <span class="at">addOverall =</span> F)</span>
<span id="cb79-39"><a href="Model-building.html#cb79-39" aria-hidden="true" tabindex="-1"></a>result2 <span class="ot">&lt;-</span> <span class="fu">print</span>(table2, </span>
<span id="cb79-40"><a href="Model-building.html#cb79-40" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># 是否对分类变量全部展示</span></span>
<span id="cb79-41"><a href="Model-building.html#cb79-41" aria-hidden="true" tabindex="-1"></a>                 <span class="at">showAllLevels =</span> F,</span>
<span id="cb79-42"><a href="Model-building.html#cb79-42" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># 指定非参数检验变量，exact选项可以指定确切概率检验的变量</span></span>
<span id="cb79-43"><a href="Model-building.html#cb79-43" aria-hidden="true" tabindex="-1"></a>                 <span class="at">nonnormal =</span> x1)</span>
<span id="cb79-44"><a href="Model-building.html#cb79-44" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(result2, <span class="st">&#39;Clinical/单因素分析-秩和检验.csv&#39;</span>)</span>
<span id="cb79-45"><a href="Model-building.html#cb79-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-46"><a href="Model-building.html#cb79-46" aria-hidden="true" tabindex="-1"></a><span class="co"># 单因素Logistic</span></span>
<span id="cb79-47"><a href="Model-building.html#cb79-47" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">glm</span>(Group<span class="sc">~</span>TP, <span class="at">data =</span> data, <span class="at">family =</span> <span class="fu">binomial</span>())</span>
<span id="cb79-48"><a href="Model-building.html#cb79-48" aria-hidden="true" tabindex="-1"></a><span class="co"># 查看模型结果</span></span>
<span id="cb79-49"><a href="Model-building.html#cb79-49" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb79-50"><a href="Model-building.html#cb79-50" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算OR值及可信区间</span></span>
<span id="cb79-51"><a href="Model-building.html#cb79-51" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">cbind</span>(<span class="st">&#39;OR&#39;</span> <span class="ot">=</span> <span class="fu">coef</span>(model), <span class="fu">confint</span>(model)))</span>
<span id="cb79-52"><a href="Model-building.html#cb79-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-53"><a href="Model-building.html#cb79-53" aria-hidden="true" tabindex="-1"></a><span class="co"># 多因素模型</span></span>
<span id="cb79-54"><a href="Model-building.html#cb79-54" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">glm</span>(Group<span class="sc">~</span>TP<span class="sc">+</span><span class="st">`</span><span class="at">LYMPH#</span><span class="st">`</span><span class="sc">+</span>SBP<span class="sc">+</span>DBP<span class="sc">+</span>NEUT<span class="sc">+</span>FN<span class="sc">+</span><span class="st">`</span><span class="at">APOA1/APOB</span><span class="st">`</span><span class="sc">+</span>APOA1<span class="sc">+</span>ALB<span class="sc">+</span>GLB, <span class="at">data =</span> data, <span class="at">family =</span> <span class="fu">binomial</span>())</span>
<span id="cb79-55"><a href="Model-building.html#cb79-55" aria-hidden="true" tabindex="-1"></a><span class="co"># 查看模型结果</span></span>
<span id="cb79-56"><a href="Model-building.html#cb79-56" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb79-57"><a href="Model-building.html#cb79-57" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算OR值及可信区间</span></span>
<span id="cb79-58"><a href="Model-building.html#cb79-58" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">cbind</span>(<span class="st">&#39;OR&#39;</span> <span class="ot">=</span> <span class="fu">coef</span>(model), <span class="fu">confint</span>(model)))</span>
<span id="cb79-59"><a href="Model-building.html#cb79-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-60"><a href="Model-building.html#cb79-60" aria-hidden="true" tabindex="-1"></a><span class="co"># 非常规先单后多-筛选协变量</span></span>
<span id="cb79-61"><a href="Model-building.html#cb79-61" aria-hidden="true" tabindex="-1"></a><span class="co"># 有用的思想是显著保留，不显著去除；</span></span>
<span id="cb79-62"><a href="Model-building.html#cb79-62" aria-hidden="true" tabindex="-1"></a><span class="co"># 指定自变量X是FN，剩下的都是协变量Z</span></span>
<span id="cb79-63"><a href="Model-building.html#cb79-63" aria-hidden="true" tabindex="-1"></a>covar_method <span class="ot">&lt;-</span> <span class="cf">function</span>(var){</span>
<span id="cb79-64"><a href="Model-building.html#cb79-64" aria-hidden="true" tabindex="-1"></a>    <span class="do">## 这里是保留了基本变量：</span></span>
<span id="cb79-65"><a href="Model-building.html#cb79-65" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">glm</span>(Group<span class="sc">~</span>FN, <span class="at">data =</span> data, <span class="at">family =</span> <span class="fu">binomial</span>())</span>
<span id="cb79-66"><a href="Model-building.html#cb79-66" aria-hidden="true" tabindex="-1"></a>  coef <span class="ot">&lt;-</span> <span class="fu">coef</span>(model)[<span class="dv">2</span>]</span>
<span id="cb79-67"><a href="Model-building.html#cb79-67" aria-hidden="true" tabindex="-1"></a>  form <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste0</span>(<span class="st">&#39;Group~FN+&#39;</span>,var))</span>
<span id="cb79-68"><a href="Model-building.html#cb79-68" aria-hidden="true" tabindex="-1"></a>    <span class="do">## 采用逐步纳入的方法进行遍历，遍历后保留OR值增加的变量；</span></span>
<span id="cb79-69"><a href="Model-building.html#cb79-69" aria-hidden="true" tabindex="-1"></a>  model2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(form, <span class="at">data =</span> data, <span class="at">family =</span> <span class="fu">binomial</span>())</span>
<span id="cb79-70"><a href="Model-building.html#cb79-70" aria-hidden="true" tabindex="-1"></a>  coef2 <span class="ot">&lt;-</span> <span class="fu">coef</span>(model2)[<span class="dv">2</span>]</span>
<span id="cb79-71"><a href="Model-building.html#cb79-71" aria-hidden="true" tabindex="-1"></a>  ratio <span class="ot">&lt;-</span> <span class="fu">abs</span>(coef2<span class="sc">-</span>coef)<span class="sc">/</span>coef</span>
<span id="cb79-72"><a href="Model-building.html#cb79-72" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (ratio <span class="sc">&gt;</span> <span class="fl">0.1</span>) {</span>
<span id="cb79-73"><a href="Model-building.html#cb79-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(var)</span>
<span id="cb79-74"><a href="Model-building.html#cb79-74" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb79-75"><a href="Model-building.html#cb79-75" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb79-76"><a href="Model-building.html#cb79-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-77"><a href="Model-building.html#cb79-77" aria-hidden="true" tabindex="-1"></a>var <span class="ot">&lt;-</span> <span class="fu">c</span>(x1,x2)</span>
<span id="cb79-78"><a href="Model-building.html#cb79-78" aria-hidden="true" tabindex="-1"></a>var <span class="ot">&lt;-</span> var[<span class="sc">-</span><span class="fu">which</span>(var <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;FN&#39;</span>, <span class="st">&#39;MoCA-B&#39;</span>,<span class="st">&#39;P-LCR&#39;</span>,<span class="st">&#39;HDL-c&#39;</span>,<span class="st">&#39;LDL-c&#39;</span>,<span class="st">&#39;RDE-SD&#39;</span>,<span class="st">&#39;APOA1/APOB&#39;</span>,<span class="st">&#39;A/G&#39;</span>,<span class="st">&#39;NEUT#&#39;</span>,</span>
<span id="cb79-79"><a href="Model-building.html#cb79-79" aria-hidden="true" tabindex="-1"></a>                             <span class="st">&#39;LYMPH#&#39;</span>,<span class="st">&#39;MONO#&#39;</span>,<span class="st">&#39;EO#&#39;</span>,<span class="st">&#39;BASO#&#39;</span>))] <span class="co">#去除一些变量名命名不规范的变量，以免引起错误</span></span>
<span id="cb79-80"><a href="Model-building.html#cb79-80" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(var, covar_method)</span>
<span id="cb79-81"><a href="Model-building.html#cb79-81" aria-hidden="true" tabindex="-1"></a><span class="co"># 将阳性的协变量与自变量一起进行多因素回归</span></span></code></pre></div>
</div>
<div id="岭回归ridge和脊回归lasso筛选变量" class="section level5 hasAnchor" number="4.2.1.4.4">
<h5><span class="header-section-number">4.2.1.4.4</span> 岭回归（ridge）和脊回归（lasso）筛选变量<a href="Model-building.html#岭回归ridge和脊回归lasso筛选变量" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="Model-building.html#cb80-1" aria-hidden="true" tabindex="-1"></a>对于高维数据，普通的变量筛选方法并不见效或者需要消耗大量计算成本和时间成本；且难以避免模型的过拟合及多重共线性问题。此时需要在模型拟合的RSS最小化过程中加入一个正则化项，称之为收缩惩罚；这个惩罚项包含了一个希腊字母λ和对系数β的权重规范化。（RSS<span class="sc">+</span>收缩惩罚最小化） 正则化可以对高维数据的系数进行限制，甚至将其缩减到0，避免多重共线性，也可以有效避免过拟合。（岭回归，LASSO，弹性回归） 岭回归中，正则化项是所有变量系数的平方和(L2<span class="sc">-</span>norm)，当λ增加时，系数βj缩小，趋向于0，但是永不为0. LASSO回归中，正则化项是变量系数的绝对值和(L1<span class="sc">-</span>norm)，这个收缩惩罚项可以使βj收缩到0，因此LASSO具有变量筛选的功能。但是当自变量存在高度共线性或高度两两相关时，LASSO可能会将某个自变量强制删除，这会损失模型预测能力！ 弹性网络中，当α等于0时，弹性网络等价于岭回归；当α等于1时，等价于LASSO；弹性网络技能做到岭回归不能做的变量筛选，又能实现LASSO不能做的变量分组。</span>
<span id="cb80-2"><a href="Model-building.html#cb80-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-3"><a href="Model-building.html#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="do">## 简单来说：</span></span>
<span id="cb80-4"><a href="Model-building.html#cb80-4" aria-hidden="true" tabindex="-1"></a>岭回归不能实现变量筛选，但可以实现一定程度的变量惩罚压缩；</span>
<span id="cb80-5"><a href="Model-building.html#cb80-5" aria-hidden="true" tabindex="-1"></a>脊回归能实现变量筛选；</span>
<span id="cb80-6"><a href="Model-building.html#cb80-6" aria-hidden="true" tabindex="-1"></a>弹性网络：既可以实现变量筛选，也可以做到变量压缩。</span>
<span id="cb80-7"><a href="Model-building.html#cb80-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-8"><a href="Model-building.html#cb80-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-9"><a href="Model-building.html#cb80-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(corrplot) <span class="co"># 相关系数分析用</span></span>
<span id="cb80-10"><a href="Model-building.html#cb80-10" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb80-11"><a href="Model-building.html#cb80-11" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span>
<span id="cb80-12"><a href="Model-building.html#cb80-12" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&#39;Clinical/Clinical.RocData.Modified.csv&#39;</span>,<span class="at">show_col_types =</span> F)</span>
<span id="cb80-13"><a href="Model-building.html#cb80-13" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(data)</span>
<span id="cb80-14"><a href="Model-building.html#cb80-14" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data) <span class="co"># 查看变量名称</span></span>
<span id="cb80-15"><a href="Model-building.html#cb80-15" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data)[<span class="dv">9</span>] <span class="ot">&lt;-</span> <span class="st">&#39;MoCA_B&#39;</span> </span>
<span id="cb80-16"><a href="Model-building.html#cb80-16" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data)[<span class="dv">22</span><span class="sc">:</span><span class="dv">26</span>] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;NEUT数&#39;</span>,<span class="st">&#39;LYMPH数&#39;</span>,<span class="st">&#39;MONO数&#39;</span>,<span class="st">&#39;EO数&#39;</span>,<span class="st">&#39;BASO数&#39;</span>) </span>
<span id="cb80-17"><a href="Model-building.html#cb80-17" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data)[<span class="dv">32</span><span class="sc">:</span><span class="dv">33</span>] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;RDE_SD&#39;</span>,<span class="st">&#39;P_LCR&#39;</span>) </span>
<span id="cb80-18"><a href="Model-building.html#cb80-18" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data)[<span class="dv">37</span>] <span class="ot">&lt;-</span> <span class="st">&#39;A与G的比值&#39;</span> </span>
<span id="cb80-19"><a href="Model-building.html#cb80-19" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data)[<span class="dv">54</span><span class="sc">:</span><span class="dv">55</span>] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;HDL_c&#39;</span>,<span class="st">&#39;LDL_c&#39;</span>) </span>
<span id="cb80-20"><a href="Model-building.html#cb80-20" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data)[<span class="dv">58</span>] <span class="ot">&lt;-</span> <span class="st">&#39;APOA1与APOB的比值&#39;</span> </span>
<span id="cb80-21"><a href="Model-building.html#cb80-21" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(data) <span class="co"># 进行NA的行删除，因为LASSO无法处理含有NA值的数据</span></span>
<span id="cb80-22"><a href="Model-building.html#cb80-22" aria-hidden="true" tabindex="-1"></a>corr <span class="ot">&lt;-</span> <span class="fu">cor</span>(<span class="fu">as.matrix</span>(data))</span>
<span id="cb80-23"><a href="Model-building.html#cb80-23" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(corr, <span class="st">&#39;Clinical/Correlation.csv&#39;</span>)</span>
<span id="cb80-24"><a href="Model-building.html#cb80-24" aria-hidden="true" tabindex="-1"></a><span class="fu">corrplot.mixed</span>(corr) <span class="co"># 简单进行可视化,查看是存在多重共线性，存在才进行LASSO</span></span>
<span id="cb80-25"><a href="Model-building.html#cb80-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-26"><a href="Model-building.html#cb80-26" aria-hidden="true" tabindex="-1"></a><span class="co"># LASSO(正则化技术)不要将分类变量处理成factor，若涉及多分类变量，手动设置哑变量（可用ifelse函数设置）</span></span>
<span id="cb80-27"><a href="Model-building.html#cb80-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 3分类举例：若data中存在一个变量X有A/B/C三个水平，此时需要将X处理成两个哑变量</span></span>
<span id="cb80-28"><a href="Model-building.html#cb80-28" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>X_B <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(data<span class="sc">$</span>X <span class="sc">==</span> <span class="st">&#39;B&#39;</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb80-29"><a href="Model-building.html#cb80-29" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>X_C <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(data<span class="sc">$</span>X <span class="sc">==</span> <span class="st">&#39;C&#39;</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb80-30"><a href="Model-building.html#cb80-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-31"><a href="Model-building.html#cb80-31" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet) <span class="co"># 通过glmnet函数进行岭回归，LASSO回归，弹性网络</span></span>
<span id="cb80-32"><a href="Model-building.html#cb80-32" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret) <span class="co"># 帮助鉴定合适的参数</span></span>
<span id="cb80-33"><a href="Model-building.html#cb80-33" aria-hidden="true" tabindex="-1"></a><span class="co"># 正则化技术需要将数据储存在矩阵里面，而不能是数据框</span></span>
<span id="cb80-34"><a href="Model-building.html#cb80-34" aria-hidden="true" tabindex="-1"></a><span class="co"># 将因变量和自变量处理成矩阵，自变量类型不能是double，否则报错</span></span>
<span id="cb80-35"><a href="Model-building.html#cb80-35" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(data[<span class="dv">2</span><span class="sc">:</span><span class="dv">60</span>])</span>
<span id="cb80-36"><a href="Model-building.html#cb80-36" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(data[<span class="dv">1</span>])</span>
<span id="cb80-37"><a href="Model-building.html#cb80-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-38"><a href="Model-building.html#cb80-38" aria-hidden="true" tabindex="-1"></a><span class="co"># glmnet()语法中alpha=0表示岭回归，1表示LASSO回归</span></span>
<span id="cb80-39"><a href="Model-building.html#cb80-39" aria-hidden="true" tabindex="-1"></a>myRidge <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(X, Y, <span class="at">alpha =</span> <span class="dv">0</span>, <span class="at">family =</span> <span class="st">&#39;binomial&#39;</span>, <span class="at">nlambda =</span> <span class="dv">1000</span>)</span>
<span id="cb80-40"><a href="Model-building.html#cb80-40" aria-hidden="true" tabindex="-1"></a>myRidge<span class="sc">$</span>lambda[<span class="dv">1000</span>] <span class="co"># 选最优模型的lambda值</span></span>
<span id="cb80-41"><a href="Model-building.html#cb80-41" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(myRidge) <span class="co"># L1范数与系数值之间的关系</span></span>
<span id="cb80-42"><a href="Model-building.html#cb80-42" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(myRidge, <span class="at">xvar =</span> <span class="st">&#39;lambda&#39;</span>) <span class="co"># lambda值减小，压缩参数也减小，而系数绝对值增大</span></span>
<span id="cb80-43"><a href="Model-building.html#cb80-43" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(myRidge, <span class="at">xvar =</span> <span class="st">&#39;dev&#39;</span>) <span class="co"># 随着偏差百分比增加，系数绝对值增加</span></span>
<span id="cb80-44"><a href="Model-building.html#cb80-44" aria-hidden="true" tabindex="-1"></a><span class="co"># 查看系数</span></span>
<span id="cb80-45"><a href="Model-building.html#cb80-45" aria-hidden="true" tabindex="-1"></a>myCoef <span class="ot">&lt;-</span> <span class="fu">coef</span>(myRidge, <span class="at">s =</span> <span class="fl">4.525281</span>)</span>
<span id="cb80-46"><a href="Model-building.html#cb80-46" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(<span class="fu">as.matrix</span>(myCoef),<span class="st">&#39;Clinical/岭回归系数.csv&#39;</span>)</span>
<span id="cb80-47"><a href="Model-building.html#cb80-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-48"><a href="Model-building.html#cb80-48" aria-hidden="true" tabindex="-1"></a><span class="co"># glmnet()语法中alpha=0表示岭回归，1表示LASSO回归</span></span>
<span id="cb80-49"><a href="Model-building.html#cb80-49" aria-hidden="true" tabindex="-1"></a>myLasso <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(X, Y, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="st">&#39;binomial&#39;</span>, <span class="at">nlambda =</span> <span class="dv">500</span>) <span class="co"># glmnet默认运行100次</span></span>
<span id="cb80-50"><a href="Model-building.html#cb80-50" aria-hidden="true" tabindex="-1"></a><span class="fu">NROW</span>(myLasso<span class="sc">$</span>lambda)</span>
<span id="cb80-51"><a href="Model-building.html#cb80-51" aria-hidden="true" tabindex="-1"></a>myLasso<span class="sc">$</span>lambda[<span class="dv">500</span>] <span class="co"># 选最优模型的lambda值</span></span>
<span id="cb80-52"><a href="Model-building.html#cb80-52" aria-hidden="true" tabindex="-1"></a>myLasso<span class="sc">$</span>df[<span class="dv">500</span>] <span class="co"># 最优模型留下的变量数</span></span>
<span id="cb80-53"><a href="Model-building.html#cb80-53" aria-hidden="true" tabindex="-1"></a><span class="co"># lambda = 0.004525281 收敛于最优解，有7个变量留下来</span></span>
<span id="cb80-54"><a href="Model-building.html#cb80-54" aria-hidden="true" tabindex="-1"></a><span class="co"># 绘制图形</span></span>
<span id="cb80-55"><a href="Model-building.html#cb80-55" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(myLasso, <span class="at">xvar =</span> <span class="st">&#39;lambda&#39;</span>, <span class="at">label =</span> T)</span>
<span id="cb80-56"><a href="Model-building.html#cb80-56" aria-hidden="true" tabindex="-1"></a>lasso.coef <span class="ot">&lt;-</span> <span class="fu">coef</span>(myLasso, <span class="at">s =</span> <span class="fl">0.004525281</span>) <span class="co"># 最优解下的回归系数</span></span>
<span id="cb80-57"><a href="Model-building.html#cb80-57" aria-hidden="true" tabindex="-1"></a><span class="co"># 只有筛选出的自变量才有回归系数</span></span>
<span id="cb80-58"><a href="Model-building.html#cb80-58" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(<span class="fu">as.matrix</span>(lasso.coef),<span class="st">&#39;Clinical/LASSO回归系数.csv&#39;</span>)</span>
<span id="cb80-59"><a href="Model-building.html#cb80-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-60"><a href="Model-building.html#cb80-60" aria-hidden="true" tabindex="-1"></a><span class="co"># 通过交叉验证进行LASSO回归</span></span>
<span id="cb80-61"><a href="Model-building.html#cb80-61" aria-hidden="true" tabindex="-1"></a>lambdas <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="fl">0.5</span>,<span class="at">length.out =</span> <span class="dv">200</span>)</span>
<span id="cb80-62"><a href="Model-building.html#cb80-62" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20220629</span>)</span>
<span id="cb80-63"><a href="Model-building.html#cb80-63" aria-hidden="true" tabindex="-1"></a><span class="co"># nfolds = 3，表示3折交叉验证</span></span>
<span id="cb80-64"><a href="Model-building.html#cb80-64" aria-hidden="true" tabindex="-1"></a>cv.lasso <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(X, Y, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">lambda =</span> lambdas, <span class="at">nfolds =</span> <span class="dv">5</span>, <span class="at">family =</span> <span class="st">&#39;binomial&#39;</span>)</span>
<span id="cb80-65"><a href="Model-building.html#cb80-65" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cv.lasso) <span class="co"># 纵坐标是MSE</span></span>
<span id="cb80-66"><a href="Model-building.html#cb80-66" aria-hidden="true" tabindex="-1"></a><span class="co"># 两条虚线：均方误差最小时对应的lambda对数值；距离最小均方误差1个标准误时对应的lambda对数值</span></span>
<span id="cb80-67"><a href="Model-building.html#cb80-67" aria-hidden="true" tabindex="-1"></a><span class="co"># 一般第二条虚线对应的是我们的最优解</span></span>
<span id="cb80-68"><a href="Model-building.html#cb80-68" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cv.lasso<span class="sc">$</span>glmnet.fit, <span class="at">xvar =</span> <span class="st">&#39;lambda&#39;</span>, <span class="at">label =</span> T)</span>
<span id="cb80-69"><a href="Model-building.html#cb80-69" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cv.lasso<span class="sc">$</span>glmnet.fit, <span class="at">xvar =</span> <span class="st">&#39;dev&#39;</span>, <span class="at">label =</span> T)</span>
<span id="cb80-70"><a href="Model-building.html#cb80-70" aria-hidden="true" tabindex="-1"></a><span class="co"># 如何找到最优lambda：通常距离最小均方误差（MSE）1个标准误时对应的lambda</span></span>
<span id="cb80-71"><a href="Model-building.html#cb80-71" aria-hidden="true" tabindex="-1"></a>lasso_lse <span class="ot">&lt;-</span> cv.lasso<span class="sc">$</span>lambda<span class="fl">.1</span>se <span class="co">#提取最优lambda</span></span>
<span id="cb80-72"><a href="Model-building.html#cb80-72" aria-hidden="true" tabindex="-1"></a>lasso.coef <span class="ot">&lt;-</span> <span class="fu">coef</span>(cv.lasso<span class="sc">$</span>glmnet.fit, <span class="at">s =</span> lasso_lse, <span class="at">exact =</span> F)</span>
<span id="cb80-73"><a href="Model-building.html#cb80-73" aria-hidden="true" tabindex="-1"></a><span class="co"># 没有回归系数的变量即为已剔除变量</span></span>
<span id="cb80-74"><a href="Model-building.html#cb80-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-75"><a href="Model-building.html#cb80-75" aria-hidden="true" tabindex="-1"></a><span class="co"># 弹性网络：寻找α和λ的最优组合</span></span>
<span id="cb80-76"><a href="Model-building.html#cb80-76" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">.alpha =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.1</span>), <span class="at">.lambda =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">0.2</span>, <span class="at">by =</span> <span class="fl">0.01</span>))</span>
<span id="cb80-77"><a href="Model-building.html#cb80-77" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(grid)</span>
<span id="cb80-78"><a href="Model-building.html#cb80-78" aria-hidden="true" tabindex="-1"></a><span class="fu">as.matrix</span>(<span class="fu">head</span>(grid))</span>
<span id="cb80-79"><a href="Model-building.html#cb80-79" aria-hidden="true" tabindex="-1"></a><span class="co"># trainControl函数设定重抽样的方法LOOCV(留一法)，cv(简单交叉验证)，bootstrp</span></span>
<span id="cb80-80"><a href="Model-building.html#cb80-80" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">&#39;LOOCV&#39;</span>) <span class="co"># 留一法消耗的时间是最多的</span></span>
<span id="cb80-81"><a href="Model-building.html#cb80-81" aria-hidden="true" tabindex="-1"></a><span class="co"># 弹性网络中必须将因变量处理成因子</span></span>
<span id="cb80-82"><a href="Model-building.html#cb80-82" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>Group <span class="ot">&lt;-</span> <span class="fu">factor</span>(data<span class="sc">$</span>Group)</span>
<span id="cb80-83"><a href="Model-building.html#cb80-83" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20220629</span>)</span>
<span id="cb80-84"><a href="Model-building.html#cb80-84" aria-hidden="true" tabindex="-1"></a>enet.train <span class="ot">&lt;-</span> <span class="fu">train</span>(Group <span class="sc">~</span> ., <span class="at">data =</span> data, <span class="at">method =</span> <span class="st">&#39;glmnet&#39;</span>,</span>
<span id="cb80-85"><a href="Model-building.html#cb80-85" aria-hidden="true" tabindex="-1"></a>                    <span class="at">trControl =</span> con, <span class="at">tuneGrid =</span> grid)</span>
<span id="cb80-86"><a href="Model-building.html#cb80-86" aria-hidden="true" tabindex="-1"></a>enet.train <span class="co"># 选择原则是Accuracy最大，最优参数是α = 0.7；λ = 0.2</span></span>
<span id="cb80-87"><a href="Model-building.html#cb80-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-88"><a href="Model-building.html#cb80-88" aria-hidden="true" tabindex="-1"></a><span class="co"># 用最优组合来拟合模型</span></span>
<span id="cb80-89"><a href="Model-building.html#cb80-89" aria-hidden="true" tabindex="-1"></a>enet <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(X, Y, <span class="at">family =</span> <span class="st">&#39;binomial&#39;</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">lambda =</span> <span class="fl">0.2</span>)</span>
<span id="cb80-90"><a href="Model-building.html#cb80-90" aria-hidden="true" tabindex="-1"></a>enet.coef <span class="ot">&lt;-</span> <span class="fu">coef</span>(enet, <span class="at">s =</span> <span class="fl">0.2</span>, <span class="at">exact =</span> T)</span>
<span id="cb80-91"><a href="Model-building.html#cb80-91" aria-hidden="true" tabindex="-1"></a>enet.coef</span></code></pre></div>
</div>
<div id="支持向量机" class="section level5 hasAnchor" number="4.2.1.4.5">
<h5><span class="header-section-number">4.2.1.4.5</span> 支持向量机<a href="Model-building.html#支持向量机" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="Model-building.html#cb81-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&#39;Clinical/Clinical.RocData.Modified.csv&#39;</span>,<span class="at">show_col_types =</span> F) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb81-2"><a href="Model-building.html#cb81-2" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(data) <span class="co"># 进行NA的行删除</span></span>
<span id="cb81-3"><a href="Model-building.html#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(data)</span>
<span id="cb81-4"><a href="Model-building.html#cb81-4" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data) <span class="co"># 查看变量名称</span></span>
<span id="cb81-5"><a href="Model-building.html#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data)[<span class="dv">9</span>] <span class="ot">&lt;-</span> <span class="st">&#39;MoCA_B&#39;</span> </span>
<span id="cb81-6"><a href="Model-building.html#cb81-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data)[<span class="dv">22</span><span class="sc">:</span><span class="dv">26</span>] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;NEUT数&#39;</span>,<span class="st">&#39;LYMPH数&#39;</span>,<span class="st">&#39;MONO数&#39;</span>,<span class="st">&#39;EO数&#39;</span>,<span class="st">&#39;BASO数&#39;</span>) </span>
<span id="cb81-7"><a href="Model-building.html#cb81-7" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data)[<span class="dv">32</span><span class="sc">:</span><span class="dv">33</span>] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;RDE_SD&#39;</span>,<span class="st">&#39;P_LCR&#39;</span>) </span>
<span id="cb81-8"><a href="Model-building.html#cb81-8" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data)[<span class="dv">37</span>] <span class="ot">&lt;-</span> <span class="st">&#39;A与G的比值&#39;</span> </span>
<span id="cb81-9"><a href="Model-building.html#cb81-9" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data)[<span class="dv">54</span><span class="sc">:</span><span class="dv">55</span>] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;HDL_c&#39;</span>,<span class="st">&#39;LDL_c&#39;</span>) </span>
<span id="cb81-10"><a href="Model-building.html#cb81-10" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data)[<span class="dv">58</span>] <span class="ot">&lt;-</span> <span class="st">&#39;APOA1与APOB的比值&#39;</span> </span>
<span id="cb81-11"><a href="Model-building.html#cb81-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-12"><a href="Model-building.html#cb81-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(e1071)</span>
<span id="cb81-13"><a href="Model-building.html#cb81-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 将因变量处理成因子型</span></span>
<span id="cb81-14"><a href="Model-building.html#cb81-14" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>Group <span class="ot">&lt;-</span> <span class="fu">factor</span>(data<span class="sc">$</span>Group)</span>
<span id="cb81-15"><a href="Model-building.html#cb81-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 线性核函数</span></span>
<span id="cb81-16"><a href="Model-building.html#cb81-16" aria-hidden="true" tabindex="-1"></a><span class="co"># tune.svm函数进行交叉验证选择最优cost成本函数</span></span>
<span id="cb81-17"><a href="Model-building.html#cb81-17" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20220629</span>)</span>
<span id="cb81-18"><a href="Model-building.html#cb81-18" aria-hidden="true" tabindex="-1"></a>linner.tune <span class="ot">&lt;-</span> <span class="fu">tune.svm</span>(Group <span class="sc">~</span> ., <span class="at">data =</span> data, <span class="at">kernal =</span> <span class="st">&#39;linner&#39;</span>, <span class="at">cost =</span> <span class="fu">c</span>(<span class="fl">0.001</span>,<span class="fl">0.01</span>,<span class="fl">0.1</span>,<span class="dv">1</span>,<span class="dv">5</span>,<span class="dv">10</span>))</span>
<span id="cb81-19"><a href="Model-building.html#cb81-19" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(linner.tune)</span>
<span id="cb81-20"><a href="Model-building.html#cb81-20" aria-hidden="true" tabindex="-1"></a><span class="co"># best parameters: cost = 0.01</span></span>
<span id="cb81-21"><a href="Model-building.html#cb81-21" aria-hidden="true" tabindex="-1"></a><span class="co"># best performance: 0.1583333</span></span>
<span id="cb81-22"><a href="Model-building.html#cb81-22" aria-hidden="true" tabindex="-1"></a>best.linner <span class="ot">&lt;-</span> linner.tune<span class="sc">$</span>best.model</span>
<span id="cb81-23"><a href="Model-building.html#cb81-23" aria-hidden="true" tabindex="-1"></a>best.linner</span>
<span id="cb81-24"><a href="Model-building.html#cb81-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 对拟合的最佳模型进行检验</span></span>
<span id="cb81-25"><a href="Model-building.html#cb81-25" aria-hidden="true" tabindex="-1"></a>linner.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(best.linner, <span class="at">newdata =</span> data)</span>
<span id="cb81-26"><a href="Model-building.html#cb81-26" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(linner.pred, data<span class="sc">$</span>Group)</span>
<span id="cb81-27"><a href="Model-building.html#cb81-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-28"><a href="Model-building.html#cb81-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 多项式核函数</span></span>
<span id="cb81-29"><a href="Model-building.html#cb81-29" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20220629</span>)</span>
<span id="cb81-30"><a href="Model-building.html#cb81-30" aria-hidden="true" tabindex="-1"></a>poly.tune <span class="ot">&lt;-</span> <span class="fu">tune.svm</span>(Group <span class="sc">~</span> ., <span class="at">data =</span> data, <span class="at">kernal =</span> <span class="st">&#39;polynomial&#39;</span>, </span>
<span id="cb81-31"><a href="Model-building.html#cb81-31" aria-hidden="true" tabindex="-1"></a>                      <span class="at">degree =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>), </span>
<span id="cb81-32"><a href="Model-building.html#cb81-32" aria-hidden="true" tabindex="-1"></a>                      <span class="at">coef0 =</span> <span class="fu">c</span>(<span class="fl">0.1</span>,<span class="fl">0.5</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>))</span>
<span id="cb81-33"><a href="Model-building.html#cb81-33" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(poly.tune)</span>
<span id="cb81-34"><a href="Model-building.html#cb81-34" aria-hidden="true" tabindex="-1"></a><span class="co"># best parameters: degree = 3, coef0 = 0.1</span></span>
<span id="cb81-35"><a href="Model-building.html#cb81-35" aria-hidden="true" tabindex="-1"></a><span class="co"># best performance: 0.08333333 </span></span>
<span id="cb81-36"><a href="Model-building.html#cb81-36" aria-hidden="true" tabindex="-1"></a>best.poly <span class="ot">&lt;-</span> poly.tune<span class="sc">$</span>best.model</span>
<span id="cb81-37"><a href="Model-building.html#cb81-37" aria-hidden="true" tabindex="-1"></a>best.poly</span>
<span id="cb81-38"><a href="Model-building.html#cb81-38" aria-hidden="true" tabindex="-1"></a><span class="co"># 对拟合的最佳模型进行检验</span></span>
<span id="cb81-39"><a href="Model-building.html#cb81-39" aria-hidden="true" tabindex="-1"></a>poly.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(best.poly, <span class="at">newdata =</span> data)</span>
<span id="cb81-40"><a href="Model-building.html#cb81-40" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(poly.pred, data<span class="sc">$</span>Group)</span>
<span id="cb81-41"><a href="Model-building.html#cb81-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-42"><a href="Model-building.html#cb81-42" aria-hidden="true" tabindex="-1"></a><span class="co"># 径向基核函数</span></span>
<span id="cb81-43"><a href="Model-building.html#cb81-43" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20220629</span>)</span>
<span id="cb81-44"><a href="Model-building.html#cb81-44" aria-hidden="true" tabindex="-1"></a>rbf.tune <span class="ot">&lt;-</span> <span class="fu">tune.svm</span>(Group <span class="sc">~</span> ., <span class="at">data =</span> data, <span class="at">kernal =</span> <span class="st">&#39;radial&#39;</span>, <span class="at">gamma =</span> <span class="fu">c</span>(<span class="fl">0.5</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>))</span>
<span id="cb81-45"><a href="Model-building.html#cb81-45" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(rbf.tune)</span>
<span id="cb81-46"><a href="Model-building.html#cb81-46" aria-hidden="true" tabindex="-1"></a><span class="co"># best parameters: gamma = 3</span></span>
<span id="cb81-47"><a href="Model-building.html#cb81-47" aria-hidden="true" tabindex="-1"></a><span class="co"># best performance: 0.425 </span></span>
<span id="cb81-48"><a href="Model-building.html#cb81-48" aria-hidden="true" tabindex="-1"></a>best.rbf <span class="ot">&lt;-</span> rbf.tune<span class="sc">$</span>best.model</span>
<span id="cb81-49"><a href="Model-building.html#cb81-49" aria-hidden="true" tabindex="-1"></a>best.rbf</span>
<span id="cb81-50"><a href="Model-building.html#cb81-50" aria-hidden="true" tabindex="-1"></a><span class="co"># 对拟合的最佳模型进行检验</span></span>
<span id="cb81-51"><a href="Model-building.html#cb81-51" aria-hidden="true" tabindex="-1"></a>rbf.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(best.rbf, <span class="at">newdata =</span> data)</span>
<span id="cb81-52"><a href="Model-building.html#cb81-52" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(rbf.pred, data<span class="sc">$</span>Group)</span>
<span id="cb81-53"><a href="Model-building.html#cb81-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-54"><a href="Model-building.html#cb81-54" aria-hidden="true" tabindex="-1"></a><span class="co"># sigmoid核函数</span></span>
<span id="cb81-55"><a href="Model-building.html#cb81-55" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20220629</span>)</span>
<span id="cb81-56"><a href="Model-building.html#cb81-56" aria-hidden="true" tabindex="-1"></a>sigmoid.tune <span class="ot">&lt;-</span> <span class="fu">tune.svm</span>(Group <span class="sc">~</span> ., <span class="at">data =</span> data, <span class="at">kernal =</span> <span class="st">&#39;sigmoid&#39;</span>, </span>
<span id="cb81-57"><a href="Model-building.html#cb81-57" aria-hidden="true" tabindex="-1"></a>                         <span class="at">gamma =</span> <span class="fu">c</span>(<span class="fl">0.1</span>,<span class="fl">0.5</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>),</span>
<span id="cb81-58"><a href="Model-building.html#cb81-58" aria-hidden="true" tabindex="-1"></a>                         <span class="at">coef0 =</span> <span class="fu">c</span>(<span class="fl">0.1</span>,<span class="fl">0.5</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>))</span>
<span id="cb81-59"><a href="Model-building.html#cb81-59" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(sigmoid.tune)</span>
<span id="cb81-60"><a href="Model-building.html#cb81-60" aria-hidden="true" tabindex="-1"></a><span class="co"># best parameters: gamma = 3, coef0 = 0.1</span></span>
<span id="cb81-61"><a href="Model-building.html#cb81-61" aria-hidden="true" tabindex="-1"></a><span class="co"># best performance: 0.425 </span></span>
<span id="cb81-62"><a href="Model-building.html#cb81-62" aria-hidden="true" tabindex="-1"></a>best.sigmoid <span class="ot">&lt;-</span> sigmoid.tune<span class="sc">$</span>best.model</span>
<span id="cb81-63"><a href="Model-building.html#cb81-63" aria-hidden="true" tabindex="-1"></a>best.sigmoid</span>
<span id="cb81-64"><a href="Model-building.html#cb81-64" aria-hidden="true" tabindex="-1"></a><span class="co"># 对拟合的最佳模型进行检验</span></span>
<span id="cb81-65"><a href="Model-building.html#cb81-65" aria-hidden="true" tabindex="-1"></a>sigmoid.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(best.sigmoid, <span class="at">newdata =</span> data)</span>
<span id="cb81-66"><a href="Model-building.html#cb81-66" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(sigmoid.pred, data<span class="sc">$</span>Group)</span>
<span id="cb81-67"><a href="Model-building.html#cb81-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-68"><a href="Model-building.html#cb81-68" aria-hidden="true" tabindex="-1"></a><span class="co"># 四种核函数最佳模型</span></span>
<span id="cb81-69"><a href="Model-building.html#cb81-69" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb81-70"><a href="Model-building.html#cb81-70" aria-hidden="true" tabindex="-1"></a><span class="fu">confusionMatrix</span>(poly.pred, data<span class="sc">$</span>Group, <span class="at">positive =</span> <span class="st">&#39;1&#39;</span>)</span>
<span id="cb81-71"><a href="Model-building.html#cb81-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-72"><a href="Model-building.html#cb81-72" aria-hidden="true" tabindex="-1"></a><span class="co"># 支持向量机的变量筛选</span></span>
<span id="cb81-73"><a href="Model-building.html#cb81-73" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20220629</span>)</span>
<span id="cb81-74"><a href="Model-building.html#cb81-74" aria-hidden="true" tabindex="-1"></a><span class="co"># 设置筛选方法</span></span>
<span id="cb81-75"><a href="Model-building.html#cb81-75" aria-hidden="true" tabindex="-1"></a>selecMeth <span class="ot">&lt;-</span> <span class="fu">rfeControl</span>(<span class="at">functions =</span> lrFuncs, </span>
<span id="cb81-76"><a href="Model-building.html#cb81-76" aria-hidden="true" tabindex="-1"></a>                        <span class="at">method =</span> <span class="st">&#39;cv&#39;</span>, <span class="co"># 指定是交叉验证</span></span>
<span id="cb81-77"><a href="Model-building.html#cb81-77" aria-hidden="true" tabindex="-1"></a>                        <span class="at">number =</span> <span class="dv">10</span>) <span class="co"># 指定nfold数</span></span>
<span id="cb81-78"><a href="Model-building.html#cb81-78" aria-hidden="true" tabindex="-1"></a><span class="co"># rfe函数中有3种变量筛选方法：svmLinner; svmPoly; svmRadial</span></span>
<span id="cb81-79"><a href="Model-building.html#cb81-79" aria-hidden="true" tabindex="-1"></a><span class="co"># size指定自变量个数</span></span>
<span id="cb81-80"><a href="Model-building.html#cb81-80" aria-hidden="true" tabindex="-1"></a><span class="co"># 指定自变量和因变量</span></span>
<span id="cb81-81"><a href="Model-building.html#cb81-81" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> data[,<span class="dv">2</span><span class="sc">:</span><span class="dv">60</span>]</span>
<span id="cb81-82"><a href="Model-building.html#cb81-82" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> data[,<span class="dv">1</span>]</span>
<span id="cb81-83"><a href="Model-building.html#cb81-83" aria-hidden="true" tabindex="-1"></a>svm.feature <span class="ot">&lt;-</span> <span class="fu">rfe</span>(X,Y,<span class="at">sizes =</span> <span class="dv">30</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">rfeControl =</span> selecMeth, <span class="at">method =</span> <span class="st">&#39;svmPoly&#39;</span>)</span>
<span id="cb81-84"><a href="Model-building.html#cb81-84" aria-hidden="true" tabindex="-1"></a>svm.feature <span class="co"># TP, MMSE, MoCA_B, DBP</span></span>
<span id="cb81-85"><a href="Model-building.html#cb81-85" aria-hidden="true" tabindex="-1"></a><span class="co"># 利用筛选出的自变量进行分析</span></span>
<span id="cb81-86"><a href="Model-building.html#cb81-86" aria-hidden="true" tabindex="-1"></a>svm<span class="fl">.4</span> <span class="ot">&lt;-</span> <span class="fu">svm</span>(Group <span class="sc">~</span> TP<span class="sc">+</span>MMSE<span class="sc">+</span>MoCA_B<span class="sc">+</span>DBP, <span class="at">data =</span> data,</span>
<span id="cb81-87"><a href="Model-building.html#cb81-87" aria-hidden="true" tabindex="-1"></a>             <span class="at">kernel =</span> <span class="st">&#39;polynomial&#39;</span>, <span class="at">degree =</span> <span class="dv">3</span>, <span class="at">coef0 =</span> <span class="fl">0.1</span>)</span>
<span id="cb81-88"><a href="Model-building.html#cb81-88" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data)</span>
<span id="cb81-89"><a href="Model-building.html#cb81-89" aria-hidden="true" tabindex="-1"></a><span class="co"># 对模型进行预测</span></span>
<span id="cb81-90"><a href="Model-building.html#cb81-90" aria-hidden="true" tabindex="-1"></a>svm.<span class="fl">4.</span>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(svm<span class="fl">.4</span>, <span class="at">newdata =</span> data[,<span class="fu">c</span>(<span class="dv">34</span>,<span class="dv">8</span>,<span class="dv">9</span>,<span class="dv">6</span>)])</span>
<span id="cb81-91"><a href="Model-building.html#cb81-91" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(svm.<span class="fl">4.</span>pred, data<span class="sc">$</span>Group)</span>
<span id="cb81-92"><a href="Model-building.html#cb81-92" aria-hidden="true" tabindex="-1"></a><span class="co"># 图形绘制</span></span>
<span id="cb81-93"><a href="Model-building.html#cb81-93" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(svm<span class="fl">.4</span>, <span class="at">data =</span> data, </span>
<span id="cb81-94"><a href="Model-building.html#cb81-94" aria-hidden="true" tabindex="-1"></a>     TP <span class="sc">~</span> MoCA_B, <span class="co"># 只展现2维的，维度过高不易观察</span></span>
<span id="cb81-95"><a href="Model-building.html#cb81-95" aria-hidden="true" tabindex="-1"></a>     <span class="at">svSymbol =</span> <span class="dv">2</span>, <span class="co"># 指定支持向量的形状为三角形</span></span>
<span id="cb81-96"><a href="Model-building.html#cb81-96" aria-hidden="true" tabindex="-1"></a>     <span class="at">dataSymbol =</span> <span class="dv">1</span>) <span class="co"># 支持向量之外的数据为圆圈</span></span></code></pre></div>
</div>
<div id="随机森林变量筛选" class="section level5 hasAnchor" number="4.2.1.4.6">
<h5><span class="header-section-number">4.2.1.4.6</span> 随机森林变量筛选<a href="Model-building.html#随机森林变量筛选" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="Model-building.html#cb82-1" aria-hidden="true" tabindex="-1"></a>为提升模型的预测能力，我们可以生成多个树模型，然后将树模型的结果组合起来。随机森林的两个方法：装袋<span class="sc">&amp;</span>变量随机。 使用数据集的约2<span class="sc">/</span>3的数据建立树模型，剩下的1<span class="sc">/</span>3成为袋外数据（验证前期建立的模型的准确率），这个过程重复N次，最后取平均结果。每个树都任其生长，不进行任何基于测量误差的剪枝，这意味着每一个树模型的方差都很大。但是对多个树模型进行平均化，可以降低方差，同时又不增加偏差。 除了对样本进行随机选择，我们对自变量也进行随机选择。对于分类问题，每次抽取的自变量数是自变量总数的平方根；对于回归问题，每次抽取的自变量数是自变量总数的1<span class="sc">/</span>3。 </span>
<span id="cb82-2"><a href="Model-building.html#cb82-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-3"><a href="Model-building.html#cb82-3" aria-hidden="true" tabindex="-1"></a>随机森林可以对变量的重要性进行评分和排序，并不能实现变量的筛选。</span>
<span id="cb82-4"><a href="Model-building.html#cb82-4" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&#39;Clinical/Clinical.RocData.Modified.csv&#39;</span>,<span class="at">show_col_types =</span> F)</span>
<span id="cb82-5"><a href="Model-building.html#cb82-5" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(data)</span>
<span id="cb82-6"><a href="Model-building.html#cb82-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data) <span class="co"># 查看变量名称</span></span>
<span id="cb82-7"><a href="Model-building.html#cb82-7" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(data) <span class="co"># 进行NA的行删除，防止bug</span></span>
<span id="cb82-8"><a href="Model-building.html#cb82-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 因变量：Group，1表示疾病，0表示对照</span></span>
<span id="cb82-9"><a href="Model-building.html#cb82-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 自变量：连续变量和分类变量都有（将分类变量处理成factor--2分类是否处理成因子不影响结果，</span></span>
<span id="cb82-10"><a href="Model-building.html#cb82-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 多分类必须处理成因子）</span></span>
<span id="cb82-11"><a href="Model-building.html#cb82-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 将分类变量处理成因子</span></span>
<span id="cb82-12"><a href="Model-building.html#cb82-12" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data)[<span class="dv">9</span>] <span class="ot">&lt;-</span> <span class="st">&#39;MoCA_B&#39;</span> </span>
<span id="cb82-13"><a href="Model-building.html#cb82-13" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data)[<span class="dv">22</span><span class="sc">:</span><span class="dv">26</span>] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;NEUT数&#39;</span>,<span class="st">&#39;LYMPH数&#39;</span>,<span class="st">&#39;MONO数&#39;</span>,<span class="st">&#39;EO数&#39;</span>,<span class="st">&#39;BASO数&#39;</span>) </span>
<span id="cb82-14"><a href="Model-building.html#cb82-14" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data)[<span class="dv">32</span><span class="sc">:</span><span class="dv">33</span>] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;RDE_SD&#39;</span>,<span class="st">&#39;P_LCR&#39;</span>) </span>
<span id="cb82-15"><a href="Model-building.html#cb82-15" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data)[<span class="dv">37</span>] <span class="ot">&lt;-</span> <span class="st">&#39;A与G的比值&#39;</span> </span>
<span id="cb82-16"><a href="Model-building.html#cb82-16" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data)[<span class="dv">54</span><span class="sc">:</span><span class="dv">55</span>] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;HDL_c&#39;</span>,<span class="st">&#39;LDL_c&#39;</span>) </span>
<span id="cb82-17"><a href="Model-building.html#cb82-17" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data)[<span class="dv">58</span>] <span class="ot">&lt;-</span> <span class="st">&#39;APOA1与APOB的比值&#39;</span> </span>
<span id="cb82-18"><a href="Model-building.html#cb82-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 将因变量处理成factor</span></span>
<span id="cb82-19"><a href="Model-building.html#cb82-19" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>Group <span class="ot">&lt;-</span> <span class="fu">factor</span>(data<span class="sc">$</span>Group, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&#39;0&#39;</span>,<span class="st">&#39;1&#39;</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&#39;Con&#39;</span>, <span class="st">&#39;AD&#39;</span>))</span>
<span id="cb82-20"><a href="Model-building.html#cb82-20" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>EducationLevel <span class="ot">&lt;-</span> <span class="fu">factor</span>(data<span class="sc">$</span>EducationLevel, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&#39;1&#39;</span>,<span class="st">&#39;2&#39;</span>,<span class="st">&#39;3&#39;</span>,<span class="st">&#39;4&#39;</span>,<span class="st">&#39;5&#39;</span>),</span>
<span id="cb82-21"><a href="Model-building.html#cb82-21" aria-hidden="true" tabindex="-1"></a>                              <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&#39;小学&#39;</span>, <span class="st">&#39;初中&#39;</span>, <span class="st">&#39;高中&#39;</span>, <span class="st">&#39;大学&#39;</span>, <span class="st">&#39;研究生&#39;</span>))</span>
<span id="cb82-22"><a href="Model-building.html#cb82-22" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>Gender <span class="ot">&lt;-</span> <span class="fu">factor</span>(data<span class="sc">$</span>Gender, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&#39;0&#39;</span>,<span class="st">&#39;1&#39;</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&#39;Female&#39;</span>, <span class="st">&#39;Male&#39;</span>))</span>
<span id="cb82-23"><a href="Model-building.html#cb82-23" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(data) <span class="co"># 查看各变量的基本统计信息</span></span>
<span id="cb82-24"><a href="Model-building.html#cb82-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-25"><a href="Model-building.html#cb82-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 随机森林的拟合</span></span>
<span id="cb82-26"><a href="Model-building.html#cb82-26" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span>
<span id="cb82-27"><a href="Model-building.html#cb82-27" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span>
<span id="cb82-28"><a href="Model-building.html#cb82-28" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20220627</span>) <span class="co"># 因为方法有随机选择，所以需要设置随机数，保证代码的复现性</span></span>
<span id="cb82-29"><a href="Model-building.html#cb82-29" aria-hidden="true" tabindex="-1"></a>model1 <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(Group<span class="sc">~</span>., <span class="at">data =</span> data)</span>
<span id="cb82-30"><a href="Model-building.html#cb82-30" aria-hidden="true" tabindex="-1"></a>model1</span>
<span id="cb82-31"><a href="Model-building.html#cb82-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Call:</span></span>
<span id="cb82-32"><a href="Model-building.html#cb82-32" aria-hidden="true" tabindex="-1"></a><span class="co">#   randomForest(formula = Group ~ ., data = data) </span></span>
<span id="cb82-33"><a href="Model-building.html#cb82-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Type of random forest: classification # 使用的是分类随机森林模型</span></span>
<span id="cb82-34"><a href="Model-building.html#cb82-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of trees: 500 # 生成了500棵不同的树</span></span>
<span id="cb82-35"><a href="Model-building.html#cb82-35" aria-hidden="true" tabindex="-1"></a><span class="co"># No. of variables tried at each split: 7 #每次树的分枝随机抽取7个变量</span></span>
<span id="cb82-36"><a href="Model-building.html#cb82-36" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb82-37"><a href="Model-building.html#cb82-37" aria-hidden="true" tabindex="-1"></a><span class="co"># OOB estimate of  error rate: 2.63% # 袋外数据估计的错误率是2.63%</span></span>
<span id="cb82-38"><a href="Model-building.html#cb82-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Confusion matrix:</span></span>
<span id="cb82-39"><a href="Model-building.html#cb82-39" aria-hidden="true" tabindex="-1"></a><span class="co">#   Con AD class.error</span></span>
<span id="cb82-40"><a href="Model-building.html#cb82-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Con  20  0  0.00000000 #预测错误率是0</span></span>
<span id="cb82-41"><a href="Model-building.html#cb82-41" aria-hidden="true" tabindex="-1"></a><span class="co"># AD    1 17  0.05555556 #预测错误率是0.056</span></span>
<span id="cb82-42"><a href="Model-building.html#cb82-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-43"><a href="Model-building.html#cb82-43" aria-hidden="true" tabindex="-1"></a><span class="co"># 画误差和树数量的关系图</span></span>
<span id="cb82-44"><a href="Model-building.html#cb82-44" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model1)</span>
<span id="cb82-45"><a href="Model-building.html#cb82-45" aria-hidden="true" tabindex="-1"></a><span class="co"># 绿色的线表示AD的误差</span></span>
<span id="cb82-46"><a href="Model-building.html#cb82-46" aria-hidden="true" tabindex="-1"></a><span class="co"># 红色的线表示Con的误差</span></span>
<span id="cb82-47"><a href="Model-building.html#cb82-47" aria-hidden="true" tabindex="-1"></a><span class="co"># 黑色的线表示总样本的误差</span></span>
<span id="cb82-48"><a href="Model-building.html#cb82-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-49"><a href="Model-building.html#cb82-49" aria-hidden="true" tabindex="-1"></a><span class="co"># 找出总样本最小误差对应的树数量</span></span>
<span id="cb82-50"><a href="Model-building.html#cb82-50" aria-hidden="true" tabindex="-1"></a><span class="fu">which.min</span>(model1<span class="sc">$</span>err.rate[,<span class="dv">1</span>])</span>
<span id="cb82-51"><a href="Model-building.html#cb82-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-52"><a href="Model-building.html#cb82-52" aria-hidden="true" tabindex="-1"></a><span class="co"># 重新拟合模型，将ntree = 47，mtry设置每次迭代次数</span></span>
<span id="cb82-53"><a href="Model-building.html#cb82-53" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20220627</span>) <span class="co"># 因为方法有随机选择，所以需要设置随机数，保证代码的复现性</span></span>
<span id="cb82-54"><a href="Model-building.html#cb82-54" aria-hidden="true" tabindex="-1"></a>model2 <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(Group<span class="sc">~</span>., <span class="at">data =</span> data, <span class="at">ntree =</span> <span class="dv">47</span>, <span class="at">mtry =</span> <span class="dv">7</span>)</span>
<span id="cb82-55"><a href="Model-building.html#cb82-55" aria-hidden="true" tabindex="-1"></a>model2</span>
<span id="cb82-56"><a href="Model-building.html#cb82-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-57"><a href="Model-building.html#cb82-57" aria-hidden="true" tabindex="-1"></a><span class="co"># 变量的重要性评分</span></span>
<span id="cb82-58"><a href="Model-building.html#cb82-58" aria-hidden="true" tabindex="-1"></a><span class="fu">importance</span>(model2)</span>
<span id="cb82-59"><a href="Model-building.html#cb82-59" aria-hidden="true" tabindex="-1"></a><span class="co"># 绘制图形</span></span>
<span id="cb82-60"><a href="Model-building.html#cb82-60" aria-hidden="true" tabindex="-1"></a><span class="fu">varImpPlot</span>(model2)</span></code></pre></div>
</div>
<div id="lasso回归做cox变量选择" class="section level5 hasAnchor" number="4.2.1.4.7">
<h5><span class="header-section-number">4.2.1.4.7</span> Lasso回归做COX变量选择<a href="Model-building.html#lasso回归做cox变量选择" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="Model-building.html#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 这里唯一的区别就是将生存数据纳入其中，并需要指定分布族为“cox”形式：</span></span>
<span id="cb83-2"><a href="Model-building.html#cb83-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-3"><a href="Model-building.html#cb83-3" aria-hidden="true" tabindex="-1"></a><span class="do">## 筛选变量前，首先将自变量数据（因子变量）转变成矩阵（matrix）</span></span>
<span id="cb83-4"><a href="Model-building.html#cb83-4" aria-hidden="true" tabindex="-1"></a>x.factors <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> dt<span class="sc">$</span>oper.name<span class="sc">+</span>dt<span class="sc">$</span>relapse<span class="sc">+</span>dt<span class="sc">$</span>group.tumor.dia<span class="sc">+</span>dt<span class="sc">$</span>sex<span class="sc">+</span>dt<span class="sc">$</span>age.group<span class="sc">+</span>dt<span class="sc">$</span>region<span class="sc">+</span>dt<span class="sc">$</span>smoking<span class="sc">+</span>dt<span class="sc">$</span>group.hepth.medical.his<span class="sc">+</span>dt<span class="sc">$</span>group.ther.be.op<span class="sc">+</span>dt<span class="sc">$</span>BCLC<span class="sc">+</span>dt<span class="sc">$</span>group.melt.time<span class="sc">+</span>dt<span class="sc">$</span>tumor.single.double<span class="sc">+</span>dt<span class="sc">$</span>group.tumor.num<span class="sc">+</span>dt<span class="sc">$</span>group.tumor.size<span class="sc">+</span>dt<span class="sc">$</span>group.tumor.location<span class="sc">+</span>dt<span class="sc">$</span>AFP<span class="sc">+</span>dt<span class="sc">$</span>CEA<span class="sc">+</span>dt<span class="sc">$</span>CA199,dt)[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb83-5"><a href="Model-building.html#cb83-5" aria-hidden="true" tabindex="-1"></a><span class="co">#将矩阵的因子变量与其它定量边量合并成数据框，定义了自变量。</span></span>
<span id="cb83-6"><a href="Model-building.html#cb83-6" aria-hidden="true" tabindex="-1"></a>x<span class="ot">=</span><span class="fu">as.matrix</span>(<span class="fu">data.frame</span>(x.factors,dt[,<span class="fu">c</span>(<span class="dv">21</span><span class="sc">:</span><span class="dv">44</span>)]))</span>
<span id="cb83-7"><a href="Model-building.html#cb83-7" aria-hidden="true" tabindex="-1"></a><span class="co">#设置应变量，生存时间和生存状态（生存数据）</span></span>
<span id="cb83-8"><a href="Model-building.html#cb83-8" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">data.matrix</span>(<span class="fu">Surv</span>(dt<span class="sc">$</span>live.time,dt<span class="sc">$</span>outcome))</span>
<span id="cb83-9"><a href="Model-building.html#cb83-9" aria-hidden="true" tabindex="-1"></a><span class="co">#调用glmnet包中的glmnet函数，注意family那里一定要制定是“cox”，如果是做logistic需要换成&quot;binomial&quot;。</span></span>
<span id="cb83-10"><a href="Model-building.html#cb83-10" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span><span class="fu">glmnet</span>(x,y,<span class="at">family =</span> <span class="st">&quot;cox&quot;</span>,<span class="at">alpha =</span> <span class="dv">1</span>)</span>
<span id="cb83-11"><a href="Model-building.html#cb83-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit,<span class="at">label=</span>T)</span>
<span id="cb83-12"><a href="Model-building.html#cb83-12" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit,<span class="at">xvar=</span><span class="st">&quot;lambda&quot;</span>,<span class="at">label=</span>T) <span class="do">##见图一</span></span>
<span id="cb83-13"><a href="Model-building.html#cb83-13" aria-hidden="true" tabindex="-1"></a><span class="co">#主要在做交叉验证,lasso</span></span>
<span id="cb83-14"><a href="Model-building.html#cb83-14" aria-hidden="true" tabindex="-1"></a>fitcv <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(x,y,<span class="at">family=</span><span class="st">&quot;cox&quot;</span>, <span class="at">alpha=</span><span class="dv">1</span>,<span class="at">nfolds=</span><span class="dv">10</span>)</span>
<span id="cb83-15"><a href="Model-building.html#cb83-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fitcv)  <span class="do">## 见图2</span></span>
<span id="cb83-16"><a href="Model-building.html#cb83-16" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fitcv) <span class="do">## 1个标准差对应变量少，选此收缩系数</span></span>
<span id="cb83-17"><a href="Model-building.html#cb83-17" aria-hidden="true" tabindex="-1"></a><span class="do">##      Lambda Measure     SE Nonzero</span></span>
<span id="cb83-18"><a href="Model-building.html#cb83-18" aria-hidden="true" tabindex="-1"></a><span class="do">## min 0.02632   11.96 0.2057      21</span></span>
<span id="cb83-19"><a href="Model-building.html#cb83-19" aria-hidden="true" tabindex="-1"></a><span class="do">## 1se 0.11661   12.15 0.1779       5</span></span>
<span id="cb83-20"><a href="Model-building.html#cb83-20" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(fitcv, <span class="at">s=</span><span class="st">&quot;lambda.1se&quot;</span>)</span></code></pre></div>
</div>
<div id="最优子集模型筛选变量" class="section level5 hasAnchor" number="4.2.1.4.8">
<h5><span class="header-section-number">4.2.1.4.8</span> 最优子集模型筛选变量<a href="Model-building.html#最优子集模型筛选变量" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="Model-building.html#cb84-1" aria-hidden="true" tabindex="-1"></a>最优子集回归是多元线性回归方程的自变量选择的一类方法。从全部自变量所有可能的自变量组合的子集回归方程中挑选最优者。如m个自变量会拟合2m<span class="sc">-</span>1个子集回归方程,然后用回归方程的统计量作准则(如交叉验证误差、Cp、BIC、调整R2等指标)从中挑选。</span>
<span id="cb84-2"><a href="Model-building.html#cb84-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-3"><a href="Model-building.html#cb84-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-4"><a href="Model-building.html#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leaps)</span>
<span id="cb84-5"><a href="Model-building.html#cb84-5" aria-hidden="true" tabindex="-1"></a>sub.fit <span class="ot">&lt;-</span> <span class="fu">regsubsets</span>(BSAAM <span class="sc">~</span> ., <span class="at">data =</span> data)<span class="co"># 执行最优子集回归</span></span>
<span id="cb84-6"><a href="Model-building.html#cb84-6" aria-hidden="true" tabindex="-1"></a>best.summary <span class="ot">&lt;-</span> <span class="fu">summary</span>(sub.fit)</span>
<span id="cb84-7"><a href="Model-building.html#cb84-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 按照模型评价标准找到评价指标</span></span>
<span id="cb84-8"><a href="Model-building.html#cb84-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 执行最优子集回归后返回的是自变量组合的子集回归方程，以及每个回归方程对应的评价指标,采用which函数选取最优的回归方程。其中调整R2越大越好，马洛斯Cp越小越好。</span></span>
<span id="cb84-9"><a href="Model-building.html#cb84-9" aria-hidden="true" tabindex="-1"></a><span class="fu">which.min</span>(best.summary<span class="sc">$</span>cp)<span class="co">#马洛斯Cp值</span></span>
<span id="cb84-10"><a href="Model-building.html#cb84-10" aria-hidden="true" tabindex="-1"></a><span class="fu">which.max</span>(best.summary<span class="sc">$</span>adjr2) <span class="co">#调整R2</span></span>
<span id="cb84-11"><a href="Model-building.html#cb84-11" aria-hidden="true" tabindex="-1"></a><span class="fu">which.min</span>(best.summary<span class="sc">$</span>bic) <span class="co">#贝叶斯信息准则</span></span>
<span id="cb84-12"><a href="Model-building.html#cb84-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-13"><a href="Model-building.html#cb84-13" aria-hidden="true" tabindex="-1"></a><span class="do">## 通过作图观测最佳变量集合的数量集：</span></span>
<span id="cb84-14"><a href="Model-building.html#cb84-14" aria-hidden="true" tabindex="-1"></a>将返回结果的调整R2作图，可以看到在模型变量个数为3的时候，调整R2最大。<span class="fu">plot</span>(best.summary<span class="sc">$</span>adjr2, <span class="at">type =</span> <span class="st">&quot;l&quot;</span>,<span class="at">xlab =</span> <span class="st">&quot;numbers of Features&quot;</span>, </span>
<span id="cb84-15"><a href="Model-building.html#cb84-15" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">&quot;adjr2&quot;</span>,<span class="at">main =</span> <span class="st">&quot;adjr2 by Feature Inclusion&quot;</span>)</span>
<span id="cb84-16"><a href="Model-building.html#cb84-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-17"><a href="Model-building.html#cb84-17" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(sub.fit, <span class="at">scale =</span> <span class="st">&quot;adjr2&quot;</span>,<span class="at">main =</span> <span class="st">&quot;Best Subset Features&quot;</span>)</span>
<span id="cb84-18"><a href="Model-building.html#cb84-18" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(sub.fit, <span class="dv">3</span>)</span>
<span id="cb84-19"><a href="Model-building.html#cb84-19" aria-hidden="true" tabindex="-1"></a><span class="co">#(Intercept)     APSLAKE      OPRC      OPSLAKE </span></span>
<span id="cb84-20"><a href="Model-building.html#cb84-20" aria-hidden="true" tabindex="-1"></a><span class="co">#  15424.597    1712.481    1797.465    2389.838</span></span>
<span id="cb84-21"><a href="Model-building.html#cb84-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-22"><a href="Model-building.html#cb84-22" aria-hidden="true" tabindex="-1"></a><span class="do">## 以往的学习思路中常忘记处理这一步：</span></span>
<span id="cb84-23"><a href="Model-building.html#cb84-23" aria-hidden="true" tabindex="-1"></a><span class="do">## 将筛选的变量建模并进行共线性检查，方差膨胀系数大于5说明有严重的共线性。对这两个强相关的变量，我们分别做模型，挑选调整R2大的模型。最终我们保留f3模型。</span></span>
<span id="cb84-24"><a href="Model-building.html#cb84-24" aria-hidden="true" tabindex="-1"></a>f2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(BSAAM <span class="sc">~</span> APSLAKE <span class="sc">+</span> OPRC <span class="sc">+</span> OPSLAKE, <span class="at">data =</span> data)</span>
<span id="cb84-25"><a href="Model-building.html#cb84-25" aria-hidden="true" tabindex="-1"></a><span class="fu">vif</span>(f2)</span>
<span id="cb84-26"><a href="Model-building.html#cb84-26" aria-hidden="true" tabindex="-1"></a>APSLAKE     OPRC     OPSLAKE </span>
<span id="cb84-27"><a href="Model-building.html#cb84-27" aria-hidden="true" tabindex="-1"></a><span class="fl">1.011499</span>  <span class="fl">6.452569</span>   <span class="fl">6.444748</span></span>
<span id="cb84-28"><a href="Model-building.html#cb84-28" aria-hidden="true" tabindex="-1"></a><span class="do">####这两个强相关的变量分别做模型，挑选R2 大的模型</span></span>
<span id="cb84-29"><a href="Model-building.html#cb84-29" aria-hidden="true" tabindex="-1"></a>f3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(BSAAM <span class="sc">~</span> APSLAKE <span class="sc">+</span> OPSLAKE, <span class="at">data =</span> data)<span class="co">#调整R2:0.9002</span></span>
<span id="cb84-30"><a href="Model-building.html#cb84-30" aria-hidden="true" tabindex="-1"></a>f4 <span class="ot">&lt;-</span> <span class="fu">lm</span>(BSAAM <span class="sc">~</span> APSLAKE <span class="sc">+</span> OPRC, <span class="at">data =</span> data)<span class="co">#调整R2:0.862</span></span></code></pre></div>
</div>
</div>
</div>
<div id="线性统计回归" class="section level3 hasAnchor" number="4.2.2">
<h3><span class="header-section-number">4.2.2</span> 线性统计回归<a href="Model-building.html#线性统计回归" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="一般线性模型" class="section level4 hasAnchor" number="4.2.2.1">
<h4><span class="header-section-number">4.2.2.1</span> 一般线性模型：<a href="Model-building.html#一般线性模型" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="Model-building.html#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 构建数据：</span></span>
<span id="cb85-2"><a href="Model-building.html#cb85-2" aria-hidden="true" tabindex="-1"></a>students <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;https://userpage.fu-berlin.de/soga/200/2010_data_sets/students.csv&quot;</span>)</span>
<span id="cb85-3"><a href="Model-building.html#cb85-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">12</span></span>
<span id="cb85-4"><a href="Model-building.html#cb85-4" aria-hidden="true" tabindex="-1"></a>sample.idx <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(students), n)</span>
<span id="cb85-5"><a href="Model-building.html#cb85-5" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> students[sample.idx , <span class="fu">c</span>(<span class="st">&#39;height&#39;</span>,<span class="st">&#39;weight&#39;</span>)]</span>
<span id="cb85-6"><a href="Model-building.html#cb85-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-7"><a href="Model-building.html#cb85-7" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> data<span class="sc">$</span>height</span>
<span id="cb85-8"><a href="Model-building.html#cb85-8" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> data<span class="sc">$</span>weight</span>
<span id="cb85-9"><a href="Model-building.html#cb85-9" aria-hidden="true" tabindex="-1"></a>x.bar <span class="ot">&lt;-</span> <span class="fu">mean</span>(x)</span>
<span id="cb85-10"><a href="Model-building.html#cb85-10" aria-hidden="true" tabindex="-1"></a>y.bar <span class="ot">&lt;-</span> <span class="fu">mean</span>(y)</span>
<span id="cb85-11"><a href="Model-building.html#cb85-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-12"><a href="Model-building.html#cb85-12" aria-hidden="true" tabindex="-1"></a>b1 <span class="ot">&lt;-</span> <span class="fu">sum</span>((x<span class="sc">-</span>x.bar)<span class="sc">*</span>(y<span class="sc">-</span>y.bar)) <span class="sc">/</span> <span class="fu">sum</span>((x<span class="sc">-</span>x.bar)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb85-13"><a href="Model-building.html#cb85-13" aria-hidden="true" tabindex="-1"></a>b1</span>
<span id="cb85-14"><a href="Model-building.html#cb85-14" aria-hidden="true" tabindex="-1"></a><span class="do">## 求解线性斜率：</span></span>
<span id="cb85-15"><a href="Model-building.html#cb85-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cov</span>(x,y) <span class="sc">/</span> <span class="fu">var</span>(x)</span>
<span id="cb85-16"><a href="Model-building.html#cb85-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-17"><a href="Model-building.html#cb85-17" aria-hidden="true" tabindex="-1"></a><span class="do">## 求解截距：</span></span>
<span id="cb85-18"><a href="Model-building.html#cb85-18" aria-hidden="true" tabindex="-1"></a>b0 <span class="ot">&lt;-</span> y.bar <span class="sc">-</span> b1<span class="sc">*</span>x.bar</span>
<span id="cb85-19"><a href="Model-building.html#cb85-19" aria-hidden="true" tabindex="-1"></a>b0</span>
<span id="cb85-20"><a href="Model-building.html#cb85-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-21"><a href="Model-building.html#cb85-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-22"><a href="Model-building.html#cb85-22" aria-hidden="true" tabindex="-1"></a><span class="do">## 使用一般线性方程求解：</span></span>
<span id="cb85-23"><a href="Model-building.html#cb85-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 一般线性方程也被称之为广义线性模型：</span></span>
<span id="cb85-24"><a href="Model-building.html#cb85-24" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lm</span>(weight <span class="sc">~</span> height, <span class="at">data =</span> data)</span>
<span id="cb85-25"><a href="Model-building.html#cb85-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 查看建模结果：</span></span>
<span id="cb85-26"><a href="Model-building.html#cb85-26" aria-hidden="true" tabindex="-1"></a>model</span>
<span id="cb85-27"><a href="Model-building.html#cb85-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-28"><a href="Model-building.html#cb85-28" aria-hidden="true" tabindex="-1"></a><span class="do">## 查看截距和斜率：</span></span>
<span id="cb85-29"><a href="Model-building.html#cb85-29" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(model)</span>
<span id="cb85-30"><a href="Model-building.html#cb85-30" aria-hidden="true" tabindex="-1"></a><span class="do">## 在给定置信区间中查看斜率和截距的范围：</span></span>
<span id="cb85-31"><a href="Model-building.html#cb85-31" aria-hidden="true" tabindex="-1"></a><span class="fu">confint.default</span>(model, <span class="at">level =</span> <span class="fl">0.90</span>)</span>
<span id="cb85-32"><a href="Model-building.html#cb85-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-33"><a href="Model-building.html#cb85-33" aria-hidden="true" tabindex="-1"></a><span class="do">## 查看模型的残差：</span></span>
<span id="cb85-34"><a href="Model-building.html#cb85-34" aria-hidden="true" tabindex="-1"></a><span class="fu">residuals</span>(model)</span>
<span id="cb85-35"><a href="Model-building.html#cb85-35" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">residuals</span>(model))</span>
<span id="cb85-36"><a href="Model-building.html#cb85-36" aria-hidden="true" tabindex="-1"></a><span class="do">## 一个好的模型需要残差满足两个基本条件：</span></span>
<span id="cb85-37"><a href="Model-building.html#cb85-37" aria-hidden="true" tabindex="-1"></a><span class="co"># 第1是残差的和基本等于0，并且再0轴附近上下波动；</span></span>
<span id="cb85-38"><a href="Model-building.html#cb85-38" aria-hidden="true" tabindex="-1"></a><span class="co"># 第2是残差服从正态分布，这包括测试集和训练集都要服从；】</span></span>
<span id="cb85-39"><a href="Model-building.html#cb85-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-40"><a href="Model-building.html#cb85-40" aria-hidden="true" tabindex="-1"></a><span class="do">## 可视化建模结果：</span></span>
<span id="cb85-41"><a href="Model-building.html#cb85-41" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(data<span class="sc">$</span>height, data<span class="sc">$</span>weight)</span>
<span id="cb85-42"><a href="Model-building.html#cb85-42" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(model, <span class="at">col =</span> <span class="st">&#39;red&#39;</span>)</span>
<span id="cb85-43"><a href="Model-building.html#cb85-43" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&quot;topleft&quot;</span>,</span>
<span id="cb85-44"><a href="Model-building.html#cb85-44" aria-hidden="true" tabindex="-1"></a>       <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">&#39;data points&#39;</span>, <span class="st">&#39;regression line&#39;</span>), </span>
<span id="cb85-45"><a href="Model-building.html#cb85-45" aria-hidden="true" tabindex="-1"></a>       <span class="at">cex =</span> <span class="fl">0.7</span>, </span>
<span id="cb85-46"><a href="Model-building.html#cb85-46" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">&#39;black&#39;</span>, <span class="st">&#39;red&#39;</span>), </span>
<span id="cb85-47"><a href="Model-building.html#cb85-47" aria-hidden="true" tabindex="-1"></a>       <span class="at">lwd =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="dv">1</span>), </span>
<span id="cb85-48"><a href="Model-building.html#cb85-48" aria-hidden="true" tabindex="-1"></a>       <span class="at">pch =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="cn">NA</span>))</span>
<span id="cb85-49"><a href="Model-building.html#cb85-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-50"><a href="Model-building.html#cb85-50" aria-hidden="true" tabindex="-1"></a><span class="do">## 查看模型的效应对应拟合值：</span></span>
<span id="cb85-51"><a href="Model-building.html#cb85-51" aria-hidden="true" tabindex="-1"></a><span class="fu">fitted</span>(model)</span>
<span id="cb85-52"><a href="Model-building.html#cb85-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-53"><a href="Model-building.html#cb85-53" aria-hidden="true" tabindex="-1"></a><span class="do">## 将拟合值纳入到可视化比较中：</span></span>
<span id="cb85-54"><a href="Model-building.html#cb85-54" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(data<span class="sc">$</span>height, data<span class="sc">$</span>weight)</span>
<span id="cb85-55"><a href="Model-building.html#cb85-55" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(model, <span class="at">col =</span><span class="st">&#39;red&#39;</span>)</span>
<span id="cb85-56"><a href="Model-building.html#cb85-56" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(data<span class="sc">$</span>height, <span class="fu">fitted</span>(model), <span class="at">col =</span> <span class="st">&#39;green&#39;</span>, <span class="at">pch =</span> <span class="dv">15</span>, <span class="at">cex =</span> <span class="fl">0.7</span>)</span>
<span id="cb85-57"><a href="Model-building.html#cb85-57" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&quot;topleft&quot;</span>,</span>
<span id="cb85-58"><a href="Model-building.html#cb85-58" aria-hidden="true" tabindex="-1"></a>       <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">&#39;data points&#39;</span>, <span class="st">&#39;regression line&#39;</span>, <span class="st">&#39;fitted values&#39;</span>), </span>
<span id="cb85-59"><a href="Model-building.html#cb85-59" aria-hidden="true" tabindex="-1"></a>       <span class="at">cex =</span> <span class="fl">0.7</span>, </span>
<span id="cb85-60"><a href="Model-building.html#cb85-60" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">&#39;black&#39;</span>, <span class="st">&#39;red&#39;</span>, <span class="st">&#39;green&#39;</span>), </span>
<span id="cb85-61"><a href="Model-building.html#cb85-61" aria-hidden="true" tabindex="-1"></a>       <span class="at">lwd =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="dv">1</span>, <span class="cn">NA</span>), </span>
<span id="cb85-62"><a href="Model-building.html#cb85-62" aria-hidden="true" tabindex="-1"></a>       <span class="at">pch =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="cn">NA</span>, <span class="dv">15</span>))</span>
<span id="cb85-63"><a href="Model-building.html#cb85-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-64"><a href="Model-building.html#cb85-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-65"><a href="Model-building.html#cb85-65" aria-hidden="true" tabindex="-1"></a><span class="do">## 模型预测：</span></span>
<span id="cb85-66"><a href="Model-building.html#cb85-66" aria-hidden="true" tabindex="-1"></a>new.data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">height=</span><span class="fu">c</span>(<span class="dv">165</span>, <span class="dv">172</span>, <span class="dv">183</span>))</span>
<span id="cb85-67"><a href="Model-building.html#cb85-67" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(model, new.data)</span>
<span id="cb85-68"><a href="Model-building.html#cb85-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-69"><a href="Model-building.html#cb85-69" aria-hidden="true" tabindex="-1"></a><span class="do">## 在给定预测区间中设置范围：</span></span>
<span id="cb85-70"><a href="Model-building.html#cb85-70" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(model, <span class="at">interval =</span> <span class="st">&quot;confidence&quot;</span>, <span class="at">level =</span> <span class="fl">0.99</span>)</span>
<span id="cb85-71"><a href="Model-building.html#cb85-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-72"><a href="Model-building.html#cb85-72" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(model, <span class="at">interval =</span> <span class="st">&quot;prediction&quot;</span>, <span class="at">level =</span> <span class="fl">0.99</span>)</span>
<span id="cb85-73"><a href="Model-building.html#cb85-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-74"><a href="Model-building.html#cb85-74" aria-hidden="true" tabindex="-1"></a><span class="do">## 可视化置信区间范围：</span></span>
<span id="cb85-75"><a href="Model-building.html#cb85-75" aria-hidden="true" tabindex="-1"></a>new.values <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(data<span class="sc">$</span>height)<span class="sc">*</span><span class="fl">0.5</span>, <span class="fu">max</span>(data<span class="sc">$</span>height)<span class="sc">*</span><span class="fl">1.5</span>, <span class="at">by =</span> <span class="fl">0.1</span>)</span>
<span id="cb85-76"><a href="Model-building.html#cb85-76" aria-hidden="true" tabindex="-1"></a>conf <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> <span class="fu">list</span>(<span class="st">&#39;height&#39;</span> <span class="ot">=</span> new.values), <span class="at">interval=</span><span class="st">&quot;confidence&quot;</span>, <span class="at">level =</span> <span class="fl">0.99</span>)</span>
<span id="cb85-77"><a href="Model-building.html#cb85-77" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> <span class="fu">list</span>(<span class="st">&#39;height&#39;</span> <span class="ot">=</span> new.values), <span class="at">interval=</span><span class="st">&quot;prediction&quot;</span>, <span class="at">level =</span> <span class="fl">0.99</span>)</span>
<span id="cb85-78"><a href="Model-building.html#cb85-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-79"><a href="Model-building.html#cb85-79" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(data<span class="sc">$</span>height, data<span class="sc">$</span>weight)</span>
<span id="cb85-80"><a href="Model-building.html#cb85-80" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(model, <span class="at">col=</span><span class="st">&#39;red&#39;</span>)</span>
<span id="cb85-81"><a href="Model-building.html#cb85-81" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(new.values, conf[,<span class="st">&#39;lwr&#39;</span>])</span>
<span id="cb85-82"><a href="Model-building.html#cb85-82" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(new.values, conf[,<span class="st">&#39;upr&#39;</span>])</span>
<span id="cb85-83"><a href="Model-building.html#cb85-83" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(new.values, pred[,<span class="st">&#39;lwr&#39;</span>], <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb85-84"><a href="Model-building.html#cb85-84" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(new.values, pred[,<span class="st">&#39;upr&#39;</span>], <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb85-85"><a href="Model-building.html#cb85-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-86"><a href="Model-building.html#cb85-86" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&quot;topleft&quot;</span>,</span>
<span id="cb85-87"><a href="Model-building.html#cb85-87" aria-hidden="true" tabindex="-1"></a>       <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">&#39;data points&#39;</span>, <span class="st">&#39;regression line&#39;</span>, <span class="st">&#39;confidence bands&#39;</span>, <span class="st">&#39;prediction bands&#39;</span>), </span>
<span id="cb85-88"><a href="Model-building.html#cb85-88" aria-hidden="true" tabindex="-1"></a>       <span class="at">cex =</span> <span class="fl">0.7</span>, </span>
<span id="cb85-89"><a href="Model-building.html#cb85-89" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">&#39;black&#39;</span>, <span class="st">&#39;red&#39;</span>, <span class="st">&#39;black&#39;</span>,<span class="st">&#39;black&#39;</span>), </span>
<span id="cb85-90"><a href="Model-building.html#cb85-90" aria-hidden="true" tabindex="-1"></a>       <span class="at">lwd =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>), </span>
<span id="cb85-91"><a href="Model-building.html#cb85-91" aria-hidden="true" tabindex="-1"></a>       <span class="at">lty =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>),</span>
<span id="cb85-92"><a href="Model-building.html#cb85-92" aria-hidden="true" tabindex="-1"></a>       <span class="at">pch =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>))</span>
<span id="cb85-93"><a href="Model-building.html#cb85-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-94"><a href="Model-building.html#cb85-94" aria-hidden="true" tabindex="-1"></a><span class="do">## 多项式线性模型拟合：</span></span>
<span id="cb85-95"><a href="Model-building.html#cb85-95" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> <span class="fu">poly</span>(x, <span class="dv">2</span>), <span class="at">data =</span> poly.data)</span>
<span id="cb85-96"><a href="Model-building.html#cb85-96" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x <span class="sc">+</span> <span class="fu">I</span>(x<span class="sc">^</span><span class="dv">2</span>), <span class="at">data =</span> poly.data)</span></code></pre></div>
</div>
<div id="广义线性模型" class="section level4 hasAnchor" number="4.2.2.2">
<h4><span class="header-section-number">4.2.2.2</span> 广义线性模型<a href="Model-building.html#广义线性模型" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<pre><code>广义线性模型（generalize linear model，GLM）扩展了线性模型的框架，它允许非正态响应变量的分析。
广义线性模型是一类服务于一组来自指数分布族的响应变量的模型框架，正态分布、指数分布、伽马分布、卡方分布、贝塔分布、伯努利分布、二项分布、负二项分布、多项分布、泊松分布、集合分布等都属于指数分布族。它们覆盖了生物学数据类型的更大范围，因此广义线性模型也广泛用于生物学领域的数据分析中。</code></pre>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="Model-building.html#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 建模方法的选择：</span></span>
<span id="cb87-2"><a href="Model-building.html#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 连续变量：</span></span>
<span id="cb87-3"><a href="Model-building.html#cb87-3" aria-hidden="true" tabindex="-1"></a>例如血糖变化值：使用协方差分析模型（一般线性模型）；</span>
<span id="cb87-4"><a href="Model-building.html#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="do">## 时间次数：</span></span>
<span id="cb87-5"><a href="Model-building.html#cb87-5" aria-hidden="true" tabindex="-1"></a>例如呕吐次数：使用Posiison回归模型；</span>
<span id="cb87-6"><a href="Model-building.html#cb87-6" aria-hidden="true" tabindex="-1"></a>如果一定时间内次数间隔断层较大，则使用负二项回归；</span>
<span id="cb87-7"><a href="Model-building.html#cb87-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 改善率：</span></span>
<span id="cb87-8"><a href="Model-building.html#cb87-8" aria-hidden="true" tabindex="-1"></a>logisitic回归模型；</span>
<span id="cb87-9"><a href="Model-building.html#cb87-9" aria-hidden="true" tabindex="-1"></a><span class="do">## OS,PFS:</span></span>
<span id="cb87-10"><a href="Model-building.html#cb87-10" aria-hidden="true" tabindex="-1"></a>COX比例风险模型；</span></code></pre></div>
<div id="二分类logistic-回归" class="section level5 hasAnchor" number="4.2.2.2.1">
<h5><span class="header-section-number">4.2.2.2.1</span> 2.3.1 二分类logistic 回归：<a href="Model-building.html#二分类logistic-回归" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="Model-building.html#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 二分类logistic 回归：</span></span>
<span id="cb88-2"><a href="Model-building.html#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 变量筛选：</span></span>
<span id="cb88-3"><a href="Model-building.html#cb88-3" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="fu">as.formula</span>(formula_all),<span class="at">data =</span> target_data)</span>
<span id="cb88-4"><a href="Model-building.html#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb88-5"><a href="Model-building.html#cb88-5" aria-hidden="true" tabindex="-1"></a>step.model <span class="ot">&lt;-</span> <span class="fu">stepAIC</span>(m2,<span class="at">direction =</span> <span class="st">&#39;backward&#39;</span>,<span class="at">trace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb88-6"><a href="Model-building.html#cb88-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(step.model)</span>
<span id="cb88-7"><a href="Model-building.html#cb88-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 结合stepAIC给出的变量参考建议：</span></span>
<span id="cb88-8"><a href="Model-building.html#cb88-8" aria-hidden="true" tabindex="-1"></a><span class="fu">drop1</span>(step.model)</span>
<span id="cb88-9"><a href="Model-building.html#cb88-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-10"><a href="Model-building.html#cb88-10" aria-hidden="true" tabindex="-1"></a><span class="do">## 如果客户确认后的总变量超过了10个，还是用adjusted R square好一点：</span></span>
<span id="cb88-11"><a href="Model-building.html#cb88-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-12"><a href="Model-building.html#cb88-12" aria-hidden="true" tabindex="-1"></a><span class="do">## 构建glm回归：</span></span>
<span id="cb88-13"><a href="Model-building.html#cb88-13" aria-hidden="true" tabindex="-1"></a><span class="do">## 基于上一步变量筛选来构筑新的模型：</span></span>
<span id="cb88-14"><a href="Model-building.html#cb88-14" aria-hidden="true" tabindex="-1"></a><span class="do">## 构建新模型：</span></span>
<span id="cb88-15"><a href="Model-building.html#cb88-15" aria-hidden="true" tabindex="-1"></a>new_model <span class="ot">=</span> <span class="fu">glm</span>(x <span class="sc">~</span> age <span class="sc">+</span> 下肢疾病并发症 <span class="sc">+</span> 口服降糖药 <span class="sc">+</span> 心血管药物 <span class="sc">+</span> 糖化血红蛋白 <span class="sc">+</span> 总胆固醇 <span class="sc">+</span> 低密度脂蛋白,<span class="at">data =</span> target_data,<span class="at">family =</span> binomial)</span>
<span id="cb88-16"><a href="Model-building.html#cb88-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-17"><a href="Model-building.html#cb88-17" aria-hidden="true" tabindex="-1"></a><span class="do">## 计算协变量的OR值：</span></span>
<span id="cb88-18"><a href="Model-building.html#cb88-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算OR值及可信区间</span></span>
<span id="cb88-19"><a href="Model-building.html#cb88-19" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">cbind</span>(<span class="st">&#39;OR&#39;</span> <span class="ot">=</span> <span class="fu">coef</span>(model), <span class="fu">confint</span>(new_model)))</span>
<span id="cb88-20"><a href="Model-building.html#cb88-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-21"><a href="Model-building.html#cb88-21" aria-hidden="true" tabindex="-1"></a><span class="do">## 回归可视化：</span></span>
<span id="cb88-22"><a href="Model-building.html#cb88-22" aria-hidden="true" tabindex="-1"></a>new_model <span class="sc">%&gt;%</span> <span class="fu">tbl_regression</span>(</span>
<span id="cb88-23"><a href="Model-building.html#cb88-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">exponentiate =</span><span class="cn">TRUE</span>,</span>
<span id="cb88-24"><a href="Model-building.html#cb88-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">pvalue_fun =</span> <span class="sc">~</span><span class="fu">style_pvalue</span>(.x,<span class="at">digits =</span><span class="dv">2</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb88-25"><a href="Model-building.html#cb88-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_global_p</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb88-26"><a href="Model-building.html#cb88-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bold_p</span>(<span class="at">t=</span><span class="fl">0.1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb88-27"><a href="Model-building.html#cb88-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bold_labels</span>() <span class="sc">%&gt;%</span> <span class="fu">italicize_levels</span>()</span></code></pre></div>
</div>
<div id="多分类logistic-回归" class="section level5 hasAnchor" number="4.2.2.2.2">
<h5><span class="header-section-number">4.2.2.2.2</span> 2.3.2 多分类logistic 回归：<a href="Model-building.html#多分类logistic-回归" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="Model-building.html#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 有序多分类和无序多分类的区别说明：</span></span>
<span id="cb89-2"><a href="Model-building.html#cb89-2" aria-hidden="true" tabindex="-1"></a>· 如果Y有多个选项，并且各个选项之间可以对比大小，例如，1代表“不愿意”，2代表“无所谓”，3代表“愿意”，这3个选项具有对比意义，数值越高，代表样本的愿意程度越高，那么应该使用多元有序Logistic回归分析(SPSSAU【进阶方法<span class="ot">-&gt;</span>有序logit】)；</span>
<span id="cb89-3"><a href="Model-building.html#cb89-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-4"><a href="Model-building.html#cb89-4" aria-hidden="true" tabindex="-1"></a>· 如果Y有多个选项，并且各个选项之间不具有对比意义，例如，1代表“淘宝”，2代表“天猫”，3代表“京东”，4代表“亚马逊中国”，数值仅代表不同类别，数值大小不具有对比意义，那么应该使用多元无序Logistic回归分析(SPSSAU【进阶方法<span class="ot">-&gt;</span>多分类logit】)。</span>
<span id="cb89-5"><a href="Model-building.html#cb89-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-6"><a href="Model-building.html#cb89-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-7"><a href="Model-building.html#cb89-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 有序多分类建模：</span></span>
<span id="cb89-8"><a href="Model-building.html#cb89-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 有序多分类建模需要满足的条件：</span></span>
<span id="cb89-9"><a href="Model-building.html#cb89-9" aria-hidden="true" tabindex="-1"></a>假设3：自变量之间无多重共线性。</span>
<span id="cb89-10"><a href="Model-building.html#cb89-10" aria-hidden="true" tabindex="-1"></a>假设4：模型满足“比例优势”假设。意思是无论因变量的分割点在什么位置，模型中各个自变量对因变量的影响不变，也就是自变量对因变量的回归系数与分割点无关。这个检验，在spss中也称之为平行线检验；</span>
<span id="cb89-11"><a href="Model-building.html#cb89-11" aria-hidden="true" tabindex="-1"></a>平行线检验χ2 <span class="ot">=</span> <span class="fl">8.620</span>, P <span class="ot">=</span> <span class="fl">0.375</span>，说明平行性假设成立，即各回归方程相互平行，可以使用有序Logistic过程进行分析。</span>
<span id="cb89-12"><a href="Model-building.html#cb89-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-13"><a href="Model-building.html#cb89-13" aria-hidden="true" tabindex="-1"></a>如果平行线假设不能满足，可以考虑一下两种方法进行处理：①进行无序多分类Logistic回归，而非有序Logistic回归，并能接受因变量失去有序的属性；② 用不同的分割点将因变量变为二分类变量，分别进行二项Logistic回归。</span>
<span id="cb89-14"><a href="Model-building.html#cb89-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-15"><a href="Model-building.html#cb89-15" aria-hidden="true" tabindex="-1"></a>但是，当样本量过大时，平行线检验会过于敏感。即当比例优势存在时，也会显示P<span class="sc">&lt;</span><span class="fl">0.05</span>。此时，可以尝试将因变量设置为哑变量，并拟合多个二分类Logistic回归模型，通过观察自变量对各哑变量的OR值是否近似来判断。</span></code></pre></div>
<div id="有序多分类逻辑回归" class="section level6 hasAnchor" number="4.2.2.2.2.1">
<h6><span class="header-section-number">4.2.2.2.2.1</span> 2.3.2.1 有序多分类逻辑回归<a href="Model-building.html#有序多分类逻辑回归" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="Model-building.html#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb90-2"><a href="Model-building.html#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="do">###生成模拟数据</span></span>
<span id="cb90-3"><a href="Model-building.html#cb90-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span><span class="dv">1000</span> <span class="co"># define sample size</span></span>
<span id="cb90-4"><a href="Model-building.html#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2022</span>) <span class="co"># so can reproduce the results</span></span>
<span id="cb90-5"><a href="Model-building.html#cb90-5" aria-hidden="true" tabindex="-1"></a>age      <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">60</span>, <span class="dv">10</span>)</span>
<span id="cb90-6"><a href="Model-building.html#cb90-6" aria-hidden="true" tabindex="-1"></a>blood.pressure <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">125</span>, <span class="dv">15</span>)</span>
<span id="cb90-7"><a href="Model-building.html#cb90-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-8"><a href="Model-building.html#cb90-8" aria-hidden="true" tabindex="-1"></a>sex      <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">&#39;female&#39;</span>,<span class="st">&#39;male&#39;</span>), n,<span class="cn">TRUE</span>))</span>
<span id="cb90-9"><a href="Model-building.html#cb90-9" aria-hidden="true" tabindex="-1"></a>outcome<span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">sample</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>),n,<span class="cn">TRUE</span>),<span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;1&quot;</span>,<span class="st">&quot;2&quot;</span>,<span class="st">&quot;3&quot;</span>),</span>
<span id="cb90-10"><a href="Model-building.html#cb90-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;poor&quot;</span>,<span class="st">&quot;fair&quot;</span>,<span class="st">&quot;good&quot;</span>))</span>
<span id="cb90-11"><a href="Model-building.html#cb90-11" aria-hidden="true" tabindex="-1"></a>data<span class="ot">&lt;-</span><span class="fu">data.frame</span>(age,blood.pressure,sex,outcome)</span>
<span id="cb90-12"><a href="Model-building.html#cb90-12" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data)</span>
<span id="cb90-13"><a href="Model-building.html#cb90-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-14"><a href="Model-building.html#cb90-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-15"><a href="Model-building.html#cb90-15" aria-hidden="true" tabindex="-1"></a><span class="do">#####单因素分析------------</span></span>
<span id="cb90-16"><a href="Model-building.html#cb90-16" aria-hidden="true" tabindex="-1"></a>fit0<span class="ot">&lt;-</span><span class="fu">polr</span>(<span class="fu">ordered</span>(outcome)<span class="sc">~</span> <span class="dv">1</span>, <span class="at">data=</span>data)<span class="do">#####空模型</span></span>
<span id="cb90-17"><a href="Model-building.html#cb90-17" aria-hidden="true" tabindex="-1"></a>fit1<span class="ot">&lt;-</span><span class="fu">polr</span>(<span class="fu">ordered</span>(outcome)<span class="sc">~</span> <span class="sc">+</span>sex, <span class="at">data=</span>data)</span>
<span id="cb90-18"><a href="Model-building.html#cb90-18" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit1)</span>
<span id="cb90-19"><a href="Model-building.html#cb90-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-20"><a href="Model-building.html#cb90-20" aria-hidden="true" tabindex="-1"></a><span class="do">#####平行线检验---</span></span>
<span id="cb90-21"><a href="Model-building.html#cb90-21" aria-hidden="true" tabindex="-1"></a><span class="do">### 用于多分类逻辑回归中的平行假设检验：</span></span>
<span id="cb90-22"><a href="Model-building.html#cb90-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brant)</span>
<span id="cb90-23"><a href="Model-building.html#cb90-23" aria-hidden="true" tabindex="-1"></a><span class="fu">brant</span>(fit1) <span class="do">###p&gt;0.1,满足平行线检验</span></span>
<span id="cb90-24"><a href="Model-building.html#cb90-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-25"><a href="Model-building.html#cb90-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-26"><a href="Model-building.html#cb90-26" aria-hidden="true" tabindex="-1"></a><span class="do">####检验模型整体是否有意义</span></span>
<span id="cb90-27"><a href="Model-building.html#cb90-27" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(fit0,fit1) <span class="do">####p=0.0687，接近有意义</span></span>
<span id="cb90-28"><a href="Model-building.html#cb90-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-29"><a href="Model-building.html#cb90-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-30"><a href="Model-building.html#cb90-30" aria-hidden="true" tabindex="-1"></a><span class="do">#####生成OR、95%CI和P值</span></span>
<span id="cb90-31"><a href="Model-building.html#cb90-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-32"><a href="Model-building.html#cb90-32" aria-hidden="true" tabindex="-1"></a><span class="do">#####生成OR、95%CI和P值</span></span>
<span id="cb90-33"><a href="Model-building.html#cb90-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-34"><a href="Model-building.html#cb90-34" aria-hidden="true" tabindex="-1"></a>OR<span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">exp</span>(fit1<span class="sc">$</span>coefficients),<span class="dv">2</span>)</span>
<span id="cb90-35"><a href="Model-building.html#cb90-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-36"><a href="Model-building.html#cb90-36" aria-hidden="true" tabindex="-1"></a>CI <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">exp</span>(<span class="fu">confint</span>(fit1)), <span class="dv">2</span>)</span>
<span id="cb90-37"><a href="Model-building.html#cb90-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-38"><a href="Model-building.html#cb90-38" aria-hidden="true" tabindex="-1"></a>CI<span class="ot">&lt;-</span> <span class="fu">data.frame</span>(CI[<span class="dv">1</span>],CI[<span class="dv">2</span>])</span>
<span id="cb90-39"><a href="Model-building.html#cb90-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-40"><a href="Model-building.html#cb90-40" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(CI) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Lower&quot;</span>, <span class="st">&quot;Higher&quot;</span>)</span>
<span id="cb90-41"><a href="Model-building.html#cb90-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-42"><a href="Model-building.html#cb90-42" aria-hidden="true" tabindex="-1"></a>P <span class="ot">&lt;-</span> (<span class="fu">pnorm</span>(<span class="fu">abs</span>( <span class="fu">coef</span>(<span class="fu">summary</span>(fit1))[,<span class="st">&quot;t value&quot;</span>]),<span class="at">lower.tail =</span> <span class="cn">FALSE</span>)<span class="sc">*</span><span class="dv">2</span>)[<span class="dv">1</span>]</span>
<span id="cb90-43"><a href="Model-building.html#cb90-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-44"><a href="Model-building.html#cb90-44" aria-hidden="true" tabindex="-1"></a>out<span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(OR, CI, P))</span>
<span id="cb90-45"><a href="Model-building.html#cb90-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-46"><a href="Model-building.html#cb90-46" aria-hidden="true" tabindex="-1"></a>out</span>
<span id="cb90-47"><a href="Model-building.html#cb90-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-48"><a href="Model-building.html#cb90-48" aria-hidden="true" tabindex="-1"></a><span class="do">#####输出的即为我们需要的OR、95%CI和P value</span></span>
<span id="cb90-49"><a href="Model-building.html#cb90-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-50"><a href="Model-building.html#cb90-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-51"><a href="Model-building.html#cb90-51" aria-hidden="true" tabindex="-1"></a><span class="do">######多因素分析，方法类似-----------------------------</span></span>
<span id="cb90-52"><a href="Model-building.html#cb90-52" aria-hidden="true" tabindex="-1"></a>fit2<span class="ot">&lt;-</span><span class="fu">polr</span>(<span class="fu">ordered</span>(outcome)<span class="sc">~</span> <span class="sc">+</span>sex<span class="sc">+</span>age<span class="sc">+</span>blood.pressure, <span class="at">data=</span>data)</span>
<span id="cb90-53"><a href="Model-building.html#cb90-53" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit2)</span>
<span id="cb90-54"><a href="Model-building.html#cb90-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-55"><a href="Model-building.html#cb90-55" aria-hidden="true" tabindex="-1"></a><span class="do">#####平行线检验---</span></span>
<span id="cb90-56"><a href="Model-building.html#cb90-56" aria-hidden="true" tabindex="-1"></a><span class="fu">brant</span>(fit2) <span class="do">###p&gt;0.1,三个变量都满足平行线检验</span></span>
<span id="cb90-57"><a href="Model-building.html#cb90-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-58"><a href="Model-building.html#cb90-58" aria-hidden="true" tabindex="-1"></a><span class="do">####检验模型整体是否有意义</span></span>
<span id="cb90-59"><a href="Model-building.html#cb90-59" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(fit0,fit2)</span>
<span id="cb90-60"><a href="Model-building.html#cb90-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-61"><a href="Model-building.html#cb90-61" aria-hidden="true" tabindex="-1"></a><span class="do">#####生成OR、95%CI和P值,和单因素的有些区别</span></span>
<span id="cb90-62"><a href="Model-building.html#cb90-62" aria-hidden="true" tabindex="-1"></a>OR_CI<span class="ot">&lt;-</span><span class="fu">exp</span>(<span class="fu">cbind</span>(<span class="at">OR=</span><span class="fu">coef</span>(fit2),<span class="fu">confint</span>(fit2)))</span>
<span id="cb90-63"><a href="Model-building.html#cb90-63" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(OR_CI) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;OR&quot;</span>,<span class="st">&quot;Lower&quot;</span>, <span class="st">&quot;Higher&quot;</span>)</span>
<span id="cb90-64"><a href="Model-building.html#cb90-64" aria-hidden="true" tabindex="-1"></a>P <span class="ot">&lt;-</span> (<span class="fu">pnorm</span>(<span class="fu">abs</span>( <span class="fu">coef</span>(<span class="fu">summary</span>(fit2))[,<span class="st">&quot;t value&quot;</span>]),<span class="at">lower.tail =</span> <span class="cn">FALSE</span>)<span class="sc">*</span><span class="dv">2</span>)</span>
<span id="cb90-65"><a href="Model-building.html#cb90-65" aria-hidden="true" tabindex="-1"></a>P</span>
<span id="cb90-66"><a href="Model-building.html#cb90-66" aria-hidden="true" tabindex="-1"></a><span class="co">#TI</span></span>
<span id="cb90-67"><a href="Model-building.html#cb90-67" aria-hidden="true" tabindex="-1"></a>P<span class="ot">&lt;-</span>P[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>] <span class="do">###提取前三个</span></span>
<span id="cb90-68"><a href="Model-building.html#cb90-68" aria-hidden="true" tabindex="-1"></a>out<span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(OR_CI, P))</span>
<span id="cb90-69"><a href="Model-building.html#cb90-69" aria-hidden="true" tabindex="-1"></a>out</span>
<span id="cb90-70"><a href="Model-building.html#cb90-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-71"><a href="Model-building.html#cb90-71" aria-hidden="true" tabindex="-1"></a><span class="do">## 计算多因素逻辑回归方法中的OR、95%CI和P值</span></span>
<span id="cb90-72"><a href="Model-building.html#cb90-72" aria-hidden="true" tabindex="-1"></a><span class="do">## 另外一种方法是使用questionr包中的odds.ratio函数。</span></span>
<span id="cb90-73"><a href="Model-building.html#cb90-73" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">odds.ratio</span>(fit),<span class="dv">2</span>)</span>
<span id="cb90-74"><a href="Model-building.html#cb90-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-75"><a href="Model-building.html#cb90-75" aria-hidden="true" tabindex="-1"></a><span class="do">## 结果解读：</span></span>
<span id="cb90-76"><a href="Model-building.html#cb90-76" aria-hidden="true" tabindex="-1"></a><span class="co"># 以性别为例(仅解释结果，先暂时忽略掉其没有意义)，我们可以说：“和女性相比，</span></span>
<span id="cb90-77"><a href="Model-building.html#cb90-77" aria-hidden="true" tabindex="-1"></a><span class="co"># 男性对自身的健康状况评价更低 （OR=0.82, 95%CI=0.65-1.02）”，</span></span>
<span id="cb90-78"><a href="Model-building.html#cb90-78" aria-hidden="true" tabindex="-1"></a><span class="co"># 或者是“男性认为自身健康好的OR值是女性的0.82倍 （OR=0.82, 95%CI=0.65-1.02）”。</span></span>
<span id="cb90-79"><a href="Model-building.html#cb90-79" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
</div>
<div id="无序多分类逻辑回归" class="section level6 hasAnchor" number="4.2.2.2.2.2">
<h6><span class="header-section-number">4.2.2.2.2.2</span> 2.3.2.2 无序多分类逻辑回归<a href="Model-building.html#无序多分类逻辑回归" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="Model-building.html#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb91-2"><a href="Model-building.html#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb91-3"><a href="Model-building.html#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nnet)</span>
<span id="cb91-4"><a href="Model-building.html#cb91-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-5"><a href="Model-building.html#cb91-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-6"><a href="Model-building.html#cb91-6" aria-hidden="true" tabindex="-1"></a><span class="do">## 本质上多因素无序逻辑回归的是给出参照，然后进行组内比较的二分类多元逻辑回归：</span></span>
<span id="cb91-7"><a href="Model-building.html#cb91-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 如果想修改指定参照需要使用以下函数代码：</span></span>
<span id="cb91-8"><a href="Model-building.html#cb91-8" aria-hidden="true" tabindex="-1"></a>train.data<span class="sc">$</span>Species <span class="ot">&lt;-</span> <span class="fu">relevel</span>(train.data<span class="sc">$</span>Species, <span class="at">ref =</span> <span class="st">&quot;virginica&quot;</span>)</span>
<span id="cb91-9"><a href="Model-building.html#cb91-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-10"><a href="Model-building.html#cb91-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-11"><a href="Model-building.html#cb91-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 导入数据</span></span>
<span id="cb91-12"><a href="Model-building.html#cb91-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(datasets)</span>
<span id="cb91-13"><a href="Model-building.html#cb91-13" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;iris&quot;</span>)</span>
<span id="cb91-14"><a href="Model-building.html#cb91-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 将数据分成训练集和测试集</span></span>
<span id="cb91-15"><a href="Model-building.html#cb91-15" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb91-16"><a href="Model-building.html#cb91-16" aria-hidden="true" tabindex="-1"></a>training.samples <span class="ot">&lt;-</span> iris<span class="sc">$</span>Species <span class="sc">%&gt;%</span> </span>
<span id="cb91-17"><a href="Model-building.html#cb91-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">createDataPartition</span>(<span class="at">p =</span> <span class="fl">0.8</span>, <span class="at">list =</span> <span class="cn">FALSE</span>)</span>
<span id="cb91-18"><a href="Model-building.html#cb91-18" aria-hidden="true" tabindex="-1"></a>train.data  <span class="ot">&lt;-</span> iris[training.samples, ]</span>
<span id="cb91-19"><a href="Model-building.html#cb91-19" aria-hidden="true" tabindex="-1"></a>test.data <span class="ot">&lt;-</span> iris[<span class="sc">-</span>training.samples, ]</span>
<span id="cb91-20"><a href="Model-building.html#cb91-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-21"><a href="Model-building.html#cb91-21" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> nnet<span class="sc">::</span><span class="fu">multinom</span>(Species <span class="sc">~</span>., <span class="at">data =</span> train.data)</span>
<span id="cb91-22"><a href="Model-building.html#cb91-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 查看结果</span></span>
<span id="cb91-23"><a href="Model-building.html#cb91-23" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span>
<span id="cb91-24"><a href="Model-building.html#cb91-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-25"><a href="Model-building.html#cb91-25" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages(&#39;questionr&#39;)</span></span>
<span id="cb91-26"><a href="Model-building.html#cb91-26" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(questionr)</span>
<span id="cb91-27"><a href="Model-building.html#cb91-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 用questionr包中的odds.ratio函数。</span></span>
<span id="cb91-28"><a href="Model-building.html#cb91-28" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">odds.ratio</span>(model),<span class="dv">2</span>)</span>
<span id="cb91-29"><a href="Model-building.html#cb91-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-30"><a href="Model-building.html#cb91-30" aria-hidden="true" tabindex="-1"></a><span class="do">## 模型预测：</span></span>
<span id="cb91-31"><a href="Model-building.html#cb91-31" aria-hidden="true" tabindex="-1"></a>predicted.classes <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> </span>
<span id="cb91-32"><a href="Model-building.html#cb91-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(test.data)</span></code></pre></div>
</div>
</div>
<div id="计数变量回归" class="section level5 hasAnchor" number="4.2.2.2.3">
<h5><span class="header-section-number">4.2.2.2.3</span> 2.3.3 计数变量回归：<a href="Model-building.html#计数变量回归" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div id="泊松分布回归" class="section level6 hasAnchor" number="4.2.2.2.3.1">
<h6><span class="header-section-number">4.2.2.2.3.1</span> 2.3.3.1 泊松分布回归<a href="Model-building.html#泊松分布回归" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="Model-building.html#cb92-1" aria-hidden="true" tabindex="-1"></a>   生物学数据中很多都是计数型数值，通常具有这些特点：（1）数值是离散的，并且只能是非负整数；（2）数值分布倾向于在特定较小范围内聚集，并具有正偏态的分布特征；（3）通常会出现很多零值；（4）方差随均值而增加。  </span>
<span id="cb92-2"><a href="Model-building.html#cb92-2" aria-hidden="true" tabindex="-1"></a>  泊松或负二项分布都是离散的概率分布，具有两个重要的属性：（1）数值仅包含非负整数；（2）方差是均值的函数。在早期，计数数型变量常通过数据变换或通过非参数假设检验进行分析，现如今更普遍使用广义线性模型方法的主要原因是可以获得可解释的参数估计。</span>
<span id="cb92-3"><a href="Model-building.html#cb92-3" aria-hidden="true" tabindex="-1"></a>   泊松分布的典型例子是呈现出偏左态分布；</span>
<span id="cb92-4"><a href="Model-building.html#cb92-4" aria-hidden="true" tabindex="-1"></a>fit_poisson <span class="ot">&lt;-</span> <span class="fu">glm</span>(fish<span class="sc">~</span>acre<span class="sc">+</span>do2<span class="sc">+</span>depth<span class="sc">+</span>no3<span class="sc">+</span>so4<span class="sc">+</span>temp, <span class="at">data =</span> dat, <span class="at">family =</span> <span class="st">&#39;poisson&#39;</span>)</span>
<span id="cb92-5"><a href="Model-building.html#cb92-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary.glm</span>(fit_poisson)  <span class="co">#展示拟合回归的简单统计</span></span></code></pre></div>
</div>
<div id="负二项分布回归" class="section level6 hasAnchor" number="4.2.2.2.3.2">
<h6><span class="header-section-number">4.2.2.2.3.2</span> 2.3.3.1 负二项分布回归<a href="Model-building.html#负二项分布回归" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="Model-building.html#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 负二项分布是泊松分布形式的一种：</span></span>
<span id="cb93-2"><a href="Model-building.html#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb93-3"><a href="Model-building.html#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="do">## 实现方法1：</span></span>
<span id="cb93-4"><a href="Model-building.html#cb93-4" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(freq<span class="sc">~</span>test,<span class="at">data =</span> target,<span class="at">weights =</span> weight)</span>
<span id="cb93-5"><a href="Model-building.html#cb93-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m1)</span>
<span id="cb93-6"><a href="Model-building.html#cb93-6" aria-hidden="true" tabindex="-1"></a><span class="fu">confint</span>(m1)</span>
<span id="cb93-7"><a href="Model-building.html#cb93-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-8"><a href="Model-building.html#cb93-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 实现方法2：</span></span>
<span id="cb93-9"><a href="Model-building.html#cb93-9" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(freq<span class="sc">~</span>test<span class="sc">+</span>age<span class="sc">+</span>sex<span class="sc">+</span>高血压<span class="sc">+</span>血脂异常<span class="sc">+</span><span class="er">:</span></span>
<span id="cb93-10"><a href="Model-building.html#cb93-10" aria-hidden="true" tabindex="-1"></a>            噻唑烷二酮类<span class="sc">+</span><span class="st">`</span><span class="at">α-糖苷酶抑制剂</span><span class="st">`</span><span class="sc">+</span><span class="st">`</span><span class="at">SGLT-2</span><span class="st">`</span><span class="sc">+</span>胰岛素<span class="sc">+</span>acei<span class="sc">+</span>arb<span class="sc">+</span>B受体阻断剂<span class="sc">+</span>ccb<span class="sc">+</span>freq_menzhen<span class="sc">+</span>all_cost,</span>
<span id="cb93-11"><a href="Model-building.html#cb93-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">family=</span><span class="fu">negative.binomial</span>(<span class="at">theta =</span> <span class="dv">1</span>),<span class="at">data =</span> target,<span class="at">weights =</span> weight)</span>
<span id="cb93-12"><a href="Model-building.html#cb93-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-13"><a href="Model-building.html#cb93-13" aria-hidden="true" tabindex="-1"></a><span class="do">## 实现方法3：</span></span>
<span id="cb93-14"><a href="Model-building.html#cb93-14" aria-hidden="true" tabindex="-1"></a>fit_glm <span class="ot">&lt;-</span> <span class="fu">manyglm</span>(Diplo_intensity<span class="sc">~</span>Treatment, <span class="at">data =</span> worm,  </span>
<span id="cb93-15"><a href="Model-building.html#cb93-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">&#39;negative.binomial&#39;</span>)</span>
<span id="cb93-16"><a href="Model-building.html#cb93-16" aria-hidden="true" tabindex="-1"></a><span class="co">#基于 9999 次自举的 Wald 统计量估计 p 值，其它参数直接使用默认值</span></span>
<span id="cb93-17"><a href="Model-building.html#cb93-17" aria-hidden="true" tabindex="-1"></a>summary_fit <span class="ot">&lt;-</span> <span class="fu">summary.manyglm</span>(fit_glm, <span class="at">test =</span> <span class="st">&#39;wald&#39;</span>, <span class="at">nBoot =</span> <span class="dv">9999</span>)</span>
<span id="cb93-18"><a href="Model-building.html#cb93-18" aria-hidden="true" tabindex="-1"></a>summary_fit</span>
<span id="cb93-19"><a href="Model-building.html#cb93-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 查看建模的合理性，以残差图分析：</span></span>
<span id="cb93-20"><a href="Model-building.html#cb93-20" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(summary_fit)</span></code></pre></div>
</div>
</div>
</div>
<div id="加性模型ga" class="section level4 hasAnchor" number="4.2.2.3">
<h4><span class="header-section-number">4.2.2.3</span> 加性模型(GA)<a href="Model-building.html#加性模型ga" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div id="一般加性模型" class="section level5 hasAnchor" number="4.2.2.3.1">
<h5><span class="header-section-number">4.2.2.3.1</span> 一般加性模型：<a href="Model-building.html#一般加性模型" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="Model-building.html#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 加性模型是常被用来探索响应变量与自变量之间函数形式的一种较为灵活的工具。在一般加性模型中，假定响应变量服从正态分布，并试图建立自变量与响应变量条件均值的非参数函数的可能形式。</span></span>
<span id="cb94-2"><a href="Model-building.html#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 与上述这种常见的参数回归相比，在非参数化的加性模型中，只设定了可加和性，而并没有对变量关系的函数形式作出假设。 总的来说，加性模型放宽了对响应关系加和形式的限制，允许任意函数之和来建模结果，自变量和响应变量之间的关系可以为任意线性或非线性。</span></span>
<span id="cb94-3"><a href="Model-building.html#cb94-3" aria-hidden="true" tabindex="-1"></a> <span class="co"># mgcv包是执行加性模型的最常见R包之一</span></span>
<span id="cb94-4"><a href="Model-building.html#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="co">#示例数据集，详情加载 agridat 包后 ?lasrosas.corn</span></span>
<span id="cb94-5"><a href="Model-building.html#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(agridat)</span>
<span id="cb94-6"><a href="Model-building.html#cb94-6" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(lasrosas.corn)</span>
<span id="cb94-7"><a href="Model-building.html#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(lasrosas.corn)</span>
<span id="cb94-8"><a href="Model-building.html#cb94-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-9"><a href="Model-building.html#cb94-9" aria-hidden="true" tabindex="-1"></a><span class="do">### 加和效应：</span></span>
<span id="cb94-10"><a href="Model-building.html#cb94-10" aria-hidden="true" tabindex="-1"></a>fit2_k3_k5 <span class="ot">&lt;-</span> <span class="fu">gam</span>(yield<span class="sc">~</span><span class="fu">s</span>(nitro, <span class="at">k =</span> <span class="dv">3</span>) <span class="sc">+</span> <span class="fu">s</span>(bv, <span class="at">k =</span> <span class="dv">5</span>), <span class="at">data =</span> lasrosas.corn.select) <span class="do">## 注意这种加和的方法；</span></span>
<span id="cb94-11"><a href="Model-building.html#cb94-11" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit2_k3_k5)  <span class="co">#检验自变量的显著性以及评估回归整体的方差解释率</span></span>
<span id="cb94-12"><a href="Model-building.html#cb94-12" aria-hidden="true" tabindex="-1"></a><span class="do">### 交互效应:</span></span>
<span id="cb94-13"><a href="Model-building.html#cb94-13" aria-hidden="true" tabindex="-1"></a>fit2_inter <span class="ot">&lt;-</span> <span class="fu">gam</span>(yield<span class="sc">~</span><span class="fu">s</span>(nitro, bv, <span class="at">k =</span> <span class="dv">5</span>), <span class="at">data =</span> lasrosas.corn.select)</span>
<span id="cb94-14"><a href="Model-building.html#cb94-14" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit2_inter)</span></code></pre></div>
</div>
<div id="广义加性模型" class="section level5 hasAnchor" number="4.2.2.3.2">
<h5><span class="header-section-number">4.2.2.3.2</span> 广义加性模型：<a href="Model-building.html#广义加性模型" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="Model-building.html#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 案例学习：</span></span>
<span id="cb95-2"><a href="Model-building.html#cb95-2" aria-hidden="true" tabindex="-1"></a>一般加性模型一般化为广义加性模型（GAM），代表了一类服务于一组来自指数分布族（如正态分布、指数分布、泊松分布、二项分布、负二项分布等）的响应变量的非参数化平滑回归框架，概括形式为：</span>
<span id="cb95-3"><a href="Model-building.html#cb95-3" aria-hidden="true" tabindex="-1"></a>此时<span class="fu">fn</span>(X)仍是非参数的函数，而响应变量Y服从指数分布族中的某种分布（不局限于正态性）。<span class="fu">g</span>(μY)代表了响应变量Y条件均值的函数（指数、泊松、二项、负二项等），又称连接函数，与在广义线性模型（GLM）中的理解相似，目的是将各类非正态的指数分布族响应变量的条件均值转化为正态形式的条件均值，以建立和自变量的非参数加和响应关系。</span>
<span id="cb95-4"><a href="Model-building.html#cb95-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-5"><a href="Model-building.html#cb95-5" aria-hidden="true" tabindex="-1"></a>连接函数根据响应变量Y的实际分布而具体为不同公式。例如，当响应变量为泊松分布时，连接函数<span class="fu">g</span>(μY) <span class="ot">=</span> <span class="fu">loge</span>(Y)。一般加性模型事实上属于广义加性模型在正态响应变量时的特殊形式，此时<span class="fu">g</span>(μY) <span class="ot">=</span> Y。</span>
<span id="cb95-6"><a href="Model-building.html#cb95-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-7"><a href="Model-building.html#cb95-7" aria-hidden="true" tabindex="-1"></a><span class="co"># R - 广义加性模型（GAM）构建详解：以归一化植被指数NDVI为例</span></span>
<span id="cb95-8"><a href="Model-building.html#cb95-8" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">as.data.frame</span>(df)</span>
<span id="cb95-9"><a href="Model-building.html#cb95-9" aria-hidden="true" tabindex="-1"></a>train <span class="ot">=</span> df[<span class="dv">1</span><span class="sc">:</span><span class="dv">115</span>,]</span>
<span id="cb95-10"><a href="Model-building.html#cb95-10" aria-hidden="true" tabindex="-1"></a>test <span class="ot">=</span> df[<span class="dv">116</span><span class="sc">:</span><span class="dv">165</span>,]</span>
<span id="cb95-11"><a href="Model-building.html#cb95-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb95-12"><a href="Model-building.html#cb95-12" aria-hidden="true" tabindex="-1"></a><span class="do">## 构建一般模型：</span></span>
<span id="cb95-13"><a href="Model-building.html#cb95-13" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">=</span> mgcv<span class="sc">::</span><span class="fu">gam</span>(ndvi <span class="sc">~</span><span class="fu">s</span>(soil1)<span class="sc">+</span><span class="fu">s</span>(soil2)<span class="sc">+</span><span class="fu">s</span>(soil3)<span class="sc">+</span><span class="fu">s</span>(soil4)<span class="sc">+</span><span class="fu">s</span>(gpp)<span class="sc">+</span></span>
<span id="cb95-14"><a href="Model-building.html#cb95-14" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">s</span>(rain)<span class="sc">+</span><span class="fu">s</span>(longwave)<span class="sc">+</span><span class="fu">s</span>(shortwave)<span class="sc">+</span><span class="fu">s</span>(root_sm)<span class="sc">+</span><span class="fu">s</span>(evap)<span class="sc">+</span><span class="fu">s</span>(temper),<span class="at">data =</span> train,</span>
<span id="cb95-15"><a href="Model-building.html#cb95-15" aria-hidden="true" tabindex="-1"></a>                <span class="at">trace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb95-16"><a href="Model-building.html#cb95-16" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit)</span></code></pre></div>
</div>
</div>
<div id="分段线性回归" class="section level4 hasAnchor" number="4.2.2.4">
<h4><span class="header-section-number">4.2.2.4</span> 分段线性回归<a href="Model-building.html#分段线性回归" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="Model-building.html#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 分段线性回归及对分段断点的评估</span></span>
<span id="cb96-2"><a href="Model-building.html#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 分段线性回归有专门的R包来做这个工作，可以在一定程度上去除人为干扰的影响；</span></span>
<span id="cb96-3"><a href="Model-building.html#cb96-3" aria-hidden="true" tabindex="-1"></a><span class="dv">5</span>.<span class="fl">3.1</span>  <span class="fu">library</span>(SiZer)</span>
<span id="cb96-4"><a href="Model-building.html#cb96-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SiZer)</span>
<span id="cb96-5"><a href="Model-building.html#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="co">#示例数据集，详情 ?Arkansas</span></span>
<span id="cb96-6"><a href="Model-building.html#cb96-6" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(Arkansas)</span>
<span id="cb96-7"><a href="Model-building.html#cb96-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Arkansas)    </span>
<span id="cb96-8"><a href="Model-building.html#cb96-8" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">piecewise.linear</span>(<span class="at">x =</span> Arkansas<span class="sc">$</span>year, <span class="at">y =</span> Arkansas<span class="sc">$</span>sqrt.mayflies, </span>
<span id="cb96-9"><a href="Model-building.html#cb96-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">CI =</span> <span class="cn">TRUE</span>, <span class="at">bootstrap.samples =</span> <span class="dv">1000</span>, <span class="at">sig.level =</span> <span class="fl">0.05</span>)</span>
<span id="cb96-10"><a href="Model-building.html#cb96-10" aria-hidden="true" tabindex="-1"></a>model</span>
<span id="cb96-11"><a href="Model-building.html#cb96-11" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb96-12"><a href="Model-building.html#cb96-12" aria-hidden="true" tabindex="-1"></a><span class="co">#简单作图查看分段线性回归图</span></span>
<span id="cb96-13"><a href="Model-building.html#cb96-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model, <span class="at">xlab =</span> <span class="st">&#39;year&#39;</span>, <span class="at">ylab =</span> <span class="st">&#39;sqrt.mayflies&#39;</span>)    </span>
<span id="cb96-14"><a href="Model-building.html#cb96-14" aria-hidden="true" tabindex="-1"></a>model <span class="do">## 会返回一个线性模型或者模型的中断点；    </span></span>
<span id="cb96-15"><a href="Model-building.html#cb96-15" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb96-16"><a href="Model-building.html#cb96-16" aria-hidden="true" tabindex="-1"></a><span class="dv">5</span>.<span class="fl">3.2</span> segmented</span>
<span id="cb96-17"><a href="Model-building.html#cb96-17" aria-hidden="true" tabindex="-1"></a>与上述方法相比，segmented包中函数segmented()更加灵活：</span>
<span id="cb96-18"><a href="Model-building.html#cb96-18" aria-hidden="true" tabindex="-1"></a>（1）它可以从一个给定的已知线性回归或广义线性回归模型出发，寻找可能存在的断点，不局限于简单的纯线性关系，适用情况更广泛；</span>
<span id="cb96-19"><a href="Model-building.html#cb96-19" aria-hidden="true" tabindex="-1"></a>（2）允许考虑多变量响应的情况，不局限于简单的一元响应关系；</span>
<span id="cb96-20"><a href="Model-building.html#cb96-20" aria-hidden="true" tabindex="-1"></a>（3）允许出现多个断点的情况，不局限于只能识别单个断点；</span>
<span id="cb96-21"><a href="Model-building.html#cb96-21" aria-hidden="true" tabindex="-1"></a>（4）关于断点位置的确定，即可以通过指定断点数量自动评估位置，但如果您大致确定了断点可能出现的数值坐标，也可以将其输入至函数中，此时函数将在指定位置两侧确定最佳的断点。</span>
<span id="cb96-22"><a href="Model-building.html#cb96-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(segmented)</span>
<span id="cb96-23"><a href="Model-building.html#cb96-23" aria-hidden="true" tabindex="-1"></a><span class="co">#例如，先拟合一个简单的线性回归模型</span></span>
<span id="cb96-24"><a href="Model-building.html#cb96-24" aria-hidden="true" tabindex="-1"></a>fit_lm <span class="ot">&lt;-</span> <span class="fu">lm</span>(sqrt.mayflies<span class="sc">~</span>year, <span class="at">data =</span> Arkansas)</span>
<span id="cb96-25"><a href="Model-building.html#cb96-25" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit_lm)</span>
<span id="cb96-26"><a href="Model-building.html#cb96-26" aria-hidden="true" tabindex="-1"></a><span class="co">#第一种，通过 npsi 指定断点数量</span></span>
<span id="cb96-27"><a href="Model-building.html#cb96-27" aria-hidden="true" tabindex="-1"></a><span class="co">#例如 1 个断点，将自动在全范围内寻找可能的断点位置</span></span>
<span id="cb96-28"><a href="Model-building.html#cb96-28" aria-hidden="true" tabindex="-1"></a>lm_seg1 <span class="ot">&lt;-</span> <span class="fu">segmented</span>(fit_lm, <span class="at">seg.Z =</span> <span class="sc">~</span>year, <span class="at">npsi =</span> <span class="dv">1</span>)</span>
<span id="cb96-29"><a href="Model-building.html#cb96-29" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm_seg1)</span>
<span id="cb96-30"><a href="Model-building.html#cb96-30" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb96-31"><a href="Model-building.html#cb96-31" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(lm_seg1, <span class="at">xlab =</span> <span class="st">&#39;year&#39;</span>, <span class="at">ylab =</span> <span class="st">&#39;sqrt.mayflies&#39;</span>)</span>
<span id="cb96-32"><a href="Model-building.html#cb96-32" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(sqrt.mayflies<span class="sc">~</span>year, <span class="at">data =</span> Arkansas)</span>
<span id="cb96-33"><a href="Model-building.html#cb96-33" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb96-34"><a href="Model-building.html#cb96-34" aria-hidden="true" tabindex="-1"></a><span class="co">#第二种，通过 psi 指定断点可能存在的大致初始位置</span></span>
<span id="cb96-35"><a href="Model-building.html#cb96-35" aria-hidden="true" tabindex="-1"></a><span class="co">#例如 x=1997 是可能的断点位置，将它指定，将自动在 x=1997 附近寻找最佳的断点位置</span></span>
<span id="cb96-36"><a href="Model-building.html#cb96-36" aria-hidden="true" tabindex="-1"></a>lm_seg2 <span class="ot">&lt;-</span> <span class="fu">segmented</span>(fit_lm, <span class="at">seg.Z =</span> <span class="sc">~</span>year, <span class="at">psi =</span> <span class="dv">1997</span>) </span>
<span id="cb96-37"><a href="Model-building.html#cb96-37" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm_seg2)</span>
<span id="cb96-38"><a href="Model-building.html#cb96-38" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb96-39"><a href="Model-building.html#cb96-39" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(lm_seg2, <span class="at">xlab =</span> <span class="st">&#39;year&#39;</span>, <span class="at">ylab =</span> <span class="st">&#39;sqrt.mayflies&#39;</span>)</span>
<span id="cb96-40"><a href="Model-building.html#cb96-40" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(sqrt.mayflies<span class="sc">~</span>year, <span class="at">data =</span> Arkansas)    </span></code></pre></div>
</div>
<div id="结构方程模型" class="section level4 hasAnchor" number="4.2.2.5">
<h4><span class="header-section-number">4.2.2.5</span> 结构方程模型<a href="Model-building.html#结构方程模型" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="Model-building.html#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fl">7.1</span> 路径分析</span>
<span id="cb97-2"><a href="Model-building.html#cb97-2" aria-hidden="true" tabindex="-1"></a>路径分析（Path Analysis）是目前使用的主要SEM模型之一，是没有潜在变量的SEM应用。</span>
<span id="cb97-3"><a href="Model-building.html#cb97-3" aria-hidden="true" tabindex="-1"></a>路径分析的优点在于，它包含了在一个模型中充当预测变量的变量之间的关系。一个典型的例子是中介模型。</span>
<span id="cb97-4"><a href="Model-building.html#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="do">##     </span></span>
<span id="cb97-5"><a href="Model-building.html#cb97-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-6"><a href="Model-building.html#cb97-6" aria-hidden="true" tabindex="-1"></a><span class="fl">7.2</span> 验证性因子分析（CFA）</span>
<span id="cb97-7"><a href="Model-building.html#cb97-7" aria-hidden="true" tabindex="-1"></a>验证性因子分析（Confirmatory Factor Analysis，CFA）是一种降维方法，在SEM中也称为测量模型，CFA意在描述潜在因子（ε1和ε2，在SEM中等同于潜在变量）与观测变量（x1<span class="sc">-</span>x8）的关系。</span>
<span id="cb97-8"><a href="Model-building.html#cb97-8" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb97-9"><a href="Model-building.html#cb97-9" aria-hidden="true" tabindex="-1"></a><span class="fl">7.3</span> 潜变量结构模型</span>
<span id="cb97-10"><a href="Model-building.html#cb97-10" aria-hidden="true" tabindex="-1"></a>潜变量结构模型（Latent Variable Structural Model）主要在路径分析框架内使用测得的潜在变量。</span>
<span id="cb97-11"><a href="Model-building.html#cb97-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-12"><a href="Model-building.html#cb97-12" aria-hidden="true" tabindex="-1"></a>例如，潜变量结构模型的一种常见形式是因子分析和路径分析的组合，因子分析挖掘潜在因子（潜在变量），之后可将潜在变量代入路径分析，假设并测试它们之间的关系。</span>
<span id="cb97-13"><a href="Model-building.html#cb97-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb97-14"><a href="Model-building.html#cb97-14" aria-hidden="true" tabindex="-1"></a><span class="fl">7.4</span> 分段结构方程建模</span>
<span id="cb97-15"><a href="Model-building.html#cb97-15" aria-hidden="true" tabindex="-1"></a>分段SEM通过引入一个灵活的数学框架，合并各种类型的模型结构、分布和假设，扩展了传统的SEM。分段SEM中，每组关系都是独立（或局部）估计的，此过程将整体关系分解为与每个响应对应的简单或多个（一般为线性）回归，分别对每个响应进行评估，最后合并以生成有关全局SEM的推论。即分别在各个模型中估计路径，然后将它们拼凑起来以构建因果模型。假定的变量关联模式，包括交互作用和非正态响应、随机效应和层次模型以及其它相关结构（包括系统发育、空间和时间）等。</span>
<span id="cb97-16"><a href="Model-building.html#cb97-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-17"><a href="Model-building.html#cb97-17" aria-hidden="true" tabindex="-1"></a>偏最小二乘路径模型（PLS<span class="sc">-</span>PM）</span>
<span id="cb97-18"><a href="Model-building.html#cb97-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-19"><a href="Model-building.html#cb97-19" aria-hidden="true" tabindex="-1"></a><span class="do">################# 关于结构方程模型的总结： ##################</span></span>
<span id="cb97-20"><a href="Model-building.html#cb97-20" aria-hidden="true" tabindex="-1"></a>常规的SEM有两个主要目标：</span>
<span id="cb97-21"><a href="Model-building.html#cb97-21" aria-hidden="true" tabindex="-1"></a>（1）了解一组变量之间的相关<span class="sc">/</span>协方差模式；</span>
<span id="cb97-22"><a href="Model-building.html#cb97-22" aria-hidden="true" tabindex="-1"></a>（2）用指定的模型尽可能解释它们的方差。</span>
<span id="cb97-23"><a href="Model-building.html#cb97-23" aria-hidden="true" tabindex="-1"></a>因此常规SEM也有人直接称为协方差SEM（下文允许我也使用这一称呼，尽管可能不贴切，因为分段SEM也基于协方差，只是情况比常规SEM复杂一些）。</span>
<span id="cb97-24"><a href="Model-building.html#cb97-24" aria-hidden="true" tabindex="-1"></a>观测协方差矩阵（原始变量观测值的协方差矩阵）与预测协方差矩阵（模型预测值的协方差矩阵）之间的差异量化了模型的拟合优度。</span>
<span id="cb97-25"><a href="Model-building.html#cb97-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb97-26"><a href="Model-building.html#cb97-26" aria-hidden="true" tabindex="-1"></a><span class="do">## 模型评估：</span></span>
<span id="cb97-27"><a href="Model-building.html#cb97-27" aria-hidden="true" tabindex="-1"></a>    可用于反映模型拟合优度的指标有很多，例如卡方值（CMIN）、卡方自由度比（CMIN<span class="sc">/</span>DF）、比较拟合指数（CFI）、近似值的均方根误差（RMSEA）、Akaike信息准则（AIC）、贝叶斯信息标准（BIC）等，它们均以比较两个协方差矩阵的差异为准</span>
<span id="cb97-28"><a href="Model-building.html#cb97-28" aria-hidden="true" tabindex="-1"></a><span class="do">## 协方差SEM的局限性</span></span>
<span id="cb97-29"><a href="Model-building.html#cb97-29" aria-hidden="true" tabindex="-1"></a>    协方差SEM假定所有变量均来自正态分布，即数据服从多元正态分布。</span>
<span id="cb97-30"><a href="Model-building.html#cb97-30" aria-hidden="true" tabindex="-1"></a>    协方差SEM假设所有观察结果都是独立的，换句话说，假设数据没有底层结构。例如在生态学研究中，这些假设经常被违反，变量间的空间、时间等相关关系普遍存在；尽管实际中通常忽略该假设。</span>
<span id="cb97-31"><a href="Model-building.html#cb97-31" aria-hidden="true" tabindex="-1"></a>    SEM通常需要相当大的样本量，每个估计参数至少需要5个样本，更普遍在10个以上。如果变量是嵌套的，则此问题可能会更为棘手，此时通常只能在层次结构的最高层考虑变量，会极大降低分析的能力。</span></code></pre></div>
</div>
<div id="混合效应模型" class="section level4 hasAnchor" number="4.2.2.6">
<h4><span class="header-section-number">4.2.2.6</span> 混合效应模型<a href="Model-building.html#混合效应模型" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<pre><code>## 参见资料：
https://zhuanlan.zhihu.com/p/60528092
https://zhuanlan.zhihu.com/p/50048784
https://blog.csdn.net/qq_27056805/article/details/87462542
https://blog.csdn.net/fjsd155/article/details/88360671</code></pre>
<pre><code>## 使用说明：
混合效应模型：使用lmer包；
lme4和lmerTest包的lmer函数

## carn中提供的metTools包；用于交互式查看那lme4的结果；
https://cran.r-project.org/web/packages/merTools/vignettes/merToolsIntro.html

#将个体当做随机因素，这样由于个体有m个水平(m个个体),因此会发现会产生m个截距值
#这里的1代表随机截距， | 后面表示分组变量；
model=lmer(pitch~sex+place+(1|subject)，data=data.csv)

#查看结果
model
#查看系数
coef(model)
# 复杂的例子，这里的place表示place中使用随机斜率；
model=lmer(pitch~sex+place+(place|subject)+(1|subject)
      
## 表示在给定随机斜率的情况下，固定截距；加上参数化的交互作用；           
lmer(Y ~ 1 + X1*W + X2 + (1 + X1 | group), ...) </code></pre>
<pre><code>## 固定截距（fixed intercept）：固定截距其实并不存在于HLM的模型中，而是“降级”到了一般的最小二乘法回归（OLS），也就是我们最常用的GLM回归分析。
→ lm(Y ~ 1 + X1 + X2, ...)

## 随机截距（random intercept）：在做HLM时，我们通常都会将截距设置为随机截距，也就是允许不同组具有各自的截距（基线水平）。可以理解为，“有的人出生就在终点，而你却在起点”。在R里面，只要你在回归表达式后面加上小括号（当然，这时就不能再用lm了，要用lme4和lmerTest包的lmer函数），括号里就定义了Level 1截距或斜率在Level 2的随机部分（Level 1的随机部分则是个体层面的残差residual，不用我们定义）。竖线“|”后面是分组变量（clustering/grouping variable，可以是省市、学校，而在重复测量、追踪设计中则是被试个体），竖线前面的1代表随机截距、具体变量名则代表这个变量对应的随机斜率。
→ lmer(Y ~ 1 + X1 + X2 + (1 | group), ...)

## 固定斜率（fixed slope）：固定斜率的意思是，某个Level 1自变量的斜率在不同的group里面都是一致的。虽然实际情况未必真的一致，但研究者可以假设并检验斜率是否在组间保持一致而不存在显著差异。需要注意的是，Level 2截距或斜率并不存在固定和随机的区分（或者说都是固定的），除非还有Level 3。
→ lmer(Y ~ 1 + X1 + X2 + (1 | group), ...)

## 随机斜率（random slope）：与固定斜率相反，随机斜率意味着某个Level 1自变量的斜率在不同的group之间存在差异，或者说“依组而变”。可以理解为，“有的人花两个小时就能赚10000，而你却只能挣个10块钱被试费”。你既可以只纳入随机斜率成分而不对斜率的差异作出具体解释，也可以再纳入一个Level 2的自变量与这个Level 1自变量发生交互作用（即跨层交互），从而解释为什么X的效应依组而变、是什么因素导致了这种变化。
→ lmer(Y ~ 1 + X1 + X2 + (1 + X1 | group), ...) # 这里的1可以省略，默认都纳入截距（但只有随机截距时则不能省）
→ lmer(Y ~ 1 + X1*W + X2 + (1 + X1 | group), ...) # W表示一个Level 2解释变量，X1*W即为一个跨层交互作用</code></pre>
<div class="figure">
<img src="https://pic4.zhimg.com/v2-c10ec7c1067381d5e7ea2b3676d162bf_r.jpg" alt="" />
<p class="caption">preview</p>
</div>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="Model-building.html#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 简单R代码实现：</span></span>
<span id="cb101-2"><a href="Model-building.html#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nlme)</span>
<span id="cb101-3"><a href="Model-building.html#cb101-3" aria-hidden="true" tabindex="-1"></a>mod_lmm1 <span class="ot">&lt;-</span> <span class="fu">lme</span>(raw_lab_result.x<span class="sc">~</span> test<span class="sc">*</span>time <span class="sc">+</span>raw_lab_result.y<span class="sc">+</span>age<span class="sc">+</span>sex<span class="sc">+</span>高血压<span class="sc">+</span>血脂异常<span class="sc">+</span>心肌梗塞<span class="sc">+</span>心肌缺血<span class="sc">+</span>心绞痛<span class="sc">+</span>房颤<span class="sc">+</span>卒中<span class="sc">+</span>心力衰竭<span class="sc">+</span>外周血管疾病<span class="sc">+</span>糖尿病足<span class="sc">+</span>神经病变<span class="sc">+</span></span>
<span id="cb101-4"><a href="Model-building.html#cb101-4" aria-hidden="true" tabindex="-1"></a>        <span class="sc">+</span>all_score<span class="sc">+</span>磺脲类<span class="sc">+</span>格列奈类<span class="sc">+</span></span>
<span id="cb101-5"><a href="Model-building.html#cb101-5" aria-hidden="true" tabindex="-1"></a>       ccb<span class="sc">+</span> 利尿剂<span class="sc">+</span>抗凝药<span class="sc">+</span>抗血小板药<span class="sc">+</span>调脂药<span class="sc">+</span>freq_zhuyuan<span class="sc">+</span> all_days<span class="sc">+</span>freq_menzhen<span class="sc">+</span>all_cost,<span class="at">random =</span> <span class="sc">~</span><span class="dv">1</span><span class="sc">|</span>patient,<span class="at">data =</span> target,<span class="at">weights =</span> <span class="fu">c</span>(<span class="st">&#39;weight&#39;</span>))</span>
<span id="cb101-6"><a href="Model-building.html#cb101-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod_lmm1)</span>
<span id="cb101-7"><a href="Model-building.html#cb101-7" aria-hidden="true" tabindex="-1"></a><span class="fu">intervals</span>(mod_lmm1,<span class="at">which =</span> <span class="st">&#39;fixed&#39;</span>)</span></code></pre></div>
</div>
</div>
<div id="方差检验" class="section level3 hasAnchor" number="4.2.3">
<h3><span class="header-section-number">4.2.3</span> 方差检验<a href="Model-building.html#方差检验" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="Model-building.html#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 代码更新：anova：</span></span>
<span id="cb102-2"><a href="Model-building.html#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">0</span>)</span>
<span id="cb102-3"><a href="Model-building.html#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="co">#创建数据框</span></span>
<span id="cb102-4"><a href="Model-building.html#cb102-4" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">program =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>, <span class="st">&quot;C&quot;</span>), <span class="at">each =</span> <span class="dv">30</span>),</span>
<span id="cb102-5"><a href="Model-building.html#cb102-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">weight_loss =</span> <span class="fu">c</span>(<span class="fu">runif</span>(<span class="dv">30</span>, <span class="dv">0</span>, <span class="dv">3</span>),<span class="fu">runif</span>(<span class="dv">30</span>, <span class="dv">0</span>, <span class="dv">5</span>),<span class="fu">runif</span>(<span class="dv">30</span>, <span class="dv">1</span>, <span class="dv">7</span>)))</span>
<span id="cb102-6"><a href="Model-building.html#cb102-6" aria-hidden="true" tabindex="-1"></a>                                 </span>
<span id="cb102-7"><a href="Model-building.html#cb102-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 方差检验前提：</span></span>
<span id="cb102-8"><a href="Model-building.html#cb102-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 即数据集应该符合正态和各组的方差相等，</span></span>
<span id="cb102-9"><a href="Model-building.html#cb102-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 可以分别用shapiro.test和bartlett.test检验从P值观察到这两个假设是符合的。</span></span>
<span id="cb102-10"><a href="Model-building.html#cb102-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 这两个检验的结局是p值大于0.05，则数据正态，方差相等。</span></span>
<span id="cb102-11"><a href="Model-building.html#cb102-11" aria-hidden="true" tabindex="-1"></a><span class="do">## 或者使用：</span></span>
<span id="cb102-12"><a href="Model-building.html#cb102-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span> (car) <span class="co">#conduct Levene&#39;s Test for equations of variances</span></span>
<span id="cb102-13"><a href="Model-building.html#cb102-13" aria-hidden="true" tabindex="-1"></a><span class="fu">leveneTest</span>(weight_loss <span class="sc">~</span> program, <span class="at">data =</span> data) </span>
<span id="cb102-14"><a href="Model-building.html#cb102-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-15"><a href="Model-building.html#cb102-15" aria-hidden="true" tabindex="-1"></a><span class="co">#fit the one-way ANOVA model</span></span>
<span id="cb102-16"><a href="Model-building.html#cb102-16" aria-hidden="true" tabindex="-1"></a><span class="do">## var.equal=TRUE满足方差齐性的需要：</span></span>
<span id="cb102-17"><a href="Model-building.html#cb102-17" aria-hidden="true" tabindex="-1"></a>result2 <span class="ot">&lt;-</span> <span class="fu">oneway.test</span>(value<span class="sc">~</span>variable,<span class="at">data=</span>anova1,<span class="at">var.equal=</span><span class="cn">TRUE</span>)</span>
<span id="cb102-18"><a href="Model-building.html#cb102-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 各水平的总体方差不相等(var.equal=FALSE)，则使用Welch的近似方法</span></span>
<span id="cb102-19"><a href="Model-building.html#cb102-19" aria-hidden="true" tabindex="-1"></a>result2 <span class="ot">&lt;-</span> <span class="fu">oneway.test</span>(value<span class="sc">~</span>variable,<span class="at">data=</span>anova1,<span class="at">var.equal=</span><span class="cn">FALSE</span>)</span>
<span id="cb102-20"><a href="Model-building.html#cb102-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-21"><a href="Model-building.html#cb102-21" aria-hidden="true" tabindex="-1"></a><span class="co">#view the model output</span></span>
<span id="cb102-22"><a href="Model-building.html#cb102-22" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span>
<span id="cb102-23"><a href="Model-building.html#cb102-23" aria-hidden="true" tabindex="-1"></a><span class="do">## 将统计结果整理成表格形式：</span></span>
<span id="cb102-24"><a href="Model-building.html#cb102-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb102-25"><a href="Model-building.html#cb102-25" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(model)</span>
<span id="cb102-26"><a href="Model-building.html#cb102-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-27"><a href="Model-building.html#cb102-27" aria-hidden="true" tabindex="-1"></a><span class="do">## 模型检验：</span></span>
<span id="cb102-28"><a href="Model-building.html#cb102-28" aria-hidden="true" tabindex="-1"></a><span class="do">## qq图：</span></span>
<span id="cb102-29"><a href="Model-building.html#cb102-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 理想情况下，标准化残差将沿着图中的直线对角线下降。</span></span>
<span id="cb102-30"><a href="Model-building.html#cb102-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 然而，在上图中，我们可以看到残差在开始和结束时偏离了这条线。</span></span>
<span id="cb102-31"><a href="Model-building.html#cb102-31" aria-hidden="true" tabindex="-1"></a><span class="co"># 这表明我们的正态性假设可能被违反。</span></span>
<span id="cb102-32"><a href="Model-building.html#cb102-32" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model)</span>
<span id="cb102-33"><a href="Model-building.html#cb102-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-34"><a href="Model-building.html#cb102-34" aria-hidden="true" tabindex="-1"></a><span class="do">## 事后检验：</span></span>
<span id="cb102-35"><a href="Model-building.html#cb102-35" aria-hidden="true" tabindex="-1"></a><span class="co"># 0.05 显着性水平上，每个程序的平均体重损失之间存在统计学上的显着差异。</span></span>
<span id="cb102-36"><a href="Model-building.html#cb102-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Tukey的HSD法要求各样本的样本相等或者接近，在样本量相差很大的情况下还是建议使用其他方法。</span></span>
<span id="cb102-37"><a href="Model-building.html#cb102-37" aria-hidden="true" tabindex="-1"></a><span class="fu">TukeyHSD</span>(model, <span class="at">conf.level=</span>.<span class="dv">95</span>) </span>
<span id="cb102-38"><a href="Model-building.html#cb102-38" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">TukeyHSD</span>(model, <span class="at">conf.level=</span>.<span class="dv">95</span>), <span class="at">las =</span> <span class="dv">2</span>)</span>
<span id="cb102-39"><a href="Model-building.html#cb102-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-40"><a href="Model-building.html#cb102-40" aria-hidden="true" tabindex="-1"></a><span class="do">## 参数事后比较：</span></span>
<span id="cb102-41"><a href="Model-building.html#cb102-41" aria-hidden="true" tabindex="-1"></a><span class="fu">pairwise.t.test</span>(x, g, <span class="at">p.adjust.method=</span>”bonferroni”)</span>
<span id="cb102-42"><a href="Model-building.html#cb102-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-43"><a href="Model-building.html#cb102-43" aria-hidden="true" tabindex="-1"></a><span class="do">## 非参数的方差检验：</span></span>
<span id="cb102-44"><a href="Model-building.html#cb102-44" aria-hidden="true" tabindex="-1"></a><span class="fu">kruskal.test</span>(DEPDC1 <span class="sc">~</span> molecular_group, <span class="at">data=</span>myeloma)</span>
<span id="cb102-45"><a href="Model-building.html#cb102-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-46"><a href="Model-building.html#cb102-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-47"><a href="Model-building.html#cb102-47" aria-hidden="true" tabindex="-1"></a><span class="do">## 有以下两种算法来进行事后检验：</span></span>
<span id="cb102-48"><a href="Model-building.html#cb102-48" aria-hidden="true" tabindex="-1"></a><span class="co"># 区别在于：</span></span>
<span id="cb102-49"><a href="Model-building.html#cb102-49" aria-hidden="true" tabindex="-1"></a><span class="co"># 参见：https://blog.csdn.net/jbb0523/article/details/109990924</span></span>
<span id="cb102-50"><a href="Model-building.html#cb102-50" aria-hidden="true" tabindex="-1"></a><span class="co"># 参见：https://baijiahao.baidu.com/s?id=1731958531513315048&amp;wfr=spider&amp;for=pc</span></span>
<span id="cb102-51"><a href="Model-building.html#cb102-51" aria-hidden="true" tabindex="-1"></a><span class="co"># DunnTest:处理组与对比组样本均数之间差别有无统计学意义；</span></span>
<span id="cb102-52"><a href="Model-building.html#cb102-52" aria-hidden="true" tabindex="-1"></a><span class="co"># NemenyiTest:是完全随机设计多样本间多重比较秩和检验的方法；</span></span>
<span id="cb102-53"><a href="Model-building.html#cb102-53" aria-hidden="true" tabindex="-1"></a><span class="co"># 相对来说，当分组较少时，使用DunnTest比使用NemenyiTest更合适；’</span></span>
<span id="cb102-54"><a href="Model-building.html#cb102-54" aria-hidden="true" tabindex="-1"></a>ans <span class="ot">&lt;-</span> <span class="fu">kwAllPairsDunnTest</span>(count <span class="sc">~</span> spray, <span class="at">data =</span> InsectSprays,</span>
<span id="cb102-55"><a href="Model-building.html#cb102-55" aria-hidden="true" tabindex="-1"></a>                          <span class="at">p.adjust.method =</span> <span class="st">&quot;bonferroni&quot;</span>)</span>
<span id="cb102-56"><a href="Model-building.html#cb102-56" aria-hidden="true" tabindex="-1"></a>ans <span class="ot">&lt;-</span> <span class="fu">kwAllPairsNemenyiTest</span>(count <span class="sc">~</span> spray, <span class="at">data =</span> InsectSprays)</span>
<span id="cb102-57"><a href="Model-building.html#cb102-57" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ans)</span></code></pre></div>
</div>
<div id="相关统计r包资源" class="section level3 hasAnchor" number="4.2.4">
<h3><span class="header-section-number">4.2.4</span> 相关统计R包资源：<a href="Model-building.html#相关统计r包资源" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="brucer-模型检验和模型整合输出" class="section level4 hasAnchor" number="4.2.4.1">
<h4><span class="header-section-number">4.2.4.1</span> BruceR-模型检验和模型整合输出<a href="Model-building.html#brucer-模型检验和模型整合输出" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="Model-building.html#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">PROCESS</span>()：致敬<span class="fu">Hayes</span> (<span class="dv">2013</span>, <span class="dv">2018</span>)开发的SPSS PROCESS宏程序，更方便地进行各种中介效应和调节效应分析，支持一般<span class="sc">/</span>广义的线性<span class="sc">/</span>线性混合模型。</span>
<span id="cb103-2"><a href="Model-building.html#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="fu">HLM_ICC_rWG</span>()：计算多层线性模型的<span class="fu">ICC</span>(<span class="dv">1</span>)、<span class="fu">ICC</span>(<span class="dv">2</span>)、rWG指标。</span>
<span id="cb103-3"><a href="Model-building.html#cb103-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lavaan_summary</span>()：整理、汇总lavaan包的结构方程模型结果，同时可以更方便地计算各种类型的bootstrap置信区间。</span>
<span id="cb103-4"><a href="Model-building.html#cb103-4" aria-hidden="true" tabindex="-1"></a><span class="fu">granger_causality</span>()：多元时间序列数据的格兰杰因果检验。</span>
<span id="cb103-5"><a href="Model-building.html#cb103-5" aria-hidden="true" tabindex="-1"></a><span class="fu">show_colors</span>()：展示不同颜色或配色方案。</span>
<span id="cb103-6"><a href="Model-building.html#cb103-6" aria-hidden="true" tabindex="-1"></a><span class="sc">%^%</span>：<span class="fu">paste0</span>()的管道函数版本，更方便地拼接字符串。</span>
<span id="cb103-7"><a href="Model-building.html#cb103-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-8"><a href="Model-building.html#cb103-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 其他资料参见；</span></span>
<span id="cb103-9"><a href="Model-building.html#cb103-9" aria-hidden="true" tabindex="-1"></a>https<span class="sc">:</span><span class="er">//</span>zhuanlan.zhihu.com<span class="sc">/</span>p<span class="sc">/</span><span class="dv">376007591</span></span>
<span id="cb103-10"><a href="Model-building.html#cb103-10" aria-hidden="true" tabindex="-1"></a>https<span class="sc">:</span><span class="er">//</span>zhuanlan.zhihu.com<span class="sc">/</span>p<span class="sc">/</span><span class="dv">281150493</span></span></code></pre></div>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="Model-building.html#cb104-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-2"><a href="Model-building.html#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages(&quot;bruceR&quot;)####</span></span>
<span id="cb104-3"><a href="Model-building.html#cb104-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bruceR)</span>
<span id="cb104-4"><a href="Model-building.html#cb104-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 基础R编程（自动设置文件夹路径、一站式数据导入导出、数据匹配拼接等）</span></span>
<span id="cb104-5"><a href="Model-building.html#cb104-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 多变量计算（极简化计算多题项平均分/总分及反向计分、数值重新编码等）</span></span>
<span id="cb104-6"><a href="Model-building.html#cb104-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 信度与因素分析（量表信度分析、探索性因素分析EFA、主成分分析PCA、验证性因素分析CFA）</span></span>
<span id="cb104-7"><a href="Model-building.html#cb104-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 描述与相关分析（描述统计、频数统计、相关分析、相关系数差异性检验）</span></span>
<span id="cb104-8"><a href="Model-building.html#cb104-8" aria-hidden="true" tabindex="-1"></a><span class="co"># t检验与方差分析（单样本/独立样本/配对样本t检验、多因素被试间/被试内/混合设计方差分析ANOVA、简单效应检验与多重比较）</span></span>
<span id="cb104-9"><a href="Model-building.html#cb104-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 普通与多层回归分析（多种回归模型结果的完整报告与表格输出、多层线性模型HLM补充分析）</span></span>
<span id="cb104-10"><a href="Model-building.html#cb104-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 中介与调节效应分析（普通与多水平的中介效应、调节效应、有调节的中介效应等，包括简单斜率分析、条件中介作用、链式中介作用、跨层调节作用等）</span></span>
<span id="cb104-11"><a href="Model-building.html#cb104-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 统计与绘图辅助工具（总均值/组均值中心化处理、时间序列交叉相关分析与格兰杰因果检验、ggplot2绘图主题theme_bruce、颜色卡/配色方案展示等）</span></span>
<span id="cb104-12"><a href="Model-building.html#cb104-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-13"><a href="Model-building.html#cb104-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-14"><a href="Model-building.html#cb104-14" aria-hidden="true" tabindex="-1"></a><span class="do">## 数据清理与导入：</span></span>
<span id="cb104-15"><a href="Model-building.html#cb104-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 导入</span></span>
<span id="cb104-16"><a href="Model-building.html#cb104-16" aria-hidden="true" tabindex="-1"></a>data<span class="ot">=</span><span class="fu">import</span>(<span class="st">&quot;MyData.csv&quot;</span>)</span>
<span id="cb104-17"><a href="Model-building.html#cb104-17" aria-hidden="true" tabindex="-1"></a><span class="fu">export</span>(data, <span class="at">file=</span><span class="st">&quot;NewData.csv&quot;</span>)</span>
<span id="cb104-18"><a href="Model-building.html#cb104-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 一次同时导出两个数据集到Excel</span></span>
<span id="cb104-19"><a href="Model-building.html#cb104-19" aria-hidden="true" tabindex="-1"></a><span class="fu">export</span>(<span class="fu">list</span>(airquality, npk), <span class="at">sheet=</span><span class="fu">c</span>(<span class="st">&quot;air&quot;</span>, <span class="st">&quot;npk&quot;</span>), <span class="at">file=</span><span class="st">&quot;Two_Datasets.xlsx&quot;</span>)</span>
<span id="cb104-20"><a href="Model-building.html#cb104-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-21"><a href="Model-building.html#cb104-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-22"><a href="Model-building.html#cb104-22" aria-hidden="true" tabindex="-1"></a><span class="do">## 打印三线表(表格或者统计模型)到word或者控制台；</span></span>
<span id="cb104-23"><a href="Model-building.html#cb104-23" aria-hidden="true" tabindex="-1"></a>dt<span class="ot">=</span><span class="fu">as.data.table</span>(psych<span class="sc">::</span>bfi)</span>
<span id="cb104-24"><a href="Model-building.html#cb104-24" aria-hidden="true" tabindex="-1"></a>dt[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb104-25"><a href="Model-building.html#cb104-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">E=</span><span class="fu">MEAN</span>(dt, <span class="st">&quot;E&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">rev=</span><span class="fu">c</span>(<span class="st">&quot;E1&quot;</span>, <span class="st">&quot;E2&quot;</span>), <span class="at">likert=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>),</span>
<span id="cb104-26"><a href="Model-building.html#cb104-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">A=</span><span class="fu">MEAN</span>(dt, <span class="st">&quot;A&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">rev=</span><span class="st">&quot;A1&quot;</span>, <span class="at">likert=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>),</span>
<span id="cb104-27"><a href="Model-building.html#cb104-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">C=</span><span class="fu">MEAN</span>(dt, <span class="st">&quot;C&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">rev=</span><span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">5</span>), <span class="at">likert=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>),</span>
<span id="cb104-28"><a href="Model-building.html#cb104-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">N=</span><span class="fu">MEAN</span>(dt, <span class="st">&quot;N&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">likert=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>),</span>
<span id="cb104-29"><a href="Model-building.html#cb104-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">O=</span><span class="fu">MEAN</span>(dt, <span class="st">&quot;O&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">rev=</span><span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">5</span>), <span class="at">likert=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>)</span>
<span id="cb104-30"><a href="Model-building.html#cb104-30" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb104-31"><a href="Model-building.html#cb104-31" aria-hidden="true" tabindex="-1"></a>dt</span>
<span id="cb104-32"><a href="Model-building.html#cb104-32" aria-hidden="true" tabindex="-1"></a><span class="fu">print_table</span>(dt) <span class="do">## 打印到控制台</span></span>
<span id="cb104-33"><a href="Model-building.html#cb104-33" aria-hidden="true" tabindex="-1"></a><span class="do">## 打印到word：</span></span>
<span id="cb104-34"><a href="Model-building.html#cb104-34" aria-hidden="true" tabindex="-1"></a><span class="fu">print_table</span>(<span class="fu">head</span>(dt), <span class="at">file=</span><span class="st">&quot;Results2.doc&quot;</span>)</span>
<span id="cb104-35"><a href="Model-building.html#cb104-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-36"><a href="Model-building.html#cb104-36" aria-hidden="true" tabindex="-1"></a><span class="do">## 打印模型结果输出：</span></span>
<span id="cb104-37"><a href="Model-building.html#cb104-37" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(iris)</span>
<span id="cb104-38"><a href="Model-building.html#cb104-38" aria-hidden="true" tabindex="-1"></a>model <span class="ot">=</span> <span class="fu">lm</span>(Sepal.Length <span class="sc">~</span> Sepal.Width,<span class="at">data =</span> iris)</span>
<span id="cb104-39"><a href="Model-building.html#cb104-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-40"><a href="Model-building.html#cb104-40" aria-hidden="true" tabindex="-1"></a><span class="fu">print_table</span>(model, <span class="at">file=</span><span class="st">&quot;Results23.doc&quot;</span>)</span>
<span id="cb104-41"><a href="Model-building.html#cb104-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-42"><a href="Model-building.html#cb104-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-43"><a href="Model-building.html#cb104-43" aria-hidden="true" tabindex="-1"></a><span class="do">### 优化现有模型输出 </span></span>
<span id="cb104-44"><a href="Model-building.html#cb104-44" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model) </span>
<span id="cb104-45"><a href="Model-building.html#cb104-45" aria-hidden="true" tabindex="-1"></a><span class="fu">model_summary</span>(model)  </span>
<span id="cb104-46"><a href="Model-building.html#cb104-46" aria-hidden="true" tabindex="-1"></a><span class="fu">GLM_summary</span>(model)</span>
<span id="cb104-47"><a href="Model-building.html#cb104-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-48"><a href="Model-building.html#cb104-48" aria-hidden="true" tabindex="-1"></a><span class="do">## 描述性统计：</span></span>
<span id="cb104-49"><a href="Model-building.html#cb104-49" aria-hidden="true" tabindex="-1"></a><span class="do">## 参数中plotw = T 时出相关关系图：</span></span>
<span id="cb104-50"><a href="Model-building.html#cb104-50" aria-hidden="true" tabindex="-1"></a><span class="do">## N  Mean    SD  |  Median   Min   Max  Skewness  Kurtosis</span></span>
<span id="cb104-51"><a href="Model-building.html#cb104-51" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;GGally&quot;</span>)</span>
<span id="cb104-52"><a href="Model-building.html#cb104-52" aria-hidden="true" tabindex="-1"></a><span class="fu">Describe</span>(iris, <span class="at">plot=</span>F, <span class="at">upper.triangle=</span><span class="cn">TRUE</span>, <span class="at">upper.smooth=</span><span class="st">&quot;lm&quot;</span>)</span>
<span id="cb104-53"><a href="Model-building.html#cb104-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-54"><a href="Model-building.html#cb104-54" aria-hidden="true" tabindex="-1"></a><span class="do">##  排序：带sort() &quot;-&quot;（按频数从大到小排列）或&quot;+&quot;（按频数从小到大排列）</span></span>
<span id="cb104-55"><a href="Model-building.html#cb104-55" aria-hidden="true" tabindex="-1"></a><span class="fu">Freq</span>(iris<span class="sc">$</span>Sepal.Length,<span class="at">sort =</span> <span class="st">&quot;-&quot;</span>)</span>
<span id="cb104-56"><a href="Model-building.html#cb104-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-57"><a href="Model-building.html#cb104-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-58"><a href="Model-building.html#cb104-58" aria-hidden="true" tabindex="-1"></a><span class="do">## 带P值矫正的相关性统计：</span></span>
<span id="cb104-59"><a href="Model-building.html#cb104-59" aria-hidden="true" tabindex="-1"></a><span class="do">## 直接输出，不需要再进行一步协方差转换：</span></span>
<span id="cb104-60"><a href="Model-building.html#cb104-60" aria-hidden="true" tabindex="-1"></a><span class="fu">Corr</span>(airquality)</span>
<span id="cb104-61"><a href="Model-building.html#cb104-61" aria-hidden="true" tabindex="-1"></a><span class="do">## 带出图和相关性统计结果：（输出相关系数及其95%置信区间）</span></span>
<span id="cb104-62"><a href="Model-building.html#cb104-62" aria-hidden="true" tabindex="-1"></a><span class="fu">Corr</span>(airquality, <span class="at">p.adjust=</span><span class="st">&quot;bonferroni&quot;</span>)</span>
<span id="cb104-63"><a href="Model-building.html#cb104-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-64"><a href="Model-building.html#cb104-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-65"><a href="Model-building.html#cb104-65" aria-hidden="true" tabindex="-1"></a><span class="do">## TTEST()：单样本/独立样本/配对样本t检验</span></span>
<span id="cb104-66"><a href="Model-building.html#cb104-66" aria-hidden="true" tabindex="-1"></a><span class="do">## （输出效应量Cohen&#39;s d及其95%置信区间、贝叶斯因子BF10）</span></span>
<span id="cb104-67"><a href="Model-building.html#cb104-67" aria-hidden="true" tabindex="-1"></a><span class="co"># 参数：test.sided：假设检验的方向，默认是双尾（一般用不到这个参数）</span></span>
<span id="cb104-68"><a href="Model-building.html#cb104-68" aria-hidden="true" tabindex="-1"></a><span class="co"># 参数：file：保存的Word文档，默认输出到R控制台</span></span>
<span id="cb104-69"><a href="Model-building.html#cb104-69" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb104-70"><a href="Model-building.html#cb104-70" aria-hidden="true" tabindex="-1"></a>d1<span class="ot">=</span>between<span class="fl">.3</span></span>
<span id="cb104-71"><a href="Model-building.html#cb104-71" aria-hidden="true" tabindex="-1"></a>d1<span class="sc">$</span>Y1<span class="ot">=</span>d1<span class="sc">$</span>SCORE  <span class="co"># 复制一下</span></span>
<span id="cb104-72"><a href="Model-building.html#cb104-72" aria-hidden="true" tabindex="-1"></a>d1<span class="sc">$</span>Y2<span class="ot">=</span><span class="fu">rnorm</span>(<span class="dv">32</span>)  <span class="co"># 随机数</span></span>
<span id="cb104-73"><a href="Model-building.html#cb104-73" aria-hidden="true" tabindex="-1"></a>d1<span class="sc">$</span>B<span class="ot">=</span><span class="fu">factor</span>(d1<span class="sc">$</span>B, <span class="at">levels=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">labels=</span><span class="fu">c</span>(<span class="st">&quot;Low&quot;</span>, <span class="st">&quot;High&quot;</span>))</span>
<span id="cb104-74"><a href="Model-building.html#cb104-74" aria-hidden="true" tabindex="-1"></a>d1<span class="sc">$</span>C<span class="ot">=</span><span class="fu">factor</span>(d1<span class="sc">$</span>C, <span class="at">levels=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">labels=</span><span class="fu">c</span>(<span class="st">&quot;M&quot;</span>, <span class="st">&quot;F&quot;</span>))</span>
<span id="cb104-75"><a href="Model-building.html#cb104-75" aria-hidden="true" tabindex="-1"></a>d2<span class="ot">=</span>within<span class="fl">.1</span></span>
<span id="cb104-76"><a href="Model-building.html#cb104-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-77"><a href="Model-building.html#cb104-77" aria-hidden="true" tabindex="-1"></a><span class="do">## 单样本t检验 ##</span></span>
<span id="cb104-78"><a href="Model-building.html#cb104-78" aria-hidden="true" tabindex="-1"></a><span class="fu">TTEST</span>(d1, <span class="st">&quot;SCORE&quot;</span>)</span>
<span id="cb104-79"><a href="Model-building.html#cb104-79" aria-hidden="true" tabindex="-1"></a><span class="fu">TTEST</span>(d1, <span class="st">&quot;SCORE&quot;</span>, <span class="at">test.value=</span><span class="dv">5</span>)</span>
<span id="cb104-80"><a href="Model-building.html#cb104-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-81"><a href="Model-building.html#cb104-81" aria-hidden="true" tabindex="-1"></a><span class="do">## 独立样本t检验 ##</span></span>
<span id="cb104-82"><a href="Model-building.html#cb104-82" aria-hidden="true" tabindex="-1"></a><span class="fu">TTEST</span>(d1, <span class="st">&quot;SCORE&quot;</span>, <span class="at">x=</span><span class="st">&quot;A&quot;</span>)</span>
<span id="cb104-83"><a href="Model-building.html#cb104-83" aria-hidden="true" tabindex="-1"></a><span class="fu">TTEST</span>(d1, <span class="st">&quot;SCORE&quot;</span>, <span class="at">x=</span><span class="st">&quot;A&quot;</span>, <span class="at">var.equal=</span><span class="cn">FALSE</span>)</span>
<span id="cb104-84"><a href="Model-building.html#cb104-84" aria-hidden="true" tabindex="-1"></a><span class="do">## 批量分析多个自变量和因变量：</span></span>
<span id="cb104-85"><a href="Model-building.html#cb104-85" aria-hidden="true" tabindex="-1"></a><span class="fu">TTEST</span>(d1, <span class="at">y=</span><span class="st">&quot;Y1&quot;</span>, <span class="at">x=</span><span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>, <span class="st">&quot;C&quot;</span>))</span>
<span id="cb104-86"><a href="Model-building.html#cb104-86" aria-hidden="true" tabindex="-1"></a><span class="fu">TTEST</span>(d1, <span class="at">y=</span><span class="fu">c</span>(<span class="st">&quot;Y1&quot;</span>, <span class="st">&quot;Y2&quot;</span>), <span class="at">x=</span><span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>, <span class="st">&quot;C&quot;</span>),</span>
<span id="cb104-87"><a href="Model-building.html#cb104-87" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean.diff=</span><span class="cn">FALSE</span>,  <span class="co"># 不保存原始均值差异</span></span>
<span id="cb104-88"><a href="Model-building.html#cb104-88" aria-hidden="true" tabindex="-1"></a>      <span class="at">file=</span><span class="st">&quot;t-result.doc&quot;</span>)</span>
<span id="cb104-89"><a href="Model-building.html#cb104-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-90"><a href="Model-building.html#cb104-90" aria-hidden="true" tabindex="-1"></a><span class="do">## 配对样本t检验 ##</span></span>
<span id="cb104-91"><a href="Model-building.html#cb104-91" aria-hidden="true" tabindex="-1"></a><span class="fu">TTEST</span>(d2, <span class="at">y=</span><span class="fu">c</span>(<span class="st">&quot;A1&quot;</span>, <span class="st">&quot;A2&quot;</span>), <span class="at">paired=</span><span class="cn">TRUE</span>)</span>
<span id="cb104-92"><a href="Model-building.html#cb104-92" aria-hidden="true" tabindex="-1"></a><span class="fu">TTEST</span>(d2, <span class="at">y=</span><span class="fu">c</span>(<span class="st">&quot;A1&quot;</span>, <span class="st">&quot;A2&quot;</span>, <span class="st">&quot;A3&quot;</span>, <span class="st">&quot;A4&quot;</span>), <span class="at">paired=</span><span class="cn">TRUE</span>)</span>
<span id="cb104-93"><a href="Model-building.html#cb104-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-94"><a href="Model-building.html#cb104-94" aria-hidden="true" tabindex="-1"></a><span class="do">## MANOVA()：多因素被试间/被试内/混合设计方差分析ANOVA</span></span>
<span id="cb104-95"><a href="Model-building.html#cb104-95" aria-hidden="true" tabindex="-1"></a><span class="do">## （输出效应量partial η²、generalized η²）</span></span>
<span id="cb104-96"><a href="Model-building.html#cb104-96" aria-hidden="true" tabindex="-1"></a><span class="co"># dvs.pattern=&quot;A(.)B(.)&quot;会自动提取&quot;A1B1&quot;、&quot;A1B2&quot;……中的数字作为因素水平；</span></span>
<span id="cb104-97"><a href="Model-building.html#cb104-97" aria-hidden="true" tabindex="-1"></a><span class="co"># between：被试间因素的名称</span></span>
<span id="cb104-98"><a href="Model-building.html#cb104-98" aria-hidden="true" tabindex="-1"></a><span class="co"># within：被试内因素的名称</span></span>
<span id="cb104-99"><a href="Model-building.html#cb104-99" aria-hidden="true" tabindex="-1"></a><span class="co"># covariate：协变量的名称</span></span>
<span id="cb104-100"><a href="Model-building.html#cb104-100" aria-hidden="true" tabindex="-1"></a><span class="do">## sph.correction：重复测量ANOVA中，违背球形假设后的校正方法，续下：</span></span>
<span id="cb104-101"><a href="Model-building.html#cb104-101" aria-hidden="true" tabindex="-1"></a><span class="do">## 默认是&quot;none&quot;，可选择&quot;GG&quot;（Greenhouse-Geisser）或&quot;HF&quot;（Huynh-Feldt）</span></span>
<span id="cb104-102"><a href="Model-building.html#cb104-102" aria-hidden="true" tabindex="-1"></a><span class="co"># 补充：P&lt;P0.05 差异有统计学意义 假设成立 两方差的相差有显著意义。</span></span>
<span id="cb104-103"><a href="Model-building.html#cb104-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-104"><a href="Model-building.html#cb104-104" aria-hidden="true" tabindex="-1"></a><span class="do">## 被试间设计 ##</span></span>
<span id="cb104-105"><a href="Model-building.html#cb104-105" aria-hidden="true" tabindex="-1"></a>between<span class="fl">.2</span></span>
<span id="cb104-106"><a href="Model-building.html#cb104-106" aria-hidden="true" tabindex="-1"></a><span class="fu">MANOVA</span>(between<span class="fl">.2</span>, <span class="at">dv=</span><span class="st">&quot;SCORE&quot;</span>, <span class="at">between=</span><span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>))</span>
<span id="cb104-107"><a href="Model-building.html#cb104-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-108"><a href="Model-building.html#cb104-108" aria-hidden="true" tabindex="-1"></a><span class="do">## 被试内设计 ##</span></span>
<span id="cb104-109"><a href="Model-building.html#cb104-109" aria-hidden="true" tabindex="-1"></a>within<span class="fl">.3</span></span>
<span id="cb104-110"><a href="Model-building.html#cb104-110" aria-hidden="true" tabindex="-1"></a><span class="fu">MANOVA</span>(within<span class="fl">.3</span>, <span class="at">dvs=</span><span class="st">&quot;A1B1C1:A2B2C2&quot;</span>, <span class="at">dvs.pattern=</span><span class="st">&quot;A(.)B(.)C(.)&quot;</span>,</span>
<span id="cb104-111"><a href="Model-building.html#cb104-111" aria-hidden="true" tabindex="-1"></a>       <span class="at">within=</span><span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>, <span class="st">&quot;C&quot;</span>))</span>
<span id="cb104-112"><a href="Model-building.html#cb104-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-113"><a href="Model-building.html#cb104-113" aria-hidden="true" tabindex="-1"></a><span class="do">## 混合设计 ## 这里的混合设计，应该是指组件和组内的设计水平同时检测：</span></span>
<span id="cb104-114"><a href="Model-building.html#cb104-114" aria-hidden="true" tabindex="-1"></a>mixed<span class="fl">.3</span>_2b1w</span>
<span id="cb104-115"><a href="Model-building.html#cb104-115" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;afex&quot;</span>)</span>
<span id="cb104-116"><a href="Model-building.html#cb104-116" aria-hidden="true" tabindex="-1"></a><span class="fu">MANOVA</span>(mixed<span class="fl">.3</span>_2b1w, <span class="at">dvs=</span><span class="st">&quot;B1:B2&quot;</span>, <span class="at">dvs.pattern=</span><span class="st">&quot;B(.)&quot;</span>,</span>
<span id="cb104-117"><a href="Model-building.html#cb104-117" aria-hidden="true" tabindex="-1"></a>       <span class="at">between=</span><span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;C&quot;</span>), <span class="at">within=</span><span class="st">&quot;B&quot;</span>)</span>
<span id="cb104-118"><a href="Model-building.html#cb104-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-119"><a href="Model-building.html#cb104-119" aria-hidden="true" tabindex="-1"></a><span class="do">## 换个变量名 ##</span></span>
<span id="cb104-120"><a href="Model-building.html#cb104-120" aria-hidden="true" tabindex="-1"></a>data.new<span class="ot">=</span>mixed<span class="fl">.3</span>_1b2w</span>
<span id="cb104-121"><a href="Model-building.html#cb104-121" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data.new)<span class="ot">=</span><span class="fu">c</span>(<span class="st">&quot;Group&quot;</span>, <span class="st">&quot;Cond_01&quot;</span>, <span class="st">&quot;Cond_02&quot;</span>, <span class="st">&quot;Cond_03&quot;</span>, <span class="st">&quot;Cond_04&quot;</span>)</span>
<span id="cb104-122"><a href="Model-building.html#cb104-122" aria-hidden="true" tabindex="-1"></a><span class="fu">MANOVA</span>(data.new,</span>
<span id="cb104-123"><a href="Model-building.html#cb104-123" aria-hidden="true" tabindex="-1"></a>       <span class="at">dvs=</span><span class="st">&quot;Cond_01:Cond_04&quot;</span>,</span>
<span id="cb104-124"><a href="Model-building.html#cb104-124" aria-hidden="true" tabindex="-1"></a>       <span class="at">dvs.pattern=</span><span class="st">&quot;Cond_(..)&quot;</span>,</span>
<span id="cb104-125"><a href="Model-building.html#cb104-125" aria-hidden="true" tabindex="-1"></a>       <span class="at">between=</span><span class="st">&quot;Group&quot;</span>,</span>
<span id="cb104-126"><a href="Model-building.html#cb104-126" aria-hidden="true" tabindex="-1"></a>       <span class="at">within=</span><span class="st">&quot;Condition&quot;</span>)</span>
<span id="cb104-127"><a href="Model-building.html#cb104-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-128"><a href="Model-building.html#cb104-128" aria-hidden="true" tabindex="-1"></a><span class="do">## 长数据也行 ##</span></span>
<span id="cb104-129"><a href="Model-building.html#cb104-129" aria-hidden="true" tabindex="-1"></a><span class="do">## 这个很有用，典型案例：</span></span>
<span id="cb104-130"><a href="Model-building.html#cb104-130" aria-hidden="true" tabindex="-1"></a><span class="co"># 同时比较组内、组件、协方差内数据间的方差波动水平：</span></span>
<span id="cb104-131"><a href="Model-building.html#cb104-131" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(afex)</span>
<span id="cb104-132"><a href="Model-building.html#cb104-132" aria-hidden="true" tabindex="-1"></a>?afex<span class="sc">::</span>obk.long</span>
<span id="cb104-133"><a href="Model-building.html#cb104-133" aria-hidden="true" tabindex="-1"></a><span class="fu">MANOVA</span>(afex<span class="sc">::</span>obk.long,</span>
<span id="cb104-134"><a href="Model-building.html#cb104-134" aria-hidden="true" tabindex="-1"></a>       <span class="at">subID=</span><span class="st">&quot;id&quot;</span>,</span>
<span id="cb104-135"><a href="Model-building.html#cb104-135" aria-hidden="true" tabindex="-1"></a>       <span class="at">dv=</span><span class="st">&quot;value&quot;</span>,</span>
<span id="cb104-136"><a href="Model-building.html#cb104-136" aria-hidden="true" tabindex="-1"></a>       <span class="at">between=</span><span class="fu">c</span>(<span class="st">&quot;treatment&quot;</span>, <span class="st">&quot;gender&quot;</span>),</span>
<span id="cb104-137"><a href="Model-building.html#cb104-137" aria-hidden="true" tabindex="-1"></a>       <span class="at">within=</span><span class="fu">c</span>(<span class="st">&quot;phase&quot;</span>, <span class="st">&quot;hour&quot;</span>),</span>
<span id="cb104-138"><a href="Model-building.html#cb104-138" aria-hidden="true" tabindex="-1"></a>       <span class="at">cov=</span><span class="st">&quot;age&quot;</span>,</span>
<span id="cb104-139"><a href="Model-building.html#cb104-139" aria-hidden="true" tabindex="-1"></a>       <span class="at">sph.correction=</span><span class="st">&quot;GG&quot;</span>)</span>
<span id="cb104-140"><a href="Model-building.html#cb104-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-141"><a href="Model-building.html#cb104-141" aria-hidden="true" tabindex="-1"></a><span class="do">## EMMEANS()：简单效应检验与多重比较</span></span>
<span id="cb104-142"><a href="Model-building.html#cb104-142" aria-hidden="true" tabindex="-1"></a><span class="do">## （输出效应量Cohen&#39;s d及其95%置信区间）</span></span>
<span id="cb104-143"><a href="Model-building.html#cb104-143" aria-hidden="true" tabindex="-1"></a><span class="co"># effect：待检验的“简单主效应”（如果输入多个，还会报告“简单交互作用”和“简单简单效应”）</span></span>
<span id="cb104-144"><a href="Model-building.html#cb104-144" aria-hidden="true" tabindex="-1"></a><span class="co"># by：简单效应检验中的“调节变量”（也可以输入多个，则检验“简单简单效应”）</span></span>
<span id="cb104-145"><a href="Model-building.html#cb104-145" aria-hidden="true" tabindex="-1"></a><span class="co"># 在这里管道符传递以后还会继续传递结果，并保存下一个结果：</span></span>
<span id="cb104-146"><a href="Model-building.html#cb104-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-147"><a href="Model-building.html#cb104-147" aria-hidden="true" tabindex="-1"></a><span class="co"># between.2</span></span>
<span id="cb104-148"><a href="Model-building.html#cb104-148" aria-hidden="true" tabindex="-1"></a><span class="fu">MANOVA</span>(between<span class="fl">.2</span>, <span class="at">dv=</span><span class="st">&quot;SCORE&quot;</span>, <span class="at">between=</span><span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb104-149"><a href="Model-building.html#cb104-149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">EMMEANS</span>(<span class="st">&quot;A&quot;</span>, <span class="at">by=</span><span class="st">&quot;B&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb104-150"><a href="Model-building.html#cb104-150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">EMMEANS</span>(<span class="st">&quot;B&quot;</span>, <span class="at">by=</span><span class="st">&quot;A&quot;</span>)</span>
<span id="cb104-151"><a href="Model-building.html#cb104-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-152"><a href="Model-building.html#cb104-152" aria-hidden="true" tabindex="-1"></a><span class="co"># within.3</span></span>
<span id="cb104-153"><a href="Model-building.html#cb104-153" aria-hidden="true" tabindex="-1"></a><span class="fu">MANOVA</span>(within<span class="fl">.3</span>, <span class="at">dvs=</span><span class="st">&quot;A1B1C1:A2B2C2&quot;</span>, <span class="at">dvs.pattern=</span><span class="st">&quot;A(.)B(.)C(.)&quot;</span>,</span>
<span id="cb104-154"><a href="Model-building.html#cb104-154" aria-hidden="true" tabindex="-1"></a>       <span class="at">within=</span><span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>, <span class="st">&quot;C&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb104-155"><a href="Model-building.html#cb104-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">EMMEANS</span>(<span class="st">&quot;A&quot;</span>, <span class="at">by=</span><span class="st">&quot;B&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb104-156"><a href="Model-building.html#cb104-156" aria-hidden="true" tabindex="-1"></a>  <span class="fu">EMMEANS</span>(<span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>), <span class="at">by=</span><span class="st">&quot;C&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb104-157"><a href="Model-building.html#cb104-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">EMMEANS</span>(<span class="st">&quot;A&quot;</span>, <span class="at">by=</span><span class="fu">c</span>(<span class="st">&quot;B&quot;</span>, <span class="st">&quot;C&quot;</span>))</span></code></pre></div>
</div>
<div id="rstatix使用指南" class="section level4 hasAnchor" number="4.2.4.2">
<h4><span class="header-section-number">4.2.4.2</span> rstatix使用指南<a href="Model-building.html#rstatix使用指南" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="Model-building.html#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="do">### 描述统计量</span></span>
<span id="cb105-2"><a href="Model-building.html#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="fu">get_summary_stats</span>()<span class="sc">:</span> Compute summary statistics <span class="cf">for</span> one or multiple numeric variables. Can handle grouped data.</span>
<span id="cb105-3"><a href="Model-building.html#cb105-3" aria-hidden="true" tabindex="-1"></a><span class="fu">freq_table</span>()<span class="sc">:</span> Compute frequency table of categorical variables.</span>
<span id="cb105-4"><a href="Model-building.html#cb105-4" aria-hidden="true" tabindex="-1"></a><span class="fu">get_mode</span>()<span class="sc">:</span> Compute the mode of a vector, that is the most frequent values.</span>
<span id="cb105-5"><a href="Model-building.html#cb105-5" aria-hidden="true" tabindex="-1"></a><span class="fu">identify_outliers</span>()<span class="sc">:</span> Detect univariate outliers using boxplot methods.</span>
<span id="cb105-6"><a href="Model-building.html#cb105-6" aria-hidden="true" tabindex="-1"></a><span class="fu">mahalanobis_distance</span>()<span class="sc">:</span> Compute Mahalanobis Distance and Flag Multivariate Outliers.</span>
<span id="cb105-7"><a href="Model-building.html#cb105-7" aria-hidden="true" tabindex="-1"></a><span class="fu">shapiro_test</span>() and <span class="fu">mshapiro_test</span>()<span class="sc">:</span> Univariate and multivariate Shapiro<span class="sc">-</span>Wilk normality test. </span>
<span id="cb105-8"><a href="Model-building.html#cb105-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-9"><a href="Model-building.html#cb105-9" aria-hidden="true" tabindex="-1"></a><span class="do">### 比较均值</span></span>
<span id="cb105-10"><a href="Model-building.html#cb105-10" aria-hidden="true" tabindex="-1"></a><span class="fu">t_test</span>()<span class="sc">:</span> perform one<span class="sc">-</span>sample, two<span class="sc">-</span>sample and pairwise t<span class="sc">-</span>tests</span>
<span id="cb105-11"><a href="Model-building.html#cb105-11" aria-hidden="true" tabindex="-1"></a><span class="fu">wilcox_test</span>()<span class="sc">:</span> perform one<span class="sc">-</span>sample, two<span class="sc">-</span>sample and pairwise Wilcoxon tests</span>
<span id="cb105-12"><a href="Model-building.html#cb105-12" aria-hidden="true" tabindex="-1"></a><span class="fu">sign_test</span>()<span class="sc">:</span> perform sign test to determine whether there is a median difference between paired or matched observations.</span>
<span id="cb105-13"><a href="Model-building.html#cb105-13" aria-hidden="true" tabindex="-1"></a><span class="fu">anova_test</span>()<span class="sc">:</span> an easy<span class="sc">-</span>to<span class="sc">-</span>use wrapper around car<span class="sc">::</span><span class="fu">Anova</span>() to perform different types of ANOVA tests, including independent measures ANOVA, repeated measures ANOVA and mixed ANOVA.</span>
<span id="cb105-14"><a href="Model-building.html#cb105-14" aria-hidden="true" tabindex="-1"></a><span class="fu">kruskal_test</span>()<span class="sc">:</span> perform kruskal<span class="sc">-</span>wallis rank sum test</span>
<span id="cb105-15"><a href="Model-building.html#cb105-15" aria-hidden="true" tabindex="-1"></a><span class="fu">tukey_hsd</span>()<span class="sc">:</span> performs tukey post<span class="sc">-</span>hoc tests. Can handle different inputs formats<span class="sc">:</span> aov, lm, formula.</span>
<span id="cb105-16"><a href="Model-building.html#cb105-16" aria-hidden="true" tabindex="-1"></a><span class="fu">dunn_test</span>()<span class="sc">:</span> compute multiple pairwise comparisons following Kruskal<span class="sc">-</span>Wallis test.</span>
<span id="cb105-17"><a href="Model-building.html#cb105-17" aria-hidden="true" tabindex="-1"></a><span class="fu">emmeans_test</span>()<span class="sc">:</span> pipe<span class="sc">-</span>friendly wrapper arround emmeans <span class="cf">function</span> to perform pairwise comparisons of estimated marginal means. Useful <span class="cf">for</span> post<span class="sc">-</span>hoc analyses following up ANOVA<span class="sc">/</span>ANCOVA tests.</span>
<span id="cb105-18"><a href="Model-building.html#cb105-18" aria-hidden="true" tabindex="-1"></a><span class="fu">get_comparisons</span>()<span class="sc">:</span> Create a list of possible pairwise comparisons between groups.</span>
<span id="cb105-19"><a href="Model-building.html#cb105-19" aria-hidden="true" tabindex="-1"></a>get_pvalue_position<span class="sc">:</span> autocompute p<span class="sc">-</span>value positions <span class="cf">for</span> plotting significance using ggplot2.</span>
<span id="cb105-20"><a href="Model-building.html#cb105-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-21"><a href="Model-building.html#cb105-21" aria-hidden="true" tabindex="-1"></a><span class="do">### 促进R的ANOVA计算</span></span>
<span id="cb105-22"><a href="Model-building.html#cb105-22" aria-hidden="true" tabindex="-1"></a><span class="fu">factorial_design</span>()<span class="sc">:</span> build factorial design <span class="cf">for</span> easily computing ANOVA using the car<span class="sc">::</span><span class="fu">Anova</span>() function. This might be very useful <span class="cf">for</span> repeated measures ANOVA, which is hard to set up with the car package.</span>
<span id="cb105-23"><a href="Model-building.html#cb105-23" aria-hidden="true" tabindex="-1"></a><span class="fu">anova_summary</span>()<span class="sc">:</span> Create beautiful summary tables of ANOVA test results obtained from either car<span class="sc">::</span><span class="fu">Anova</span>() or stats<span class="sc">::</span><span class="fu">aov</span>(). The results include ANOVA table, generalized effect size and some assumption checks, such as Mauchly’s test <span class="cf">for</span> sphericity <span class="cf">in</span> the case of repeated measures ANOVA.</span>
<span id="cb105-24"><a href="Model-building.html#cb105-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb105-25"><a href="Model-building.html#cb105-25" aria-hidden="true" tabindex="-1"></a><span class="do">### 比较方差</span></span>
<span id="cb105-26"><a href="Model-building.html#cb105-26" aria-hidden="true" tabindex="-1"></a><span class="fu">levene_test</span>()<span class="sc">:</span> Pipe<span class="sc">-</span>friendly framework to easily compute Levene’s test <span class="cf">for</span> homogeneity of variance across groups. Handles grouped data.</span>
<span id="cb105-27"><a href="Model-building.html#cb105-27" aria-hidden="true" tabindex="-1"></a><span class="fu">box_m</span>()<span class="sc">:</span> Box’s M<span class="sc">-</span>test <span class="cf">for</span> homogeneity of covariance matrices</span>
<span id="cb105-28"><a href="Model-building.html#cb105-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-29"><a href="Model-building.html#cb105-29" aria-hidden="true" tabindex="-1"></a><span class="do">### 效应值</span></span>
<span id="cb105-30"><a href="Model-building.html#cb105-30" aria-hidden="true" tabindex="-1"></a><span class="fu">cohens_d</span>()<span class="sc">:</span> Compute cohen’s d measure of effect size <span class="cf">for</span> t<span class="sc">-</span>tests.</span>
<span id="cb105-31"><a href="Model-building.html#cb105-31" aria-hidden="true" tabindex="-1"></a><span class="fu">eta_squared</span>() and <span class="fu">partial_eta_squared</span>()<span class="sc">:</span> Compute effect size <span class="cf">for</span> ANOVA.</span>
<span id="cb105-32"><a href="Model-building.html#cb105-32" aria-hidden="true" tabindex="-1"></a><span class="fu">cramer_v</span>()<span class="sc">:</span> Compute Cramer’s V, which measures the strength of the association between categorical variables.</span>
<span id="cb105-33"><a href="Model-building.html#cb105-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-34"><a href="Model-building.html#cb105-34" aria-hidden="true" tabindex="-1"></a><span class="do">### 相关分析 计算相关性:</span></span>
<span id="cb105-35"><a href="Model-building.html#cb105-35" aria-hidden="true" tabindex="-1"></a><span class="fu">cor_test</span>()<span class="sc">:</span> correlation test between two or more variables using Pearson, Spearman or Kendall methods.</span>
<span id="cb105-36"><a href="Model-building.html#cb105-36" aria-hidden="true" tabindex="-1"></a><span class="fu">cor_mat</span>()<span class="sc">:</span> compute correlation matrix with p<span class="sc">-</span>values. Returns a data frame containing the matrix of the correlation coefficients. The output has an attribute named “pvalue”, which contains the matrix of the correlation test p<span class="sc">-</span>values.</span>
<span id="cb105-37"><a href="Model-building.html#cb105-37" aria-hidden="true" tabindex="-1"></a><span class="fu">cor_get_pval</span>()<span class="sc">:</span> extract a correlation matrix p<span class="sc">-</span>values from an object of class <span class="fu">cor_mat</span>().</span>
<span id="cb105-38"><a href="Model-building.html#cb105-38" aria-hidden="true" tabindex="-1"></a><span class="fu">cor_pmat</span>()<span class="sc">:</span> compute the correlation matrix, but returns only the p<span class="sc">-</span>values of the correlation tests.</span>
<span id="cb105-39"><a href="Model-building.html#cb105-39" aria-hidden="true" tabindex="-1"></a><span class="fu">as_cor_mat</span>()<span class="sc">:</span> convert a cor_test object into a correlation matrix format.</span>
<span id="cb105-40"><a href="Model-building.html#cb105-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-41"><a href="Model-building.html#cb105-41" aria-hidden="true" tabindex="-1"></a><span class="do">## 重塑相关矩阵:</span></span>
<span id="cb105-42"><a href="Model-building.html#cb105-42" aria-hidden="true" tabindex="-1"></a><span class="fu">cor_reorder</span>()<span class="sc">:</span> reorder correlation matrix, according to the coefficients, using the hierarchical clustering method.</span>
<span id="cb105-43"><a href="Model-building.html#cb105-43" aria-hidden="true" tabindex="-1"></a><span class="fu">cor_gather</span>()<span class="sc">:</span> takes a correlation matrix and <span class="fu">collapses</span> (or melt) it into long format data <span class="fu">frame</span> (paired list)</span>
<span id="cb105-44"><a href="Model-building.html#cb105-44" aria-hidden="true" tabindex="-1"></a><span class="fu">cor_spread</span>()<span class="sc">:</span> spread a long correlation data frame into wide <span class="fu">format</span> (correlation matrix).</span>
<span id="cb105-45"><a href="Model-building.html#cb105-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-46"><a href="Model-building.html#cb105-46" aria-hidden="true" tabindex="-1"></a><span class="do">## 取子集:</span></span>
<span id="cb105-47"><a href="Model-building.html#cb105-47" aria-hidden="true" tabindex="-1"></a><span class="fu">cor_select</span>()<span class="sc">:</span> subset a correlation matrix by selecting variables of interest.</span>
<span id="cb105-48"><a href="Model-building.html#cb105-48" aria-hidden="true" tabindex="-1"></a><span class="fu">pull_triangle</span>(), <span class="fu">pull_upper_triangle</span>(), <span class="fu">pull_lower_triangle</span>()<span class="sc">:</span> pull upper and lower triangular parts of <span class="fu">a</span> (correlation) matrix.</span>
<span id="cb105-49"><a href="Model-building.html#cb105-49" aria-hidden="true" tabindex="-1"></a><span class="fu">replace_triangle</span>(), <span class="fu">replace_upper_triangle</span>(), <span class="fu">replace_lower_triangle</span>()<span class="sc">:</span> replace upper and lower triangular parts of <span class="fu">a</span> (correlation) matrix.</span>
<span id="cb105-50"><a href="Model-building.html#cb105-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-51"><a href="Model-building.html#cb105-51" aria-hidden="true" tabindex="-1"></a><span class="do">## 可视化相关矩阵:</span></span>
<span id="cb105-52"><a href="Model-building.html#cb105-52" aria-hidden="true" tabindex="-1"></a><span class="fu">cor_as_symbols</span>()<span class="sc">:</span> replaces the correlation coefficients, <span class="cf">in</span> a matrix, by symbols according to the value.</span>
<span id="cb105-53"><a href="Model-building.html#cb105-53" aria-hidden="true" tabindex="-1"></a><span class="fu">cor_plot</span>()<span class="sc">:</span> visualize correlation matrix using base plot.</span>
<span id="cb105-54"><a href="Model-building.html#cb105-54" aria-hidden="true" tabindex="-1"></a><span class="fu">cor_mark_significant</span>()<span class="sc">:</span> add significance levels to a correlation matrix.</span>
<span id="cb105-55"><a href="Model-building.html#cb105-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-56"><a href="Model-building.html#cb105-56" aria-hidden="true" tabindex="-1"></a><span class="do">#### 矫正p值和添加显著性标记</span></span>
<span id="cb105-57"><a href="Model-building.html#cb105-57" aria-hidden="true" tabindex="-1"></a><span class="fu">adjust_pvalue</span>()<span class="sc">:</span> add an adjusted p<span class="sc">-</span>values column to a data frame containing statistical test p<span class="sc">-</span>values</span>
<span id="cb105-58"><a href="Model-building.html#cb105-58" aria-hidden="true" tabindex="-1"></a><span class="fu">add_significance</span>()<span class="sc">:</span> add a column containing the p<span class="sc">-</span>value significance level</span>
<span id="cb105-59"><a href="Model-building.html#cb105-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-60"><a href="Model-building.html#cb105-60" aria-hidden="true" tabindex="-1"></a><span class="do">### 其他</span></span>
<span id="cb105-61"><a href="Model-building.html#cb105-61" aria-hidden="true" tabindex="-1"></a><span class="fu">doo</span>()<span class="sc">:</span> alternative to dplyr<span class="sc">::</span>do <span class="cf">for</span> doing anything. Technically it uses <span class="fu">nest</span>() <span class="sc">+</span> <span class="fu">mutate</span>() <span class="sc">+</span> <span class="fu">map</span>() to apply arbitrary computation to a grouped data frame.</span>
<span id="cb105-62"><a href="Model-building.html#cb105-62" aria-hidden="true" tabindex="-1"></a><span class="fu">sample_n_by</span>()<span class="sc">:</span> sample n rows by group from a table</span>
<span id="cb105-63"><a href="Model-building.html#cb105-63" aria-hidden="true" tabindex="-1"></a><span class="fu">convert_as_factor</span>(), <span class="fu">set_ref_level</span>(), <span class="fu">reorder_levels</span>()<span class="sc">:</span> Provides pipe<span class="sc">-</span>friendly functions to convert simultaneously multiple variables into a factor variable.</span>
<span id="cb105-64"><a href="Model-building.html#cb105-64" aria-hidden="true" tabindex="-1"></a><span class="fu">make_clean_names</span>()<span class="sc">:</span> Pipe<span class="sc">-</span>friendly <span class="cf">function</span> to make syntactically valid column <span class="fu">names</span> (<span class="cf">for</span> input data frame) or <span class="fu">names</span> (<span class="cf">for</span> input vector).</span></code></pre></div>
</div>
<div id="eazystat-体系" class="section level4 hasAnchor" number="4.2.4.3">
<h4><span class="header-section-number">4.2.4.3</span> eazystat 体系<a href="Model-building.html#eazystat-体系" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="Model-building.html#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 网站主页;</span></span>
<span id="cb106-2"><a href="Model-building.html#cb106-2" aria-hidden="true" tabindex="-1"></a>https<span class="sc">:</span><span class="er">//</span>www.r<span class="sc">-</span>bloggers.com<span class="sc">/</span><span class="dv">2022</span><span class="sc">/</span><span class="dv">01</span><span class="sc">/</span>happy<span class="sc">-</span>birthday<span class="sc">-</span>easystats<span class="sc">-</span>a<span class="sc">-</span>retrospective<span class="sc">/</span></span>
<span id="cb106-3"><a href="Model-building.html#cb106-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-4"><a href="Model-building.html#cb106-4" aria-hidden="true" tabindex="-1"></a><span class="do">##insight:：</span></span>
<span id="cb106-5"><a href="Model-building.html#cb106-5" aria-hidden="true" tabindex="-1"></a>🔮这个无依赖的低级帮助程序包提供了一个统一的门户来提取有关各种统计模型的信息。如果您（作为用户或开发人员）曾经对 R 中对象的多样性及其提供的 API 以及如何从这种疯狂中创建 (S3) 方法感到沮丧，那么这正是适合您的软件包！</span>
<span id="cb106-6"><a href="Model-building.html#cb106-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-7"><a href="Model-building.html#cb106-7" aria-hidden="true" tabindex="-1"></a><span class="do">## datawizard :</span></span>
<span id="cb106-8"><a href="Model-building.html#cb106-8" aria-hidden="true" tabindex="-1"></a>🧙生态系统的最新成员！这个包构成了整个生态系统的数据整理后端，如果您想进行类似 tidyverse的数据整理，但希望避免向您的项目添加依赖，那么它可能正是您正在寻找的</span>
<span id="cb106-9"><a href="Model-building.html#cb106-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-10"><a href="Model-building.html#cb106-10" aria-hidden="true" tabindex="-1"></a><span class="do">### 然后，我们有专门的软件包来从统计模型中提取额外的信息。</span></span>
<span id="cb106-11"><a href="Model-building.html#cb106-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-12"><a href="Model-building.html#cb106-12" aria-hidden="true" tabindex="-1"></a>bayestestR：</span>
<span id="cb106-13"><a href="Model-building.html#cb106-13" aria-hidden="true" tabindex="-1"></a>👻一个包，提供用于操作和可视化贝叶斯统计模型的实用工具。</span>
<span id="cb106-14"><a href="Model-building.html#cb106-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-15"><a href="Model-building.html#cb106-15" aria-hidden="true" tabindex="-1"></a>effectize：</span>
<span id="cb106-16"><a href="Model-building.html#cb106-16" aria-hidden="true" tabindex="-1"></a>🐉一个一站式解决方案，用于计算人类已知的几乎所有效果大小</span>
<span id="cb106-17"><a href="Model-building.html#cb106-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-18"><a href="Model-building.html#cb106-18" aria-hidden="true" tabindex="-1"></a>correlation：🔗专用于计算和可视化的软件包，可能是最全面的相关性套件。</span>
<span id="cb106-19"><a href="Model-building.html#cb106-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-20"><a href="Model-building.html#cb106-20" aria-hidden="true" tabindex="-1"></a>modelbased：📈一个实用程序包，用于处理统计模型的预测，可用于计算和可视化边际均值或对比分析。</span>
<span id="cb106-21"><a href="Model-building.html#cb106-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-22"><a href="Model-building.html#cb106-22" aria-hidden="true" tabindex="-1"></a><span class="do">### 统计模型的信息通过以下两个包进行提取和聚合：</span></span>
<span id="cb106-23"><a href="Model-building.html#cb106-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-24"><a href="Model-building.html#cb106-24" aria-hidden="true" tabindex="-1"></a>performance：💪计算、分析和测试统计模型的性能。</span>
<span id="cb106-25"><a href="Model-building.html#cb106-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-26"><a href="Model-building.html#cb106-26" aria-hidden="true" tabindex="-1"></a>parameters：📊提取几乎所有统计模型参数的综合数据框，并提供帮助以优雅的表格和图表呈现它们。</span>
<span id="cb106-27"><a href="Model-building.html#cb106-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-28"><a href="Model-building.html#cb106-28" aria-hidden="true" tabindex="-1"></a><span class="do">### 最后，这两个高级软件包利用所有其他软件包以图形或文本方式传达统计分析的结果。</span></span>
<span id="cb106-29"><a href="Model-building.html#cb106-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-30"><a href="Model-building.html#cb106-30" aria-hidden="true" tabindex="-1"></a>see：</span>
<span id="cb106-31"><a href="Model-building.html#cb106-31" aria-hidden="true" tabindex="-1"></a>🎨这个包构成了整个生态系统的可视化后端，并与ggplot2接口以支持各种easystats对象的绘图方法。</span>
<span id="cb106-32"><a href="Model-building.html#cb106-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-33"><a href="Model-building.html#cb106-33" aria-hidden="true" tabindex="-1"></a>report：</span>
<span id="cb106-34"><a href="Model-building.html#cb106-34" aria-hidden="true" tabindex="-1"></a>📜 🎉这个包提供了一种自动化的方式来创建文本报告，详细说明统计分析的结果。</span></code></pre></div>
</div>
<div id="finalfit-辅助批运行回归模型" class="section level4 hasAnchor" number="4.2.4.4">
<h4><span class="header-section-number">4.2.4.4</span> finalfit 辅助批运行回归模型：<a href="Model-building.html#finalfit-辅助批运行回归模型" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="Model-building.html#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 参见资料：</span></span>
<span id="cb107-2"><a href="Model-building.html#cb107-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-3"><a href="Model-building.html#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="do">## 类型1：</span></span>
<span id="cb107-4"><a href="Model-building.html#cb107-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(finalfit)</span>
<span id="cb107-5"><a href="Model-building.html#cb107-5" aria-hidden="true" tabindex="-1"></a>dependent <span class="ot">&lt;-</span> <span class="st">&quot;mort_5yr&quot;</span></span>
<span id="cb107-6"><a href="Model-building.html#cb107-6" aria-hidden="true" tabindex="-1"></a>explanatory <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;ulcer.factor&quot;</span>, <span class="st">&quot;age&quot;</span>, <span class="st">&quot;sex.factor&quot;</span>, <span class="st">&quot;t_stage.factor&quot;</span>)</span>
<span id="cb107-7"><a href="Model-building.html#cb107-7" aria-hidden="true" tabindex="-1"></a>fit2 <span class="ot">=</span> melanoma <span class="sc">%&gt;%</span> </span>
<span id="cb107-8"><a href="Model-building.html#cb107-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalfit</span>(dependent, explanatory, <span class="at">metrics =</span> <span class="cn">TRUE</span>)</span>
<span id="cb107-9"><a href="Model-building.html#cb107-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb107-10"><a href="Model-building.html#cb107-10" aria-hidden="true" tabindex="-1"></a><span class="do">## 类型2：</span></span>
<span id="cb107-11"><a href="Model-building.html#cb107-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(finalfit)</span>
<span id="cb107-12"><a href="Model-building.html#cb107-12" aria-hidden="true" tabindex="-1"></a>dependent <span class="ot">&lt;-</span> <span class="st">&quot;mort_5yr&quot;</span></span>
<span id="cb107-13"><a href="Model-building.html#cb107-13" aria-hidden="true" tabindex="-1"></a>explanatory <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;ulcer.factor&quot;</span>, <span class="st">&quot;I(age^2)&quot;</span>, <span class="st">&quot;age&quot;</span>)</span>
<span id="cb107-14"><a href="Model-building.html#cb107-14" aria-hidden="true" tabindex="-1"></a>melanoma <span class="sc">%&gt;%</span> </span>
<span id="cb107-15"><a href="Model-building.html#cb107-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalfit</span>(dependent, explanatory, <span class="at">metrics =</span> <span class="cn">TRUE</span>)</span>
<span id="cb107-16"><a href="Model-building.html#cb107-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-17"><a href="Model-building.html#cb107-17" aria-hidden="true" tabindex="-1"></a><span class="do">## 绘制逻辑回归的OR森林图：</span></span>
<span id="cb107-18"><a href="Model-building.html#cb107-18" aria-hidden="true" tabindex="-1"></a>dependent <span class="ot">&lt;-</span> <span class="st">&quot;mort_5yr&quot;</span></span>
<span id="cb107-19"><a href="Model-building.html#cb107-19" aria-hidden="true" tabindex="-1"></a>explanatory_multi <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;ulcer.factor&quot;</span>, <span class="st">&quot;t_stage.factor&quot;</span>)</span>
<span id="cb107-20"><a href="Model-building.html#cb107-20" aria-hidden="true" tabindex="-1"></a>melanoma <span class="sc">%&gt;%</span> </span>
<span id="cb107-21"><a href="Model-building.html#cb107-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">or_plot</span>(dependent, explanatory_multi,</span>
<span id="cb107-22"><a href="Model-building.html#cb107-22" aria-hidden="true" tabindex="-1"></a>          <span class="at">breaks =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">25</span>),</span>
<span id="cb107-23"><a href="Model-building.html#cb107-23" aria-hidden="true" tabindex="-1"></a>          <span class="at">table_text_size =</span> <span class="fl">3.5</span>,</span>
<span id="cb107-24"><a href="Model-building.html#cb107-24" aria-hidden="true" tabindex="-1"></a>          <span class="at">title_text_size =</span> <span class="dv">16</span>) </span>
<span id="cb107-25"><a href="Model-building.html#cb107-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-26"><a href="Model-building.html#cb107-26" aria-hidden="true" tabindex="-1"></a><span class="do">##  补充说明：</span></span>
<span id="cb107-27"><a href="Model-building.html#cb107-27" aria-hidden="true" tabindex="-1"></a>finalfit包中函数支持导出的结果到rmarkdown体系中，再经由markdown体系导出到word函数中。</span></code></pre></div>
</div>
</div>
</div>
<div id="临床统计模型" class="section level2 hasAnchor" number="4.3">
<h2><span class="header-section-number">4.3</span> 临床统计模型<a href="Model-building.html#临床统计模型" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="平衡匹配" class="section level3 hasAnchor" number="4.3.1">
<h3><span class="header-section-number">4.3.1</span> 平衡匹配<a href="Model-building.html#平衡匹配" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="Model-building.html#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 进行平衡匹配的主要原因：</span></span>
<span id="cb108-2"><a href="Model-building.html#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 辛普森悖论：</span></span>
<span id="cb108-3"><a href="Model-building.html#cb108-3" aria-hidden="true" tabindex="-1"></a>https<span class="sc">:</span><span class="er">//</span>www.zhihu.com<span class="sc">/</span>people<span class="sc">/</span>wang<span class="sc">-</span>jiang<span class="sc">-</span>yuan<span class="dv">-59</span><span class="sc">/</span>posts</span></code></pre></div>
<div id="逆概率加权" class="section level4 hasAnchor" number="4.3.1.1">
<h4><span class="header-section-number">4.3.1.1</span> 逆概率加权：<a href="Model-building.html#逆概率加权" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="Model-building.html#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Propensity score IPTW</span></span>
<span id="cb109-2"><a href="Model-building.html#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MatchIt)</span>
<span id="cb109-3"><a href="Model-building.html#cb109-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb109-4"><a href="Model-building.html#cb109-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb109-5"><a href="Model-building.html#cb109-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(twang)</span>
<span id="cb109-6"><a href="Model-building.html#cb109-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-7"><a href="Model-building.html#cb109-7" aria-hidden="true" tabindex="-1"></a>dt1 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;~/Documents/96 R/riskfactor.csv&quot;</span>)</span>
<span id="cb109-8"><a href="Model-building.html#cb109-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dt1)</span>
<span id="cb109-9"><a href="Model-building.html#cb109-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-10"><a href="Model-building.html#cb109-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Pre-requirements for Dataset and Variables</span></span>
<span id="cb109-11"><a href="Model-building.html#cb109-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Treatment variable should be binary with value of (0, 1)</span></span>
<span id="cb109-12"><a href="Model-building.html#cb109-12" aria-hidden="true" tabindex="-1"></a>dt1<span class="sc">$</span>DLSTYPN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(dt1<span class="sc">$</span>DLSTYP<span class="sc">==</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb109-13"><a href="Model-building.html#cb109-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-14"><a href="Model-building.html#cb109-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Covariates should be no missing value</span></span>
<span id="cb109-15"><a href="Model-building.html#cb109-15" aria-hidden="true" tabindex="-1"></a>dt2 <span class="ot">&lt;-</span> dt1[<span class="fu">complete.cases</span>(dt1<span class="sc">$</span>LOGCACBSAVAL,dt1<span class="sc">$</span>LOGAACBSAVAL, dt1<span class="sc">$</span>CVCBSAVAL), ]</span>
<span id="cb109-16"><a href="Model-building.html#cb109-16" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(dt2)</span>
<span id="cb109-17"><a href="Model-building.html#cb109-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-18"><a href="Model-building.html#cb109-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. All categorical string covariates should be re-coded with numeric values.</span></span>
<span id="cb109-19"><a href="Model-building.html#cb109-19" aria-hidden="true" tabindex="-1"></a>dt2<span class="sc">$</span>DIABMIN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(dt2<span class="sc">$</span>DIABMI<span class="sc">==</span><span class="st">&quot;Y&quot;</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb109-20"><a href="Model-building.html#cb109-20" aria-hidden="true" tabindex="-1"></a>dt2<span class="sc">$</span>HYPMIN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(dt2<span class="sc">$</span>HYPMI<span class="sc">==</span><span class="st">&quot;Y&quot;</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb109-21"><a href="Model-building.html#cb109-21" aria-hidden="true" tabindex="-1"></a>dt2<span class="sc">$</span>CPBCMN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(dt2<span class="sc">$</span>CPBCM<span class="sc">==</span><span class="st">&quot;Y&quot;</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb109-22"><a href="Model-building.html#cb109-22" aria-hidden="true" tabindex="-1"></a>dt2<span class="sc">$</span>NCPBCMN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(dt2<span class="sc">$</span>NCPBCM<span class="sc">==</span><span class="st">&quot;Y&quot;</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb109-23"><a href="Model-building.html#cb109-23" aria-hidden="true" tabindex="-1"></a>dt2<span class="sc">$</span>STNCMN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(dt2<span class="sc">$</span>STNCM<span class="sc">==</span><span class="st">&quot;Y&quot;</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb109-24"><a href="Model-building.html#cb109-24" aria-hidden="true" tabindex="-1"></a>dt2<span class="sc">$</span>VITDCMN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(dt2<span class="sc">$</span>VITDCM<span class="sc">==</span><span class="st">&quot;Y&quot;</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb109-25"><a href="Model-building.html#cb109-25" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dt2)</span>
<span id="cb109-26"><a href="Model-building.html#cb109-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-27"><a href="Model-building.html#cb109-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Run logistic regression to get PS</span></span>
<span id="cb109-28"><a href="Model-building.html#cb109-28" aria-hidden="true" tabindex="-1"></a>param <span class="ot">&lt;-</span> <span class="fu">matchit</span>(DLSTYPN <span class="sc">~</span> DLAGE<span class="sc">+</span>AGE<span class="sc">+</span>SEXN<span class="sc">+</span>BMIMI<span class="sc">+</span>MAPMI<span class="sc">+</span>PPMI<span class="sc">+</span>SMOKE1N<span class="sc">+</span>DIABMIN</span>
<span id="cb109-29"><a href="Model-building.html#cb109-29" aria-hidden="true" tabindex="-1"></a>                 <span class="sc">+</span>HYPMIN<span class="sc">+</span>BSTGMI<span class="sc">+</span>BSHDLMI<span class="sc">+</span>BSLDLMI<span class="sc">+</span>LOGBSCRPMI</span>
<span id="cb109-30"><a href="Model-building.html#cb109-30" aria-hidden="true" tabindex="-1"></a>                 <span class="sc">+</span>AVGCACAT<span class="sc">+</span>AVGP<span class="sc">+</span>AVGPTH<span class="sc">+</span>LOGAVGFGFMI<span class="sc">+</span>AVGOHDMI </span>
<span id="cb109-31"><a href="Model-building.html#cb109-31" aria-hidden="true" tabindex="-1"></a>                 <span class="sc">+</span>CPBCMN<span class="sc">+</span>NCPBCMN<span class="sc">+</span>STNCMN<span class="sc">+</span>VITDCMN </span>
<span id="cb109-32"><a href="Model-building.html#cb109-32" aria-hidden="true" tabindex="-1"></a>                 <span class="sc">+</span>LOGCACBSAVAL<span class="sc">+</span>LOGAACBSAVAL<span class="sc">+</span>CVCBSAVAL, <span class="at">data=</span>dt2)</span>
<span id="cb109-33"><a href="Model-building.html#cb109-33" aria-hidden="true" tabindex="-1"></a>dt2<span class="sc">$</span>param_ps <span class="ot">&lt;-</span> param<span class="sc">$</span>distance</span>
<span id="cb109-34"><a href="Model-building.html#cb109-34" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dt2)</span>
<span id="cb109-35"><a href="Model-building.html#cb109-35" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(dt2)</span>
<span id="cb109-36"><a href="Model-building.html#cb109-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-37"><a href="Model-building.html#cb109-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Check the distribution of PS</span></span>
<span id="cb109-38"><a href="Model-building.html#cb109-38" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>dt2, <span class="fu">aes</span>(param_ps, <span class="at">fill=</span><span class="fu">factor</span>(DLSTYPN))) <span class="sc">+</span> </span>
<span id="cb109-39"><a href="Model-building.html#cb109-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth=</span><span class="fl">0.01</span>, <span class="at">alpha=</span><span class="fl">0.5</span>, <span class="at">position=</span><span class="st">&quot;identity&quot;</span>)</span>
<span id="cb109-40"><a href="Model-building.html#cb109-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-41"><a href="Model-building.html#cb109-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3 (Optional): Trim &lt;2.5 percentiles and &gt;97.5 percentiles of PS</span></span>
<span id="cb109-42"><a href="Model-building.html#cb109-42" aria-hidden="true" tabindex="-1"></a>p2_5_cutoff <span class="ot">&lt;-</span> <span class="fu">quantile</span>(dt2<span class="sc">$</span>param_ps, <span class="fl">0.025</span>)</span>
<span id="cb109-43"><a href="Model-building.html#cb109-43" aria-hidden="true" tabindex="-1"></a>p97_5_cutoff <span class="ot">&lt;-</span> <span class="fu">quantile</span>(dt2<span class="sc">$</span>param_ps, <span class="fl">0.975</span>)</span>
<span id="cb109-44"><a href="Model-building.html#cb109-44" aria-hidden="true" tabindex="-1"></a>dt3 <span class="ot">&lt;-</span> dt2 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(param_ps <span class="sc">&gt;=</span>p2_5_cutoff, dt2<span class="sc">$</span>param_ps <span class="sc">&lt;=</span> p97_5_cutoff)</span>
<span id="cb109-45"><a href="Model-building.html#cb109-45" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(dt3)</span>
<span id="cb109-46"><a href="Model-building.html#cb109-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-47"><a href="Model-building.html#cb109-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Calculate IPTW with stabilization</span></span>
<span id="cb109-48"><a href="Model-building.html#cb109-48" aria-hidden="true" tabindex="-1"></a>dt3<span class="sc">$</span>iptw <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(dt3<span class="sc">$</span>DLSTYPN<span class="sc">==</span><span class="dv">1</span>, (<span class="fu">mean</span>(dt3<span class="sc">$</span>param_ps))<span class="sc">/</span>dt3<span class="sc">$</span>param_ps, </span>
<span id="cb109-49"><a href="Model-building.html#cb109-49" aria-hidden="true" tabindex="-1"></a>                   (<span class="fu">mean</span>(<span class="dv">1</span><span class="sc">-</span>dt3<span class="sc">$</span>param_ps))<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>dt3<span class="sc">$</span>param_ps))</span>
<span id="cb109-50"><a href="Model-building.html#cb109-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-51"><a href="Model-building.html#cb109-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 5: Check the balance of ASD before and after IPTW</span></span>
<span id="cb109-52"><a href="Model-building.html#cb109-52" aria-hidden="true" tabindex="-1"></a>iptw <span class="ot">&lt;-</span> <span class="fu">dx.wts</span>(dt3<span class="sc">$</span>iptw, <span class="at">data=</span>dt3, </span>
<span id="cb109-53"><a href="Model-building.html#cb109-53" aria-hidden="true" tabindex="-1"></a>                <span class="at">vars=</span><span class="fu">c</span>(<span class="st">&quot;DLAGE&quot;</span>, <span class="st">&quot;AGE&quot;</span>, <span class="st">&quot;SEXN&quot;</span>, <span class="st">&quot;BMIMI&quot;</span>,<span class="st">&quot;MAPMI&quot;</span>,<span class="st">&quot;PPMI&quot;</span>,<span class="st">&quot;SMOKE1N&quot;</span>,</span>
<span id="cb109-54"><a href="Model-building.html#cb109-54" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;DIABMIN&quot;</span>,<span class="st">&quot;HYPMIN&quot;</span>,<span class="st">&quot;BSTGMI&quot;</span>,<span class="st">&quot;BSHDLMI&quot;</span>,<span class="st">&quot;BSLDLMI&quot;</span>,</span>
<span id="cb109-55"><a href="Model-building.html#cb109-55" aria-hidden="true" tabindex="-1"></a> <span class="st">&quot;LOGBSCRPMI&quot;</span>,<span class="st">&quot;AVGCACAT&quot;</span>,<span class="st">&quot;AVGP&quot;</span>,<span class="st">&quot;AVGPTH&quot;</span>,<span class="st">&quot;LOGAVGFGFMI&quot;</span>,</span>
<span id="cb109-56"><a href="Model-building.html#cb109-56" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;AVGOHDMI&quot;</span>, <span class="st">&quot;CPBCMN&quot;</span>,<span class="st">&quot;NCPBCMN&quot;</span>,<span class="st">&quot;STNCMN&quot;</span>,<span class="st">&quot;VITDCMN&quot;</span>,</span>
<span id="cb109-57"><a href="Model-building.html#cb109-57" aria-hidden="true" tabindex="-1"></a>     <span class="st">&quot;LOGCACBSAVAL&quot;</span>,<span class="st">&quot;LOGAACBSAVAL&quot;</span>,<span class="st">&quot;CVCBSAVAL&quot;</span>),</span>
<span id="cb109-58"><a href="Model-building.html#cb109-58" aria-hidden="true" tabindex="-1"></a>                <span class="at">treat.var=</span><span class="st">&quot;DLSTYPN&quot;</span>,<span class="at">estimand=</span><span class="st">&quot;ATT&quot;</span>)</span>
<span id="cb109-59"><a href="Model-building.html#cb109-59" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.table</span>(iptw)</span>
<span id="cb109-60"><a href="Model-building.html#cb109-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-61"><a href="Model-building.html#cb109-61" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages(&quot;twang&quot;)</span></span>
<span id="cb109-62"><a href="Model-building.html#cb109-62" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(twang)</span>
<span id="cb109-63"><a href="Model-building.html#cb109-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 6: Include IPTW as a weighting variable to perform outcome analysis</span></span>
<span id="cb109-64"><a href="Model-building.html#cb109-64" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Logistic regression </span></span>
<span id="cb109-65"><a href="Model-building.html#cb109-65" aria-hidden="true" tabindex="-1"></a>logistic_iptw <span class="ot">&lt;-</span> <span class="fu">glm</span>(outcome <span class="sc">~</span> DLSTYPN<span class="sc">+</span>DLAGE<span class="sc">+</span>AGE<span class="sc">+</span>SEXN<span class="sc">+</span>BMIMI<span class="sc">+</span>MAPMI<span class="sc">+</span>PPMI<span class="sc">+</span>SMOKE1N</span>
<span id="cb109-66"><a href="Model-building.html#cb109-66" aria-hidden="true" tabindex="-1"></a>                     <span class="sc">+</span>DIABMIN<span class="sc">+</span>HYPMIN<span class="sc">+</span>BSTGMI<span class="sc">+</span>BSHDLMI<span class="sc">+</span>BSLDLMI<span class="sc">+</span>LOGBSCRPMI</span>
<span id="cb109-67"><a href="Model-building.html#cb109-67" aria-hidden="true" tabindex="-1"></a>                     <span class="sc">+</span>AVGCACAT<span class="sc">+</span>AVGP<span class="sc">+</span>AVGPTH<span class="sc">+</span>LOGAVGFGFMI<span class="sc">+</span>AVGOHDMI </span>
<span id="cb109-68"><a href="Model-building.html#cb109-68" aria-hidden="true" tabindex="-1"></a>                     <span class="sc">+</span>CPBCMN<span class="sc">+</span>NCPBCMN<span class="sc">+</span>STNCMN<span class="sc">+</span>VITDCMN </span>
<span id="cb109-69"><a href="Model-building.html#cb109-69" aria-hidden="true" tabindex="-1"></a>                     <span class="sc">+</span>LOGCACBSAVAL<span class="sc">+</span>LOGAACBSAVAL<span class="sc">+</span>CVCBSAVAL, </span>
<span id="cb109-70"><a href="Model-building.html#cb109-70" aria-hidden="true" tabindex="-1"></a>                     <span class="at">data=</span>dt3, <span class="at">weights=</span>iptw, <span class="at">family=</span>binomial)</span>
<span id="cb109-71"><a href="Model-building.html#cb109-71" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(logistic_iptw)</span>
<span id="cb109-72"><a href="Model-building.html#cb109-72" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">coef</span>(logistic_iptw))</span>
<span id="cb109-73"><a href="Model-building.html#cb109-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-74"><a href="Model-building.html#cb109-74" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Cox regression</span></span>
<span id="cb109-75"><a href="Model-building.html#cb109-75" aria-hidden="true" tabindex="-1"></a>cox_iptw <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="at">outcome =</span> <span class="fu">Surv</span>(time, status) <span class="sc">~</span> DLSTYPN<span class="sc">+</span>DLAGE<span class="sc">+</span>AGE<span class="sc">+</span>SEXN<span class="sc">+</span>BMIMI</span>
<span id="cb109-76"><a href="Model-building.html#cb109-76" aria-hidden="true" tabindex="-1"></a>                  <span class="sc">+</span>MAPMI<span class="sc">+</span>PPMI<span class="sc">+</span>SMOKE1N <span class="sc">+</span>DIABMIN<span class="sc">+</span>HYPMIN<span class="sc">+</span>BSTGMI<span class="sc">+</span>BSHDLMI<span class="sc">+</span>BSLDLMI</span>
<span id="cb109-77"><a href="Model-building.html#cb109-77" aria-hidden="true" tabindex="-1"></a>                  <span class="sc">+</span>LOGBSCRPMI<span class="sc">+</span>AVGCACAT<span class="sc">+</span>AVGP<span class="sc">+</span>AVGPTH<span class="sc">+</span>LOGAVGFGFMI<span class="sc">+</span>AVGOHDMI </span>
<span id="cb109-78"><a href="Model-building.html#cb109-78" aria-hidden="true" tabindex="-1"></a>                  <span class="sc">+</span>CPBCMN<span class="sc">+</span>NCPBCMN<span class="sc">+</span>STNCMN<span class="sc">+</span>VITDCMN </span>
<span id="cb109-79"><a href="Model-building.html#cb109-79" aria-hidden="true" tabindex="-1"></a>                  <span class="sc">+</span>LOGCACBSAVAL<span class="sc">+</span>LOGAACBSAVAL<span class="sc">+</span>CVCBSAVAL, </span>
<span id="cb109-80"><a href="Model-building.html#cb109-80" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data=</span>dt3, <span class="at">weights=</span>iptw)</span>
<span id="cb109-81"><a href="Model-building.html#cb109-81" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox_iptw)</span></code></pre></div>
</div>
<div id="psm倾向性评分匹配" class="section level4 hasAnchor" number="4.3.1.2">
<h4><span class="header-section-number">4.3.1.2</span> psm倾向性评分匹配：<a href="Model-building.html#psm倾向性评分匹配" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="Model-building.html#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 补充说明：</span></span>
<span id="cb110-2"><a href="Model-building.html#cb110-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-3"><a href="Model-building.html#cb110-3" aria-hidden="true" tabindex="-1"></a><span class="do">## 倾向于评分平衡匹配：</span></span>
<span id="cb110-4"><a href="Model-building.html#cb110-4" aria-hidden="true" tabindex="-1"></a><span class="do">## 构造数据集：</span></span>
<span id="cb110-5"><a href="Model-building.html#cb110-5" aria-hidden="true" tabindex="-1"></a>baseline_group2 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;/workspace/dev/glp1/data/analysisdata/baseline_group2.csv&quot;</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>X1)</span>
<span id="cb110-6"><a href="Model-building.html#cb110-6" aria-hidden="true" tabindex="-1"></a>baseline_group2<span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(baseline_group2)  </span>
<span id="cb110-7"><a href="Model-building.html#cb110-7" aria-hidden="true" tabindex="-1"></a>baseline_group2[,<span class="fu">c</span>(<span class="dv">7</span><span class="sc">:</span><span class="dv">49</span>)] <span class="ot">&lt;-</span> <span class="fu">lapply</span>(baseline_group2[,<span class="fu">c</span>(<span class="dv">7</span><span class="sc">:</span><span class="dv">49</span>)],as.integer)</span>
<span id="cb110-8"><a href="Model-building.html#cb110-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-9"><a href="Model-building.html#cb110-9" aria-hidden="true" tabindex="-1"></a>covarsname <span class="ot">&lt;-</span> <span class="fu">colnames</span>(baseline_group2)</span>
<span id="cb110-10"><a href="Model-building.html#cb110-10" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> baseline_group2[,covarsname]</span>
<span id="cb110-11"><a href="Model-building.html#cb110-11" aria-hidden="true" tabindex="-1"></a>w <span class="ot">&lt;-</span> x[,<span class="st">&#39;test&#39;</span>] <span class="do">## 分组变量：</span></span>
<span id="cb110-12"><a href="Model-building.html#cb110-12" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> x[,<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,<span class="dv">9</span>,<span class="dv">7</span>)] <span class="do">## 建模变量：</span></span>
<span id="cb110-13"><a href="Model-building.html#cb110-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-14"><a href="Model-building.html#cb110-14" aria-hidden="true" tabindex="-1"></a><span class="do">################# 倾向性得分匹配： ###############</span></span>
<span id="cb110-15"><a href="Model-building.html#cb110-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;MatchIt&quot;</span>)</span>
<span id="cb110-16"><a href="Model-building.html#cb110-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;tableone&quot;</span>)</span>
<span id="cb110-17"><a href="Model-building.html#cb110-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&#39;survival&#39;</span>)</span>
<span id="cb110-18"><a href="Model-building.html#cb110-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Matching)</span>
<span id="cb110-19"><a href="Model-building.html#cb110-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-20"><a href="Model-building.html#cb110-20" aria-hidden="true" tabindex="-1"></a><span class="do">## 方法1：Matching方法：</span></span>
<span id="cb110-21"><a href="Model-building.html#cb110-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb110-22"><a href="Model-building.html#cb110-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Matching)</span>
<span id="cb110-23"><a href="Model-building.html#cb110-23" aria-hidden="true" tabindex="-1"></a>bout.nm <span class="ot">&lt;-</span> <span class="fu">MatchBalance</span>(w<span class="sc">~</span>x, <span class="at">match.out =</span> <span class="cn">NULL</span>,<span class="at">ks=</span><span class="cn">FALSE</span>)</span>
<span id="cb110-24"><a href="Model-building.html#cb110-24" aria-hidden="true" tabindex="-1"></a>bal.nm <span class="ot">&lt;-</span> <span class="fu">baltest.collect</span>(<span class="at">matchbal.out =</span> bout.nm,<span class="at">var.names =</span> <span class="fu">colnames</span>(x),<span class="at">after =</span> <span class="cn">FALSE</span>)</span>
<span id="cb110-25"><a href="Model-building.html#cb110-25" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(bal.nm,<span class="dv">3</span>)</span>
<span id="cb110-26"><a href="Model-building.html#cb110-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-27"><a href="Model-building.html#cb110-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-28"><a href="Model-building.html#cb110-28" aria-hidden="true" tabindex="-1"></a><span class="do">## 方法2：matchit方法：</span></span>
<span id="cb110-29"><a href="Model-building.html#cb110-29" aria-hidden="true" tabindex="-1"></a><span class="do">## 构建普通的psm：</span></span>
<span id="cb110-30"><a href="Model-building.html#cb110-30" aria-hidden="true" tabindex="-1"></a>m.out <span class="ot">&lt;-</span> <span class="fu">matchit</span>(treat <span class="sc">~</span> educ <span class="sc">+</span> age <span class="sc">+</span> race, <span class="at">data =</span> lalonde,</span>
<span id="cb110-31"><a href="Model-building.html#cb110-31" aria-hidden="true" tabindex="-1"></a>                 <span class="at">method =</span> <span class="st">&quot;nearest&quot;</span>,<span class="at">ratio=</span><span class="dv">1</span>,<span class="at">caliper=</span><span class="fl">0.01</span>)</span>
<span id="cb110-32"><a href="Model-building.html#cb110-32" aria-hidden="true" tabindex="-1"></a>m.data <span class="ot">&lt;-</span> <span class="fu">match.data</span>(m.out)</span>
<span id="cb110-33"><a href="Model-building.html#cb110-33" aria-hidden="true" tabindex="-1"></a><span class="do">## 参数介绍：</span></span>
<span id="cb110-34"><a href="Model-building.html#cb110-34" aria-hidden="true" tabindex="-1"></a><span class="co"># method =&#39;exact&#39;： 精确匹配；或者使用 &quot;nearest&quot;最近邻匹配；</span></span>
<span id="cb110-35"><a href="Model-building.html#cb110-35" aria-hidden="true" tabindex="-1"></a><span class="co"># ratio=1 : 比例1:1</span></span>
<span id="cb110-36"><a href="Model-building.html#cb110-36" aria-hidden="true" tabindex="-1"></a><span class="do">## 卡钳值：</span></span>
<span id="cb110-37"><a href="Model-building.html#cb110-37" aria-hidden="true" tabindex="-1"></a><span class="co"># caliper=0.001：设置的越小，越能够精确匹配；</span></span>
<span id="cb110-38"><a href="Model-building.html#cb110-38" aria-hidden="true" tabindex="-1"></a><span class="co"># caliper = c(.1, age = 2, educ = 1) ##针对具体的参数来定义；</span></span>
<span id="cb110-39"><a href="Model-building.html#cb110-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-40"><a href="Model-building.html#cb110-40" aria-hidden="true" tabindex="-1"></a><span class="do">## 熵平衡：</span></span>
<span id="cb110-41"><a href="Model-building.html#cb110-41" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&#39;ebal&#39;</span>)</span>
<span id="cb110-42"><a href="Model-building.html#cb110-42" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ebal)</span>
<span id="cb110-43"><a href="Model-building.html#cb110-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-44"><a href="Model-building.html#cb110-44" aria-hidden="true" tabindex="-1"></a><span class="co"># create toy data: treatment indicator and three covariates X1-3</span></span>
<span id="cb110-45"><a href="Model-building.html#cb110-45" aria-hidden="true" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">50</span>),<span class="fu">rep</span>(<span class="dv">1</span>,<span class="dv">30</span>))</span>
<span id="cb110-46"><a href="Model-building.html#cb110-46" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">replicate</span>(<span class="dv">3</span>,<span class="fu">rnorm</span>(<span class="dv">50</span>,<span class="dv">0</span>)),<span class="fu">replicate</span>(<span class="dv">3</span>,<span class="fu">rnorm</span>(<span class="dv">30</span>,.<span class="dv">5</span>))) <span class="sc">%&gt;%</span> <span class="fu">data.frame</span>()</span>
<span id="cb110-47"><a href="Model-building.html#cb110-47" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(x) <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;x&quot;</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb110-48"><a href="Model-building.html#cb110-48" aria-hidden="true" tabindex="-1"></a><span class="co"># entropy balancing</span></span>
<span id="cb110-49"><a href="Model-building.html#cb110-49" aria-hidden="true" tabindex="-1"></a>eb.out <span class="ot">&lt;-</span> <span class="fu">ebalance</span>(<span class="at">Treatment=</span>w,<span class="at">X=</span>x)</span>
<span id="cb110-50"><a href="Model-building.html#cb110-50" aria-hidden="true" tabindex="-1"></a><span class="co"># 结果提取：</span></span>
<span id="cb110-51"><a href="Model-building.html#cb110-51" aria-hidden="true" tabindex="-1"></a>x<span class="sc">$</span>weight <span class="ot">&lt;-</span> <span class="fu">c</span>(eb.out<span class="sc">$</span>w,w[w<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb110-52"><a href="Model-building.html#cb110-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-53"><a href="Model-building.html#cb110-53" aria-hidden="true" tabindex="-1"></a><span class="co"># 平衡评估：                   </span></span>
<span id="cb110-54"><a href="Model-building.html#cb110-54" aria-hidden="true" tabindex="-1"></a>bout.eb <span class="ot">&lt;-</span> <span class="fu">MatchBalance</span>(w<span class="sc">~</span>x, <span class="at">weights =</span><span class="fu">c</span>(eb.out<span class="sc">$</span>w,w[w<span class="sc">==</span><span class="dv">1</span>]),<span class="at">ks=</span><span class="cn">FALSE</span>)</span>
<span id="cb110-55"><a href="Model-building.html#cb110-55" aria-hidden="true" tabindex="-1"></a>bal.eb <span class="ot">&lt;-</span> <span class="fu">baltest.collect</span>(<span class="at">matchbal.out =</span> bout.eb,<span class="at">var.names =</span> <span class="fu">colnames</span>(x),<span class="at">after =</span> <span class="cn">FALSE</span>)</span>
<span id="cb110-56"><a href="Model-building.html#cb110-56" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(bal.eb,<span class="dv">3</span>)</span>
<span id="cb110-57"><a href="Model-building.html#cb110-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-58"><a href="Model-building.html#cb110-58" aria-hidden="true" tabindex="-1"></a><span class="do">##################  应用权重与检测平衡可靠性：</span></span>
<span id="cb110-59"><a href="Model-building.html#cb110-59" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Matrix)</span>
<span id="cb110-60"><a href="Model-building.html#cb110-60" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(grid)</span>
<span id="cb110-61"><a href="Model-building.html#cb110-61" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb110-62"><a href="Model-building.html#cb110-62" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survey)</span>
<span id="cb110-63"><a href="Model-building.html#cb110-63" aria-hidden="true" tabindex="-1"></a>xx <span class="ot">=</span> <span class="fu">cbind</span>(w,x)</span>
<span id="cb110-64"><a href="Model-building.html#cb110-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-65"><a href="Model-building.html#cb110-65" aria-hidden="true" tabindex="-1"></a>des1 <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span><span class="dv">1</span>, <span class="at">weights =</span> <span class="sc">~</span>weight,<span class="at">data =</span>xx)</span>
<span id="cb110-66"><a href="Model-building.html#cb110-66" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;x&quot;</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb110-67"><a href="Model-building.html#cb110-67" aria-hidden="true" tabindex="-1"></a>tab <span class="ot">&lt;-</span> <span class="fu">svyCreateTableOne</span>(<span class="at">vars =</span> vars,,<span class="at">strata =</span> <span class="st">&#39;w&#39;</span>,<span class="at">data =</span> des1)</span>
<span id="cb110-68"><a href="Model-building.html#cb110-68" aria-hidden="true" tabindex="-1"></a><span class="do">## 出具smd</span></span>
<span id="cb110-69"><a href="Model-building.html#cb110-69" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(tab, <span class="at">showAlllevels =</span> <span class="cn">TRUE</span>,<span class="at">catDigits =</span> <span class="dv">2</span>, <span class="at">contDigits =</span> <span class="dv">2</span>,<span class="at">smd =</span> <span class="cn">TRUE</span>)</span>
<span id="cb110-70"><a href="Model-building.html#cb110-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-71"><a href="Model-building.html#cb110-71" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
</div>
<div id="熵平衡匹配" class="section level4 hasAnchor" number="4.3.1.3">
<h4><span class="header-section-number">4.3.1.3</span> 熵平衡匹配<a href="Model-building.html#熵平衡匹配" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="Model-building.html#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&#39;ebal&#39;</span>)</span>
<span id="cb111-2"><a href="Model-building.html#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ebal)</span>
<span id="cb111-3"><a href="Model-building.html#cb111-3" aria-hidden="true" tabindex="-1"></a><span class="do">### 熵平衡不改变1，只改变0 的权重值：</span></span>
<span id="cb111-4"><a href="Model-building.html#cb111-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-5"><a href="Model-building.html#cb111-5" aria-hidden="true" tabindex="-1"></a><span class="co"># create toy data: treatment indicator and three covariates X1-3</span></span>
<span id="cb111-6"><a href="Model-building.html#cb111-6" aria-hidden="true" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">50</span>),<span class="fu">rep</span>(<span class="dv">1</span>,<span class="dv">30</span>))</span>
<span id="cb111-7"><a href="Model-building.html#cb111-7" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">replicate</span>(<span class="dv">3</span>,<span class="fu">rnorm</span>(<span class="dv">50</span>,<span class="dv">0</span>)),<span class="fu">replicate</span>(<span class="dv">3</span>,<span class="fu">rnorm</span>(<span class="dv">30</span>,.<span class="dv">5</span>))) <span class="sc">%&gt;%</span> <span class="fu">data.frame</span>()</span>
<span id="cb111-8"><a href="Model-building.html#cb111-8" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(x) <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;x&quot;</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb111-9"><a href="Model-building.html#cb111-9" aria-hidden="true" tabindex="-1"></a><span class="co"># entropy balancing</span></span>
<span id="cb111-10"><a href="Model-building.html#cb111-10" aria-hidden="true" tabindex="-1"></a>eb.out <span class="ot">&lt;-</span> <span class="fu">ebalance</span>(<span class="at">Treatment=</span>w,<span class="at">X=</span>x)</span>
<span id="cb111-11"><a href="Model-building.html#cb111-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 结果提取：</span></span>
<span id="cb111-12"><a href="Model-building.html#cb111-12" aria-hidden="true" tabindex="-1"></a>x<span class="sc">$</span>weight <span class="ot">&lt;-</span> <span class="fu">c</span>(eb.out<span class="sc">$</span>w,w[w<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb111-13"><a href="Model-building.html#cb111-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-14"><a href="Model-building.html#cb111-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 平衡评估：                   </span></span>
<span id="cb111-15"><a href="Model-building.html#cb111-15" aria-hidden="true" tabindex="-1"></a>bout.eb <span class="ot">&lt;-</span> <span class="fu">MatchBalance</span>(w<span class="sc">~</span>x, <span class="at">weights =</span><span class="fu">c</span>(eb.out<span class="sc">$</span>w,w[w<span class="sc">==</span><span class="dv">1</span>]),<span class="at">ks=</span><span class="cn">FALSE</span>)</span>
<span id="cb111-16"><a href="Model-building.html#cb111-16" aria-hidden="true" tabindex="-1"></a>bal.eb <span class="ot">&lt;-</span> <span class="fu">baltest.collect</span>(<span class="at">matchbal.out =</span> bout.eb,<span class="at">var.names =</span> <span class="fu">colnames</span>(x),<span class="at">after =</span> <span class="cn">FALSE</span>)</span>
<span id="cb111-17"><a href="Model-building.html#cb111-17" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(bal.eb,<span class="dv">3</span>)</span>
<span id="cb111-18"><a href="Model-building.html#cb111-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-19"><a href="Model-building.html#cb111-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 应用权重：</span></span>
<span id="cb111-20"><a href="Model-building.html#cb111-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Matrix)</span>
<span id="cb111-21"><a href="Model-building.html#cb111-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(grid)</span>
<span id="cb111-22"><a href="Model-building.html#cb111-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb111-23"><a href="Model-building.html#cb111-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survey)</span>
<span id="cb111-24"><a href="Model-building.html#cb111-24" aria-hidden="true" tabindex="-1"></a>xx <span class="ot">=</span> <span class="fu">cbind</span>(w,x)</span>
<span id="cb111-25"><a href="Model-building.html#cb111-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-26"><a href="Model-building.html#cb111-26" aria-hidden="true" tabindex="-1"></a>des1 <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span><span class="dv">1</span>, <span class="at">weights =</span> <span class="sc">~</span>weight,<span class="at">data =</span>xx)</span>
<span id="cb111-27"><a href="Model-building.html#cb111-27" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;x&quot;</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb111-28"><a href="Model-building.html#cb111-28" aria-hidden="true" tabindex="-1"></a>tab <span class="ot">&lt;-</span> <span class="fu">svyCreateTableOne</span>(<span class="at">vars =</span> vars,,<span class="at">strata =</span> <span class="st">&#39;w&#39;</span>,<span class="at">data =</span> des1)</span>
<span id="cb111-29"><a href="Model-building.html#cb111-29" aria-hidden="true" tabindex="-1"></a><span class="do">## 出具smd</span></span>
<span id="cb111-30"><a href="Model-building.html#cb111-30" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(tab, <span class="at">showAlllevels =</span> <span class="cn">TRUE</span>,<span class="at">catDigits =</span> <span class="dv">2</span>, <span class="at">contDigits =</span> <span class="dv">2</span>,<span class="at">smd =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
</div>
<div id="多组倾向得分匹配" class="section level4 hasAnchor" number="4.3.1.4">
<h4><span class="header-section-number">4.3.1.4</span> 多组倾向得分匹配<a href="Model-building.html#多组倾向得分匹配" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="Model-building.html#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;twang&quot;</span>)</span>
<span id="cb112-2"><a href="Model-building.html#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(twang)</span>
<span id="cb112-3"><a href="Model-building.html#cb112-3" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(AOD)</span>
<span id="cb112-4"><a href="Model-building.html#cb112-4" aria-hidden="true" tabindex="-1"></a>mnps.AOD <span class="ot">&lt;-</span> <span class="fu">mnps</span>(treat <span class="sc">~</span> illact <span class="sc">+</span> crimjust <span class="sc">+</span> subprob <span class="sc">+</span> subdep <span class="sc">+</span> white,</span>
<span id="cb112-5"><a href="Model-building.html#cb112-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> AOD,</span>
<span id="cb112-6"><a href="Model-building.html#cb112-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">estimand =</span> <span class="st">&quot;ATE&quot;</span>,</span>
<span id="cb112-7"><a href="Model-building.html#cb112-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">verbose =</span> <span class="cn">FALSE</span>,</span>
<span id="cb112-8"><a href="Model-building.html#cb112-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">stop.method =</span> <span class="fu">c</span>(<span class="st">&quot;es.mean&quot;</span>, <span class="st">&quot;ks.mean&quot;</span>),</span>
<span id="cb112-9"><a href="Model-building.html#cb112-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">n.trees =</span> <span class="dv">3000</span>)</span>
<span id="cb112-10"><a href="Model-building.html#cb112-10" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.table</span>(mnps.AOD, <span class="at">digits =</span> <span class="dv">2</span>)</span>
<span id="cb112-11"><a href="Model-building.html#cb112-11" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mnps.AOD)</span>
<span id="cb112-12"><a href="Model-building.html#cb112-12" aria-hidden="true" tabindex="-1"></a>AOD<span class="sc">$</span>w <span class="ot">&lt;-</span> <span class="fu">get.weights</span>(mnps.AOD, <span class="at">stop.method =</span> <span class="st">&quot;es.mean&quot;</span>)</span>
<span id="cb112-13"><a href="Model-building.html#cb112-13" aria-hidden="true" tabindex="-1"></a>design.mnps <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids=</span><span class="sc">~</span><span class="dv">1</span>, <span class="at">weights=</span><span class="sc">~</span>w, <span class="at">data=</span>AOD)</span></code></pre></div>
</div>
</div>
<div id="生存分析" class="section level3 hasAnchor" number="4.3.2">
<h3><span class="header-section-number">4.3.2</span> 生存分析<a href="Model-building.html#生存分析" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<pre><code>## 参考资料:
(1) https://www.emilyzabor.com/tutorials/survival_analysis_in_r_tutorial.html#Part_3:_Competing_Risks
(2)
https://www.drizopoulos.com/courses/emc/survival%20analysis%20in%20r%20companion
(3) 分布族描述：
https://devinincerti.com/code/survival-distributions.html
（4） 这本书把所有的生存分析与R都讲的清清楚楚：
http://ehar.se/r/ehar2/parametric.html#the-piecewise-constant-proportional-hazards-model</code></pre>
<div class="figure">
<img src="image/04/image-20220903133057292.png" alt="" />
<p class="caption">image-20220903133057292</p>
</div>
<div id="km曲线" class="section level4 hasAnchor" number="4.3.2.1">
<h4><span class="header-section-number">4.3.2.1</span> KM曲线<a href="Model-building.html#km曲线" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div id="常见比较检验方法" class="section level5 hasAnchor" number="4.3.2.1.1">
<h5><span class="header-section-number">4.3.2.1.1</span> 2.1.1 常见比较检验方法：<a href="Model-building.html#常见比较检验方法" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<pre><code>对KM生存函数有三种常见检验方法：log-rank、breslow、tarone。这三种都属于卡方检验的方法。KM法根据观察时点的顺序，把生存资料从小到大排列，依次计算实际死亡数和预期死亡数。并根据公式计算卡方统计量，复合（自由度=组数-1）的卡方分布。不同的是，不同的方法在计算统计量的时候，赋予了不同的权重。

# 对数秩（Log-Rank）检验
各时点的权重均为“1”。就是不考虑各观察时点开始时存活的人数对统计模型的影响。也就是每个时点死亡情况的变化对整个模型的贡献是一样的。

# Breslow检验
在Log Rank检验的基础上增加了权重，并设置权重为各时点开始时存活的人数。也就是开始存活人数多的时点死亡情况的变化对整个模型的贡献较大，而开始存活人数少的时点死亡情况的变化对整个模型的贡献较小。
# Tarone-Ware检验
是权重的取值方法介于以上两种方法之间，设置权重为各时点开始时存活的人数的平方根。同样是开始存活人数多的时点死亡情况的变化对整个模型的贡献较大，而开始存活人数少的时点死亡情况的变化对整个模型的贡献较小。只是开始存活人数多的时点对整个模型的贡献不如Breslow检验大。
简而言之，log-rank法侧重于远期差别，breslow法侧重于近期差别，tarone法介于两者之间。</code></pre>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="Model-building.html#cb115-1" aria-hidden="true" tabindex="-1"></a>Kaplan<span class="sc">-</span>Meier曲线采用Log<span class="sc">-</span>rank 检验方法对组间差异进行比较，采用Possion分布计算事件发生率及其置信区间。Log<span class="sc">-</span>rank检验的零假设是指两组的生存时间分布完全一致，当p<span class="sc">&lt;</span><span class="fl">0.05</span>时，就可以认为两组的生存时间分布存在统计学差异。</span>
<span id="cb115-2"><a href="Model-building.html#cb115-2" aria-hidden="true" tabindex="-1"></a>其中生存曲线的组间比较常采用Log<span class="sc">-</span>rank检验（对远期差异敏感）和Wilcoxon检验（对近期敏感）。</span>
<span id="cb115-3"><a href="Model-building.html#cb115-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb115-4"><a href="Model-building.html#cb115-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survminer)</span>
<span id="cb115-5"><a href="Model-building.html#cb115-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit survival curves</span></span>
<span id="cb115-6"><a href="Model-building.html#cb115-6" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> sex, <span class="at">data =</span> lung)</span>
<span id="cb115-7"><a href="Model-building.html#cb115-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-8"><a href="Model-building.html#cb115-8" aria-hidden="true" tabindex="-1"></a><span class="co"># log-rank检验：</span></span>
<span id="cb115-9"><a href="Model-building.html#cb115-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 本质上是时间节点下的列联表卡方检验：</span></span>
<span id="cb115-10"><a href="Model-building.html#cb115-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 当满足比例风险 (PH) 假设时，对数秩检验是最有效的检验</span></span>
<span id="cb115-11"><a href="Model-building.html#cb115-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 即检验不同组受试者的生存函数是否在统计学上有显着差异的假设</span></span>
<span id="cb115-12"><a href="Model-building.html#cb115-12" aria-hidden="true" tabindex="-1"></a>surv_diff <span class="ot">&lt;-</span> <span class="fu">survdiff</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> sex, <span class="at">data =</span> lung) </span>
<span id="cb115-13"><a href="Model-building.html#cb115-13" aria-hidden="true" tabindex="-1"></a><span class="do">## 模型提取的p值为log-rank检验结果：</span></span>
<span id="cb115-14"><a href="Model-building.html#cb115-14" aria-hidden="true" tabindex="-1"></a>p.value <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">pchisq</span>(surv_diff<span class="sc">$</span>chisq, <span class="fu">length</span>(surv_diff<span class="sc">$</span>n) <span class="sc">-</span><span class="dv">1</span>) </span>
<span id="cb115-15"><a href="Model-building.html#cb115-15" aria-hidden="true" tabindex="-1"></a>p.value <span class="ot">&lt;-</span>  p.value <span class="sc">%&gt;%</span> <span class="fu">format</span>(<span class="fu">round</span>(.,<span class="at">digits =</span><span class="dv">3</span>),<span class="at">nsmall=</span><span class="dv">3</span>)</span>
<span id="cb115-16"><a href="Model-building.html#cb115-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-17"><a href="Model-building.html#cb115-17" aria-hidden="true" tabindex="-1"></a><span class="do">##  Peto &amp; Peto Gehan-Wilcoxon 检验</span></span>
<span id="cb115-18"><a href="Model-building.html#cb115-18" aria-hidden="true" tabindex="-1"></a>peto_peto <span class="ot">&lt;-</span> <span class="fu">survdiff</span>(<span class="fu">Surv</span>(time, status <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">~</span> sex, <span class="at">data =</span> lung, <span class="at">rho =</span> <span class="dv">1</span>)</span>
<span id="cb115-19"><a href="Model-building.html#cb115-19" aria-hidden="true" tabindex="-1"></a>peto_peto</span>
<span id="cb115-20"><a href="Model-building.html#cb115-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-21"><a href="Model-building.html#cb115-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-22"><a href="Model-building.html#cb115-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Breslow检验：</span></span>
<span id="cb115-23"><a href="Model-building.html#cb115-23" aria-hidden="true" tabindex="-1"></a><span class="fu">survdiff</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> sex, <span class="at">rho =</span> <span class="dv">1</span>)</span>
<span id="cb115-24"><a href="Model-building.html#cb115-24" aria-hidden="true" tabindex="-1"></a><span class="do">## 使用surv_pvalue的method包含了多种方法：</span></span>
<span id="cb115-25"><a href="Model-building.html#cb115-25" aria-hidden="true" tabindex="-1"></a><span class="fu">surv_pvalue</span>(fit, <span class="at">method =</span> <span class="st">&quot;Gehan-Breslow&quot;</span>)</span>
<span id="cb115-26"><a href="Model-building.html#cb115-26" aria-hidden="true" tabindex="-1"></a><span class="do">## 另外一种实现方法：</span></span>
<span id="cb115-27"><a href="Model-building.html#cb115-27" aria-hidden="true" tabindex="-1"></a>Br_fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> stanford2, </span>
<span id="cb115-28"><a href="Model-building.html#cb115-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">&quot;fleming-harrington&quot;</span>)</span>
<span id="cb115-29"><a href="Model-building.html#cb115-29" aria-hidden="true" tabindex="-1"></a>Br_fit</span>
<span id="cb115-30"><a href="Model-building.html#cb115-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-31"><a href="Model-building.html#cb115-31" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
</div>
<div id="rr值计算及可视化" class="section level5 hasAnchor" number="4.3.2.1.2">
<h5><span class="header-section-number">4.3.2.1.2</span> 2.1.2 RR值计算及可视化：<a href="Model-building.html#rr值计算及可视化" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="Model-building.html#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 续上（单变量）：</span></span>
<span id="cb116-2"><a href="Model-building.html#cb116-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(<span class="st">&quot;survival&quot;</span>)</span>
<span id="cb116-3"><a href="Model-building.html#cb116-3" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> sex, <span class="at">data =</span> lung)</span>
<span id="cb116-4"><a href="Model-building.html#cb116-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-5"><a href="Model-building.html#cb116-5" aria-hidden="true" tabindex="-1"></a><span class="do">## 写一个计算RR的函数：</span></span>
<span id="cb116-6"><a href="Model-building.html#cb116-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 举例：ac为一组，bd为一组，ab为有；cd为无；</span></span>
<span id="cb116-7"><a href="Model-building.html#cb116-7" aria-hidden="true" tabindex="-1"></a><span class="co"># RR = (a/(a+b)) / (c/(c+d))</span></span>
<span id="cb116-8"><a href="Model-building.html#cb116-8" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">scipen =</span> <span class="dv">3</span>)</span>
<span id="cb116-9"><a href="Model-building.html#cb116-9" aria-hidden="true" tabindex="-1"></a>rr_ca <span class="ot">=</span> <span class="cf">function</span>(fit){</span>
<span id="cb116-10"><a href="Model-building.html#cb116-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb116-11"><a href="Model-building.html#cb116-11" aria-hidden="true" tabindex="-1"></a>  n.event <span class="ot">=</span> fit<span class="sc">$</span>n.event</span>
<span id="cb116-12"><a href="Model-building.html#cb116-12" aria-hidden="true" tabindex="-1"></a>  stra <span class="ot">=</span> fit<span class="sc">$</span>strata <span class="sc">%&gt;%</span> <span class="fu">data.frame</span>() </span>
<span id="cb116-13"><a href="Model-building.html#cb116-13" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">=</span> <span class="fu">cbind</span>(<span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>,stra<span class="sc">$</span>.[<span class="dv">1</span>]),<span class="fu">rep</span>(<span class="dv">2</span>,stra<span class="sc">$</span>.[<span class="dv">2</span>])),n.event) <span class="sc">%&gt;%</span> </span>
<span id="cb116-14"><a href="Model-building.html#cb116-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span>  <span class="fu">rename</span>(<span class="st">&quot;cla&quot;</span> <span class="ot">=</span> V1) <span class="sc">%&gt;%</span> </span>
<span id="cb116-15"><a href="Model-building.html#cb116-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">z01 =</span> <span class="fu">ifelse</span>(n.event<span class="sc">&gt;</span><span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb116-16"><a href="Model-building.html#cb116-16" aria-hidden="true" tabindex="-1"></a>  a <span class="ot">=</span> data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(cla<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> z01<span class="sc">==</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="fu">dim</span>() <span class="sc">%&gt;%</span> .[<span class="dv">1</span>]</span>
<span id="cb116-17"><a href="Model-building.html#cb116-17" aria-hidden="true" tabindex="-1"></a>  c <span class="ot">=</span> data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(cla<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> z01<span class="sc">==</span><span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="fu">dim</span>() <span class="sc">%&gt;%</span> .[<span class="dv">1</span>]</span>
<span id="cb116-18"><a href="Model-building.html#cb116-18" aria-hidden="true" tabindex="-1"></a>  b <span class="ot">=</span> data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(cla<span class="sc">==</span><span class="dv">2</span> <span class="sc">&amp;</span> z01<span class="sc">==</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="fu">dim</span>() <span class="sc">%&gt;%</span> .[<span class="dv">1</span>]</span>
<span id="cb116-19"><a href="Model-building.html#cb116-19" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">=</span> data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(cla<span class="sc">==</span><span class="dv">2</span> <span class="sc">&amp;</span> z01<span class="sc">==</span><span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="fu">dim</span>() <span class="sc">%&gt;%</span> .[<span class="dv">1</span>]</span>
<span id="cb116-20"><a href="Model-building.html#cb116-20" aria-hidden="true" tabindex="-1"></a>  rr <span class="ot">=</span> (a<span class="sc">/</span>(a<span class="sc">+</span>b)) <span class="sc">/</span> (c<span class="sc">/</span>(c<span class="sc">+</span>d)) </span>
<span id="cb116-21"><a href="Model-building.html#cb116-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb116-22"><a href="Model-building.html#cb116-22" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 计算上下限：</span></span>
<span id="cb116-23"><a href="Model-building.html#cb116-23" aria-hidden="true" tabindex="-1"></a>  rr_mat <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(a,b,c,d),<span class="at">byrow=</span><span class="cn">TRUE</span>,<span class="at">nrow=</span><span class="dv">2</span>)</span>
<span id="cb116-24"><a href="Model-building.html#cb116-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># install.packages(&quot;epitools&quot;)</span></span>
<span id="cb116-25"><a href="Model-building.html#cb116-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">&quot;epitools&quot;</span>)</span>
<span id="cb116-26"><a href="Model-building.html#cb116-26" aria-hidden="true" tabindex="-1"></a>  rr_ur <span class="ot">=</span> <span class="fu">epitab</span>(rr_mat,<span class="at">method=</span><span class="st">&quot;riskratio&quot;</span>)</span>
<span id="cb116-27"><a href="Model-building.html#cb116-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb116-28"><a href="Model-building.html#cb116-28" aria-hidden="true" tabindex="-1"></a>  rr_ur_out <span class="ot">=</span> rr_ur<span class="sc">$</span>tab <span class="sc">%&gt;%</span> <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb116-29"><a href="Model-building.html#cb116-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(lower,upper,p.value) <span class="sc">%&gt;%</span> </span>
<span id="cb116-30"><a href="Model-building.html#cb116-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rows_delete</span>(<span class="fu">tibble</span>(<span class="at">lower=</span><span class="cn">NA</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb116-31"><a href="Model-building.html#cb116-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">lower =</span> <span class="fu">format</span>(<span class="fu">round</span>(lower,<span class="at">digits =</span><span class="dv">2</span>),<span class="at">nsmall=</span><span class="dv">2</span>),</span>
<span id="cb116-32"><a href="Model-building.html#cb116-32" aria-hidden="true" tabindex="-1"></a>           <span class="at">upper  =</span> <span class="fu">format</span>(<span class="fu">round</span>(upper,<span class="at">digits =</span><span class="dv">2</span>),<span class="at">nsmall=</span><span class="dv">2</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb116-33"><a href="Model-building.html#cb116-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>()</span>
<span id="cb116-34"><a href="Model-building.html#cb116-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb116-35"><a href="Model-building.html#cb116-35" aria-hidden="true" tabindex="-1"></a>  RR <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">&quot;RR=&quot;</span>,<span class="fu">round</span>(rr,<span class="dv">2</span>),<span class="st">&quot;,&quot;</span>,<span class="st">&quot;95%CI[&quot;</span>,rr_ur_out<span class="sc">$</span>lower,<span class="st">&quot;,&quot;</span>,rr_ur_out<span class="sc">$</span>upper,<span class="st">&quot;]&quot;</span>)</span>
<span id="cb116-36"><a href="Model-building.html#cb116-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-37"><a href="Model-building.html#cb116-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(RR)</span>
<span id="cb116-38"><a href="Model-building.html#cb116-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb116-39"><a href="Model-building.html#cb116-39" aria-hidden="true" tabindex="-1"></a>rr <span class="ot">=</span> <span class="fu">rr_ca</span>(fit)</span>
<span id="cb116-40"><a href="Model-building.html#cb116-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-41"><a href="Model-building.html#cb116-41" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 添加p值和RR:</span></span>
<span id="cb116-42"><a href="Model-building.html#cb116-42" aria-hidden="true" tabindex="-1"></a>fig <span class="ot">=</span> <span class="fu">ggsurvplot</span>(fit,</span>
<span id="cb116-43"><a href="Model-building.html#cb116-43" aria-hidden="true" tabindex="-1"></a>                 <span class="at">fun=</span><span class="st">&quot;event&quot;</span>,</span>
<span id="cb116-44"><a href="Model-building.html#cb116-44" aria-hidden="true" tabindex="-1"></a>                 <span class="at">palette=</span><span class="fu">c</span>(<span class="st">&quot;#B47846&quot;</span>,<span class="st">&quot;#4682B4&quot;</span>),</span>
<span id="cb116-45"><a href="Model-building.html#cb116-45" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb116-46"><a href="Model-building.html#cb116-46" aria-hidden="true" tabindex="-1"></a>                 <span class="at">legend.title =</span> <span class="st">&quot;Sex&quot;</span>,</span>
<span id="cb116-47"><a href="Model-building.html#cb116-47" aria-hidden="true" tabindex="-1"></a>                 <span class="at">legend.labs=</span><span class="fu">c</span>(<span class="st">&quot;baseline&quot;</span>,<span class="st">&quot;followup&quot;</span>),</span>
<span id="cb116-48"><a href="Model-building.html#cb116-48" aria-hidden="true" tabindex="-1"></a>                 <span class="at">legend=</span> <span class="fu">c</span>(<span class="st">&quot;right&quot;</span>),</span>
<span id="cb116-49"><a href="Model-building.html#cb116-49" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb116-50"><a href="Model-building.html#cb116-50" aria-hidden="true" tabindex="-1"></a>                 <span class="at">risk.table =</span> F,</span>
<span id="cb116-51"><a href="Model-building.html#cb116-51" aria-hidden="true" tabindex="-1"></a>                 <span class="at">conf.int =</span> F,</span>
<span id="cb116-52"><a href="Model-building.html#cb116-52" aria-hidden="true" tabindex="-1"></a>                 <span class="at">risk.table.height=</span><span class="fl">0.32</span>,</span>
<span id="cb116-53"><a href="Model-building.html#cb116-53" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb116-54"><a href="Model-building.html#cb116-54" aria-hidden="true" tabindex="-1"></a>                 <span class="do">## 参数配置：</span></span>
<span id="cb116-55"><a href="Model-building.html#cb116-55" aria-hidden="true" tabindex="-1"></a>                 <span class="at">title=</span><span class="st">&quot;Kaplan-Meier Curve for MI&quot;</span>,</span>
<span id="cb116-56"><a href="Model-building.html#cb116-56" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># legend.title=&quot;Period&quot;,</span></span>
<span id="cb116-57"><a href="Model-building.html#cb116-57" aria-hidden="true" tabindex="-1"></a>                 <span class="at">xlab=</span><span class="st">&quot;Time(Days)&quot;</span>,</span>
<span id="cb116-58"><a href="Model-building.html#cb116-58" aria-hidden="true" tabindex="-1"></a>                 <span class="at">ylab=</span><span class="st">&quot;Patients with an event(%)&quot;</span>)</span>
<span id="cb116-59"><a href="Model-building.html#cb116-59" aria-hidden="true" tabindex="-1"></a>fig<span class="sc">$</span>plot <span class="sc">+</span> </span>
<span id="cb116-60"><a href="Model-building.html#cb116-60" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">annotate</span>(<span class="st">&quot;text&quot;</span>,<span class="at">x =</span> <span class="dv">200</span>, <span class="at">y =</span> <span class="fl">0.95</span> ,<span class="at">size =</span><span class="dv">5</span>,<span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">&#39;P=&#39;</span>,p.value)) <span class="sc">+</span></span>
<span id="cb116-61"><a href="Model-building.html#cb116-61" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">annotate</span>(<span class="st">&quot;text&quot;</span>,<span class="at">x =</span> <span class="dv">200</span>, <span class="at">y =</span> <span class="fl">0.90</span> ,<span class="at">size =</span><span class="dv">5</span>,<span class="at">label =</span> rr ) <span class="sc">+</span></span>
<span id="cb116-62"><a href="Model-building.html#cb116-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">15</span>),</span>
<span id="cb116-63"><a href="Model-building.html#cb116-63" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">15</span>))</span>
<span id="cb116-64"><a href="Model-building.html#cb116-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-65"><a href="Model-building.html#cb116-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-66"><a href="Model-building.html#cb116-66" aria-hidden="true" tabindex="-1"></a><span class="do">## 多变量生成组图可视化：</span></span>
<span id="cb116-67"><a href="Model-building.html#cb116-67" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;survival&quot;</span>)</span>
<span id="cb116-68"><a href="Model-building.html#cb116-68" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;survminer&quot;</span>)</span>
<span id="cb116-69"><a href="Model-building.html#cb116-69" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(<span class="st">&quot;survival&quot;</span>)</span>
<span id="cb116-70"><a href="Model-building.html#cb116-70" aria-hidden="true" tabindex="-1"></a>fit2 <span class="ot">&lt;-</span> <span class="fu">survfit</span>( <span class="fu">Surv</span>(time, status) <span class="sc">~</span> sex <span class="sc">+</span> rx <span class="sc">+</span> adhere,</span>
<span id="cb116-71"><a href="Model-building.html#cb116-71" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> colon )</span>
<span id="cb116-72"><a href="Model-building.html#cb116-72" aria-hidden="true" tabindex="-1"></a>ggsurv <span class="ot">&lt;-</span> <span class="fu">ggsurvplot</span>(fit2, <span class="at">fun =</span> <span class="st">&quot;event&quot;</span>, <span class="at">conf.int =</span> <span class="cn">TRUE</span>,</span>
<span id="cb116-73"><a href="Model-building.html#cb116-73" aria-hidden="true" tabindex="-1"></a>                     <span class="at">ggtheme =</span> <span class="fu">theme_bw</span>())</span>
<span id="cb116-74"><a href="Model-building.html#cb116-74" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb116-75"><a href="Model-building.html#cb116-75" aria-hidden="true" tabindex="-1"></a>ggsurv<span class="sc">$</span>plot <span class="sc">+</span><span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb116-76"><a href="Model-building.html#cb116-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span> (<span class="at">legend.position =</span> <span class="st">&quot;right&quot;</span>)<span class="sc">+</span></span>
<span id="cb116-77"><a href="Model-building.html#cb116-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(rx <span class="sc">~</span> adhere)</span></code></pre></div>
</div>
<div id="landmark分析" class="section level5 hasAnchor" number="4.3.2.1.3">
<h5><span class="header-section-number">4.3.2.1.3</span> 2.1.3 landmark分析<a href="Model-building.html#landmark分析" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<pre><code>landmark分析关注的是事件结局中当KM曲线相交时的解决办法：
具体实施：
将cox针对time进行分组组合数据，然后分段拟合和求RR值和p值；
再之后将分段km曲线拟合到一张图中即可；</code></pre>
</div>
<div id="生成中位生存时间" class="section level5 hasAnchor" number="4.3.2.1.4">
<h5><span class="header-section-number">4.3.2.1.4</span> 2.1.4 生成中位生存时间<a href="Model-building.html#生成中位生存时间" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="Model-building.html#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 计算中位生存时间：</span></span>
<span id="cb118-2"><a href="Model-building.html#cb118-2" aria-hidden="true" tabindex="-1"></a>lung <span class="sc">%&gt;%</span> </span>
<span id="cb118-3"><a href="Model-building.html#cb118-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(status <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb118-4"><a href="Model-building.html#cb118-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">median_surv =</span> <span class="fu">median</span>(time))</span>
<span id="cb118-5"><a href="Model-building.html#cb118-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-6"><a href="Model-building.html#cb118-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-7"><a href="Model-building.html#cb118-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 可视化报表：</span></span>
<span id="cb118-8"><a href="Model-building.html#cb118-8" aria-hidden="true" tabindex="-1"></a><span class="fu">survfit</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> lung) <span class="sc">%&gt;%</span> </span>
<span id="cb118-9"><a href="Model-building.html#cb118-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_survfit</span>(</span>
<span id="cb118-10"><a href="Model-building.html#cb118-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">probs =</span> <span class="fl">0.5</span>,</span>
<span id="cb118-11"><a href="Model-building.html#cb118-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">label_header =</span> <span class="st">&quot;**Median survival (95% CI)**&quot;</span></span>
<span id="cb118-12"><a href="Model-building.html#cb118-12" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
</div>
</div>
<div id="cox回归" class="section level4 hasAnchor" number="4.3.2.2">
<h4><span class="header-section-number">4.3.2.2</span> COX回归<a href="Model-building.html#cox回归" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<pre><code>##  参见资料：
# https://rviews.rstudio.com/2017/09/25/survival-analysis-with-r/
https://www.emilyzabor.com/tutorials/survival_analysis_in_r_tutorial.html#(x)-year_survival_and_the_survival_curve
# 论文资料：
https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4645729/
https://ekja.org/journal/view.php?number=8532</code></pre>
<div id="构建cox回归模型检验比例" class="section level5 hasAnchor" number="4.3.2.2.1">
<h5><span class="header-section-number">4.3.2.2.1</span> 构建cox回归模型检验（比例）<a href="Model-building.html#构建cox回归模型检验比例" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div id="cox回归构建方法原理" class="section level6 hasAnchor" number="4.3.2.2.1.1">
<h6><span class="header-section-number">4.3.2.2.1.1</span> cox回归构建方法原理<a href="Model-building.html#cox回归构建方法原理" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<pre><code>## 参见资料：
https://zhuanlan.zhihu.com/p/53847644</code></pre>
<p><strong>cox回归用到的参数变量</strong></p>
<div class="figure">
<img src="image/04/image-20220905103709180.png" alt="" />
<p class="caption">image-20220905103709180</p>
</div>
<p><strong>cox回归基于偏似然回归求解 β值：</strong></p>
<pre><code>（1）回归求参数值，原理的h(t)是一个不指定分布族的非参数变量；

（2）求每个协变量的 β值不需要基于非参数h(t)就可以求解，因为在对数转换过程中被消去了。

（3）从对数转换后的cox回归解释中，可以看到【风险比值的对数与时无关，只与胁逼哪里的线性组合有关。如果该假设不成立，就需要使用时依cox回归】

(4) 参见：
https://zhuanlan.zhihu.com/p/97501833
如果我们认为h(t)是常数c，那么存活时间就满足参数为c的指数分布。如果认为logh(t) = a + bt，那么存活时间满足Gompertz分布，如果认为logh(t) = a + log(t)。那么存活时间满足Weibull分布。 

（5）关于利用最大似然方法求解 β值时补充解释：
最大似然依赖于先验背景和θ值。而已有的推导表明三种删失方法都不会影响θ的界定，也即无论哪种删失（限定在常用的三种删失）所推导得到的基于似然估计得到的总体概率分布是相对固定的，也即求解β值的解并不受到删失类型的影响。</code></pre>
<div class="figure">
<img src="image/04/image-20220905104115551.png" alt="" />
<p class="caption">image-20220905104115551</p>
</div>
<p><strong>回归参数的解读</strong></p>
<pre><code>## 基于上述求对数消除的方法就可以获得每个协变量的 β值，则利用h(t)函数求解
HR = eβ( β为指数)，则ln(HR) = β;
因此，如果 β&gt;0,则HR&gt;1为危险因素；反之，当 β&lt;0,则HR&lt;1，为保护性因素。</code></pre>
<div class="figure">
<img src="image/04/image-20220905105320020.png" alt="" />
<p class="caption">image-20220905105320020</p>
</div>
</div>
<div id="参数解释和先验假设" class="section level6 hasAnchor" number="4.3.2.2.1.2">
<h6><span class="header-section-number">4.3.2.2.1.2</span> 参数解释和先验假设<a href="Model-building.html#参数解释和先验假设" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="Model-building.html#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 1前提配置：-----</span></span>
<span id="cb123-2"><a href="Model-building.html#cb123-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 1、状态结局：</span></span>
<span id="cb123-3"><a href="Model-building.html#cb123-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 一般结局为0-1，其中1的另外一种可能来自于删失；</span></span>
<span id="cb123-4"><a href="Model-building.html#cb123-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 所谓删失是指患者在中途因意外因素退出试验；</span></span>
<span id="cb123-5"><a href="Model-building.html#cb123-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Cox回归主要探讨什么样的患者死亡的更快，什么因素影响了患者死亡的速度。</span></span>
<span id="cb123-6"><a href="Model-building.html#cb123-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-7"><a href="Model-building.html#cb123-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 删失定义；</span></span>
<span id="cb123-8"><a href="Model-building.html#cb123-8" aria-hidden="true" tabindex="-1"></a>生存结局（status）一般分为「死亡」和删失两类。「死亡」指的是我们感兴趣的终点事件（如白血病患者死亡、冠心病患者第二次发病）。除此之外的结局或生存结局则归类为删失（censoring），也称为截尾或终检。</span>
<span id="cb123-9"><a href="Model-building.html#cb123-9" aria-hidden="true" tabindex="-1"></a>删失的一般原因有：</span>
<span id="cb123-10"><a href="Model-building.html#cb123-10" aria-hidden="true" tabindex="-1"></a><span class="fl">1.</span> 研究截至日期时，感兴趣终点事件仍未出现</span>
<span id="cb123-11"><a href="Model-building.html#cb123-11" aria-hidden="true" tabindex="-1"></a><span class="fl">2.</span> 失访，不知道感兴趣终点事件何时发生或是否会发生</span>
<span id="cb123-12"><a href="Model-building.html#cb123-12" aria-hidden="true" tabindex="-1"></a><span class="fl">3.</span> 因各种原因中途退出</span>
<span id="cb123-13"><a href="Model-building.html#cb123-13" aria-hidden="true" tabindex="-1"></a><span class="fl">4.</span> 死于其它「事件」，如交通意外或其他疾病；</span>
<span id="cb123-14"><a href="Model-building.html#cb123-14" aria-hidden="true" tabindex="-1"></a>删失分为左删失、右删失和中间删失：</span>
<span id="cb123-15"><a href="Model-building.html#cb123-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-16"><a href="Model-building.html#cb123-16" aria-hidden="true" tabindex="-1"></a><span class="do">## 右删失分为三种类型：</span></span>
<span id="cb123-17"><a href="Model-building.html#cb123-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 一型删失：</span></span>
<span id="cb123-18"><a href="Model-building.html#cb123-18" aria-hidden="true" tabindex="-1"></a>在一型删失方案中，试验中收集失效部件的失效时间，一旦试验进程到达提前设计的停止时间T，则删失所有剩余未失效部件，并停止试验进程。但此时收到的失效数据的数据量k是一个随机数。</span>
<span id="cb123-19"><a href="Model-building.html#cb123-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 二型删失：</span></span>
<span id="cb123-20"><a href="Model-building.html#cb123-20" aria-hidden="true" tabindex="-1"></a>在二型删失方案中，试验会提前给定收集到的失效数据量n，则试验会在收集到提前给定数据的数据量时停止。相较于一型删失方案，二型的优点是能够收集到固定数量的删失数据，但由于试验时间不可控制，为收集大足够多的数据会导致试验时间过长和成本大大提高。</span>
<span id="cb123-21"><a href="Model-building.html#cb123-21" aria-hidden="true" tabindex="-1"></a><span class="co"># III型删失（Type III censoring）：</span></span>
<span id="cb123-22"><a href="Model-building.html#cb123-22" aria-hidden="true" tabindex="-1"></a>不同起点，无固定终点 在实际的研究过程中，往往不能保证所有研究对象在同一时间同时进入研究，在研究开始后，随着研究对象的陆续招募进入研究，不同研究对象的观察起始时间有先有后。同时，在研究结束前，有些研究对象已经发生终点事件，可以记录其准确的生存时间，但也有些研究对象中途退出研究，或者在研究结束时仍然未发生终点事件，他们的生存时间无法明确。这种观察起始时间和删失时间均不相同的类型，称之为III型删失，也是临床研究中最为常见的类型。由于删失数据往往是随机发生的，因此III型删失也称为随机删失（Random censoring）。</span>
<span id="cb123-23"><a href="Model-building.html#cb123-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-24"><a href="Model-building.html#cb123-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-25"><a href="Model-building.html#cb123-25" aria-hidden="true" tabindex="-1"></a><span class="do">## 2、模型参数解释</span></span>
<span id="cb123-26"><a href="Model-building.html#cb123-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 1、HR值：</span></span>
<span id="cb123-27"><a href="Model-building.html#cb123-27" aria-hidden="true" tabindex="-1"></a><span class="co"># HR值：Cox模型用来衡量某个因素对于生存的影响程度，HR就是影响程度的量化。</span></span>
<span id="cb123-28"><a href="Model-building.html#cb123-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 如果HR=1，则X是0还是1对于生存状况无影响，如果HR&gt;1,则X为1时会增加死亡的风险，</span></span>
<span id="cb123-29"><a href="Model-building.html#cb123-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 如果HR&lt;1，则X为1是会减少死亡的风险。</span></span>
<span id="cb123-30"><a href="Model-building.html#cb123-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 当自变量增大一个单位时，对于COX回归，改变了风险比HR的自然对数值。</span></span>
<span id="cb123-31"><a href="Model-building.html#cb123-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-32"><a href="Model-building.html#cb123-32" aria-hidden="true" tabindex="-1"></a><span class="co"># 2、相关性分析：</span></span>
<span id="cb123-33"><a href="Model-building.html#cb123-33" aria-hidden="true" tabindex="-1"></a><span class="co"># 3）相关性分析：Cox的单因素回归分析时p&lt;0.05，但是用于多因素回归时会出现p&gt;0.05的情况。</span></span>
<span id="cb123-34"><a href="Model-building.html#cb123-34" aria-hidden="true" tabindex="-1"></a><span class="co"># 这个时候往往是该因素和其他因素有一定的相关性，</span></span>
<span id="cb123-35"><a href="Model-building.html#cb123-35" aria-hidden="true" tabindex="-1"></a><span class="co"># 需要去做进一步的相关性分析。</span></span>
<span id="cb123-36"><a href="Model-building.html#cb123-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-37"><a href="Model-building.html#cb123-37" aria-hidden="true" tabindex="-1"></a><span class="do">## 3、模型构建的先验假设：</span></span>
<span id="cb123-38"><a href="Model-building.html#cb123-38" aria-hidden="true" tabindex="-1"></a><span class="co">#（3.1）比例风险假设：又称PH假设，指模型自变量系数为固定值，不随时间T的变化而变化。</span></span>
<span id="cb123-39"><a href="Model-building.html#cb123-39" aria-hidden="true" tabindex="-1"></a>vet <span class="ot">&lt;-</span> <span class="fu">mutate</span>(veteran, <span class="at">AG =</span> <span class="fu">ifelse</span>((age <span class="sc">&lt;</span> <span class="dv">60</span>), <span class="st">&quot;LT60&quot;</span>, <span class="st">&quot;OV60&quot;</span>),</span>
<span id="cb123-40"><a href="Model-building.html#cb123-40" aria-hidden="true" tabindex="-1"></a>              <span class="at">AG =</span> <span class="fu">factor</span>(AG),</span>
<span id="cb123-41"><a href="Model-building.html#cb123-41" aria-hidden="true" tabindex="-1"></a>              <span class="at">trt =</span> <span class="fu">factor</span>(trt,<span class="at">labels=</span><span class="fu">c</span>(<span class="st">&quot;standard&quot;</span>,<span class="st">&quot;test&quot;</span>)),</span>
<span id="cb123-42"><a href="Model-building.html#cb123-42" aria-hidden="true" tabindex="-1"></a>              <span class="at">prior =</span> <span class="fu">factor</span>(prior,<span class="at">labels=</span><span class="fu">c</span>(<span class="st">&quot;N0&quot;</span>,<span class="st">&quot;Yes&quot;</span>)))</span>
<span id="cb123-43"><a href="Model-building.html#cb123-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-44"><a href="Model-building.html#cb123-44" aria-hidden="true" tabindex="-1"></a><span class="do">## 观测协变量如何随时间变化： </span></span>
<span id="cb123-45"><a href="Model-building.html#cb123-45" aria-hidden="true" tabindex="-1"></a><span class="do">## 适合删失数据的Aalen加性回归模型</span></span>
<span id="cb123-46"><a href="Model-building.html#cb123-46" aria-hidden="true" tabindex="-1"></a>aa_fit <span class="ot">&lt;-</span><span class="fu">aareg</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> trt <span class="sc">+</span> celltype <span class="sc">+</span></span>
<span id="cb123-47"><a href="Model-building.html#cb123-47" aria-hidden="true" tabindex="-1"></a>                 karno <span class="sc">+</span> diagtime <span class="sc">+</span> age <span class="sc">+</span> prior , </span>
<span id="cb123-48"><a href="Model-building.html#cb123-48" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> vet)</span>
<span id="cb123-49"><a href="Model-building.html#cb123-49" aria-hidden="true" tabindex="-1"></a><span class="do">## 使用autoplot的前提是需要配置好分类变量和连续变量的属性：</span></span>
<span id="cb123-50"><a href="Model-building.html#cb123-50" aria-hidden="true" tabindex="-1"></a>cox <span class="sc">%&gt;%</span> <span class="fu">autoplot</span>()</span>
<span id="cb123-51"><a href="Model-building.html#cb123-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-52"><a href="Model-building.html#cb123-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-53"><a href="Model-building.html#cb123-53" aria-hidden="true" tabindex="-1"></a><span class="do">## 使用cox.zph测试比例风险假设（针对每个变量）</span></span>
<span id="cb123-54"><a href="Model-building.html#cb123-54" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> trt <span class="sc">+</span> celltype <span class="sc">+</span> karno <span class="sc">+</span> </span>
<span id="cb123-55"><a href="Model-building.html#cb123-55" aria-hidden="true" tabindex="-1"></a>               diagtime <span class="sc">+</span> age <span class="sc">+</span> prior , <span class="at">data =</span> veteran)</span>
<span id="cb123-56"><a href="Model-building.html#cb123-56" aria-hidden="true" tabindex="-1"></a>test.ph <span class="ot">=</span> <span class="fu">cox.zph</span>(fit) <span class="do">## p值小于0.05时该变量不符合使用Schoenfeld 假设；</span></span>
<span id="cb123-57"><a href="Model-building.html#cb123-57" aria-hidden="true" tabindex="-1"></a><span class="do">## 通过可视化方法来校验Schoenfeld分布：</span></span>
<span id="cb123-58"><a href="Model-building.html#cb123-58" aria-hidden="true" tabindex="-1"></a><span class="fu">ggcoxzph</span>(test.ph)</span>
<span id="cb123-59"><a href="Model-building.html#cb123-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-60"><a href="Model-building.html#cb123-60" aria-hidden="true" tabindex="-1"></a><span class="do">## 当变量违反该假设时，使用分层或者交互来解决：</span></span>
<span id="cb123-61"><a href="Model-building.html#cb123-61" aria-hidden="true" tabindex="-1"></a><span class="co"># 添加covariate×time相互作用。</span></span>
<span id="cb123-62"><a href="Model-building.html#cb123-62" aria-hidden="true" tabindex="-1"></a><span class="co"># 分层（对令人讨厌的混杂因素有用）。</span></span>
<span id="cb123-63"><a href="Model-building.html#cb123-63" aria-hidden="true" tabindex="-1"></a><span class="co"># 还有有一种方法是使用时间加速失效模型（Accelerated Failure Time Models，AFT）</span></span>
<span id="cb123-64"><a href="Model-building.html#cb123-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-65"><a href="Model-building.html#cb123-65" aria-hidden="true" tabindex="-1"></a><span class="co">#（3.2）对数线性假设： 模型中对数风险比值Ln(HR)与自变量X呈线性关系。</span></span>
<span id="cb123-66"><a href="Model-building.html#cb123-66" aria-hidden="true" tabindex="-1"></a><span class="co"># 这个假设检验通常被忽略；</span></span>
<span id="cb123-67"><a href="Model-building.html#cb123-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-68"><a href="Model-building.html#cb123-68" aria-hidden="true" tabindex="-1"></a><span class="do">## 4 通过可视化偏差的方法来检查纳入数据集的异常值：</span></span>
<span id="cb123-69"><a href="Model-building.html#cb123-69" aria-hidden="true" tabindex="-1"></a><span class="fu">ggcoxdiagnostics</span>(fit, <span class="at">type =</span> <span class="st">&quot;deviance&quot;</span>,</span>
<span id="cb123-70"><a href="Model-building.html#cb123-70" aria-hidden="true" tabindex="-1"></a>                 <span class="at">linear.predictions =</span> <span class="cn">FALSE</span>, <span class="at">ggtheme =</span> <span class="fu">theme_bw</span>())</span></code></pre></div>
</div>
<div id="构建cox模型的两种方法" class="section level6 hasAnchor" number="4.3.2.2.1.3">
<h6><span class="header-section-number">4.3.2.2.1.3</span> 构建cox模型的两种方法<a href="Model-building.html#构建cox模型的两种方法" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb124-1"><a href="Model-building.html#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 构建模型方法1：</span></span>
<span id="cb124-2"><a href="Model-building.html#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survey)</span>
<span id="cb124-3"><a href="Model-building.html#cb124-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb124-4"><a href="Model-building.html#cb124-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survminer)</span>
<span id="cb124-5"><a href="Model-building.html#cb124-5" aria-hidden="true" tabindex="-1"></a>cox <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> trt <span class="sc">+</span> celltype <span class="sc">+</span> karno <span class="sc">+</span> </span>
<span id="cb124-6"><a href="Model-building.html#cb124-6" aria-hidden="true" tabindex="-1"></a>               diagtime <span class="sc">+</span> age <span class="sc">+</span> prior , <span class="at">data =</span> veteran)</span>
<span id="cb124-7"><a href="Model-building.html#cb124-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-8"><a href="Model-building.html#cb124-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox)</span>
<span id="cb124-9"><a href="Model-building.html#cb124-9" aria-hidden="true" tabindex="-1"></a>cox_fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(cox)</span>
<span id="cb124-10"><a href="Model-building.html#cb124-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cox_fit, <span class="at">main =</span> <span class="st">&quot;cph model&quot;</span>, <span class="at">xlab=</span><span class="st">&quot;Days&quot;</span>)</span>
<span id="cb124-11"><a href="Model-building.html#cb124-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-12"><a href="Model-building.html#cb124-12" aria-hidden="true" tabindex="-1"></a><span class="do">## 构建模型方法2:：</span></span>
<span id="cb124-13"><a href="Model-building.html#cb124-13" aria-hidden="true" tabindex="-1"></a><span class="co">#用 cph()函数来拟合Cox比例风险回归模</span></span>
<span id="cb124-14"><a href="Model-building.html#cb124-14" aria-hidden="true" tabindex="-1"></a>res.cox <span class="ot">&lt;-</span> <span class="fu">cph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> age <span class="sc">+</span> sex, <span class="at">data =</span> lung)</span>
<span id="cb124-15"><a href="Model-building.html#cb124-15" aria-hidden="true" tabindex="-1"></a><span class="co">#构建生存函数</span></span>
<span id="cb124-16"><a href="Model-building.html#cb124-16" aria-hidden="true" tabindex="-1"></a>med <span class="ot">&lt;-</span> <span class="fu">Quantile</span>(res.cox) <span class="co"># 计算中位生存时间</span></span>
<span id="cb124-17"><a href="Model-building.html#cb124-17" aria-hidden="true" tabindex="-1"></a>surv <span class="ot">&lt;-</span> <span class="fu">Survival</span>(res.cox) <span class="co"># 构建生存概率函数</span></span>
<span id="cb124-18"><a href="Model-building.html#cb124-18" aria-hidden="true" tabindex="-1"></a><span class="co">#绘图：预测中位生存时间</span></span>
<span id="cb124-19"><a href="Model-building.html#cb124-19" aria-hidden="true" tabindex="-1"></a>nom <span class="ot">&lt;-</span> <span class="fu">nomogram</span>(res.cox, <span class="at">fun=</span><span class="cf">function</span>(x) <span class="fu">med</span>(<span class="at">lp=</span>x),</span>
<span id="cb124-20"><a href="Model-building.html#cb124-20" aria-hidden="true" tabindex="-1"></a>                <span class="at">funlabel=</span><span class="st">&quot;Median Survival Time&quot;</span>)</span>
<span id="cb124-21"><a href="Model-building.html#cb124-21" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(nom)</span>
<span id="cb124-22"><a href="Model-building.html#cb124-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-23"><a href="Model-building.html#cb124-23" aria-hidden="true" tabindex="-1"></a><span class="do">## 计算中位生存时间和和生存概率：</span></span>
<span id="cb124-24"><a href="Model-building.html#cb124-24" aria-hidden="true" tabindex="-1"></a>med <span class="ot">&lt;-</span> <span class="fu">Quantile</span>(res.cox) <span class="co"># 计算中位生存时间</span></span>
<span id="cb124-25"><a href="Model-building.html#cb124-25" aria-hidden="true" tabindex="-1"></a>surv <span class="ot">&lt;-</span> <span class="fu">Survival</span>(res.cox) <span class="co"># 构建生存概率函数</span></span>
<span id="cb124-26"><a href="Model-building.html#cb124-26" aria-hidden="true" tabindex="-1"></a><span class="do">## 计算指定时间的生存概率：</span></span>
<span id="cb124-27"><a href="Model-building.html#cb124-27" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(res.cox, <span class="at">times =</span> <span class="fu">c</span>(<span class="dv">1000</span>, <span class="dv">2000</span>))</span>
<span id="cb124-28"><a href="Model-building.html#cb124-28" aria-hidden="true" tabindex="-1"></a><span class="do">## 计算指定生存概率累计和的天数：</span></span>
<span id="cb124-29"><a href="Model-building.html#cb124-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 在probs参数中quantile()我们必须指定一个减去我们的目标生存概率；这是因为该 # 函数在累积分布函数 (CDF) 约定下工作，并且 CDF 等于 1 减去生存概率</span></span>
<span id="cb124-30"><a href="Model-building.html#cb124-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 找出生存概率等于 0.7 的天数和等于 0.6 的天数</span></span>
<span id="cb124-31"><a href="Model-building.html#cb124-31" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(KM_fit, <span class="at">probs =</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">c</span>(<span class="fl">0.7</span>, <span class="fl">0.6</span>))</span>
<span id="cb124-32"><a href="Model-building.html#cb124-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-33"><a href="Model-building.html#cb124-33" aria-hidden="true" tabindex="-1"></a><span class="do">## 预测多年持续生存概率：</span></span>
<span id="cb124-34"><a href="Model-building.html#cb124-34" aria-hidden="true" tabindex="-1"></a><span class="co">#  根据模型预测患者1年，3年和5年的生存概率。</span></span>
<span id="cb124-35"><a href="Model-building.html#cb124-35" aria-hidden="true" tabindex="-1"></a>t <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">*</span><span class="dv">365</span>,<span class="dv">3</span><span class="sc">*</span><span class="dv">365</span>,<span class="dv">5</span><span class="sc">*</span><span class="dv">365</span>)</span>
<span id="cb124-36"><a href="Model-building.html#cb124-36" aria-hidden="true" tabindex="-1"></a>survprob <span class="ot">&lt;-</span> <span class="fu">predictSurvProb</span>(cox1,<span class="at">newd=</span>test,<span class="at">times=</span>t)</span></code></pre></div>
</div>
<div id="模型结果解读" class="section level6 hasAnchor" number="4.3.2.2.1.4">
<h6><span class="header-section-number">4.3.2.2.1.4</span> 模型结果解读<a href="Model-building.html#模型结果解读" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<pre><code># 2、z值代表Wald统计量，其值等于回归系数coef除以其标准误se(coef)，即z = coef/se(coef)；有统计量必有其对应的假设检验的显著性P值，其说明bata值是否与0有统计学意义上的显著差别。
# 补充来说：
标记为“z”的列给出了Wald统计值。它对应于每个回归系数与其标准误差的比率（z = coef / se（coef））。wald统计评估是否beta（ββ）系数在统计上显着不同于0。

# 3、coef(-0.5310)值小于0说明HR值小于1，而这里的Cox模型是group two相对于group one而言的，那么按照测试数据集来说：male=1，female=1，即女性的死亡风险相比男性要低
# 
# 4、exp(coef)[等价于HR]等于0.59，即风险比例等于0.59，说明女性(male=2)减少了0.59倍风险，女性与良好预后相关
#      
# 5、Likelihood ratio test，Wald test，Score (logrank) test则是给出了3种可选择的P值，这三者是asymptotically equivalent；当样本数目足够大时，这三者的值是相似的；当样本数目较少时，这三者是有差别的，但是Likelihood ratio test会比其他两种在小样本中表现的更优
</code></pre>
</div>
<div id="模型评估c-index" class="section level6 hasAnchor" number="4.3.2.2.1.5">
<h6><span class="header-section-number">4.3.2.2.1.5</span> 模型评估(c-index)<a href="Model-building.html#模型评估c-index" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="Model-building.html#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="co"># c-index：可以看到Cox回归中还有一个值是Concordance；</span></span>
<span id="cb126-2"><a href="Model-building.html#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 它反映模型的区分能力，考察模型正确预测的能力。</span></span>
<span id="cb126-3"><a href="Model-building.html#cb126-3" aria-hidden="true" tabindex="-1"></a><span class="co"># c-index等于0.5时，表示模型的预测结果是随机的，没有任何预测作用，0.5-0.7为低准确度，</span></span>
<span id="cb126-4"><a href="Model-building.html#cb126-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 0.7-0.9表示中等准确度，0.9以上表示高准确度。</span></span>
<span id="cb126-5"><a href="Model-building.html#cb126-5" aria-hidden="true" tabindex="-1"></a><span class="do">## base-R中：rcorrcens已被删除：</span></span>
<span id="cb126-6"><a href="Model-building.html#cb126-6" aria-hidden="true" tabindex="-1"></a><span class="fu">rcorrcens</span>(<span class="fu">Surv</span>(time,status) <span class="sc">~</span> <span class="fu">predict</span>(res.cox), <span class="at">data =</span>lung)</span>
<span id="cb126-7"><a href="Model-building.html#cb126-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-8"><a href="Model-building.html#cb126-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Hmisc::rcorr.cens()</span></span>
<span id="cb126-9"><a href="Model-building.html#cb126-9" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;survivaldta.csv&quot;</span>)</span>
<span id="cb126-10"><a href="Model-building.html#cb126-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Hmisc)</span>
<span id="cb126-11"><a href="Model-building.html#cb126-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb126-12"><a href="Model-building.html#cb126-12" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">cph</span>(<span class="fu">Surv</span>(time,death)<span class="sc">~</span>x1<span class="sc">+</span>x2<span class="sc">+</span>x3,<span class="at">data=</span>survivldata)</span>
<span id="cb126-13"><a href="Model-building.html#cb126-13" aria-hidden="true" tabindex="-1"></a>fp <span class="ot">&lt;-</span> <span class="fu">predict</span>(f)</span>
<span id="cb126-14"><a href="Model-building.html#cb126-14" aria-hidden="true" tabindex="-1"></a>cindex.orig<span class="ot">=</span><span class="dv">1</span><span class="sc">-</span><span class="fu">rcorr.cens</span>(fp,<span class="fu">Surv</span>(time,death))</span>
<span id="cb126-15"><a href="Model-building.html#cb126-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-16"><a href="Model-building.html#cb126-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-17"><a href="Model-building.html#cb126-17" aria-hidden="true" tabindex="-1"></a><span class="do">## survival::survConcordance</span></span>
<span id="cb126-18"><a href="Model-building.html#cb126-18" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;survivaldta.csv&quot;</span>)</span>
<span id="cb126-19"><a href="Model-building.html#cb126-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb126-20"><a href="Model-building.html#cb126-20" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time,death)<span class="sc">~</span>x1<span class="sc">+</span>x2<span class="sc">+</span>x3,<span class="at">data=</span>survivldata)</span>
<span id="cb126-21"><a href="Model-building.html#cb126-21" aria-hidden="true" tabindex="-1"></a>sum.surv <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit)</span>
<span id="cb126-22"><a href="Model-building.html#cb126-22" aria-hidden="true" tabindex="-1"></a>c_index <span class="ot">&lt;-</span>sum.surv<span class="sc">$</span>concordance</span>
<span id="cb126-23"><a href="Model-building.html#cb126-23" aria-hidden="true" tabindex="-1"></a>c_index</span>
<span id="cb126-24"><a href="Model-building.html#cb126-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-25"><a href="Model-building.html#cb126-25" aria-hidden="true" tabindex="-1"></a><span class="do">## concordance.concordant            se.std(c-d) </span></span>
<span id="cb126-26"><a href="Model-building.html#cb126-26" aria-hidden="true" tabindex="-1"></a><span class="do">##             0.54469239             0.02788881</span></span>
<span id="cb126-27"><a href="Model-building.html#cb126-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-28"><a href="Model-building.html#cb126-28" aria-hidden="true" tabindex="-1"></a><span class="co"># or using the function survConcordance to get c-index</span></span>
<span id="cb126-29"><a href="Model-building.html#cb126-29" aria-hidden="true" tabindex="-1"></a>c_index <span class="ot">&lt;-</span> <span class="fu">survConcordance</span>(<span class="fu">Surv</span>(time,death)<span class="sc">~</span><span class="fu">predict</span>(fit,survivldata))<span class="sc">$</span>concordance</span></code></pre></div>
</div>
<div id="绘制多变量列线图" class="section level6 hasAnchor" number="4.3.2.2.1.6">
<h6><span class="header-section-number">4.3.2.2.1.6</span> 绘制多变量列线图<a href="Model-building.html#绘制多变量列线图" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="Model-building.html#cb127-1" aria-hidden="true" tabindex="-1"></a>Cox比例风险模型也是多因素回归模型的一种，在考虑结局时，还加入了时间因素的影响。</span>
<span id="cb127-2"><a href="Model-building.html#cb127-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-3"><a href="Model-building.html#cb127-3" aria-hidden="true" tabindex="-1"></a>列线图（Alignment Diagram），又称诺莫图（Nomogram图），用来把多因素回归分析结果（logistic回归和cox回归）用图形方式表现出来，将多个预测指标进行整合，然后采用带有刻度的线段，按照一定的比例绘制在同一平面上，从而用以表达预测模型中各个变量之间的相互关系。</span>
<span id="cb127-4"><a href="Model-building.html#cb127-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-5"><a href="Model-building.html#cb127-5" aria-hidden="true" tabindex="-1"></a>根据模型中各个影响因素对结局变量的贡献程度（回归系数的大小），给每个影响因素的每个取值水平进行赋分，然后再将各个评分相加得到总评分，最后通过总评分与结局事件发生概率之间的函数转换关系，从而计算出该个体结局事件的预测值。</span>
<span id="cb127-6"><a href="Model-building.html#cb127-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-7"><a href="Model-building.html#cb127-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 列线图解读：</span></span>
<span id="cb127-8"><a href="Model-building.html#cb127-8" aria-hidden="true" tabindex="-1"></a>就那上图来说。我们想知道年龄45岁 (<span class="at">age=</span><span class="dv">45</span>) 的女性（sex<span class="ot">=</span>1）的患病风险，只需要将age<span class="ot">=</span>45岁向“ points（评分）”轴投射，则：points<span class="ot">=</span>50；同理 sex<span class="ot">=</span><span class="dv">1</span> 时，points≈37。两者相加则“ Total points<span class="ot">=</span>87”；将此数值在“ Total points ”轴上向“ Risk ”概率轴投射，则可知风险大概在0<span class="fl">.4</span>和0<span class="fl">.5</span>之间。（参见图中红线）。</span></code></pre></div>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb128-1"><a href="Model-building.html#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 方法1：</span></span>
<span id="cb128-2"><a href="Model-building.html#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb128-3"><a href="Model-building.html#cb128-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rms)</span>
<span id="cb128-4"><a href="Model-building.html#cb128-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-5"><a href="Model-building.html#cb128-5" aria-hidden="true" tabindex="-1"></a>dd <span class="ot">&lt;-</span> <span class="fu">datadist</span>(lung)</span>
<span id="cb128-6"><a href="Model-building.html#cb128-6" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">datadist =</span> <span class="st">&quot;dd&quot;</span>)</span>
<span id="cb128-7"><a href="Model-building.html#cb128-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-8"><a href="Model-building.html#cb128-8" aria-hidden="true" tabindex="-1"></a>coxfit <span class="ot">&lt;-</span> <span class="fu">cph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> age <span class="sc">+</span> sex <span class="sc">+</span> ph.ecog <span class="sc">+</span> ph.karno <span class="sc">+</span> pat.karno,</span>
<span id="cb128-9"><a href="Model-building.html#cb128-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> lung, <span class="at">x=</span>T,<span class="at">y=</span>T,<span class="at">surv =</span> T</span>
<span id="cb128-10"><a href="Model-building.html#cb128-10" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb128-11"><a href="Model-building.html#cb128-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-12"><a href="Model-building.html#cb128-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 构建生存函数，注意你的最大生存时间</span></span>
<span id="cb128-13"><a href="Model-building.html#cb128-13" aria-hidden="true" tabindex="-1"></a>surv <span class="ot">&lt;-</span> <span class="fu">Survival</span>(coxfit) </span>
<span id="cb128-14"><a href="Model-building.html#cb128-14" aria-hidden="true" tabindex="-1"></a>surv1 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">surv</span>(<span class="dv">365</span>,x) <span class="co"># 1年OS</span></span>
<span id="cb128-15"><a href="Model-building.html#cb128-15" aria-hidden="true" tabindex="-1"></a>surv2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">surv</span>(<span class="dv">365</span><span class="sc">*</span><span class="dv">2</span>,x) <span class="co"># 2年OS</span></span>
<span id="cb128-16"><a href="Model-building.html#cb128-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-17"><a href="Model-building.html#cb128-17" aria-hidden="true" tabindex="-1"></a>nom <span class="ot">&lt;-</span> <span class="fu">nomogram</span>(coxfit,</span>
<span id="cb128-18"><a href="Model-building.html#cb128-18" aria-hidden="true" tabindex="-1"></a>                <span class="at">fun =</span> <span class="fu">list</span>(surv1,surv2),</span>
<span id="cb128-19"><a href="Model-building.html#cb128-19" aria-hidden="true" tabindex="-1"></a>                <span class="at">lp =</span> T,</span>
<span id="cb128-20"><a href="Model-building.html#cb128-20" aria-hidden="true" tabindex="-1"></a>                <span class="at">funlabel =</span> <span class="fu">c</span>(<span class="st">&#39;1-year survival Probability&#39;</span>,</span>
<span id="cb128-21"><a href="Model-building.html#cb128-21" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&#39;2-year survival Probability&#39;</span>),</span>
<span id="cb128-22"><a href="Model-building.html#cb128-22" aria-hidden="true" tabindex="-1"></a>                <span class="at">maxscale =</span> <span class="dv">100</span>,</span>
<span id="cb128-23"><a href="Model-building.html#cb128-23" aria-hidden="true" tabindex="-1"></a>                <span class="at">fun.at =</span> <span class="fu">c</span>(<span class="fl">0.95</span>,<span class="fl">0.9</span>,<span class="fl">0.8</span>,<span class="fl">0.7</span>,<span class="fl">0.6</span>,<span class="fl">0.5</span>,<span class="fl">0.4</span>,<span class="fl">0.3</span>,<span class="fl">0.2</span>,<span class="fl">0.1</span>))</span>
<span id="cb128-24"><a href="Model-building.html#cb128-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-25"><a href="Model-building.html#cb128-25" aria-hidden="true" tabindex="-1"></a><span class="do">## 绘制列线图：</span></span>
<span id="cb128-26"><a href="Model-building.html#cb128-26" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(nom, </span>
<span id="cb128-27"><a href="Model-building.html#cb128-27" aria-hidden="true" tabindex="-1"></a>     <span class="at">lplabel=</span><span class="st">&quot;Linear Predictor&quot;</span>,</span>
<span id="cb128-28"><a href="Model-building.html#cb128-28" aria-hidden="true" tabindex="-1"></a>     <span class="at">xfrac =</span> <span class="fl">0.2</span>, <span class="co"># 左侧标签距离坐标轴的距离</span></span>
<span id="cb128-29"><a href="Model-building.html#cb128-29" aria-hidden="true" tabindex="-1"></a>     <span class="co">#varname.label = TRUE, </span></span>
<span id="cb128-30"><a href="Model-building.html#cb128-30" aria-hidden="true" tabindex="-1"></a>     <span class="at">tcl =</span> <span class="sc">-</span><span class="fl">0.2</span>, <span class="co"># 刻度长短和方向 </span></span>
<span id="cb128-31"><a href="Model-building.html#cb128-31" aria-hidden="true" tabindex="-1"></a>     <span class="at">lmgp =</span> <span class="fl">0.1</span>, <span class="co"># 坐标轴标签距离坐标轴远近</span></span>
<span id="cb128-32"><a href="Model-building.html#cb128-32" aria-hidden="true" tabindex="-1"></a>     <span class="at">points.label =</span><span class="st">&#39;Points&#39;</span>, </span>
<span id="cb128-33"><a href="Model-building.html#cb128-33" aria-hidden="true" tabindex="-1"></a>     <span class="at">total.points.label =</span> <span class="st">&#39;Total Points&#39;</span>,</span>
<span id="cb128-34"><a href="Model-building.html#cb128-34" aria-hidden="true" tabindex="-1"></a>     <span class="at">cap.labels =</span> <span class="cn">FALSE</span>,</span>
<span id="cb128-35"><a href="Model-building.html#cb128-35" aria-hidden="true" tabindex="-1"></a>     <span class="at">cex.var =</span> <span class="dv">1</span>, <span class="co"># 左侧标签字体大小</span></span>
<span id="cb128-36"><a href="Model-building.html#cb128-36" aria-hidden="true" tabindex="-1"></a>     <span class="at">cex.axis =</span> <span class="dv">1</span>, <span class="co"># 坐标轴字体大小</span></span>
<span id="cb128-37"><a href="Model-building.html#cb128-37" aria-hidden="true" tabindex="-1"></a>     <span class="at">col.grid =</span> <span class="fu">gray</span>(<span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">0.95</span>))) <span class="co"># 竖线颜色</span></span>
<span id="cb128-38"><a href="Model-building.html#cb128-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-39"><a href="Model-building.html#cb128-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-40"><a href="Model-building.html#cb128-40" aria-hidden="true" tabindex="-1"></a><span class="do">## 方法2：动态弹出：</span></span>
<span id="cb128-41"><a href="Model-building.html#cb128-41" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DynNom)</span>
<span id="cb128-42"><a href="Model-building.html#cb128-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-43"><a href="Model-building.html#cb128-43" aria-hidden="true" tabindex="-1"></a>coxfit <span class="ot">&lt;-</span> <span class="fu">cph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> age <span class="sc">+</span> sex <span class="sc">+</span> ph.ecog <span class="sc">+</span> ph.karno <span class="sc">+</span> pat.karno, <span class="at">data =</span> lung, <span class="at">x=</span>T,<span class="at">y=</span>T,<span class="at">surv =</span> T)</span>
<span id="cb128-44"><a href="Model-building.html#cb128-44" aria-hidden="true" tabindex="-1"></a>             </span>
<span id="cb128-45"><a href="Model-building.html#cb128-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-46"><a href="Model-building.html#cb128-46" aria-hidden="true" tabindex="-1"></a><span class="fu">DynNom</span>(coxfit,</span>
<span id="cb128-47"><a href="Model-building.html#cb128-47" aria-hidden="true" tabindex="-1"></a>       <span class="at">DNxlab =</span> <span class="st">&quot;Survival probability&quot;</span>,</span>
<span id="cb128-48"><a href="Model-building.html#cb128-48" aria-hidden="true" tabindex="-1"></a>       <span class="at">KMtitle=</span><span class="st">&quot;Kaplan-Meier plot&quot;</span>, </span>
<span id="cb128-49"><a href="Model-building.html#cb128-49" aria-hidden="true" tabindex="-1"></a>       <span class="at">KMxlab =</span> <span class="st">&quot;Time (Days)&quot;</span>, </span>
<span id="cb128-50"><a href="Model-building.html#cb128-50" aria-hidden="true" tabindex="-1"></a>       <span class="at">KMylab =</span> <span class="st">&quot;Survival probability&quot;</span>)</span>
<span id="cb128-51"><a href="Model-building.html#cb128-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-52"><a href="Model-building.html#cb128-52" aria-hidden="true" tabindex="-1"></a><span class="do">## 方法3：</span></span>
<span id="cb128-53"><a href="Model-building.html#cb128-53" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(regplot)</span>
<span id="cb128-54"><a href="Model-building.html#cb128-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-55"><a href="Model-building.html#cb128-55" aria-hidden="true" tabindex="-1"></a>coxfit <span class="ot">&lt;-</span> <span class="fu">cph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> age <span class="sc">+</span> sex <span class="sc">+</span> ph.ecog <span class="sc">+</span> ph.karno <span class="sc">+</span> pat.karno,<span class="at">data =</span> lung, <span class="at">x=</span>T,<span class="at">y=</span>T,<span class="at">surv =</span> T)</span>
<span id="cb128-56"><a href="Model-building.html#cb128-56" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb128-57"><a href="Model-building.html#cb128-57" aria-hidden="true" tabindex="-1"></a><span class="fu">regplot</span>(coxfit,</span>
<span id="cb128-58"><a href="Model-building.html#cb128-58" aria-hidden="true" tabindex="-1"></a>        <span class="at">plots =</span> <span class="fu">c</span>(<span class="st">&quot;violin&quot;</span>, <span class="st">&quot;boxes&quot;</span>), <span class="do">##连续性变量形状，可选&quot;no plot&quot; &quot;density&quot; &quot;boxes&quot; &quot;ecdf&quot; &quot;bars&quot; &quot;boxplot&quot; &quot;violin&quot; &quot;bean&quot; &quot;spikes&quot;；分类变量的形状，可选&quot;no plot&quot; &quot;boxes&quot; &quot;bars&quot; &quot;spikes&quot;</span></span>
<span id="cb128-59"><a href="Model-building.html#cb128-59" aria-hidden="true" tabindex="-1"></a>        <span class="at">observation =</span> lung[<span class="dv">1</span>,], <span class="co">#用哪行观测，或者T F</span></span>
<span id="cb128-60"><a href="Model-building.html#cb128-60" aria-hidden="true" tabindex="-1"></a>        <span class="at">center =</span> T, <span class="co"># 对齐变量</span></span>
<span id="cb128-61"><a href="Model-building.html#cb128-61" aria-hidden="true" tabindex="-1"></a>        <span class="at">subticks =</span> T,</span>
<span id="cb128-62"><a href="Model-building.html#cb128-62" aria-hidden="true" tabindex="-1"></a>        <span class="at">droplines =</span> T,<span class="co">#是否画竖线</span></span>
<span id="cb128-63"><a href="Model-building.html#cb128-63" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">&quot;nomogram&quot;</span>,</span>
<span id="cb128-64"><a href="Model-building.html#cb128-64" aria-hidden="true" tabindex="-1"></a>        <span class="at">points =</span> T, <span class="co"># 截距项显示为0-100</span></span>
<span id="cb128-65"><a href="Model-building.html#cb128-65" aria-hidden="true" tabindex="-1"></a>        <span class="at">odds =</span> T, <span class="co"># 是否显示OR值</span></span>
<span id="cb128-66"><a href="Model-building.html#cb128-66" aria-hidden="true" tabindex="-1"></a>        <span class="at">showP =</span> T, <span class="co"># 是否显示变量的显著性标记</span></span>
<span id="cb128-67"><a href="Model-building.html#cb128-67" aria-hidden="true" tabindex="-1"></a>        <span class="at">rank =</span> <span class="st">&quot;sd&quot;</span>, <span class="co"># 根据sd给变量排序</span></span>
<span id="cb128-68"><a href="Model-building.html#cb128-68" aria-hidden="true" tabindex="-1"></a>        <span class="at">interval=</span><span class="st">&quot;confidence&quot;</span>, <span class="co"># 展示可信区间</span></span>
<span id="cb128-69"><a href="Model-building.html#cb128-69" aria-hidden="true" tabindex="-1"></a>        <span class="at">clickable =</span> F <span class="co"># 是否可以交互)</span></span>
<span id="cb128-70"><a href="Model-building.html#cb128-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-71"><a href="Model-building.html#cb128-71" aria-hidden="true" tabindex="-1"></a><span class="do">## 方法4：</span></span>
<span id="cb128-72"><a href="Model-building.html#cb128-72" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(VRPM)</span>
<span id="cb128-73"><a href="Model-building.html#cb128-73" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb128-74"><a href="Model-building.html#cb128-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-75"><a href="Model-building.html#cb128-75" aria-hidden="true" tabindex="-1"></a>cox_fit <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> age <span class="sc">+</span> sex <span class="sc">+</span> ph.ecog <span class="sc">+</span> ph.karno <span class="sc">+</span> pat.karno,</span>
<span id="cb128-76"><a href="Model-building.html#cb128-76" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> lung,<span class="at">model =</span> T)</span>
<span id="cb128-77"><a href="Model-building.html#cb128-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-78"><a href="Model-building.html#cb128-78" aria-hidden="true" tabindex="-1"></a><span class="fu">colplot</span>(cox_fit,<span class="at">coloroptions =</span> <span class="dv">3</span>,<span class="at">filename =</span> <span class="st">&quot;cox.png&quot;</span>)</span></code></pre></div>
</div>
<div id="可视化多变量条件下连续变量与累计风险的关系" class="section level6 hasAnchor" number="4.3.2.2.1.7">
<h6><span class="header-section-number">4.3.2.2.1.7</span> 可视化多变量条件下连续变量与累计风险的关系：<a href="Model-building.html#可视化多变量条件下连续变量与累计风险的关系" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="Model-building.html#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 参见资料：</span></span>
<span id="cb129-2"><a href="Model-building.html#cb129-2" aria-hidden="true" tabindex="-1"></a>https<span class="sc">:</span><span class="er">//</span>zhuanlan.zhihu.com<span class="sc">/</span>p<span class="sc">/</span><span class="dv">370963253</span></span>
<span id="cb129-3"><a href="Model-building.html#cb129-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-4"><a href="Model-building.html#cb129-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb129-5"><a href="Model-building.html#cb129-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(titanic)</span>
<span id="cb129-6"><a href="Model-building.html#cb129-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rms)</span>
<span id="cb129-7"><a href="Model-building.html#cb129-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb129-8"><a href="Model-building.html#cb129-8" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb129-9"><a href="Model-building.html#cb129-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-10"><a href="Model-building.html#cb129-10" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> lung[, <span class="fu">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;status&quot;</span>, <span class="st">&quot;age&quot;</span>, <span class="st">&quot;sex&quot;</span>, <span class="st">&quot;ph.karno&quot;</span>)]</span>
<span id="cb129-11"><a href="Model-building.html#cb129-11" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(data)</span>
<span id="cb129-12"><a href="Model-building.html#cb129-12" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>sex <span class="ot">&lt;-</span> <span class="fu">factor</span>(data<span class="sc">$</span>sex, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb129-13"><a href="Model-building.html#cb129-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-14"><a href="Model-building.html#cb129-14" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> age <span class="sc">+</span> sex <span class="sc">+</span> ph.karno, <span class="at">data =</span> data)</span>
<span id="cb129-15"><a href="Model-building.html#cb129-15" aria-hidden="true" tabindex="-1"></a>fit</span>
<span id="cb129-16"><a href="Model-building.html#cb129-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-17"><a href="Model-building.html#cb129-17" aria-hidden="true" tabindex="-1"></a>dd <span class="ot">&lt;-</span> <span class="fu">datadist</span>(data)</span>
<span id="cb129-18"><a href="Model-building.html#cb129-18" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">datadist =</span> <span class="st">&quot;dd&quot;</span>)</span>
<span id="cb129-19"><a href="Model-building.html#cb129-19" aria-hidden="true" tabindex="-1"></a>dd<span class="sc">$</span>limits<span class="sc">$</span>age[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co"># 指定参考点</span></span>
<span id="cb129-20"><a href="Model-building.html#cb129-20" aria-hidden="true" tabindex="-1"></a><span class="do">## 使用rms提供的样条样本采样方法获得：</span></span>
<span id="cb129-21"><a href="Model-building.html#cb129-21" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">update</span>(fit)</span>
<span id="cb129-22"><a href="Model-building.html#cb129-22" aria-hidden="true" tabindex="-1"></a>HR <span class="ot">&lt;-</span> <span class="fu">Predict</span>(fit, <span class="at">age =</span> <span class="fu">seq</span>(<span class="dv">40</span>, <span class="dv">80</span>, <span class="dv">1</span>), <span class="at">fun =</span> exp, <span class="at">ref.zero =</span> T)</span>
<span id="cb129-23"><a href="Model-building.html#cb129-23" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(HR) <span class="sc">+</span> </span>
<span id="cb129-24"><a href="Model-building.html#cb129-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> dt, <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> HR, <span class="at">color =</span> <span class="st">&quot;HR&quot;</span>), <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb129-25"><a href="Model-building.html#cb129-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> dt, <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> HR_lwr, <span class="at">color =</span> <span class="st">&quot;HR_lwr&quot;</span>), <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb129-26"><a href="Model-building.html#cb129-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> dt, <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> HR_upr, <span class="at">color =</span> <span class="st">&quot;HR_upr&quot;</span>), <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb129-27"><a href="Model-building.html#cb129-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">color =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span> </span>
<span id="cb129-28"><a href="Model-building.html#cb129-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">0.8</span>))</span></code></pre></div>
</div>
</div>
<div id="构建时依cox回归模型检验非比例" class="section level5 hasAnchor" number="4.3.2.2.2">
<h5><span class="header-section-number">4.3.2.2.2</span> 构建时依cox回归模型检验（非比例）<a href="Model-building.html#构建时依cox回归模型检验非比例" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div id="时依协变量-类型" class="section level6 hasAnchor" number="4.3.2.2.2.1">
<h6><span class="header-section-number">4.3.2.2.2.1</span> 时依协变量 类型<a href="Model-building.html#时依协变量-类型" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="Model-building.html#cb130-1" aria-hidden="true" tabindex="-1"></a>时依协变量（Time<span class="sc">-</span>Dependent Covariate），所谓时依协变量，顾名思义指的就是随时间变化而变化解释变量，也有翻译成时变解释变量、时变协变量，我觉得也很不错。 大体时变协变量分为几个情况：</span>
<span id="cb130-2"><a href="Model-building.html#cb130-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-3"><a href="Model-building.html#cb130-3" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span> 内在时依协变量：时依协变量是指随时间变化自变量本身发生变化的那些变量，比如有些患者原来是吸烟的，但在随访过程中戒烟了，这种时依协变量被称为内在时依协变量。</span>
<span id="cb130-4"><a href="Model-building.html#cb130-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-5"><a href="Model-building.html#cb130-5" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span> 外在时依协变量：还有一种情况，随着时间的变化，模型中自变量本身取值并未发生改变，但其效应却在发生变化，这种时依协变量被称为外在时依协变量。</span>
<span id="cb130-6"><a href="Model-building.html#cb130-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-7"><a href="Model-building.html#cb130-7" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span> 交互项纳入：有时候我们也会刻意构建一种时依协变量，比如当违背比例风险假定时，我们可以将变量与时间的相乘作为将互项纳入（即使变量本身不一定会随时间变化而变化），这样就可以进行COX回归了。当然我们也可以利用这个原理考察比例风险假定是否满足。</span>
<span id="cb130-8"><a href="Model-building.html#cb130-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-9"><a href="Model-building.html#cb130-9" aria-hidden="true" tabindex="-1"></a>一个典型的例子就是多疗程治疗下用户的死亡时间，如果以用户接受的药剂量来做协变量，则属于一个经典时变变量。 因为用户活得越久，接受大疗程越多，注入的要药剂也越多。换而言之，药剂量在用户的生存期内，是随时间变化的，不像性别这些因素一样保持不变。 这样的问题在用户流失中同样存在，如优惠券的累计发放量，同样与药剂量类似。</span>
<span id="cb130-10"><a href="Model-building.html#cb130-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-11"><a href="Model-building.html#cb130-11" aria-hidden="true" tabindex="-1"></a>对于这种变量，我们需要对原始数据做split。根据变化的时间节点，把原始数据打断为多行。 以用户流失为例，假设某用户在一年内35日、186日、303日分别接受了优惠券：</span></code></pre></div>
</div>
<div id="r-时依cox" class="section level6 hasAnchor" number="4.3.2.2.2.2">
<h6><span class="header-section-number">4.3.2.2.2.2</span> R 时依COX<a href="Model-building.html#r-时依cox" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="Model-building.html#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 先进行PH检验：</span></span>
<span id="cb131-2"><a href="Model-building.html#cb131-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb131-3"><a href="Model-building.html#cb131-3" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> <span class="fu">factor</span>(trt) <span class="sc">+</span> <span class="fu">factor</span>(prior) <span class="sc">+</span> karno, <span class="at">data =</span> veteran)</span>
<span id="cb131-4"><a href="Model-building.html#cb131-4" aria-hidden="true" tabindex="-1"></a><span class="do">## 时依模式下的变量是否符合比例风险假设：</span></span>
<span id="cb131-5"><a href="Model-building.html#cb131-5" aria-hidden="true" tabindex="-1"></a>zp <span class="ot">&lt;-</span> <span class="fu">cox.zph</span>(fit, <span class="at">transform =</span> <span class="cf">function</span>(time) <span class="fu">log</span>(time <span class="sc">+</span> <span class="dv">20</span>))</span>
<span id="cb131-6"><a href="Model-building.html#cb131-6" aria-hidden="true" tabindex="-1"></a>zp</span>
<span id="cb131-7"><a href="Model-building.html#cb131-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 如果不符合需要根据需要来修改时间变量的方法：</span></span>
<span id="cb131-8"><a href="Model-building.html#cb131-8" aria-hidden="true" tabindex="-1"></a>zp2 <span class="ot">&lt;-</span> <span class="fu">cox.zph</span>(fit, <span class="at">transform =</span> <span class="cf">function</span>(time) <span class="fu">log</span>(time))</span>
<span id="cb131-9"><a href="Model-building.html#cb131-9" aria-hidden="true" tabindex="-1"></a>zp2</span>
<span id="cb131-10"><a href="Model-building.html#cb131-10" aria-hidden="true" tabindex="-1"></a>               </span>
<span id="cb131-11"><a href="Model-building.html#cb131-11" aria-hidden="true" tabindex="-1"></a><span class="do">## 构建时依变量模型 -- 方法1:</span></span>
<span id="cb131-12"><a href="Model-building.html#cb131-12" aria-hidden="true" tabindex="-1"></a><span class="do">## tt这里是构架了一种处理函数，来转换时间尺度的变化：</span></span>
<span id="cb131-13"><a href="Model-building.html#cb131-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 常用转换有三种形式：</span></span>
<span id="cb131-14"><a href="Model-building.html#cb131-14" aria-hidden="true" tabindex="-1"></a>x<span class="sc">*</span>t ; x<span class="sc">*</span><span class="fu">log</span>(t); x<span class="sc">*</span><span class="fu">log</span>(t<span class="sc">+</span><span class="dv">20</span>)               </span>
<span id="cb131-15"><a href="Model-building.html#cb131-15" aria-hidden="true" tabindex="-1"></a>                       </span>
<span id="cb131-16"><a href="Model-building.html#cb131-16" aria-hidden="true" tabindex="-1"></a>fit2 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> <span class="fu">factor</span>(trt) <span class="sc">+</span> <span class="fu">factor</span>(prior) <span class="sc">+</span> karno <span class="sc">+</span> <span class="fu">tt</span>(karno), <span class="at">data =</span> veteran, <span class="at">tt =</span> <span class="cf">function</span>(x, t, ...) x<span class="sc">*</span><span class="fu">log</span>(t<span class="sc">+</span><span class="dv">20</span>))</span>
<span id="cb131-17"><a href="Model-building.html#cb131-17" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb131-18"><a href="Model-building.html#cb131-18" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit2)</span>
<span id="cb131-19"><a href="Model-building.html#cb131-19" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb131-20"><a href="Model-building.html#cb131-20" aria-hidden="true" tabindex="-1"></a><span class="do">## 构建时依变量模型 -- 方法2:   </span></span>
<span id="cb131-21"><a href="Model-building.html#cb131-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 注意不能通过添加交互项的方法来为cox回归添加协变量，因为那种方法相当于给指定协变量添加了一个静态变量：              </span></span>
<span id="cb131-22"><a href="Model-building.html#cb131-22" aria-hidden="true" tabindex="-1"></a>先以unique生存时间为分割点，将每个id拆分成多条记录，然后在拆分的数据集中构建协变量<span class="sc">*</span>时间的交互项。拆分数据集可通过survival包的survSplit()函数或Greg包timeSplitter()函数实现。    </span>
<span id="cb131-23"><a href="Model-building.html#cb131-23" aria-hidden="true" tabindex="-1"></a>这里的实现逻辑本质上是放宽了cox回归的假设要求；              </span>
<span id="cb131-24"><a href="Model-building.html#cb131-24" aria-hidden="true" tabindex="-1"></a><span class="do">##   方法1：使用survive包的survSplit()函数：    </span></span>
<span id="cb131-25"><a href="Model-building.html#cb131-25" aria-hidden="true" tabindex="-1"></a><span class="co"># id 一般默认为患者id；</span></span>
<span id="cb131-26"><a href="Model-building.html#cb131-26" aria-hidden="true" tabindex="-1"></a>veteran2 <span class="ot">&lt;-</span> <span class="fu">survSplit</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span>., <span class="at">cut =</span> <span class="fu">unique</span>(veteran<span class="sc">$</span>time), <span class="at">data =</span> veteran, <span class="at">id =</span> <span class="st">&quot;id&quot;</span>)             </span>
<span id="cb131-27"><a href="Model-building.html#cb131-27" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb131-28"><a href="Model-building.html#cb131-28" aria-hidden="true" tabindex="-1"></a>fit3_1 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(tstart, time, status) <span class="sc">~</span> trt <span class="sc">+</span> prior <span class="sc">+</span> karno <span class="sc">+</span> karno <span class="sc">:</span> <span class="fu">log</span>(time <span class="sc">+</span> <span class="dv">20</span>), <span class="at">data =</span> veteran2)</span>
<span id="cb131-29"><a href="Model-building.html#cb131-29" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit3_1)              </span>
<span id="cb131-30"><a href="Model-building.html#cb131-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-31"><a href="Model-building.html#cb131-31" aria-hidden="true" tabindex="-1"></a><span class="do">## 方法2：使用Greg包的timeSplitter：</span></span>
<span id="cb131-32"><a href="Model-building.html#cb131-32" aria-hidden="true" tabindex="-1"></a>veteran<span class="sc">$</span>id <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(veteran)</span>
<span id="cb131-33"><a href="Model-building.html#cb131-33" aria-hidden="true" tabindex="-1"></a>veteran4 <span class="ot">&lt;-</span> <span class="fu">timeSplitter</span>(<span class="at">data =</span> veteran, <span class="at">by =</span> <span class="fu">unique</span>(veteran<span class="sc">$</span>time), <span class="at">time_var =</span> <span class="st">&quot;time&quot;</span>, <span class="at">event_var =</span> <span class="st">&quot;status&quot;</span>)     </span>
<span id="cb131-34"><a href="Model-building.html#cb131-34" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb131-35"><a href="Model-building.html#cb131-35" aria-hidden="true" tabindex="-1"></a><span class="do">## 总结：</span></span>
<span id="cb131-36"><a href="Model-building.html#cb131-36" aria-hidden="true" tabindex="-1"></a><span class="fl">1.</span> <span class="fu">survSplit</span>()函数和<span class="fu">timeSplitter</span>()函数拆分的数据集完全一样，差别在于：1）起止时间变量的命名不同，<span class="fu">survSplit</span>()函数为tstart和time，<span class="fu">timeSplitter</span>()函数为Start_time和Stop_time；2）<span class="fu">survSplit</span>()函数可以通过参数id在拆分数据集中生成变量id，而<span class="fu">timeSplitter</span>()函数则需在拆分前手动生成变量id。</span>
<span id="cb131-37"><a href="Model-building.html#cb131-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-38"><a href="Model-building.html#cb131-38" aria-hidden="true" tabindex="-1"></a><span class="fl">2.</span> 以unique生存时间为分割点和以unique事件发生的生存时间为分割点，回归结果是一样的，只不过以unique生存时间为分割点的拆分数据集会更大。       </span>
<span id="cb131-39"><a href="Model-building.html#cb131-39" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb131-40"><a href="Model-building.html#cb131-40" aria-hidden="true" tabindex="-1"></a>3、tt参数构建的模型占用的内存相对更大（fit5），所以在数据量较大的情况下可以优先选择先拆分数据集再构建模型的方式。       </span>
<span id="cb131-41"><a href="Model-building.html#cb131-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-42"><a href="Model-building.html#cb131-42" aria-hidden="true" tabindex="-1"></a>4、最后要说明一点，在不考虑时依协变量的情况下，是否拆分数据集以及分割点的选择，对回归结果没有影响。              </span></code></pre></div>
</div>
</div>
<div id="构建分段cox回归模型检验非比例" class="section level5 hasAnchor" number="4.3.2.2.3">
<h5><span class="header-section-number">4.3.2.2.3</span> 构建分段cox回归模型检验（非比例）<a href="Model-building.html#构建分段cox回归模型检验非比例" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<pre><code>虽然风险比例假定在整个随访时间内不成立，但在一个较短的时间段内则可能是成立的，分段模型的逻辑就是把整个生存时间拆分成多个时间段，每一段拟合一个比例风险模型。

## 第一种情况：
很多案例常从中位生存时间处下刀，SPSS中进行含时依协变量的COX回归时，会给出模型的-2 Log Likelihood值，根据模型“smaller-is-better”的信息准则格式，可以采用尝试法，选用-2LL值最小的模型对应的时间点为分割点，当然我们还需要兼顾样本量的问题【EVP原则：10 outcome events per variable】。

## 参见资料：
https://cran.r-project.org/web/packages/eha/vignettes/tpchreg.html
https://cran.r-project.org/web/packages/eha/vignettes/tpchreg.html


## 分段cox回归：
## 本质上是一种中间删失的cox数据组：
## 使用surv函数来定义：t
oldmort$birthyear &lt;- floor(oldmort$birthdate) - 1800
## Surv(time, time2, event,type=c(&#39;right&#39;,&#39;interval&#39;))
om &lt;- toTpch(Surv(enter, exit, event) ~ sex + civ + birthyear, 
             cuts = seq(60, 100, by = 2), data = oldmort)
head(om)

oldpar &lt;- par(mfrow = c(1, 2), las = 1, lwd = 1.5)
plot(fit3, fn = &quot;haz&quot;, log = &quot;y&quot;, main = &quot;log(hazards)&quot;, 
     xlab = &quot;Age&quot;, ylab = &quot;log(Deaths / Year)&quot;, col = &quot;blue&quot;)
plot(fit3, fn = &quot;haz&quot;, log = &quot;&quot;, main = &quot;hazards&quot;, 
     xlab = &quot;Age&quot;, ylab = &quot;Deaths / Year&quot;, col = &quot;blue&quot;)</code></pre>
</div>
</div>
<div id="竞争风险研究fine-gray" class="section level4 hasAnchor" number="4.3.2.3">
<h4><span class="header-section-number">4.3.2.3</span> 竞争风险研究（Fine-gray）<a href="Model-building.html#竞争风险研究fine-gray" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div id="竞争风险统计背景" class="section level5 hasAnchor" number="4.3.2.3.1">
<h5><span class="header-section-number">4.3.2.3.1</span> 竞争风险统计背景<a href="Model-building.html#竞争风险统计背景" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="Model-building.html#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 定义；</span></span>
<span id="cb133-2"><a href="Model-building.html#cb133-2" aria-hidden="true" tabindex="-1"></a>竞争风险模型( Competing Risk Model ) <span class="sc">:</span> 指的是在观察队列中，存在某种已知事件可能会影响另一种事件发生的概率或者是完全阻碍其发生,则可认为前者与后者存在竞争风险。</span>
<span id="cb133-3"><a href="Model-building.html#cb133-3" aria-hidden="true" tabindex="-1"></a>所谓竞争风险模型（Competing Risk Model）是一种处理多种潜在结局生存数据的分析方法，早在1999年Fine和Gray就提出了部分分布的半参数比例风险模型，通常使用的终点指标是累积发生率函数（Cumulative incidence function，CIF）。 作者：咩咩羊不是羊 https<span class="sc">:</span><span class="er">//</span>www.bilibili.com<span class="sc">/</span>read<span class="sc">/</span>cv14611796 出处：bilibili</span>
<span id="cb133-4"><a href="Model-building.html#cb133-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-5"><a href="Model-building.html#cb133-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 当受试者在事件发生时间设置中有多个可能事件时</span></span>
<span id="cb133-6"><a href="Model-building.html#cb133-6" aria-hidden="true" tabindex="-1"></a>例子：复发、死于疾病等</span>
<span id="cb133-7"><a href="Model-building.html#cb133-7" aria-hidden="true" tabindex="-1"></a>例如，可以想象复发的患者更有可能死亡，因此复发时间和死亡时间不会是独立事件。</span>
<span id="cb133-8"><a href="Model-building.html#cb133-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-9"><a href="Model-building.html#cb133-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 竞争风险的背景：</span></span>
<span id="cb133-10"><a href="Model-building.html#cb133-10" aria-hidden="true" tabindex="-1"></a>1、给定事件的特定原因危害：这表示事件在没有因其他事件而失败的事件中的每单位时间发生率</span>
<span id="cb133-11"><a href="Model-building.html#cb133-11" aria-hidden="true" tabindex="-1"></a>2、给定事件的累积发生率：这表示事件单位时间的发生率以及竞争事件的影响</span>
<span id="cb133-12"><a href="Model-building.html#cb133-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-13"><a href="Model-building.html#cb133-13" aria-hidden="true" tabindex="-1"></a><span class="do">## 竞争风险模型分析原因：</span></span>
<span id="cb133-14"><a href="Model-building.html#cb133-14" aria-hidden="true" tabindex="-1"></a>竞争风险模型<span class="sc">:</span>适用于多个终点的生存数据，是一种处理多种潜在结局生存数据的分析方法,通过计算每个结局的累积发生率函数( Cumulative Incidences Function , CIF )进行分析。</span>
<span id="cb133-15"><a href="Model-building.html#cb133-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-16"><a href="Model-building.html#cb133-16" aria-hidden="true" tabindex="-1"></a>单一结局的生存分析,主要关注研究对象的生存概率或者死L _风险，这里的生存概率仅仅是这一个结局的生存的概率，而竞争风险中,可能是多个结局共同的总的生存概率或者总的死L _风险,研究的兴趣点的生存概率是这个总生存概率的一部分。</span>
<span id="cb133-17"><a href="Model-building.html#cb133-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-18"><a href="Model-building.html#cb133-18" aria-hidden="true" tabindex="-1"></a><span class="do">## 竞争风险模型也分为单因素多终点和多因素多终点两种：</span></span>
<span id="cb133-19"><a href="Model-building.html#cb133-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 单因素多终点：</span></span>
<span id="cb133-20"><a href="Model-building.html#cb133-20" aria-hidden="true" tabindex="-1"></a>使用CIF（见上）意为各自的关心事件累积发生函数、竞争事件累积发生函数。CIF假设事件每次发生有且仅有一种，具有期望属性,即各类别CIF之和等于复合事件CIF。</span>
<span id="cb133-21"><a href="Model-building.html#cb133-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-22"><a href="Model-building.html#cb133-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 多因素多终点：</span></span>
<span id="cb133-23"><a href="Model-building.html#cb133-23" aria-hidden="true" tabindex="-1"></a>CS <span class="sc">:</span>表示时刻未发生任何事件的观察个体发生第k类事件的瞬时概率强度。</span>
<span id="cb133-24"><a href="Model-building.html#cb133-24" aria-hidden="true" tabindex="-1"></a>SD <span class="sc">:</span>表示时刻未发生第k类事件的观察个体发生第k类事件的瞬时概率强度。</span>
<span id="cb133-25"><a href="Model-building.html#cb133-25" aria-hidden="true" tabindex="-1"></a>其中：</span>
<span id="cb133-26"><a href="Model-building.html#cb133-26" aria-hidden="true" tabindex="-1"></a>CS解决了比例风险模型中不能同时较准确地考虑多个终点事件,适合病因学研究。</span>
<span id="cb133-27"><a href="Model-building.html#cb133-27" aria-hidden="true" tabindex="-1"></a>缺点<span class="sc">:</span></span>
<span id="cb133-28"><a href="Model-building.html#cb133-28" aria-hidden="true" tabindex="-1"></a>1、要求观察量两两之间及协变量之间独立;</span>
<span id="cb133-29"><a href="Model-building.html#cb133-29" aria-hidden="true" tabindex="-1"></a>2、对结果的解释不是很直观。</span>
<span id="cb133-30"><a href="Model-building.html#cb133-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-31"><a href="Model-building.html#cb133-31" aria-hidden="true" tabindex="-1"></a><span class="do">## 何时选择竞争风险模型：</span></span>
<span id="cb133-32"><a href="Model-building.html#cb133-32" aria-hidden="true" tabindex="-1"></a>临床生存数据如果有多个结局,当存在竞争结局时,不满足”删失独立”的假设，则不能用Cox比例风，险模型进行多因素分析,否则会出现错误的HR。竞争事件比例<span class="sc">&gt;</span> <span class="dv">10</span><span class="sc">%采用传统方法可造成严重偏倚,而&lt;10%</span>可能出现假阳性或假阴性。</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th></th>
<th>单因素分析</th>
<th>单因素分析</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td></td>
<td>不存在竞争风险</td>
<td>存在竞争风险</td>
</tr>
<tr class="even">
<td>发生率</td>
<td>Kaplan-Meier</td>
<td>CIF</td>
</tr>
<tr class="odd">
<td>生存曲线</td>
<td>Kaplan-Meier曲线</td>
<td>Nelson-Aalen累积风险曲线</td>
</tr>
<tr class="even">
<td>差异性检验</td>
<td>Log-rank</td>
<td>Gray’s检验</td>
</tr>
</tbody>
</table>
</div>
<div id="r-代码实现竞争风险回归" class="section level5 hasAnchor" number="4.3.2.3.2">
<h5><span class="header-section-number">4.3.2.3.2</span> R 代码实现竞争风险回归<a href="Model-building.html#r-代码实现竞争风险回归" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="Model-building.html#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 此案例数据是从 </span></span>
<span id="cb134-2"><a href="Model-building.html#cb134-2" aria-hidden="true" tabindex="-1"></a>http<span class="sc">:</span><span class="er">//</span>www.stat.unipg.it<span class="sc">/</span>luca<span class="sc">/</span>R<span class="sc">/</span></span>
<span id="cb134-3"><a href="Model-building.html#cb134-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-4"><a href="Model-building.html#cb134-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 单因素竞争风险：</span></span>
<span id="cb134-5"><a href="Model-building.html#cb134-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(foreign) </span>
<span id="cb134-6"><a href="Model-building.html#cb134-6" aria-hidden="true" tabindex="-1"></a>bmt <span class="ot">&lt;-</span><span class="fu">read.csv</span>(‘bmtcrr.csv’) </span>
<span id="cb134-7"><a href="Model-building.html#cb134-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmprsk)</span>
<span id="cb134-8"><a href="Model-building.html#cb134-8" aria-hidden="true" tabindex="-1"></a>bmt<span class="sc">$</span>D <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(bmt<span class="sc">$</span>D) </span>
<span id="cb134-9"><a href="Model-building.html#cb134-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-10"><a href="Model-building.html#cb134-10" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">cuminc</span>(ftime,Status,D) </span>
<span id="cb134-11"><a href="Model-building.html#cb134-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit1,<span class="at">xlab =</span> ‘Month’, <span class="at">ylab =</span> ‘CIF’,<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">lty=</span><span class="dv">1</span>, </span>
<span id="cb134-12"><a href="Model-building.html#cb134-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> <span class="fu">c</span>(‘red’,’blue’,’black’,’forestgreen’))</span>
<span id="cb134-13"><a href="Model-building.html#cb134-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb134-14"><a href="Model-building.html#cb134-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 多因素竞争风险 -方法1:：    </span></span>
<span id="cb134-15"><a href="Model-building.html#cb134-15" aria-hidden="true" tabindex="-1"></a><span class="do">## 注意cov的构建应尽可能展开数据，并分类成0-1类的数字编码形式：</span></span>
<span id="cb134-16"><a href="Model-building.html#cb134-16" aria-hidden="true" tabindex="-1"></a>cov <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">age =</span> bmt<span class="sc">$</span>Age, </span>
<span id="cb134-17"><a href="Model-building.html#cb134-17" aria-hidden="true" tabindex="-1"></a>                 <span class="at">sex_F =</span> <span class="fu">ifelse</span>(bmt<span class="sc">$</span>Sex<span class="sc">==</span>‘F’,<span class="dv">1</span>,<span class="dv">0</span>), </span>
<span id="cb134-18"><a href="Model-building.html#cb134-18" aria-hidden="true" tabindex="-1"></a>                <span class="at">dis_AML =</span> <span class="fu">ifelse</span>(bmt<span class="sc">$</span>D<span class="sc">==</span>‘AML’,<span class="dv">1</span>,<span class="dv">0</span>), </span>
<span id="cb134-19"><a href="Model-building.html#cb134-19" aria-hidden="true" tabindex="-1"></a>                 <span class="at">phase_cr1 =</span> <span class="fu">ifelse</span>(bmt<span class="sc">$</span>Phase<span class="sc">==</span>‘CR1’,<span class="dv">1</span>,<span class="dv">0</span>), </span>
<span id="cb134-20"><a href="Model-building.html#cb134-20" aria-hidden="true" tabindex="-1"></a>                 <span class="at">phase_cr2 =</span> <span class="fu">ifelse</span>(bmt<span class="sc">$</span>Phase<span class="sc">==</span>‘CR2’,<span class="dv">1</span>,<span class="dv">0</span>), </span>
<span id="cb134-21"><a href="Model-building.html#cb134-21" aria-hidden="true" tabindex="-1"></a>                 <span class="at">phase_cr3 =</span> <span class="fu">ifelse</span>(bmt<span class="sc">$</span>Phase<span class="sc">==</span>‘CR3’,<span class="dv">1</span>,<span class="dv">0</span>), </span>
<span id="cb134-22"><a href="Model-building.html#cb134-22" aria-hidden="true" tabindex="-1"></a>                <span class="at">source_PB =</span> <span class="fu">ifelse</span>(bmt<span class="sc">$</span>Source<span class="sc">==</span>‘PB’,<span class="dv">1</span>,<span class="dv">0</span>)) </span>
<span id="cb134-23"><a href="Model-building.html#cb134-23" aria-hidden="true" tabindex="-1"></a>1fit2 <span class="ot">&lt;-</span> <span class="fu">crr</span>(bmt<span class="sc">$</span>ftime, bmt<span class="sc">$</span>Status, cov , <span class="at">failcode=</span><span class="dv">1</span>, <span class="at">cencode=</span><span class="dv">0</span>) </span>
<span id="cb134-24"><a href="Model-building.html#cb134-24" aria-hidden="true" tabindex="-1"></a>2summary(fit2)</span>
<span id="cb134-25"><a href="Model-building.html#cb134-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-26"><a href="Model-building.html#cb134-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 多因素竞争风险 -- 方法2：</span></span>
<span id="cb134-27"><a href="Model-building.html#cb134-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 竞争风险图表：</span></span>
<span id="cb134-28"><a href="Model-building.html#cb134-28" aria-hidden="true" tabindex="-1"></a><span class="do">## 竞争分享评估；</span></span>
<span id="cb134-29"><a href="Model-building.html#cb134-29" aria-hidden="true" tabindex="-1"></a><span class="do">## 参见资料：</span></span>
<span id="cb134-30"><a href="Model-building.html#cb134-30" aria-hidden="true" tabindex="-1"></a><span class="co"># https://www.emilyzabor.com/tutorials/survival_analysis_in_r_tutorial.html</span></span>
<span id="cb134-31"><a href="Model-building.html#cb134-31" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmprsk)</span>
<span id="cb134-32"><a href="Model-building.html#cb134-32" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(Melanoma, <span class="at">package =</span> <span class="st">&quot;MASS&quot;</span>)</span>
<span id="cb134-33"><a href="Model-building.html#cb134-33" aria-hidden="true" tabindex="-1"></a><span class="do">## cencode=2表示删失的数据类型：</span></span>
<span id="cb134-34"><a href="Model-building.html#cb134-34" aria-hidden="true" tabindex="-1"></a>ci_fit <span class="ot">&lt;-</span> <span class="fu">cuminc</span>(Melanoma<span class="sc">$</span>time, Melanoma<span class="sc">$</span>status, <span class="at">cencode =</span> <span class="dv">2</span>)</span>
<span id="cb134-35"><a href="Model-building.html#cb134-35" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ci_fit, <span class="at">xlab =</span> <span class="st">&quot;Days&quot;</span>)</span>
<span id="cb134-36"><a href="Model-building.html#cb134-36" aria-hidden="true" tabindex="-1"></a><span class="fu">ggcompetingrisks</span>(ci_fit, <span class="at">xlab =</span> <span class="st">&quot;Days&quot;</span>)</span>
<span id="cb134-37"><a href="Model-building.html#cb134-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-38"><a href="Model-building.html#cb134-38" aria-hidden="true" tabindex="-1"></a><span class="do">## 比较组间竞争差异：</span></span>
<span id="cb134-39"><a href="Model-building.html#cb134-39" aria-hidden="true" tabindex="-1"></a>ci_fit <span class="ot">&lt;-</span> <span class="fu">cuminc</span>(Melanoma<span class="sc">$</span>time, Melanoma<span class="sc">$</span>status,</span>
<span id="cb134-40"><a href="Model-building.html#cb134-40" aria-hidden="true" tabindex="-1"></a>                 <span class="at">group =</span> Melanoma<span class="sc">$</span>ulcer,<span class="at">cencode =</span> <span class="dv">2</span>)</span>
<span id="cb134-41"><a href="Model-building.html#cb134-41" aria-hidden="true" tabindex="-1"></a>ci_ulcer[[<span class="st">&quot;Tests&quot;</span>]]</span>
<span id="cb134-42"><a href="Model-building.html#cb134-42" aria-hidden="true" tabindex="-1"></a><span class="fu">ggcompetingrisks</span>(</span>
<span id="cb134-43"><a href="Model-building.html#cb134-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">fit =</span> ci_ulcer, </span>
<span id="cb134-44"><a href="Model-building.html#cb134-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">multiple_panels =</span> <span class="cn">FALSE</span>,</span>
<span id="cb134-45"><a href="Model-building.html#cb134-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">&quot;Days&quot;</span>,</span>
<span id="cb134-46"><a href="Model-building.html#cb134-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">&quot;Cumulative incidence of event&quot;</span>,</span>
<span id="cb134-47"><a href="Model-building.html#cb134-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">title =</span> <span class="st">&quot;Death by ulceration&quot;</span>,</span>
<span id="cb134-48"><a href="Model-building.html#cb134-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb134-49"><a href="Model-building.html#cb134-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-50"><a href="Model-building.html#cb134-50" aria-hidden="true" tabindex="-1"></a><span class="do">## 绘制竞争风险图表：生存曲线（不同竞争风险因素 ）：</span></span>
<span id="cb134-51"><a href="Model-building.html#cb134-51" aria-hidden="true" tabindex="-1"></a>ciplotdat1 <span class="ot">&lt;-</span> </span>
<span id="cb134-52"><a href="Model-building.html#cb134-52" aria-hidden="true" tabindex="-1"></a>  ci_ulcer <span class="sc">%&gt;%</span> </span>
<span id="cb134-53"><a href="Model-building.html#cb134-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 可以识别数据组内的列表</span></span>
<span id="cb134-54"><a href="Model-building.html#cb134-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list_modify</span>(<span class="st">&quot;Tests&quot;</span> <span class="ot">=</span> <span class="cn">NULL</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb134-55"><a href="Model-building.html#cb134-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 使用浅拷贝方法从列表直接考虑一层数据，并转置成数据框：</span></span>
<span id="cb134-56"><a href="Model-building.html#cb134-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_df</span>(<span class="st">`</span><span class="at">[</span><span class="st">`</span>, <span class="fu">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;est&quot;</span>), <span class="at">.id =</span> <span class="st">&quot;id&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb134-57"><a href="Model-building.html#cb134-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;0 1&quot;</span>, <span class="st">&quot;1 1&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb134-58"><a href="Model-building.html#cb134-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Ulceration =</span> <span class="fu">recode</span>(</span>
<span id="cb134-59"><a href="Model-building.html#cb134-59" aria-hidden="true" tabindex="-1"></a>    id, </span>
<span id="cb134-60"><a href="Model-building.html#cb134-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;0 1&quot;</span> <span class="ot">=</span> <span class="st">&quot;Not ulcerated&quot;</span>, </span>
<span id="cb134-61"><a href="Model-building.html#cb134-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;1 1&quot;</span> <span class="ot">=</span> <span class="st">&quot;Ulcerated&quot;</span>)</span>
<span id="cb134-62"><a href="Model-building.html#cb134-62" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb134-63"><a href="Model-building.html#cb134-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-64"><a href="Model-building.html#cb134-64" aria-hidden="true" tabindex="-1"></a>mel_plot <span class="ot">&lt;-</span> </span>
<span id="cb134-65"><a href="Model-building.html#cb134-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(ciplotdat1, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> est, <span class="at">color =</span> Ulceration)) <span class="sc">+</span></span>
<span id="cb134-66"><a href="Model-building.html#cb134-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">lwd =</span> <span class="fl">1.2</span>)  <span class="sc">+</span></span>
<span id="cb134-67"><a href="Model-building.html#cb134-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb134-68"><a href="Model-building.html#cb134-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5000</span>)) <span class="sc">+</span></span>
<span id="cb134-69"><a href="Model-building.html#cb134-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">5000</span>, <span class="dv">1000</span>)) <span class="sc">+</span></span>
<span id="cb134-70"><a href="Model-building.html#cb134-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb134-71"><a href="Model-building.html#cb134-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb134-72"><a href="Model-building.html#cb134-72" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb134-73"><a href="Model-building.html#cb134-73" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>) <span class="sc">+</span></span>
<span id="cb134-74"><a href="Model-building.html#cb134-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Days&quot;</span>, </span>
<span id="cb134-75"><a href="Model-building.html#cb134-75" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Cumulative incidence&quot;</span>,</span>
<span id="cb134-76"><a href="Model-building.html#cb134-76" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;Melanoma death by ulceration status&quot;</span>) <span class="sc">+</span></span>
<span id="cb134-77"><a href="Model-building.html#cb134-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">&quot;text&quot;</span>, <span class="at">x =</span> <span class="dv">0</span>, <span class="at">y =</span> <span class="dv">1</span>, <span class="at">hjust =</span> <span class="dv">0</span>,</span>
<span id="cb134-78"><a href="Model-building.html#cb134-78" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">paste0</span>(</span>
<span id="cb134-79"><a href="Model-building.html#cb134-79" aria-hidden="true" tabindex="-1"></a>             <span class="st">&quot;p-value = &quot;</span>, </span>
<span id="cb134-80"><a href="Model-building.html#cb134-80" aria-hidden="true" tabindex="-1"></a>             <span class="fu">ifelse</span>(ci_ulcer<span class="sc">$</span>Tests[<span class="dv">1</span>, <span class="dv">2</span>] <span class="sc">&lt;</span> .<span class="dv">001</span>, </span>
<span id="cb134-81"><a href="Model-building.html#cb134-81" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;&lt;.001&quot;</span>, </span>
<span id="cb134-82"><a href="Model-building.html#cb134-82" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">round</span>(ci_ulcer<span class="sc">$</span>Tests[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">3</span>))))</span>
<span id="cb134-83"><a href="Model-building.html#cb134-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-84"><a href="Model-building.html#cb134-84" aria-hidden="true" tabindex="-1"></a>mel_fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(</span>
<span id="cb134-85"><a href="Model-building.html#cb134-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Surv</span>(time, <span class="fu">ifelse</span>(status <span class="sc">!=</span> <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">~</span> ulcer, </span>
<span id="cb134-86"><a href="Model-building.html#cb134-86" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> Melanoma)</span>
<span id="cb134-87"><a href="Model-building.html#cb134-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-88"><a href="Model-building.html#cb134-88" aria-hidden="true" tabindex="-1"></a>num <span class="ot">&lt;-</span> <span class="fu">ggsurvplot</span>(</span>
<span id="cb134-89"><a href="Model-building.html#cb134-89" aria-hidden="true" tabindex="-1"></a>  <span class="at">fit =</span> mel_fit, </span>
<span id="cb134-90"><a href="Model-building.html#cb134-90" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk.table =</span> <span class="cn">TRUE</span>, </span>
<span id="cb134-91"><a href="Model-building.html#cb134-91" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk.table.y.text =</span> <span class="cn">FALSE</span>,</span>
<span id="cb134-92"><a href="Model-building.html#cb134-92" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">&quot;Days&quot;</span>,</span>
<span id="cb134-93"><a href="Model-building.html#cb134-93" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk.table.fontsize =</span> <span class="fl">3.2</span>,</span>
<span id="cb134-94"><a href="Model-building.html#cb134-94" aria-hidden="true" tabindex="-1"></a>  <span class="at">tables.theme =</span> <span class="fu">theme_survminer</span>(<span class="at">font.main =</span> <span class="dv">10</span>),</span>
<span id="cb134-95"><a href="Model-building.html#cb134-95" aria-hidden="true" tabindex="-1"></a>  <span class="at">title =</span> <span class="st">&quot;Test&quot;</span>)</span>
<span id="cb134-96"><a href="Model-building.html#cb134-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-97"><a href="Model-building.html#cb134-97" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(</span>
<span id="cb134-98"><a href="Model-building.html#cb134-98" aria-hidden="true" tabindex="-1"></a>  mel_plot, </span>
<span id="cb134-99"><a href="Model-building.html#cb134-99" aria-hidden="true" tabindex="-1"></a>  num<span class="sc">$</span>table <span class="sc">+</span> <span class="fu">theme_cleantable</span>(), </span>
<span id="cb134-100"><a href="Model-building.html#cb134-100" aria-hidden="true" tabindex="-1"></a>  <span class="at">nrow =</span> <span class="dv">2</span>, </span>
<span id="cb134-101"><a href="Model-building.html#cb134-101" aria-hidden="true" tabindex="-1"></a>  <span class="at">rel_heights =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">1</span>), </span>
<span id="cb134-102"><a href="Model-building.html#cb134-102" aria-hidden="true" tabindex="-1"></a>  <span class="at">align =</span> <span class="st">&quot;v&quot;</span>, </span>
<span id="cb134-103"><a href="Model-building.html#cb134-103" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis =</span> <span class="st">&quot;b&quot;</span>)</span>
<span id="cb134-104"><a href="Model-building.html#cb134-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-105"><a href="Model-building.html#cb134-105" aria-hidden="true" tabindex="-1"></a><span class="do">## 竞争风险评估的协变量回归评估：</span></span>
<span id="cb134-106"><a href="Model-building.html#cb134-106" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用crr函数：并需要将协变量指定为矩阵；</span></span>
<span id="cb134-107"><a href="Model-building.html#cb134-107" aria-hidden="true" tabindex="-1"></a><span class="co"># 如果感兴趣的事件结局不止一个，可以使用failcode来请求不同事件的结果；</span></span>
<span id="cb134-108"><a href="Model-building.html#cb134-108" aria-hidden="true" tabindex="-1"></a>shr_fit <span class="ot">&lt;-</span> </span>
<span id="cb134-109"><a href="Model-building.html#cb134-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">crr</span>(<span class="at">ftime =</span> Melanoma<span class="sc">$</span>time,</span>
<span id="cb134-110"><a href="Model-building.html#cb134-110" aria-hidden="true" tabindex="-1"></a>    <span class="at">fstatus =</span> Melanoma<span class="sc">$</span>status,</span>
<span id="cb134-111"><a href="Model-building.html#cb134-111" aria-hidden="true" tabindex="-1"></a>    <span class="at">cov1 =</span> Melanoma[, <span class="fu">c</span>(<span class="st">&quot;sex&quot;</span>, <span class="st">&quot;age&quot;</span>)],</span>
<span id="cb134-112"><a href="Model-building.html#cb134-112" aria-hidden="true" tabindex="-1"></a>    <span class="at">cencode =</span> <span class="dv">2</span>)</span>
<span id="cb134-113"><a href="Model-building.html#cb134-113" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(Melanoma)</span>
<span id="cb134-114"><a href="Model-building.html#cb134-114" aria-hidden="true" tabindex="-1"></a><span class="do">## 如果性别和年龄未被编码为数值变量，crr不能处理字符变量：</span></span>
<span id="cb134-115"><a href="Model-building.html#cb134-115" aria-hidden="true" tabindex="-1"></a><span class="co">#需要使用model.matrix()来进行编码定义：</span></span>
<span id="cb134-116"><a href="Model-building.html#cb134-116" aria-hidden="true" tabindex="-1"></a>chardat <span class="ot">&lt;-</span> </span>
<span id="cb134-117"><a href="Model-building.html#cb134-117" aria-hidden="true" tabindex="-1"></a>  Melanoma <span class="sc">%&gt;%</span> </span>
<span id="cb134-118"><a href="Model-building.html#cb134-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb134-119"><a href="Model-building.html#cb134-119" aria-hidden="true" tabindex="-1"></a>    <span class="at">sex_char =</span> <span class="fu">ifelse</span>(sex <span class="sc">==</span> <span class="dv">0</span>, <span class="st">&quot;Male&quot;</span>, <span class="st">&quot;Female&quot;</span>))</span>
<span id="cb134-120"><a href="Model-building.html#cb134-120" aria-hidden="true" tabindex="-1"></a><span class="do">## 这里的covs1对应使用如上：</span></span>
<span id="cb134-121"><a href="Model-building.html#cb134-121" aria-hidden="true" tabindex="-1"></a>covs1 <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> sex_char <span class="sc">+</span> age, <span class="at">data =</span> chardat)[, <span class="sc">-</span><span class="dv">1</span>]</span></code></pre></div>
</div>
<div id="r-代码实现竞争风险回归列线图" class="section level5 hasAnchor" number="4.3.2.3.3">
<h5><span class="header-section-number">4.3.2.3.3</span> R 代码实现竞争风险回归列线图：<a href="Model-building.html#r-代码实现竞争风险回归列线图" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="Model-building.html#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 参见资料：</span></span>
<span id="cb135-2"><a href="Model-building.html#cb135-2" aria-hidden="true" tabindex="-1"></a>https<span class="sc">:</span><span class="er">//</span>cloud.tencent.com<span class="sc">/</span>developer<span class="sc">/</span>article<span class="sc">/</span><span class="dv">1666334</span></span>
<span id="cb135-3"><a href="Model-building.html#cb135-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-4"><a href="Model-building.html#cb135-4" aria-hidden="true" tabindex="-1"></a><span class="do">## 资料来自：</span></span>
<span id="cb135-5"><a href="Model-building.html#cb135-5" aria-hidden="true" tabindex="-1"></a>http<span class="sc">:</span><span class="er">//</span>www.stat.unipg.it<span class="sc">/</span>luca<span class="sc">/</span>R<span class="sc">/</span></span>
<span id="cb135-6"><a href="Model-building.html#cb135-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-7"><a href="Model-building.html#cb135-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(foreign)</span>
<span id="cb135-8"><a href="Model-building.html#cb135-8" aria-hidden="true" tabindex="-1"></a>bmt <span class="ot">&lt;-</span><span class="fu">read.csv</span>(‘bmtcrr.csv’)</span>
<span id="cb135-9"><a href="Model-building.html#cb135-9" aria-hidden="true" tabindex="-1"></a>bmt<span class="sc">$</span>id<span class="ot">&lt;-</span><span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(bmt)</span>
<span id="cb135-10"><a href="Model-building.html#cb135-10" aria-hidden="true" tabindex="-1"></a>bmt<span class="sc">$</span>sex <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(<span class="fu">ifelse</span>(bmt<span class="sc">$</span>Sex<span class="sc">==</span>‘F’,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb135-11"><a href="Model-building.html#cb135-11" aria-hidden="true" tabindex="-1"></a>bmt<span class="sc">$</span>D <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(<span class="fu">ifelse</span>(bmt<span class="sc">$</span>D<span class="sc">==</span>‘AML’,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb135-12"><a href="Model-building.html#cb135-12" aria-hidden="true" tabindex="-1"></a>bmt<span class="sc">$</span>phase_cr <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(<span class="fu">ifelse</span>(bmt<span class="sc">$</span>Phase<span class="sc">==</span>‘Relapse’,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb135-13"><a href="Model-building.html#cb135-13" aria-hidden="true" tabindex="-1"></a>bmt<span class="sc">$</span>source <span class="ot">=</span> <span class="fu">as.factor</span>(<span class="fu">ifelse</span>(bmt<span class="sc">$</span>Source<span class="sc">==</span>‘PB’,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb135-14"><a href="Model-building.html#cb135-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-15"><a href="Model-building.html#cb135-15" aria-hidden="true" tabindex="-1"></a><span class="do">## 注意事项：</span></span>
<span id="cb135-16"><a href="Model-building.html#cb135-16" aria-hidden="true" tabindex="-1"></a>列线图中不建议使用哑变量，应避免在列线图中使用哑变量；</span>
<span id="cb135-17"><a href="Model-building.html#cb135-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-18"><a href="Model-building.html#cb135-18" aria-hidden="true" tabindex="-1"></a>regplot包中的regplot()函数可以绘制更多美观的列线图。但是，它目前仅接受由<span class="fu">coxph</span>()，<span class="fu">lm</span>()和<span class="fu">glm</span>()函数返回的回归对象。</span>
<span id="cb135-19"><a href="Model-building.html#cb135-19" aria-hidden="true" tabindex="-1"></a>因此，为了绘制竞争风险模型的列线图，我们需要对原始数据集进行加权，以创建用于竞争风险模型分析的新数据集。</span>
<span id="cb135-20"><a href="Model-building.html#cb135-20" aria-hidden="true" tabindex="-1"></a>mstate包中crprep()函数的主要功能是创建此加权数据集，如下面的R代码所示。然后，我们可以使用<span class="fu">coxph</span>()函数拟合加权数据集的竞争风险模型，再将其给<span class="fu">regplot</span>()函数以绘制列线图。对于特定的加权原理，读者可以参考Geskus等人发表的文章。此处不再详述。</span>
<span id="cb135-21"><a href="Model-building.html#cb135-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-22"><a href="Model-building.html#cb135-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mstate)</span>
<span id="cb135-23"><a href="Model-building.html#cb135-23" aria-hidden="true" tabindex="-1"></a>df.w <span class="ot">&lt;-</span> <span class="fu">crprep</span>(“ftime”, “Status”,</span>
<span id="cb135-24"><a href="Model-building.html#cb135-24" aria-hidden="true" tabindex="-1"></a>               <span class="at">data=</span>bmt, <span class="at">trans=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>),</span>
<span id="cb135-25"><a href="Model-building.html#cb135-25" aria-hidden="true" tabindex="-1"></a>               <span class="at">cens=</span><span class="dv">0</span>, <span class="at">id=</span>“id”,</span>
<span id="cb135-26"><a href="Model-building.html#cb135-26" aria-hidden="true" tabindex="-1"></a>               <span class="at">keep=</span><span class="fu">c</span>(“age”,”sex”,”D”,”phase_cr”,”source”))</span>
<span id="cb135-27"><a href="Model-building.html#cb135-27" aria-hidden="true" tabindex="-1"></a>df.w<span class="sc">$</span>T<span class="ot">&lt;-</span> df.w<span class="sc">$</span>Tstop <span class="sc">-</span> df.w<span class="sc">$</span>Tstart</span>
<span id="cb135-28"><a href="Model-building.html#cb135-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-29"><a href="Model-building.html#cb135-29" aria-hidden="true" tabindex="-1"></a>m.crr<span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(T,status<span class="sc">==</span><span class="dv">1</span>)<span class="sc">~</span>age<span class="sc">+</span>sex<span class="sc">+</span>D<span class="sc">+</span>phase_cr<span class="sc">+</span>source,</span>
<span id="cb135-30"><a href="Model-building.html#cb135-30" aria-hidden="true" tabindex="-1"></a>             <span class="at">data=</span>df.w[df.w<span class="sc">$</span>failcode<span class="sc">==</span><span class="dv">1</span>,],</span>
<span id="cb135-31"><a href="Model-building.html#cb135-31" aria-hidden="true" tabindex="-1"></a>             <span class="at">weight=</span>weight.cens,</span>
<span id="cb135-32"><a href="Model-building.html#cb135-32" aria-hidden="true" tabindex="-1"></a>             <span class="at">subset=</span>failcode<span class="sc">==</span><span class="dv">1</span>)</span>
<span id="cb135-33"><a href="Model-building.html#cb135-33" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m.crr)</span>
<span id="cb135-34"><a href="Model-building.html#cb135-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-35"><a href="Model-building.html#cb135-35" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(regplot)</span>
<span id="cb135-36"><a href="Model-building.html#cb135-36" aria-hidden="true" tabindex="-1"></a><span class="fu">regplot</span>(m.crr,<span class="at">observation=</span>df.w[df.w<span class="sc">$</span>id<span class="sc">==</span><span class="dv">31</span><span class="sc">&amp;</span>df.w<span class="sc">$</span>failcode<span class="sc">==</span><span class="dv">1</span>,],</span>
<span id="cb135-37"><a href="Model-building.html#cb135-37" aria-hidden="true" tabindex="-1"></a>        <span class="at">failtime =</span> <span class="fu">c</span>(<span class="dv">36</span>, <span class="dv">60</span>), <span class="at">prfail =</span> T, <span class="at">droplines=</span>T)</span>
<span id="cb135-38"><a href="Model-building.html#cb135-38" aria-hidden="true" tabindex="-1"></a><span class="co"># 为了便于比较，可以在原始数据集bmt中进一步构建Cox回归模型，将id=31的患者的协变 # 量的值计算为相应的得分，并计算总分，分别计算id=31的患者在36个月和60个月的累积复# 发概率。计算结果分别为：0.205和0.217(图33)。</span></span>
<span id="cb135-39"><a href="Model-building.html#cb135-39" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb135-40"><a href="Model-building.html#cb135-40" aria-hidden="true" tabindex="-1"></a>m.cph<span class="ot">&lt;-</span><span class="fu">coxph</span>(<span class="fu">Surv</span>(ftime,Status<span class="sc">==</span><span class="dv">1</span>)<span class="sc">~</span>age<span class="sc">+</span>sex<span class="sc">+</span>D<span class="sc">+</span>phase_cr<span class="sc">+</span>source,</span>
<span id="cb135-41"><a href="Model-building.html#cb135-41" aria-hidden="true" tabindex="-1"></a>             <span class="at">data=</span>bmt)</span>
<span id="cb135-42"><a href="Model-building.html#cb135-42" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m.cph)</span>
<span id="cb135-43"><a href="Model-building.html#cb135-43" aria-hidden="true" tabindex="-1"></a><span class="fu">regplot</span>(m.cph,<span class="at">observation=</span>bmt[bmt<span class="sc">$</span>id<span class="sc">==</span><span class="dv">31</span>,],</span>
<span id="cb135-44"><a href="Model-building.html#cb135-44" aria-hidden="true" tabindex="-1"></a>       <span class="at">failtime =</span> <span class="fu">c</span>(<span class="dv">36</span>,<span class="dv">60</span>), <span class="at">prfail =</span> <span class="cn">TRUE</span>,<span class="at">droplines=</span>T)</span></code></pre></div>
</div>
</div>
<div id="cox模型的扩展" class="section level4 hasAnchor" number="4.3.2.4">
<h4><span class="header-section-number">4.3.2.4</span> COX模型的扩展<a href="Model-building.html#cox模型的扩展" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div id="使用参数分布族来拟合cox回归模型" class="section level5 hasAnchor" number="4.3.2.4.1">
<h5><span class="header-section-number">4.3.2.4.1</span> 使用参数分布族来拟合cox回归模型：<a href="Model-building.html#使用参数分布族来拟合cox回归模型" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb136-1"><a href="Model-building.html#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 如果基线风险是参数类型，则可以在某些条件下使用参数cox回归法方法更精准的解释cox回归结果；</span></span>
<span id="cb136-2"><a href="Model-building.html#cb136-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 如果基线风险被认为是非参数的，则将获得 Cox 比例风险模型。</span></span>
<span id="cb136-3"><a href="Model-building.html#cb136-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Weibull 和exponential是仅有的同时具有比例风险和加速故障时间表示的参数回归模型。</span></span>
<span id="cb136-4"><a href="Model-building.html#cb136-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-5"><a href="Model-building.html#cb136-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 关于不同分布族的选择方法：</span></span>
<span id="cb136-6"><a href="Model-building.html#cb136-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 参考:https://blog.sciencenet.cn/blog-927304-876450.html</span></span>
<span id="cb136-7"><a href="Model-building.html#cb136-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 如果我们认为h(t)是常数c，那么存活时间就满足参数为c的指数分布。如果认为logh(t) = a + bt，那么存活时间满足Gompertz分布，如果认为logh(t) = a + log(t)。那么存活时间满足Weibull分布。</span></span>
<span id="cb136-8"><a href="Model-building.html#cb136-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-9"><a href="Model-building.html#cb136-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-10"><a href="Model-building.html#cb136-10" aria-hidden="true" tabindex="-1"></a><span class="do">## survival提供了survreg函数用于参数分析cox回归；</span></span>
<span id="cb136-11"><a href="Model-building.html#cb136-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 当survreg中的method为log形式时，则表示使用AFT模型：</span></span>
<span id="cb136-12"><a href="Model-building.html#cb136-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 注意survreg计算的p值是基于似然比(LR)，而不是 Wald 检验。</span></span>
<span id="cb136-13"><a href="Model-building.html#cb136-13" aria-hidden="true" tabindex="-1"></a><span class="do">## Weibull 分布：</span></span>
<span id="cb136-14"><a href="Model-building.html#cb136-14" aria-hidden="true" tabindex="-1"></a><span class="fu">survreg</span>(<span class="fu">Surv</span>(futime, fustat) <span class="sc">~</span> ecog.ps <span class="sc">+</span> rx, ovarian, <span class="at">dist=</span><span class="st">&#39;weibull&#39;</span>,</span>
<span id="cb136-15"><a href="Model-building.html#cb136-15" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">scale=</span><span class="dv">1</span>)</span>
<span id="cb136-16"><a href="Model-building.html#cb136-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-17"><a href="Model-building.html#cb136-17" aria-hidden="true" tabindex="-1"></a><span class="do">## exponential指数分布：</span></span>
<span id="cb136-18"><a href="Model-building.html#cb136-18" aria-hidden="true" tabindex="-1"></a><span class="fu">survreg</span>(<span class="fu">Surv</span>(futime, fustat) <span class="sc">~</span> ecog.ps <span class="sc">+</span> rx, ovarian,</span>
<span id="cb136-19"><a href="Model-building.html#cb136-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">dist=</span><span class="st">&quot;exponential&quot;</span>)</span>
<span id="cb136-20"><a href="Model-building.html#cb136-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-21"><a href="Model-building.html#cb136-21" aria-hidden="true" tabindex="-1"></a><span class="do">## Gompertz 分布：</span></span>
<span id="cb136-22"><a href="Model-building.html#cb136-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 这里是参数化的cox回归类型，需要注意AFT中的Gompertz还需要后向参数：</span></span>
<span id="cb136-23"><a href="Model-building.html#cb136-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(eha)</span>
<span id="cb136-24"><a href="Model-building.html#cb136-24" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">phreg</span>(<span class="fu">Surv</span>(enter <span class="sc">+</span> <span class="dv">40</span>, exit <span class="sc">+</span> <span class="dv">40</span>, event) <span class="sc">~</span> <span class="fu">I</span>(birthdate <span class="sc">-</span> <span class="dv">1810</span>) <span class="sc">+</span> <span class="fu">strata</span>(ses), <span class="at">data =</span> mort, <span class="at">dist =</span> <span class="st">&quot;gompertz&quot;</span>)</span>
<span id="cb136-25"><a href="Model-building.html#cb136-25" aria-hidden="true" tabindex="-1"></a>             </span>
<span id="cb136-26"><a href="Model-building.html#cb136-26" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit, <span class="at">fn =</span> <span class="st">&quot;haz&quot;</span>, <span class="at">col =</span> <span class="fu">c</span>(<span class="st">&quot;red&quot;</span>, <span class="st">&quot;blue&quot;</span>), </span>
<span id="cb136-27"><a href="Model-building.html#cb136-27" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">&quot;Male mortality by social class&quot;</span>, </span>
<span id="cb136-28"><a href="Model-building.html#cb136-28" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">&quot;Gompertz hazard&quot;</span>, <span class="at">xlab =</span> <span class="st">&quot;Age&quot;</span>)</span></code></pre></div>
</div>
<div id="协变量分层cox回归" class="section level5 hasAnchor" number="4.3.2.4.2">
<h5><span class="header-section-number">4.3.2.4.2</span> 协变量分层cox回归：<a href="Model-building.html#协变量分层cox回归" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb137"><pre class="sourceCode e"><code class="sourceCode eiffel"><span id="cb137-1"><a href="Model-building.html#cb137-1" aria-hidden="true" tabindex="-1"></a>如果某个分类性质的混杂因素不满足风险比例假定，可以考虑分层分析。分层分析一般用于混杂因素比较少的情况，且进行分层的变量须是分类变量（分层实际上就是按分层变量的各个水平分为不同的层），每一层内仍然要求保持比例风险假定。</span>
<span id="cb137-2"><a href="Model-building.html#cb137-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-3"><a href="Model-building.html#cb137-3" aria-hidden="true" tabindex="-1"></a>也就是要求在进行分层分析时，允许基线风险率在分层因素的各个层上完全不同，但其他因素的相对危险度RR在各个时点及层内保持不变。由于无法估计基线风险函数，进行分层的变量对生存结局的影响强度就无法分析，也就无法获得分层因素的统计学检验，因此分层因素只适合用于控制混杂。</span>
<span id="cb137-4"><a href="Model-building.html#cb137-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-5"><a href="Model-building.html#cb137-5" aria-hidden="true" tabindex="-1"></a>直接将混杂因素进行多因素回归分析也可以控制混杂，不同的是这种在Cox回归模型中，要求基线风险率在混在因素不同的水平间是一样的，其他因素的相对危险度RR在混杂因素的各个水平中保持一致：</span>
<span id="cb137-6"><a href="Model-building.html#cb137-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-7"><a href="Model-building.html#cb137-7" aria-hidden="true" tabindex="-1"></a>在某些情况下，我们在数据中存在固有的异质性（例如，多中心试验），或者我们有一个不满足比例风险假设的分类变量，我们可以使用分层。为了拟合分层 Cox 模型，我们在使用strata()函数的模型公式中包含分层因子。</span>
<span id="cb137-8"><a href="Model-building.html#cb137-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-9"><a href="Model-building.html#cb137-9" aria-hidden="true" tabindex="-1"></a>## 两种形式：</span>
<span id="cb137-10"><a href="Model-building.html#cb137-10" aria-hidden="true" tabindex="-1"></a>## 形式（1）：直接生成每个风险模型具有不同的基线风险sex;</span>
<span id="cb137-11"><a href="Model-building.html#cb137-11" aria-hidden="true" tabindex="-1"></a>fit &lt;- coxph(Surv(years, status2) ~ age + drug + log(serBilir) + strata(sex), data = pbc2.id)</span>
<span id="cb137-12"><a href="Model-building.html#cb137-12" aria-hidden="true" tabindex="-1"></a>             </span>
<span id="cb137-13"><a href="Model-building.html#cb137-13" aria-hidden="true" tabindex="-1"></a>## 形式（2）：</span>
<span id="cb137-14"><a href="Model-building.html#cb137-14" aria-hidden="true" tabindex="-1"></a>如果希望获得分层和其他协变量之间的交互：</span>
<span id="cb137-15"><a href="Model-building.html#cb137-15" aria-hidden="true" tabindex="-1"></a>fit_int &lt;- coxph(Surv(years, status2) ~ age * strata(sex) + drug + log(serBilir), data = pbc2.id)</span>
<span id="cb137-16"><a href="Model-building.html#cb137-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-17"><a href="Model-building.html#cb137-17" aria-hidden="true" tabindex="-1"></a>## 可视化：</span>
<span id="cb137-18"><a href="Model-building.html#cb137-18" aria-hidden="true" tabindex="-1"></a># 需要使用expand.grid生成分组后的扩展数据集：</span>
<span id="cb137-19"><a href="Model-building.html#cb137-19" aria-hidden="true" tabindex="-1"></a>ND &lt;- with(pbc2.id, expand.grid(</span>
<span id="cb137-20"><a href="Model-building.html#cb137-20" aria-hidden="true" tabindex="-1"></a>    age = <span class="dv">60</span>, </span>
<span id="cb137-21"><a href="Model-building.html#cb137-21" aria-hidden="true" tabindex="-1"></a>    drug = factor(<span class="st">&quot;placebo&quot;</span>, levels = levels(drug)),</span>
<span id="cb137-22"><a href="Model-building.html#cb137-22" aria-hidden="true" tabindex="-1"></a>    serBilir = <span class="dv">15</span>,</span>
<span id="cb137-23"><a href="Model-building.html#cb137-23" aria-hidden="true" tabindex="-1"></a>    sex = factor(<span class="st">&quot;male&quot;</span>, levels = levels(sex))))</span>
<span id="cb137-24"><a href="Model-building.html#cb137-24" aria-hidden="true" tabindex="-1"></a>sfit &lt;- survfit(fit_int, newdata = ND)</span>
<span id="cb137-25"><a href="Model-building.html#cb137-25" aria-hidden="true" tabindex="-1"></a>plot(sfit, col = c(<span class="st">&quot;black&quot;</span>, <span class="st">&quot;red&quot;</span>))</span>
<span id="cb137-26"><a href="Model-building.html#cb137-26" aria-hidden="true" tabindex="-1"></a>legend(<span class="st">&quot;topright&quot;</span>, levels(pbc2.id$sex), lty = <span class="dv">1</span>, lwd = <span class="dv">2</span>, col = c(<span class="st">&quot;black&quot;</span>, <span class="st">&quot;red&quot;</span>), bty = <span class="st">&quot;n&quot;</span>)     </span>
<span id="cb137-27"><a href="Model-building.html#cb137-27" aria-hidden="true" tabindex="-1"></a>       </span></code></pre></div>
</div>
<div id="集群cox回归" class="section level5 hasAnchor" number="4.3.2.4.3">
<h5><span class="header-section-number">4.3.2.4.3</span> 集群cox回归<a href="Model-building.html#集群cox回归" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb138-1"><a href="Model-building.html#cb138-1" aria-hidden="true" tabindex="-1"></a>当分层cox回归的每个中心条件下都有相对充足的人群数据时，使用分层cox回归是合适的。但是当分层后人群数不够，则需要处理集群数据来合理外推：</span>
<span id="cb138-2"><a href="Model-building.html#cb138-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-3"><a href="Model-building.html#cb138-3" aria-hidden="true" tabindex="-1"></a><span class="do">## 第一种方法：跨集群合并：</span></span>
<span id="cb138-4"><a href="Model-building.html#cb138-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用cluster()方法：</span></span>
<span id="cb138-5"><a href="Model-building.html#cb138-5" aria-hidden="true" tabindex="-1"></a>例如，在多中心试验中，我们想要估计跨中心的合并治疗效果。为了考虑 Cox 模型中的聚类并获得合并效应，我们使用分组折刀方差估计调整结果估计的标准误差。这是我们使用函数时自动实现的<span class="fu">cluster</span>(). </span>
<span id="cb138-6"><a href="Model-building.html#cb138-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-7"><a href="Model-building.html#cb138-7" aria-hidden="true" tabindex="-1"></a>marginal_model <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> age <span class="sc">+</span> <span class="fu">cluster</span>(inst), <span class="at">data =</span> lung)</span>
<span id="cb138-8"><a href="Model-building.html#cb138-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-9"><a href="Model-building.html#cb138-9" aria-hidden="true" tabindex="-1"></a><span class="co"># summary(marginal_model)</span></span>
<span id="cb138-10"><a href="Model-building.html#cb138-10" aria-hidden="true" tabindex="-1"></a>在p值检验中的z<span class="sc">-</span>score似然估计中的会输出一个robust结果错误矫正以及返回的p值；</span>
<span id="cb138-11"><a href="Model-building.html#cb138-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-12"><a href="Model-building.html#cb138-12" aria-hidden="true" tabindex="-1"></a><span class="do">## 第二种方法：观测集群数据的异质性：</span></span>
<span id="cb138-13"><a href="Model-building.html#cb138-13" aria-hidden="true" tabindex="-1"></a>在这种方法中，我们假设集群内的所有成员共享一个未观察到的变量。由于这个变量的共享产生了相关性。</span>
<span id="cb138-14"><a href="Model-building.html#cb138-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用frailty()</span></span>
<span id="cb138-15"><a href="Model-building.html#cb138-15" aria-hidden="true" tabindex="-1"></a>frailty_model <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> age <span class="sc">+</span> <span class="fu">frailty</span>(inst), </span>
<span id="cb138-16"><a href="Model-building.html#cb138-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> lung)</span>
<span id="cb138-17"><a href="Model-building.html#cb138-17" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(frailty_model)</span></code></pre></div>
</div>
<div id="加速失效时间模型aft" class="section level5 hasAnchor" number="4.3.2.4.4">
<h5><span class="header-section-number">4.3.2.4.4</span> 加速失效时间模型（AFT）<a href="Model-building.html#加速失效时间模型aft" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="figure">
<img src="image/04/image-20220905143823100.png" alt="" />
<p class="caption">image-20220905143823100.png</p>
</div>
<div id="模型假设检验" class="section level6 hasAnchor" number="4.3.2.4.4.1">
<h6><span class="header-section-number">4.3.2.4.4.1</span> 2.4.4.1 模型假设检验<a href="Model-building.html#模型假设检验" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="Model-building.html#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 在加速失效时间回归模型中，评估协变量对生存时间对数的影响。在这种情况下获得的模型包括广义 gamma、Log-logistic、Log-normal、威布尔和指数。</span></span>
<span id="cb139-2"><a href="Model-building.html#cb139-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-3"><a href="Model-building.html#cb139-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用替代的时间加速模型的原因：</span></span>
<span id="cb139-4"><a href="Model-building.html#cb139-4" aria-hidden="true" tabindex="-1"></a>比例风险模型不需要考虑生存时间的特定概率分布；因此，它是分析生存数据最有用的模型。但是模型的效率严重依赖于比例风险假设，因此，Cox 模型通常被称为比例风险模型。在比例风险模型不可接受的情况下，从 Cox 模型得出的估计值将导致模型拟合不当和推论不正确 ( <span class="dv">16</span> – <span class="dv">22</span> )。在这种情况下，加速故障时间模型尤其重要。这些模型——由于具有生存时间的参数分布——使统计推断更加准确，并导致模型的正确拟合</span></code></pre></div>
</div>
<div id="模型拟合" class="section level6 hasAnchor" number="4.3.2.4.4.2">
<h6><span class="header-section-number">4.3.2.4.4.2</span> 2.4.4.2 模型拟合<a href="Model-building.html#模型拟合" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb140-1"><a href="Model-building.html#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 方法来自survivel：最常用为对数正态和逻辑正态：</span></span>
<span id="cb140-2"><a href="Model-building.html#cb140-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 也支持gamma、指数和威布尔分布；</span></span>
<span id="cb140-3"><a href="Model-building.html#cb140-3" aria-hidden="true" tabindex="-1"></a>fit_lnorm <span class="ot">&lt;-</span> <span class="fu">survreg</span>(<span class="fu">Surv</span>(years, status2) <span class="sc">~</span> drug <span class="sc">+</span> sex <span class="sc">+</span> age, <span class="at">data =</span> pbc2.id,<span class="at">dist =</span> <span class="st">&quot;lognormal&quot;</span>)</span>
<span id="cb140-4"><a href="Model-building.html#cb140-4" aria-hidden="true" tabindex="-1"></a>                   </span>
<span id="cb140-5"><a href="Model-building.html#cb140-5" aria-hidden="true" tabindex="-1"></a>fit_llogis <span class="ot">&lt;-</span> <span class="fu">survreg</span>(<span class="fu">Surv</span>(years, status2) <span class="sc">~</span> drug <span class="sc">+</span> sex <span class="sc">+</span> age, <span class="at">data =</span> pbc2.id,<span class="at">dist =</span> <span class="st">&quot;loglogistic&quot;</span>)</span>
<span id="cb140-6"><a href="Model-building.html#cb140-6" aria-hidden="true" tabindex="-1"></a>                   </span>
<span id="cb140-7"><a href="Model-building.html#cb140-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit_llogis)</span>
<span id="cb140-8"><a href="Model-building.html#cb140-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-9"><a href="Model-building.html#cb140-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 使用方法来自：eha包：</span></span>
<span id="cb140-10"><a href="Model-building.html#cb140-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(eha)</span>
<span id="cb140-11"><a href="Model-building.html#cb140-11" aria-hidden="true" tabindex="-1"></a>fit.gaft <span class="ot">&lt;-</span> <span class="fu">aftreg</span>(<span class="fu">Surv</span>(enter <span class="sc">-</span> <span class="dv">60</span>, exit <span class="sc">-</span> <span class="dv">60</span>, event) <span class="sc">~</span> sex <span class="sc">+</span> region, </span>
<span id="cb140-12"><a href="Model-building.html#cb140-12" aria-hidden="true" tabindex="-1"></a>                   <span class="at">id =</span> id, <span class="at">param =</span> <span class="st">&quot;lifeExp&quot;</span>, <span class="at">dist =</span> <span class="st">&quot;gompertz&quot;</span>, </span>
<span id="cb140-13"><a href="Model-building.html#cb140-13" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> oldmort)</span>
<span id="cb140-14"><a href="Model-building.html#cb140-14" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit.gaft)</span></code></pre></div>
</div>
<div id="交互项检查效果图" class="section level6 hasAnchor" number="4.3.2.4.4.3">
<h6><span class="header-section-number">4.3.2.4.4.3</span> 2.4.4.3 交互项检查效果图<a href="Model-building.html#交互项检查效果图" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<pre><code>## 参见：
https://www.drizopoulos.com/courses/emc/survival%20analysis%20in%20r%20companion</code></pre>
</div>
<div id="复杂与简单模型的交互检验" class="section level6 hasAnchor" number="4.3.2.4.4.4">
<h6><span class="header-section-number">4.3.2.4.4.4</span> 2.5.4 复杂与简单模型的交互检验<a href="Model-building.html#复杂与简单模型的交互检验" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<pre><code>fit_alt &lt;- survreg(Surv(years, status2) ~ (drug + sex) * (age + I(age^2)), data = pbc2.id)

fit_null &lt;- survreg(Surv(years, status2) ~ drug + sex + age, data = pbc2.id)

anova(fit_null, fit_alt)</code></pre>
</div>
<div id="残差分析-模型拟合效果检验" class="section level6 hasAnchor" number="4.3.2.4.4.5">
<h6><span class="header-section-number">4.3.2.4.4.5</span> 2.4.4.5 残差分析-模型拟合效果检验<a href="Model-building.html#残差分析-模型拟合效果检验" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb143-1"><a href="Model-building.html#cb143-1" aria-hidden="true" tabindex="-1"></a>fit_weib <span class="ot">&lt;-</span> <span class="fu">survreg</span>(<span class="fu">Surv</span>(Time, death) <span class="sc">~</span> drug <span class="sc">*</span> gender, <span class="at">data =</span> aids.id)</span>
<span id="cb143-2"><a href="Model-building.html#cb143-2" aria-hidden="true" tabindex="-1"></a>fitted_values <span class="ot">&lt;-</span> fit_weib<span class="sc">$</span>linear.predictors</span>
<span id="cb143-3"><a href="Model-building.html#cb143-3" aria-hidden="true" tabindex="-1"></a>resids <span class="ot">&lt;-</span> (<span class="fu">log</span>(fit_weib<span class="sc">$</span>y[, <span class="dv">1</span>]) <span class="sc">-</span> fitted_values) <span class="sc">/</span> fit_weib<span class="sc">$</span>scale</span>
<span id="cb143-4"><a href="Model-building.html#cb143-4" aria-hidden="true" tabindex="-1"></a>resKM <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(resids, death) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> aids.id)</span>
<span id="cb143-5"><a href="Model-building.html#cb143-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(resKM, <span class="at">mark.time =</span> <span class="cn">FALSE</span>, <span class="at">xlab =</span> <span class="st">&quot;AFT Residuals&quot;</span>, <span class="at">ylab =</span> <span class="st">&quot;Survival Probability&quot;</span>)</span>
<span id="cb143-6"><a href="Model-building.html#cb143-6" aria-hidden="true" tabindex="-1"></a>xx <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(resids), <span class="fu">max</span>(resids), <span class="at">length.out =</span> <span class="dv">35</span>)</span>
<span id="cb143-7"><a href="Model-building.html#cb143-7" aria-hidden="true" tabindex="-1"></a>yy <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span> <span class="fu">exp</span>(xx))</span>
<span id="cb143-8"><a href="Model-building.html#cb143-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(xx, yy, <span class="at">col =</span> <span class="st">&quot;red&quot;</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb143-9"><a href="Model-building.html#cb143-9" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&quot;bottomleft&quot;</span>, <span class="fu">c</span>(<span class="st">&quot;KM estimate&quot;</span>, <span class="st">&quot;95% CI KM estimate&quot;</span>, </span>
<span id="cb143-10"><a href="Model-building.html#cb143-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Survival function of Extreme Value distribution&quot;</span>), </span>
<span id="cb143-11"><a href="Model-building.html#cb143-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">lty =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>), <span class="at">col =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>), <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span></code></pre></div>
</div>
</div>
<div id="finalfit批运行cox回归" class="section level5 hasAnchor" number="4.3.2.4.5">
<h5><span class="header-section-number">4.3.2.4.5</span> finalfit批运行cox回归<a href="Model-building.html#finalfit批运行cox回归" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div id="cox回归-1" class="section level6 hasAnchor" number="4.3.2.4.5.1">
<h6><span class="header-section-number">4.3.2.4.5.1</span> 2.4.5.1 COX回归<a href="Model-building.html#cox回归-1" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb144-1"><a href="Model-building.html#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages(&quot;finalfit&quot;)</span></span>
<span id="cb144-2"><a href="Model-building.html#cb144-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(finalfit)</span>
<span id="cb144-3"><a href="Model-building.html#cb144-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb144-4"><a href="Model-building.html#cb144-4" aria-hidden="true" tabindex="-1"></a>melanoma <span class="ot">&lt;-</span> boot<span class="sc">::</span>melanoma </span>
<span id="cb144-5"><a href="Model-building.html#cb144-5" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(melanoma)</span>
<span id="cb144-6"><a href="Model-building.html#cb144-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-7"><a href="Model-building.html#cb144-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 构造可读参数模型：</span></span>
<span id="cb144-8"><a href="Model-building.html#cb144-8" aria-hidden="true" tabindex="-1"></a>dependent_os  <span class="ot">&lt;-</span> <span class="st">&quot;Surv(time, status)&quot;</span></span>
<span id="cb144-9"><a href="Model-building.html#cb144-9" aria-hidden="true" tabindex="-1"></a>explanatory   <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;age&quot;</span>, <span class="st">&quot;sex&quot;</span>, <span class="st">&quot;thickness&quot;</span>, <span class="st">&quot;ulcer&quot;</span>)</span>
<span id="cb144-10"><a href="Model-building.html#cb144-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-11"><a href="Model-building.html#cb144-11" aria-hidden="true" tabindex="-1"></a><span class="do">## 单次运行模型：</span></span>
<span id="cb144-12"><a href="Model-building.html#cb144-12" aria-hidden="true" tabindex="-1"></a>melanoma <span class="sc">%&gt;%</span> </span>
<span id="cb144-13"><a href="Model-building.html#cb144-13" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 输出每个参数变量的单变量HR和多变量HR;</span></span>
<span id="cb144-14"><a href="Model-building.html#cb144-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalfit</span>(dependent_os, explanatory)</span>
<span id="cb144-15"><a href="Model-building.html#cb144-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-16"><a href="Model-building.html#cb144-16" aria-hidden="true" tabindex="-1"></a><span class="do">## 标签调整：</span></span>
<span id="cb144-17"><a href="Model-building.html#cb144-17" aria-hidden="true" tabindex="-1"></a>melanoma <span class="sc">%&gt;%</span> </span>
<span id="cb144-18"><a href="Model-building.html#cb144-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalfit</span>(dependent_os, explanatory, <span class="at">add_dependent_label =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb144-19"><a href="Model-building.html#cb144-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="st">&quot;Overall survival&quot;</span> <span class="ot">=</span> label) <span class="sc">%&gt;%</span> </span>
<span id="cb144-20"><a href="Model-building.html#cb144-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="st">&quot; &quot;</span> <span class="ot">=</span> levels) <span class="sc">%&gt;%</span> </span>
<span id="cb144-21"><a href="Model-building.html#cb144-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="st">&quot;  &quot;</span> <span class="ot">=</span> all)</span>
<span id="cb144-22"><a href="Model-building.html#cb144-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-23"><a href="Model-building.html#cb144-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-24"><a href="Model-building.html#cb144-24" aria-hidden="true" tabindex="-1"></a><span class="do">## 指定变量(基于条件筛选后，直接输出指定变量的多变量HR和p值)：</span></span>
<span id="cb144-25"><a href="Model-building.html#cb144-25" aria-hidden="true" tabindex="-1"></a>explanatory_multi <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;age&quot;</span>, <span class="st">&quot;thickness&quot;</span>, <span class="st">&quot;ulcer&quot;</span>)</span>
<span id="cb144-26"><a href="Model-building.html#cb144-26" aria-hidden="true" tabindex="-1"></a>melanoma <span class="sc">%&gt;%</span> </span>
<span id="cb144-27"><a href="Model-building.html#cb144-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalfit</span>(dependent_os, explanatory, </span>
<span id="cb144-28"><a href="Model-building.html#cb144-28" aria-hidden="true" tabindex="-1"></a>           <span class="do">## explanatory_multi指定保留的变量（为变量筛选后）</span></span>
<span id="cb144-29"><a href="Model-building.html#cb144-29" aria-hidden="true" tabindex="-1"></a>           explanatory_multi, <span class="at">keep_models =</span> <span class="cn">TRUE</span>)</span>
<span id="cb144-30"><a href="Model-building.html#cb144-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-31"><a href="Model-building.html#cb144-31" aria-hidden="true" tabindex="-1"></a><span class="do">## 变量的PH检验：</span></span>
<span id="cb144-32"><a href="Model-building.html#cb144-32" aria-hidden="true" tabindex="-1"></a>explanatory <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;age&quot;</span>, <span class="st">&quot;sex&quot;</span>, <span class="st">&quot;thickness&quot;</span>, <span class="st">&quot;ulcer&quot;</span>, <span class="st">&quot;year&quot;</span>)</span>
<span id="cb144-33"><a href="Model-building.html#cb144-33" aria-hidden="true" tabindex="-1"></a>melanoma <span class="sc">%&gt;%</span> </span>
<span id="cb144-34"><a href="Model-building.html#cb144-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coxphmulti</span>(dependent_os, explanatory) <span class="sc">%&gt;%</span> </span>
<span id="cb144-35"><a href="Model-building.html#cb144-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cox.zph</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb144-36"><a href="Model-building.html#cb144-36" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 内部函数进行全局参数赋值：</span></span>
<span id="cb144-37"><a href="Model-building.html#cb144-37" aria-hidden="true" tabindex="-1"></a>  {zph_result <span class="ot">&lt;&lt;-</span> .} <span class="sc">%&gt;%</span> </span>
<span id="cb144-38"><a href="Model-building.html#cb144-38" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 输出cox.zph()函数运行结果：</span></span>
<span id="cb144-39"><a href="Model-building.html#cb144-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="at">var=</span><span class="dv">2</span>)</span>
<span id="cb144-40"><a href="Model-building.html#cb144-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-41"><a href="Model-building.html#cb144-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-42"><a href="Model-building.html#cb144-42" aria-hidden="true" tabindex="-1"></a><span class="do">## 分层cox回归模型实现：</span></span>
<span id="cb144-43"><a href="Model-building.html#cb144-43" aria-hidden="true" tabindex="-1"></a>explanatory <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;age&quot;</span>, <span class="st">&quot;sex&quot;</span>, <span class="st">&quot;ulcer&quot;</span>, <span class="st">&quot;thickness&quot;</span>, </span>
<span id="cb144-44"><a href="Model-building.html#cb144-44" aria-hidden="true" tabindex="-1"></a>                 <span class="st">&quot;strata(year)&quot;</span>)</span>
<span id="cb144-45"><a href="Model-building.html#cb144-45" aria-hidden="true" tabindex="-1"></a>melanoma <span class="sc">%&gt;%</span> </span>
<span id="cb144-46"><a href="Model-building.html#cb144-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalfit</span>(dependent_os, explanatory)</span>
<span id="cb144-47"><a href="Model-building.html#cb144-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-48"><a href="Model-building.html#cb144-48" aria-hidden="true" tabindex="-1"></a><span class="do">## 使用cluster和frailty聚类分析：</span></span>
<span id="cb144-49"><a href="Model-building.html#cb144-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate random hospital identifier</span></span>
<span id="cb144-50"><a href="Model-building.html#cb144-50" aria-hidden="true" tabindex="-1"></a>melanoma <span class="ot">&lt;-</span> melanoma <span class="sc">%&gt;%</span> </span>
<span id="cb144-51"><a href="Model-building.html#cb144-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hospital_id =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">20</span>), <span class="fu">rep</span>(<span class="dv">11</span>, <span class="dv">5</span>)))</span>
<span id="cb144-52"><a href="Model-building.html#cb144-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-53"><a href="Model-building.html#cb144-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Cluster model</span></span>
<span id="cb144-54"><a href="Model-building.html#cb144-54" aria-hidden="true" tabindex="-1"></a>explanatory <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;age&quot;</span>, <span class="st">&quot;sex&quot;</span>, <span class="st">&quot;thickness&quot;</span>, <span class="st">&quot;ulcer&quot;</span>, </span>
<span id="cb144-55"><a href="Model-building.html#cb144-55" aria-hidden="true" tabindex="-1"></a>                 <span class="st">&quot;cluster(hospital_id)&quot;</span>)</span>
<span id="cb144-56"><a href="Model-building.html#cb144-56" aria-hidden="true" tabindex="-1"></a>melanoma <span class="sc">%&gt;%</span> </span>
<span id="cb144-57"><a href="Model-building.html#cb144-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalfit</span>(dependent_os, explanatory)</span>
<span id="cb144-58"><a href="Model-building.html#cb144-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-59"><a href="Model-building.html#cb144-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Frailty model</span></span>
<span id="cb144-60"><a href="Model-building.html#cb144-60" aria-hidden="true" tabindex="-1"></a>explanatory <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;age&quot;</span>, <span class="st">&quot;sex&quot;</span>, <span class="st">&quot;thickness&quot;</span>, <span class="st">&quot;ulcer&quot;</span>, </span>
<span id="cb144-61"><a href="Model-building.html#cb144-61" aria-hidden="true" tabindex="-1"></a>                 <span class="st">&quot;frailty(hospital_id)&quot;</span>)</span>
<span id="cb144-62"><a href="Model-building.html#cb144-62" aria-hidden="true" tabindex="-1"></a>melanoma <span class="sc">%&gt;%</span> </span>
<span id="cb144-63"><a href="Model-building.html#cb144-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalfit</span>(dependent_os, explanatory)</span>
<span id="cb144-64"><a href="Model-building.html#cb144-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-65"><a href="Model-building.html#cb144-65" aria-hidden="true" tabindex="-1"></a><span class="do">## 风险比例森林图：</span></span>
<span id="cb144-66"><a href="Model-building.html#cb144-66" aria-hidden="true" tabindex="-1"></a>melanoma <span class="sc">%&gt;%</span> </span>
<span id="cb144-67"><a href="Model-building.html#cb144-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hr_plot</span>(dependent_os, explanatory)</span>
<span id="cb144-68"><a href="Model-building.html#cb144-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-69"><a href="Model-building.html#cb144-69" aria-hidden="true" tabindex="-1"></a><span class="do">## 补充：</span></span>
<span id="cb144-70"><a href="Model-building.html#cb144-70" aria-hidden="true" tabindex="-1"></a>explanatory <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;age.factor&quot;</span>, <span class="st">&quot;sex.factor&quot;</span>, <span class="st">&quot;obstruct.factor&quot;</span>, <span class="st">&quot;perfor.factor&quot;</span>)</span>
<span id="cb144-71"><a href="Model-building.html#cb144-71" aria-hidden="true" tabindex="-1"></a>dependent <span class="ot">=</span> <span class="st">&quot;Surv(time, status)&quot;</span></span>
<span id="cb144-72"><a href="Model-building.html#cb144-72" aria-hidden="true" tabindex="-1"></a>colon_s <span class="sc">%&gt;%</span></span>
<span id="cb144-73"><a href="Model-building.html#cb144-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coxphmulti</span>(dependent, explanatory) <span class="sc">%&gt;%</span></span>
<span id="cb144-74"><a href="Model-building.html#cb144-74" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 提取整洁的coxphmulti结果：</span></span>
<span id="cb144-75"><a href="Model-building.html#cb144-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit2df</span>()</span></code></pre></div>
</div>
<div id="竞争风险模型" class="section level6 hasAnchor" number="4.3.2.4.5.2">
<h6><span class="header-section-number">4.3.2.4.5.2</span> 2.4.5.2 竞争风险模型：<a href="Model-building.html#竞争风险模型" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="Model-building.html#cb145-1" aria-hidden="true" tabindex="-1"></a>explanatory   <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;age&quot;</span>, <span class="st">&quot;sex&quot;</span>, <span class="st">&quot;thickness&quot;</span>, <span class="st">&quot;ulcer&quot;</span>)</span>
<span id="cb145-2"><a href="Model-building.html#cb145-2" aria-hidden="true" tabindex="-1"></a>dependent_dss <span class="ot">&lt;-</span> <span class="st">&quot;Surv(time, status_dss)&quot;</span></span>
<span id="cb145-3"><a href="Model-building.html#cb145-3" aria-hidden="true" tabindex="-1"></a>dependent_crr <span class="ot">&lt;-</span> <span class="st">&quot;Surv(time, status_crr)&quot;</span></span>
<span id="cb145-4"><a href="Model-building.html#cb145-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-5"><a href="Model-building.html#cb145-5" aria-hidden="true" tabindex="-1"></a>melanoma <span class="sc">%&gt;%</span></span>
<span id="cb145-6"><a href="Model-building.html#cb145-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Summary table</span></span>
<span id="cb145-7"><a href="Model-building.html#cb145-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 这里是将分类变量进行参数化分解，保证每个列名下的变量都有独特分类用于计算</span></span>
<span id="cb145-8"><a href="Model-building.html#cb145-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">#  HR和P值；</span></span>
<span id="cb145-9"><a href="Model-building.html#cb145-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary_factorlist</span>(dependent_dss, explanatory, </span>
<span id="cb145-10"><a href="Model-building.html#cb145-10" aria-hidden="true" tabindex="-1"></a>                     <span class="at">column =</span> <span class="cn">TRUE</span>, <span class="at">fit_id =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb145-11"><a href="Model-building.html#cb145-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CPH univariable</span></span>
<span id="cb145-12"><a href="Model-building.html#cb145-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ff_merge</span>(</span>
<span id="cb145-13"><a href="Model-building.html#cb145-13" aria-hidden="true" tabindex="-1"></a>    melanoma <span class="sc">%&gt;%</span></span>
<span id="cb145-14"><a href="Model-building.html#cb145-14" aria-hidden="true" tabindex="-1"></a>      <span class="co"># 计算 每个变量的HR;    </span></span>
<span id="cb145-15"><a href="Model-building.html#cb145-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">coxphmulti</span>(dependent_dss, explanatory) <span class="sc">%&gt;%</span></span>
<span id="cb145-16"><a href="Model-building.html#cb145-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fit2df</span>(<span class="at">estimate_suffix =</span> <span class="st">&quot; (DSS CPH univariable)&quot;</span>)</span>
<span id="cb145-17"><a href="Model-building.html#cb145-17" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb145-18"><a href="Model-building.html#cb145-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CPH multivariable</span></span>
<span id="cb145-19"><a href="Model-building.html#cb145-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ff_merge</span>(</span>
<span id="cb145-20"><a href="Model-building.html#cb145-20" aria-hidden="true" tabindex="-1"></a>    melanoma <span class="sc">%&gt;%</span></span>
<span id="cb145-21"><a href="Model-building.html#cb145-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">coxphmulti</span>(dependent_dss, explanatory) <span class="sc">%&gt;%</span></span>
<span id="cb145-22"><a href="Model-building.html#cb145-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fit2df</span>(<span class="at">estimate_suffix =</span> <span class="st">&quot; (DSS CPH multivariable)&quot;</span>)</span>
<span id="cb145-23"><a href="Model-building.html#cb145-23" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb145-24"><a href="Model-building.html#cb145-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fine and Gray competing risks regression</span></span>
<span id="cb145-25"><a href="Model-building.html#cb145-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ff_merge</span>(</span>
<span id="cb145-26"><a href="Model-building.html#cb145-26" aria-hidden="true" tabindex="-1"></a>    melanoma <span class="sc">%&gt;%</span></span>
<span id="cb145-27"><a href="Model-building.html#cb145-27" aria-hidden="true" tabindex="-1"></a>      <span class="do">## 注意这种写法：提取的是竞争风险模型的参数：</span></span>
<span id="cb145-28"><a href="Model-building.html#cb145-28" aria-hidden="true" tabindex="-1"></a>      <span class="fu">crrmulti</span>(dependent_crr, explanatory) <span class="sc">%&gt;%</span></span>
<span id="cb145-29"><a href="Model-building.html#cb145-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fit2df</span>(<span class="at">estimate_suffix =</span> <span class="st">&quot; (competing risks multivariable)&quot;</span>)</span>
<span id="cb145-30"><a href="Model-building.html#cb145-30" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb145-31"><a href="Model-building.html#cb145-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>fit_id, <span class="sc">-</span>index) <span class="sc">%&gt;%</span></span>
<span id="cb145-32"><a href="Model-building.html#cb145-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dependent_label</span>(melanoma, <span class="st">&quot;Survival&quot;</span>)</span></code></pre></div>
</div>
</div>
<div id="pec包提高cox回归模型的交叉时间点验证" class="section level5 hasAnchor" number="4.3.2.4.6">
<h5><span class="header-section-number">4.3.2.4.6</span> pec包提高cox回归模型的交叉时间点验证<a href="Model-building.html#pec包提高cox回归模型的交叉时间点验证" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="Model-building.html#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;pec&quot;</span>)</span>
<span id="cb146-2"><a href="Model-building.html#cb146-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pec) <span class="do">##验证模型</span></span>
<span id="cb146-3"><a href="Model-building.html#cb146-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rms)  <span class="do">##拟合生存分析模型</span></span>
<span id="cb146-4"><a href="Model-building.html#cb146-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)  <span class="do">##生存分析包</span></span>
<span id="cb146-5"><a href="Model-building.html#cb146-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)  <span class="do">##Lasso回归包</span></span>
<span id="cb146-6"><a href="Model-building.html#cb146-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-7"><a href="Model-building.html#cb146-7" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb146-8"><a href="Model-building.html#cb146-8" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dt) <span class="sc">%&gt;%</span> <span class="fu">runif</span>()  </span>
<span id="cb146-9"><a href="Model-building.html#cb146-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 随机生成449个生成从0到1区间范围内的服从正态分布的随机数</span></span>
<span id="cb146-10"><a href="Model-building.html#cb146-10" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">transform</span>(dt,<span class="at">sample=</span> <span class="fu">order</span>(x))<span class="sc">%&gt;%</span> <span class="fu">arrange</span>(sample)</span>
<span id="cb146-11"><a href="Model-building.html#cb146-11" aria-hidden="true" tabindex="-1"></a><span class="do">###随机排列数据集样本</span></span>
<span id="cb146-12"><a href="Model-building.html#cb146-12" aria-hidden="true" tabindex="-1"></a><span class="do">###拆分数据集</span></span>
<span id="cb146-13"><a href="Model-building.html#cb146-13" aria-hidden="true" tabindex="-1"></a>train  <span class="ot">&lt;-</span> dt[<span class="dv">1</span><span class="sc">:</span>((<span class="fu">nrow</span>(dt)<span class="sc">-</span><span class="dv">1</span>)<span class="sc">/</span><span class="dv">2</span>),<span class="sc">-</span><span class="dv">45</span>]</span>
<span id="cb146-14"><a href="Model-building.html#cb146-14" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> dt[((<span class="fu">nrow</span>(dt)<span class="sc">+</span><span class="dv">1</span>)<span class="sc">/</span><span class="dv">2</span>)<span class="sc">:</span><span class="fu">nrow</span>(dt),<span class="sc">-</span><span class="dv">45</span>]</span>
<span id="cb146-15"><a href="Model-building.html#cb146-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-16"><a href="Model-building.html#cb146-16" aria-hidden="true" tabindex="-1"></a><span class="do">## 全模型：</span></span>
<span id="cb146-17"><a href="Model-building.html#cb146-17" aria-hidden="true" tabindex="-1"></a><span class="do">## 注意cph来自rms包，并对原有的coxph回归做进一步拓展：</span></span>
<span id="cb146-18"><a href="Model-building.html#cb146-18" aria-hidden="true" tabindex="-1"></a>cox1 <span class="ot">&lt;-</span> <span class="fu">cph</span>(<span class="fu">Surv</span>(live.time,outcome<span class="sc">==</span><span class="dv">1</span>)<span class="sc">~</span>.,<span class="at">x=</span>T,<span class="at">y=</span>T,<span class="at">data=</span>train, <span class="at">surv=</span><span class="cn">TRUE</span>)</span>
<span id="cb146-19"><a href="Model-building.html#cb146-19" aria-hidden="true" tabindex="-1"></a><span class="do">## cox2 筛选变量搭建的模型</span></span>
<span id="cb146-20"><a href="Model-building.html#cb146-20" aria-hidden="true" tabindex="-1"></a>cox2 <span class="ot">&lt;-</span> <span class="fu">cph</span>(<span class="fu">Surv</span>(live.time,outcome<span class="sc">==</span><span class="dv">1</span>)<span class="sc">~</span>relapse<span class="sc">+</span>BCLC<span class="sc">+</span>tumor.single.double<span class="sc">+</span>AFP,<span class="at">x=</span>T,<span class="at">y=</span>T,<span class="at">data=</span>train,<span class="at">surv=</span><span class="cn">TRUE</span>)</span>
<span id="cb146-21"><a href="Model-building.html#cb146-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-22"><a href="Model-building.html#cb146-22" aria-hidden="true" tabindex="-1"></a><span class="do">## 模型区分度对比和验证</span></span>
<span id="cb146-23"><a href="Model-building.html#cb146-23" aria-hidden="true" tabindex="-1"></a><span class="do">## eval.times 输入评价模型区分能力的时间点向量，缺少的话系统认为是最大生存时间</span></span>
<span id="cb146-24"><a href="Model-building.html#cb146-24" aria-hidden="true" tabindex="-1"></a><span class="do">## 此时相当于单个时间点评估，同之前文章中求的模型concordance</span></span>
<span id="cb146-25"><a href="Model-building.html#cb146-25" aria-hidden="true" tabindex="-1"></a><span class="do">## 这个就是优于rms的一个点，可以对每个时间点比较。</span></span>
<span id="cb146-26"><a href="Model-building.html#cb146-26" aria-hidden="true" tabindex="-1"></a><span class="do">## cindex来自pec包，专门用于时序回归模型之间的比较检验：</span></span>
<span id="cb146-27"><a href="Model-building.html#cb146-27" aria-hidden="true" tabindex="-1"></a><span class="do">## 官网定义：</span></span>
<span id="cb146-28"><a href="Model-building.html#cb146-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 该函数提供了审查一致性概率的加权估计的概率的倒数，以调整正确的审查。</span></span>
<span id="cb146-29"><a href="Model-building.html#cb146-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 基于自举重采样或自举二次抽样的交叉验证可用于评估和</span></span>
<span id="cb146-30"><a href="Model-building.html#cb146-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 比较各种回归建模策略对同一组数据的判别能力。</span></span>
<span id="cb146-31"><a href="Model-building.html#cb146-31" aria-hidden="true" tabindex="-1"></a>c_index  <span class="ot">&lt;-</span> <span class="fu">cindex</span>(<span class="fu">list</span>(<span class="st">&quot;Cox(43 variables)&quot;</span><span class="ot">=</span>cox1, <span class="st">&quot;Cox(4 variables)&quot;</span><span class="ot">=</span>cox2),</span>
<span id="cb146-32"><a href="Model-building.html#cb146-32" aria-hidden="true" tabindex="-1"></a>                   <span class="at">formula=</span><span class="fu">Surv</span>(live.time,outcome<span class="sc">==</span><span class="dv">1</span>)<span class="sc">~</span>.,</span>
<span id="cb146-33"><a href="Model-building.html#cb146-33" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data=</span>test,</span>
<span id="cb146-34"><a href="Model-building.html#cb146-34" aria-hidden="true" tabindex="-1"></a>                   <span class="at">eval.times=</span><span class="fu">seq</span>(<span class="dv">365</span>,<span class="dv">5</span><span class="sc">*</span><span class="dv">365</span>,<span class="fl">36.5</span>))</span>
<span id="cb146-35"><a href="Model-building.html#cb146-35" aria-hidden="true" tabindex="-1"></a><span class="do">## 设置画图参数</span></span>
<span id="cb146-36"><a href="Model-building.html#cb146-36" aria-hidden="true" tabindex="-1"></a><span class="do">##mar 以数值向量表示的边界大小，顺序为“下、左、上、右”，单位为英分*。</span></span>
<span id="cb146-37"><a href="Model-building.html#cb146-37" aria-hidden="true" tabindex="-1"></a><span class="do">##默认值为c(5, 4, 4, 2) + 0.1</span></span>
<span id="cb146-38"><a href="Model-building.html#cb146-38" aria-hidden="true" tabindex="-1"></a><span class="do">##mgp 设定标题、坐标轴名称、坐标轴距图形边框的距离。默认值为c(3,1,0)，</span></span>
<span id="cb146-39"><a href="Model-building.html#cb146-39" aria-hidden="true" tabindex="-1"></a><span class="do">##其中第一个值影响的是标题</span></span>
<span id="cb146-40"><a href="Model-building.html#cb146-40" aria-hidden="true" tabindex="-1"></a><span class="do">## cex.axis 坐标轴刻度放大倍数</span></span>
<span id="cb146-41"><a href="Model-building.html#cb146-41" aria-hidden="true" tabindex="-1"></a><span class="do">## cex.main 标题的放大倍数</span></span>
<span id="cb146-42"><a href="Model-building.html#cb146-42" aria-hidden="true" tabindex="-1"></a><span class="do">## legend.x，legend.y 图例位置的横坐标和纵坐标</span></span>
<span id="cb146-43"><a href="Model-building.html#cb146-43" aria-hidden="true" tabindex="-1"></a><span class="do">## legend.cex 图例文字大小</span></span>
<span id="cb146-44"><a href="Model-building.html#cb146-44" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mgp=</span><span class="fu">c</span>(<span class="fl">3.1</span>,<span class="fl">0.8</span>,<span class="dv">0</span>),<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">5</span>,<span class="dv">3</span>,<span class="dv">1</span>),<span class="at">cex.axis=</span><span class="fl">0.8</span>,<span class="at">cex.main=</span><span class="fl">0.8</span>)</span>
<span id="cb146-45"><a href="Model-building.html#cb146-45" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(c_index,<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">2000</span>),<span class="at">legend.x=</span><span class="dv">1</span>,<span class="at">legend.y=</span><span class="dv">1</span>,<span class="at">legend.cex=</span><span class="fl">0.8</span>)</span>
<span id="cb146-46"><a href="Model-building.html#cb146-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-47"><a href="Model-building.html#cb146-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-48"><a href="Model-building.html#cb146-48" aria-hidden="true" tabindex="-1"></a><span class="do">## 采用bootstrap重抽样法进行交叉验证，提高结果稳定性。</span></span>
<span id="cb146-49"><a href="Model-building.html#cb146-49" aria-hidden="true" tabindex="-1"></a><span class="do">## calPlot也来自pec包：</span></span>
<span id="cb146-50"><a href="Model-building.html#cb146-50" aria-hidden="true" tabindex="-1"></a>calPolt2 <span class="ot">&lt;-</span> <span class="fu">calPlot</span>(<span class="fu">list</span>(<span class="st">&quot;Cox(43 variables)&quot;</span><span class="ot">=</span>cox1,</span>
<span id="cb146-51"><a href="Model-building.html#cb146-51" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;Cox(4 variables)&quot;</span><span class="ot">=</span>cox2),</span>
<span id="cb146-52"><a href="Model-building.html#cb146-52" aria-hidden="true" tabindex="-1"></a>                    <span class="at">time=</span><span class="dv">3</span><span class="sc">*</span><span class="dv">365</span>,<span class="co">#设置想要观察的时间点</span></span>
<span id="cb146-53"><a href="Model-building.html#cb146-53" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data=</span>test,<span class="at">legend.x=</span><span class="fl">0.5</span>,</span>
<span id="cb146-54"><a href="Model-building.html#cb146-54" aria-hidden="true" tabindex="-1"></a>                    <span class="at">legend.y=</span><span class="fl">0.3</span>,<span class="at">legend.cex=</span><span class="fl">0.8</span>,</span>
<span id="cb146-55"><a href="Model-building.html#cb146-55" aria-hidden="true" tabindex="-1"></a>                    <span class="at">splitMethod =</span> <span class="st">&quot;BootCv&quot;</span>,</span>
<span id="cb146-56"><a href="Model-building.html#cb146-56" aria-hidden="true" tabindex="-1"></a>                    <span class="at">B=</span>1000）</span></code></pre></div>
</div>
</div>
</div>
<div id="补充r包" class="section level3 hasAnchor" number="4.3.3">
<h3><span class="header-section-number">4.3.3</span> 补充R包<a href="Model-building.html#补充r包" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<pre><code>## survMS R 包：生存模型模拟
## 参见：
https://github.com/mathildesautreuil/survMS


生存管理系统是一个 R 包，它从具有不同复杂程度的不同生存模型生成生存数据。包中实现了三个生存模型来模拟生存数据：Cox 模型、加速故障时间 (AFT) 模型和加速危险 (AH) 模型。这些模型有其特殊性。事实上，Cox 模型是比例风险模型，而不是 AFT 和 AH 模型。比例风险模型意味着具有不同解释变量的两个人之间的风险比不依赖于时间。在 AFT 模型中，解释变量对个体的生存有加速或减速的影响。在 Cox 模型和 AFT 模型这两个模型中，生存函数的曲线从不相交。例如，当人们对具有相交生存曲线的更复杂的数据感兴趣时，为了使方法更难预测生存，包中实现了两种方法。第一种方法包括修改 AFT 模型以具有相交的生存曲线。第二种方法涉及使用 AH 模型（对于Accelerated Hazards ) 以生成生存数据。AH模型比上面提到的两种模型更灵活。在 AH 模型中，变量加速或减速危险风险。因此，AH 模型的生存曲线可以相互交叉。从上面提到的不同模型中产生的生存时间。假设模型的基线风险函数是已知的并且遵循特定的概率分布。对于这些不同的模型，我们使用基线风险的参数分布来生成生存时间。

请注意，我们停留在没有交互的线性依赖框架中。我们将在第二步中将包调整为非线性框架以模拟交互。通过用解释变量的非线性函数替换解释变量的线性部分，该包的实现很容易适应具有交互作用的非线性框架。包中的所有函数都经过编码，以便轻松引入解释变量的这种非线性函数。</code></pre>
</div>
</div>
<div id="构造模型的辅助函数或参数" class="section level2 hasAnchor" number="4.4">
<h2><span class="header-section-number">4.4</span> 构造模型的辅助函数或参数<a href="Model-building.html#构造模型的辅助函数或参数" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="常用参数" class="section level3 hasAnchor" number="4.4.1">
<h3><span class="header-section-number">4.4.1</span> 常用参数<a href="Model-building.html#常用参数" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="Model-building.html#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 正则运算符：</span></span>
<span id="cb148-2"><a href="Model-building.html#cb148-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&amp;&amp;</span> 和 <span class="sc">||</span> 是短路运算，即遇到TRUE （FALSE）则返回TRUE（false）而不继续往下计算；</span>
<span id="cb148-3"><a href="Model-building.html#cb148-3" aria-hidden="true" tabindex="-1"></a>而<span class="sc">&amp;</span> 和 <span class="sc">|</span> 是向量运算符，对向量中所有元素分别进行运算；</span>
<span id="cb148-4"><a href="Model-building.html#cb148-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-5"><a href="Model-building.html#cb148-5" aria-hidden="true" tabindex="-1"></a><span class="do">## 数据类型知识：</span></span>
<span id="cb148-6"><a href="Model-building.html#cb148-6" aria-hidden="true" tabindex="-1"></a>R中使用NA表示缺失值，null表示空值，NaN表示非数，Inf表示无穷大；</span></code></pre></div>
</div>
<div id="查询线性模型结果" class="section level3 hasAnchor" number="4.4.2">
<h3><span class="header-section-number">4.4.2</span> 查询线性模型结果<a href="Model-building.html#查询线性模型结果" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="Model-building.html#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 函数</span></span>
<span id="cb149-2"><a href="Model-building.html#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>()</span>
<span id="cb149-3"><a href="Model-building.html#cb149-3" aria-hidden="true" tabindex="-1"></a>展示拟合模型的详细结果</span>
<span id="cb149-4"><a href="Model-building.html#cb149-4" aria-hidden="true" tabindex="-1"></a><span class="co"># coefficients</span></span>
<span id="cb149-5"><a href="Model-building.html#cb149-5" aria-hidden="true" tabindex="-1"></a>列出拟合模型的模型参数(截距项和斜率)</span>
<span id="cb149-6"><a href="Model-building.html#cb149-6" aria-hidden="true" tabindex="-1"></a><span class="co"># confine():</span></span>
<span id="cb149-7"><a href="Model-building.html#cb149-7" aria-hidden="true" tabindex="-1"></a>提供模型参数的置信区间(默认95%)</span>
<span id="cb149-8"><a href="Model-building.html#cb149-8" aria-hidden="true" tabindex="-1"></a><span class="co"># fitted()</span></span>
<span id="cb149-9"><a href="Model-building.html#cb149-9" aria-hidden="true" tabindex="-1"></a>列出拟合模型的预测值</span>
<span id="cb149-10"><a href="Model-building.html#cb149-10" aria-hidden="true" tabindex="-1"></a><span class="co"># residuals (   </span></span>
<span id="cb149-11"><a href="Model-building.html#cb149-11" aria-hidden="true" tabindex="-1"></a>列出拟合模型的残差值</span>
<span id="cb149-12"><a href="Model-building.html#cb149-12" aria-hidden="true" tabindex="-1"></a><span class="co"># anova()</span></span>
<span id="cb149-13"><a href="Model-building.html#cb149-13" aria-hidden="true" tabindex="-1"></a>生成一个拟合模型的方差分析表,或者比较两个或更多拟合模型的方差分析表</span>
<span id="cb149-14"><a href="Model-building.html#cb149-14" aria-hidden="true" tabindex="-1"></a>此外，anova还可以将模型的结果求出，解出每个协变量的截距值；    </span>
<span id="cb149-15"><a href="Model-building.html#cb149-15" aria-hidden="true" tabindex="-1"></a><span class="co"># vcov()</span></span>
<span id="cb149-16"><a href="Model-building.html#cb149-16" aria-hidden="true" tabindex="-1"></a>列出模型参数的协方差矩阵</span>
<span id="cb149-17"><a href="Model-building.html#cb149-17" aria-hidden="true" tabindex="-1"></a><span class="co"># AIC()</span></span>
<span id="cb149-18"><a href="Model-building.html#cb149-18" aria-hidden="true" tabindex="-1"></a>输出赤池信息统计量</span>
<span id="cb149-19"><a href="Model-building.html#cb149-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb149-20"><a href="Model-building.html#cb149-20" aria-hidden="true" tabindex="-1"></a><span class="do">## 另外一种方法是使用questionr包中的odds.ratio函数。</span></span>
<span id="cb149-21"><a href="Model-building.html#cb149-21" aria-hidden="true" tabindex="-1"></a><span class="do">## 计算模型回归后拟合的p、OR和95%CI值等；    </span></span>
<span id="cb149-22"><a href="Model-building.html#cb149-22" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">odds.ratio</span>(fit),<span class="dv">2</span>)</span>
<span id="cb149-23"><a href="Model-building.html#cb149-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb149-24"><a href="Model-building.html#cb149-24" aria-hidden="true" tabindex="-1"></a><span class="do">## 提取模型输出结果：</span></span>
<span id="cb149-25"><a href="Model-building.html#cb149-25" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(step.model)</span>
<span id="cb149-26"><a href="Model-building.html#cb149-26" aria-hidden="true" tabindex="-1"></a><span class="do">## 结合逐步回归给出的变量参考建议：</span></span>
<span id="cb149-27"><a href="Model-building.html#cb149-27" aria-hidden="true" tabindex="-1"></a><span class="fu">drop1</span>(step.model)</span>
<span id="cb149-28"><a href="Model-building.html#cb149-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-29"><a href="Model-building.html#cb149-29" aria-hidden="true" tabindex="-1"></a><span class="do">## 可视化交互效应模型变量间的强弱关系：</span></span>
<span id="cb149-30"><a href="Model-building.html#cb149-30" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(effects)</span>
<span id="cb149-31"><a href="Model-building.html#cb149-31" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">effect</span>(<span class="st">&#39;prey_num*temperature&#39;</span>, fit2), <span class="at">multiline=</span><span class="cn">TRUE</span>)    </span>
<span id="cb149-32"><a href="Model-building.html#cb149-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb149-33"><a href="Model-building.html#cb149-33" aria-hidden="true" tabindex="-1"></a><span class="do">## 整理检验结果：</span></span>
<span id="cb149-34"><a href="Model-building.html#cb149-34" aria-hidden="true" tabindex="-1"></a><span class="co">#view the model output</span></span>
<span id="cb149-35"><a href="Model-building.html#cb149-35" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span>
<span id="cb149-36"><a href="Model-building.html#cb149-36" aria-hidden="true" tabindex="-1"></a><span class="do">## 将统计结果整理成表格形式：</span></span>
<span id="cb149-37"><a href="Model-building.html#cb149-37" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb149-38"><a href="Model-building.html#cb149-38" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(model)</span></code></pre></div>
</div>
<div id="r语言笔记.formula" class="section level3 hasAnchor" number="4.4.3">
<h3><span class="header-section-number">4.4.3</span> R语言笔记.formula<a href="Model-building.html#r语言笔记.formula" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="常用公式构建参数" class="section level5 hasAnchor" number="4.4.3.0.1">
<h5><span class="header-section-number">4.4.3.0.1</span> 常用公式构建参数：<a href="Model-building.html#常用公式构建参数" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="figure">
<img src="image/04/image-20220902144627876.png" alt="" />
<p class="caption">image-20220902144627876</p>
</div>
<div class="figure">
<img src="image/04/image-20210708152116483.png" alt="" />
<p class="caption">image-20210708152116483</p>
</div>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb150-1"><a href="Model-building.html#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 补充：</span></span>
<span id="cb150-2"><a href="Model-building.html#cb150-2" aria-hidden="true" tabindex="-1"></a>1、<span class="fu">I</span>()：使用<span class="fu">I</span>()包含二次项和交互项；</span>
<span id="cb150-3"><a href="Model-building.html#cb150-3" aria-hidden="true" tabindex="-1"></a><span class="fu">model.frame</span>( y <span class="sc">~</span> x <span class="sc">+</span> x<span class="sc">^</span><span class="dv">2</span>, <span class="at">data =</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="fu">rnorm</span>(<span class="dv">5</span>), <span class="at">y =</span> <span class="fu">rnorm</span>(<span class="dv">5</span>)))</span>
<span id="cb150-4"><a href="Model-building.html#cb150-4" aria-hidden="true" tabindex="-1"></a>y<span class="sc">~</span>x<span class="sc">+</span>x<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb150-5"><a href="Model-building.html#cb150-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-6"><a href="Model-building.html#cb150-6" aria-hidden="true" tabindex="-1"></a>首先先在外面算好x<span class="sc">^</span>2的值,然后再放进formula</span>
<span id="cb150-7"><a href="Model-building.html#cb150-7" aria-hidden="true" tabindex="-1"></a>用<span class="fu">I</span>()<span class="sc">:</span> <span class="st">`</span><span class="at">y~x + I(x^2)</span></span>
<span id="cb150-8"><a href="Model-building.html#cb150-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-9"><a href="Model-building.html#cb150-9" aria-hidden="true" tabindex="-1"></a><span class="at">2、*：在公式中*表示交互式，同时包含参数间的交互作用和不同参数各自的作用；</span></span>
<span id="cb150-10"><a href="Model-building.html#cb150-10" aria-hidden="true" tabindex="-1"></a><span class="at">而：表示仅提取交互项的作用；</span></span>
<span id="cb150-11"><a href="Model-building.html#cb150-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-12"><a href="Model-building.html#cb150-12" aria-hidden="true" tabindex="-1"></a><span class="at">3、y ~ .：其中&quot;.&quot;表示将所有的环境变量全部纳入到其中；</span></span>
<span id="cb150-13"><a href="Model-building.html#cb150-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-14"><a href="Model-building.html#cb150-14" aria-hidden="true" tabindex="-1"></a><span class="at">4、使用poly()函数来直接简写交互项：</span></span>
<span id="cb150-15"><a href="Model-building.html#cb150-15" aria-hidden="true" tabindex="-1"></a><span class="at">## 直接写公式：</span></span>
<span id="cb150-16"><a href="Model-building.html#cb150-16" aria-hidden="true" tabindex="-1"></a><span class="at">m1 &lt;- lm(y~x+I(x^2),data = swiss)</span></span>
<span id="cb150-17"><a href="Model-building.html#cb150-17" aria-hidden="true" tabindex="-1"></a><span class="at">## 使用poly 函数</span></span>
<span id="cb150-18"><a href="Model-building.html#cb150-18" aria-hidden="true" tabindex="-1"></a><span class="at">m2 &lt;- lm(y ~ poly(x, 2, raw=TRUE),data = swiss) # raw 参数表示使用正交多项式</span></span>
<span id="cb150-19"><a href="Model-building.html#cb150-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-20"><a href="Model-building.html#cb150-20" aria-hidden="true" tabindex="-1"></a><span class="at">5、lm()函数释义：</span></span>
<span id="cb150-21"><a href="Model-building.html#cb150-21" aria-hidden="true" tabindex="-1"></a><span class="at">此时再看lm(y~x)、lm(y~x+1)、lm(y~-1)三者的区别便可发现：</span></span>
<span id="cb150-22"><a href="Model-building.html#cb150-22" aria-hidden="true" tabindex="-1"></a><span class="at">+1表示有截距项与-1相对应，</span></span>
<span id="cb150-23"><a href="Model-building.html#cb150-23" aria-hidden="true" tabindex="-1"></a><span class="at">-1指没有截距项，</span></span>
<span id="cb150-24"><a href="Model-building.html#cb150-24" aria-hidden="true" tabindex="-1"></a><span class="at">而x表示默认有截距项。</span></span></code></pre></div>
<div class="figure">
<img src="image/04/image-20210708152742317.png" alt="" />
<p class="caption">image-20210708152742317</p>
</div>
<pre><code>## 补充：
## 模型中的“1”代表什么？
#将个体当做随机因素，这样由于个体有m个水平(m个个体),因此会发现会产生m个截距值。不仅仅是这样，还是作为做随机效应
#这里的1代表随机截距， | 后面表示分组变量；
model=lmer(pitch~sex+place+(1|subject)，data=data.csv)

## 
# 复杂的例子，这里的place表示place中使用随机斜率；
model=lmer(pitch~sex+place+(place|subject)+(1|subject)
      
## 表示在给定随机斜率的情况下，固定截距；加上参数化的交互作用；           
lmer(Y ~ 1 + X1*W + X2 + (1 + X1 | group), ...)</code></pre>
</div>
<div id="手动构造交互变量" class="section level5 hasAnchor" number="4.4.3.0.2">
<h5><span class="header-section-number">4.4.3.0.2</span> 手动构造交互变量：<a href="Model-building.html#手动构造交互变量" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="Model-building.html#cb152-1" aria-hidden="true" tabindex="-1"></a>在R语言中，两个变量相乘可以用“<span class="sc">*</span>”表示，若任一个变量为分类变量，R语言会警告“‘<span class="sc">*</span>’ not meaningful <span class="cf">for</span> factors”。回归模型中如果需要添加交互项，可以直接在formula中通过“<span class="sc">*</span>”或“<span class="sc">:</span>”实现（连续变量和分类变量均适用）。但在某些情况下，可能需要拆解分类变量的交互项而后使用，那么在R语言中如何实现手动构建交互项呢？</span>
<span id="cb152-2"><a href="Model-building.html#cb152-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-3"><a href="Model-building.html#cb152-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-4"><a href="Model-building.html#cb152-4" aria-hidden="true" tabindex="-1"></a><span class="do">## “连续变量*连续变量”</span></span>
<span id="cb152-5"><a href="Model-building.html#cb152-5" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">within</span>(dat, {</span>
<span id="cb152-6"><a href="Model-building.html#cb152-6" aria-hidden="true" tabindex="-1"></a>  gender <span class="ot">&lt;-</span> <span class="fu">factor</span>(gender, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;male&quot;</span>, <span class="st">&quot;female&quot;</span>))</span>
<span id="cb152-7"><a href="Model-building.html#cb152-7" aria-hidden="true" tabindex="-1"></a>  prog <span class="ot">&lt;-</span> <span class="fu">factor</span>(prog, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;jog&quot;</span>, <span class="st">&quot;swim&quot;</span>, <span class="st">&quot;read&quot;</span>))})</span>
<span id="cb152-8"><a href="Model-building.html#cb152-8" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(loss <span class="sc">~</span> hours <span class="sc">*</span> effort, <span class="at">data =</span> dat)</span>
<span id="cb152-9"><a href="Model-building.html#cb152-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit1)</span>
<span id="cb152-10"><a href="Model-building.html#cb152-10" aria-hidden="true" tabindex="-1"></a>等价于：</span>
<span id="cb152-11"><a href="Model-building.html#cb152-11" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(loss <span class="sc">~</span> hours <span class="sc">+</span> effort <span class="sc">+</span> hours <span class="sc">:</span> effort, <span class="at">data =</span> dat)</span>
<span id="cb152-12"><a href="Model-building.html#cb152-12" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit1)</span>
<span id="cb152-13"><a href="Model-building.html#cb152-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-14"><a href="Model-building.html#cb152-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-15"><a href="Model-building.html#cb152-15" aria-hidden="true" tabindex="-1"></a><span class="do">## “连续变量*分类变量”、</span></span>
<span id="cb152-16"><a href="Model-building.html#cb152-16" aria-hidden="true" tabindex="-1"></a><span class="do">## 方法1:</span></span>
<span id="cb152-17"><a href="Model-building.html#cb152-17" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>gender <span class="ot">&lt;-</span> <span class="fu">relevel</span>(dat<span class="sc">$</span>gender, <span class="at">ref =</span> <span class="st">&quot;female&quot;</span>) </span>
<span id="cb152-18"><a href="Model-building.html#cb152-18" aria-hidden="true" tabindex="-1"></a>fit2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(loss <span class="sc">~</span> hours <span class="sc">*</span> gender, <span class="at">data =</span> dat)</span>
<span id="cb152-19"><a href="Model-building.html#cb152-19" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit2)</span>
<span id="cb152-20"><a href="Model-building.html#cb152-20" aria-hidden="true" tabindex="-1"></a>等价于：</span>
<span id="cb152-21"><a href="Model-building.html#cb152-21" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>hours_gender_male <span class="ot">&lt;-</span> dat<span class="sc">$</span>hours <span class="sc">*</span> (dat<span class="sc">$</span>gender <span class="sc">==</span> <span class="st">&quot;male&quot;</span>) </span>
<span id="cb152-22"><a href="Model-building.html#cb152-22" aria-hidden="true" tabindex="-1"></a>fit2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(loss <span class="sc">~</span> hours <span class="sc">+</span> gender <span class="sc">+</span> hours_gender_male, <span class="at">data =</span> dat)</span>
<span id="cb152-23"><a href="Model-building.html#cb152-23" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit2)</span>
<span id="cb152-24"><a href="Model-building.html#cb152-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-25"><a href="Model-building.html#cb152-25" aria-hidden="true" tabindex="-1"></a><span class="do">## 方法2：</span></span>
<span id="cb152-26"><a href="Model-building.html#cb152-26" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>prog <span class="ot">&lt;-</span> <span class="fu">relevel</span>(dat<span class="sc">$</span>prog, <span class="at">ref =</span> <span class="st">&quot;read&quot;</span>) </span>
<span id="cb152-27"><a href="Model-building.html#cb152-27" aria-hidden="true" tabindex="-1"></a>fit3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(loss <span class="sc">~</span> hours <span class="sc">*</span> prog, <span class="at">data =</span> dat)</span>
<span id="cb152-28"><a href="Model-building.html#cb152-28" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit3)</span>
<span id="cb152-29"><a href="Model-building.html#cb152-29" aria-hidden="true" tabindex="-1"></a>等价于：</span>
<span id="cb152-30"><a href="Model-building.html#cb152-30" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>hours_prog_jog <span class="ot">&lt;-</span> dat<span class="sc">$</span>hours <span class="sc">*</span> (dat<span class="sc">$</span>prog <span class="sc">==</span> <span class="st">&quot;jog&quot;</span>) </span>
<span id="cb152-31"><a href="Model-building.html#cb152-31" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>hours_prog_swim <span class="ot">&lt;-</span> dat<span class="sc">$</span>hours <span class="sc">*</span> (dat<span class="sc">$</span>prog <span class="sc">==</span> <span class="st">&quot;swim&quot;</span>) </span>
<span id="cb152-32"><a href="Model-building.html#cb152-32" aria-hidden="true" tabindex="-1"></a>fit3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(loss <span class="sc">~</span> hours <span class="sc">+</span> prog <span class="sc">+</span> hours_prog_jog <span class="sc">+</span> hours_prog_swim, <span class="at">data =</span> dat)</span>
<span id="cb152-33"><a href="Model-building.html#cb152-33" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit3)</span>
<span id="cb152-34"><a href="Model-building.html#cb152-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-35"><a href="Model-building.html#cb152-35" aria-hidden="true" tabindex="-1"></a><span class="do">## “分类变量*分类变量”</span></span>
<span id="cb152-36"><a href="Model-building.html#cb152-36" aria-hidden="true" tabindex="-1"></a><span class="do">## 方法1：</span></span>
<span id="cb152-37"><a href="Model-building.html#cb152-37" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>gender <span class="ot">&lt;-</span> <span class="fu">relevel</span>(dat<span class="sc">$</span>gender, <span class="at">ref =</span> <span class="st">&quot;female&quot;</span>) </span>
<span id="cb152-38"><a href="Model-building.html#cb152-38" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>prog <span class="ot">&lt;-</span> <span class="fu">relevel</span>(dat<span class="sc">$</span>prog, <span class="at">ref =</span> <span class="st">&quot;read&quot;</span>) </span>
<span id="cb152-39"><a href="Model-building.html#cb152-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-40"><a href="Model-building.html#cb152-40" aria-hidden="true" tabindex="-1"></a>fit4 <span class="ot">&lt;-</span> <span class="fu">lm</span>(loss <span class="sc">~</span> gender <span class="sc">*</span> prog, <span class="at">data =</span> dat)</span>
<span id="cb152-41"><a href="Model-building.html#cb152-41" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit4)</span>
<span id="cb152-42"><a href="Model-building.html#cb152-42" aria-hidden="true" tabindex="-1"></a>等价于：</span>
<span id="cb152-43"><a href="Model-building.html#cb152-43" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>gender_male_prog_jog <span class="ot">&lt;-</span> (dat<span class="sc">$</span>gender <span class="sc">==</span> <span class="st">&quot;male&quot;</span>) <span class="sc">*</span> (dat<span class="sc">$</span>prog <span class="sc">==</span> <span class="st">&quot;jog&quot;</span>) </span>
<span id="cb152-44"><a href="Model-building.html#cb152-44" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>gender_male_prog_swim <span class="ot">&lt;-</span> (dat<span class="sc">$</span>gender <span class="sc">==</span> <span class="st">&quot;male&quot;</span>) <span class="sc">*</span> (dat<span class="sc">$</span>prog <span class="sc">==</span> <span class="st">&quot;swim&quot;</span>) </span>
<span id="cb152-45"><a href="Model-building.html#cb152-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-46"><a href="Model-building.html#cb152-46" aria-hidden="true" tabindex="-1"></a>fit4 <span class="ot">&lt;-</span> <span class="fu">lm</span>(loss <span class="sc">~</span> gender <span class="sc">+</span> prog <span class="sc">+</span> gender_male_prog_jog <span class="sc">+</span> gender_male_prog_swim, <span class="at">data =</span> dat)</span>
<span id="cb152-47"><a href="Model-building.html#cb152-47" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit4)</span>
<span id="cb152-48"><a href="Model-building.html#cb152-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-49"><a href="Model-building.html#cb152-49" aria-hidden="true" tabindex="-1"></a><span class="do">## 方法2：</span></span>
<span id="cb152-50"><a href="Model-building.html#cb152-50" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>effort_cat <span class="ot">&lt;-</span> <span class="fu">cut</span>(dat<span class="sc">$</span>effort, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">25</span>, <span class="dv">35</span>, <span class="cn">Inf</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;low&quot;</span>, <span class="st">&quot;medium&quot;</span>, <span class="st">&quot;high&quot;</span>))</span>
<span id="cb152-51"><a href="Model-building.html#cb152-51" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>effort_cat <span class="ot">&lt;-</span> <span class="fu">relevel</span>(dat<span class="sc">$</span>effort_cat, <span class="at">ref =</span> <span class="st">&quot;low&quot;</span>)</span>
<span id="cb152-52"><a href="Model-building.html#cb152-52" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>prog <span class="ot">&lt;-</span> <span class="fu">relevel</span>(dat<span class="sc">$</span>prog, <span class="at">ref =</span> <span class="st">&quot;read&quot;</span>) </span>
<span id="cb152-53"><a href="Model-building.html#cb152-53" aria-hidden="true" tabindex="-1"></a>fit5 <span class="ot">&lt;-</span> <span class="fu">lm</span>(loss <span class="sc">~</span> effort_cat <span class="sc">*</span> prog, <span class="at">data =</span> dat)</span>
<span id="cb152-54"><a href="Model-building.html#cb152-54" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit5)</span>
<span id="cb152-55"><a href="Model-building.html#cb152-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-56"><a href="Model-building.html#cb152-56" aria-hidden="true" tabindex="-1"></a>等价于：</span>
<span id="cb152-57"><a href="Model-building.html#cb152-57" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>effort_cat_medium_prog_jog <span class="ot">&lt;-</span> (dat<span class="sc">$</span>effort_cat <span class="sc">==</span> <span class="st">&quot;medium&quot;</span>) <span class="sc">*</span> (dat<span class="sc">$</span>prog <span class="sc">==</span> <span class="st">&quot;jog&quot;</span>)</span>
<span id="cb152-58"><a href="Model-building.html#cb152-58" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>effort_cat_high_prog_jog <span class="ot">&lt;-</span> (dat<span class="sc">$</span>effort_cat <span class="sc">==</span> <span class="st">&quot;high&quot;</span>) <span class="sc">*</span> (dat<span class="sc">$</span>prog <span class="sc">==</span> <span class="st">&quot;jog&quot;</span>)</span>
<span id="cb152-59"><a href="Model-building.html#cb152-59" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>effort_cat_medium_prog_swim <span class="ot">&lt;-</span> (dat<span class="sc">$</span>effort_cat <span class="sc">==</span> <span class="st">&quot;medium&quot;</span>) <span class="sc">*</span> (dat<span class="sc">$</span>prog <span class="sc">==</span> <span class="st">&quot;swim&quot;</span>)</span>
<span id="cb152-60"><a href="Model-building.html#cb152-60" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>effort_cat_high_prog_swim <span class="ot">&lt;-</span> (dat<span class="sc">$</span>effort_cat <span class="sc">==</span> <span class="st">&quot;high&quot;</span>) <span class="sc">*</span> (dat<span class="sc">$</span>prog <span class="sc">==</span> <span class="st">&quot;swim&quot;</span>)</span>
<span id="cb152-61"><a href="Model-building.html#cb152-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-62"><a href="Model-building.html#cb152-62" aria-hidden="true" tabindex="-1"></a>fit5 <span class="ot">&lt;-</span> <span class="fu">lm</span>(loss <span class="sc">~</span> effort_cat <span class="sc">+</span> prog <span class="sc">+</span> effort_cat_medium_prog_jog <span class="sc">+</span> effort_cat_high_prog_jog <span class="sc">+</span></span>
<span id="cb152-63"><a href="Model-building.html#cb152-63" aria-hidden="true" tabindex="-1"></a>             effort_cat_medium_prog_swim <span class="sc">+</span> effort_cat_high_prog_swim, <span class="at">data =</span> dat)</span>
<span id="cb152-64"><a href="Model-building.html#cb152-64" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit5)</span></code></pre></div>
</div>
<div id="分组回归和交互项回归的区别" class="section level5 hasAnchor" number="4.4.3.0.3">
<h5><span class="header-section-number">4.4.3.0.3</span> 分组回归和交互项回归的区别<a href="Model-building.html#分组回归和交互项回归的区别" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb153-1"><a href="Model-building.html#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 参见：https://zhuanlan.zhihu.com/p/429103359</span></span></code></pre></div>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="Model-building.html#cb154-1" aria-hidden="true" tabindex="-1"></a>例如以mtcar中的数据为例：</span>
<span id="cb154-2"><a href="Model-building.html#cb154-2" aria-hidden="true" tabindex="-1"></a>研究wt对mpg的影响是否因为am而异？</span>
<span id="cb154-3"><a href="Model-building.html#cb154-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-4"><a href="Model-building.html#cb154-4" aria-hidden="true" tabindex="-1"></a><span class="do">## 经比较发现：</span></span>
<span id="cb154-5"><a href="Model-building.html#cb154-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 当添加额外协变量时，分组回归和交互式回归的结果不同：</span></span>
<span id="cb154-6"><a href="Model-building.html#cb154-6" aria-hidden="true" tabindex="-1"></a>举例俩说：</span>
<span id="cb154-7"><a href="Model-building.html#cb154-7" aria-hidden="true" tabindex="-1"></a>fit1_1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> wt <span class="sc">+</span> hp, mtcars, <span class="at">subset =</span> (am <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb154-8"><a href="Model-building.html#cb154-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit1_1)</span>
<span id="cb154-9"><a href="Model-building.html#cb154-9" aria-hidden="true" tabindex="-1"></a>fit1_2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> wt <span class="sc">+</span> hp, mtcars, <span class="at">subset =</span> (am <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb154-10"><a href="Model-building.html#cb154-10" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit1_2)</span>
<span id="cb154-11"><a href="Model-building.html#cb154-11" aria-hidden="true" tabindex="-1"></a>不等价于：</span>
<span id="cb154-12"><a href="Model-building.html#cb154-12" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> wt <span class="sc">*</span> <span class="fu">factor</span>(am) <span class="sc">+</span> hp, mtcars)</span>
<span id="cb154-13"><a href="Model-building.html#cb154-13" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit1)</span>
<span id="cb154-14"><a href="Model-building.html#cb154-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-15"><a href="Model-building.html#cb154-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 当没有添加额外协变量时，分组回归和交互式回归的结果相同：</span></span>
<span id="cb154-16"><a href="Model-building.html#cb154-16" aria-hidden="true" tabindex="-1"></a>fit2_1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> wt, mtcars, <span class="at">subset =</span> (am <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb154-17"><a href="Model-building.html#cb154-17" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit2_1)</span>
<span id="cb154-18"><a href="Model-building.html#cb154-18" aria-hidden="true" tabindex="-1"></a>fit2_2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> wt, mtcars, <span class="at">subset =</span> (am <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb154-19"><a href="Model-building.html#cb154-19" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit2_2)</span>
<span id="cb154-20"><a href="Model-building.html#cb154-20" aria-hidden="true" tabindex="-1"></a>等价于：</span>
<span id="cb154-21"><a href="Model-building.html#cb154-21" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> wt <span class="sc">*</span> <span class="fu">factor</span>(am) , mtcars)</span>
<span id="cb154-22"><a href="Model-building.html#cb154-22" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit1)</span>
<span id="cb154-23"><a href="Model-building.html#cb154-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-24"><a href="Model-building.html#cb154-24" aria-hidden="true" tabindex="-1"></a><span class="do">## 总结：</span></span>
<span id="cb154-25"><a href="Model-building.html#cb154-25" aria-hidden="true" tabindex="-1"></a><span class="fl">1.</span> 亚组分析主要关注不同亚组的疗效是否有统计学差异，而不是亚组的疗效是否有统计学意义。</span>
<span id="cb154-26"><a href="Model-building.html#cb154-26" aria-hidden="true" tabindex="-1"></a><span class="fl">2.</span> 亚组分析需注意：（1）分亚组后样本量减少，检验效能降低（Ⅱ类错误）；（2）对同一效应进行多次检验增加假阳性率（Ⅰ类错误）；（3）在随机分组试验中，亚组分析会破坏随机化的作用，结果解释需谨慎。</span>
<span id="cb154-27"><a href="Model-building.html#cb154-27" aria-hidden="true" tabindex="-1"></a><span class="fl">3.</span> 预先定义的亚组分析和事后亚组分析▪  预先定义的亚组分析（prespecified subgroup analysis），一般作为验证性分析，需要在临床试验方案中提前声明，并在计算样本量和随机化分组时考虑亚组变量的影响，确定研究的假设检验和统计方法。▪  预事后亚组分析（post hoc subgroup analyses），一般作为探索性分析。</span></code></pre></div>
</div>
<div id="构建glm分布族和链接函数" class="section level5 hasAnchor" number="4.4.3.0.4">
<h5><span class="header-section-number">4.4.3.0.4</span> 构建GLM分布族和链接函数<a href="Model-building.html#构建glm分布族和链接函数" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="Model-building.html#cb155-1" aria-hidden="true" tabindex="-1"></a>逻辑回归、一般线性回归等都是广义线性回归的一种分布族下的子集函数；广义线性模型通过拟合响应变量的条件均值的一个函数（不是响应变量的条件均值），并假设响应变量服从指数分布族中的某个分布（不限于正态分布），从而极大地扩展了标准线性模型。模型参数估计的推导依据是极大似然估计，而非最小二乘法。</span>
<span id="cb155-2"><a href="Model-building.html#cb155-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-3"><a href="Model-building.html#cb155-3" aria-hidden="true" tabindex="-1"></a>此外，在glm模型中可以选择使用链接函数log或者identity，其中log函数会对因变量做log转换处理，而identity对原始因变量不做修正。</span>
<span id="cb155-4"><a href="Model-building.html#cb155-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-5"><a href="Model-building.html#cb155-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-6"><a href="Model-building.html#cb155-6" aria-hidden="true" tabindex="-1"></a><span class="do">## 举例如下：</span></span>
<span id="cb155-7"><a href="Model-building.html#cb155-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 二项式分布：</span></span>
<span id="cb155-8"><a href="Model-building.html#cb155-8" aria-hidden="true" tabindex="-1"></a><span class="fu">glm</span>(Y <span class="sc">~</span> X1 <span class="sc">+</span> X2 <span class="sc">+</span> X3, <span class="at">family=</span><span class="fu">binomial</span>(<span class="at">link=</span><span class="st">&quot;logit&quot;</span>), <span class="at">data=</span>data)</span>
<span id="cb155-9"><a href="Model-building.html#cb155-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 正态：n趋于无穷大则为高斯分布</span></span>
<span id="cb155-10"><a href="Model-building.html#cb155-10" aria-hidden="true" tabindex="-1"></a><span class="fu">glm</span>(y<span class="sc">~</span>x,<span class="at">family=</span><span class="fu">gaussian</span>(<span class="at">link=</span><span class="st">&quot;identity&quot;</span>),<span class="at">data=</span>base)</span>
<span id="cb155-11"><a href="Model-building.html#cb155-11" aria-hidden="true" tabindex="-1"></a><span class="fu">glm</span>(y<span class="sc">~</span>x,<span class="at">family=</span><span class="fu">gaussian</span>(<span class="at">link=</span><span class="st">&quot;log&quot;</span>),<span class="at">data=</span>base)</span>
<span id="cb155-12"><a href="Model-building.html#cb155-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 反正态</span></span>
<span id="cb155-13"><a href="Model-building.html#cb155-13" aria-hidden="true" tabindex="-1"></a><span class="fu">glm</span>(y<span class="sc">~</span>x,<span class="at">family=</span><span class="fu">inverse.gaussian</span>(<span class="at">link=</span><span class="st">&quot;identity&quot;</span>),<span class="at">data=</span>base)</span>
<span id="cb155-14"><a href="Model-building.html#cb155-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-15"><a href="Model-building.html#cb155-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 泊松回归适用于在给定时间内响应变量为事件发生数目的情形，其假设Y服从泊松分布，连接函数为log(λ)，概率分布为泊松分布：</span></span>
<span id="cb155-16"><a href="Model-building.html#cb155-16" aria-hidden="true" tabindex="-1"></a><span class="fu">glm</span>(y<span class="sc">~</span>x,<span class="at">family=</span><span class="fu">poisson</span>(<span class="at">link=</span><span class="st">&quot;identity&quot;</span>),<span class="at">data=</span>base)</span>
<span id="cb155-17"><a href="Model-building.html#cb155-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-18"><a href="Model-building.html#cb155-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 连续概率变量函数，</span></span>
<span id="cb155-19"><a href="Model-building.html#cb155-19" aria-hidden="true" tabindex="-1"></a><span class="fu">glm</span>(y<span class="sc">~</span>x,<span class="at">family=</span><span class="fu">Gamma</span>(<span class="at">link=</span><span class="st">&quot;identity&quot;</span>),<span class="at">data=</span>base)</span></code></pre></div>
</div>
</div>
<div id="特征工程" class="section level3 hasAnchor" number="4.4.4">
<h3><span class="header-section-number">4.4.4</span> 特征工程<a href="Model-building.html#特征工程" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<pre><code>1、避免无意义的信息；
## 这里所指 的无意义信息，包含两种，第一种是指因果联系十分薄弱的非相关信息；
第二种是无法区分数据类型的数据；

2、避免重复性新信息，
## 简言之，就是在处理去除掉存在强共线性的信息；

3、避免复杂的信息：
## 简言之，去除那些多阶信息，保留尽可能的单阶信息。但可能部分情况下，这个问题 并不 绝对。</code></pre>
<div class="figure">
<img src="https://pica.zhimg.com/20e4522e6104ad71fc543cc21f402b36_r.jpg?source=1940ef5c" alt="" />
<p class="caption">preview</p>
</div>
<div id="构造哑变量-1" class="section level5 hasAnchor" number="4.4.4.0.1">
<h5><span class="header-section-number">4.4.4.0.1</span> 构造哑变量<a href="Model-building.html#构造哑变量-1" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<pre><code>library(caret)
library(ISLR)
dummies &lt;- dummyVars(~League+Division+NewLeague, data = Hitters)
dummies &lt;- predict(dummies, newdata = Hitters)
head(dummies)</code></pre>
</div>
<div id="构造训练集和测试集" class="section level5 hasAnchor" number="4.4.4.0.2">
<h5><span class="header-section-number">4.4.4.0.2</span> 构造训练集和测试集<a href="Model-building.html#构造训练集和测试集" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="Model-building.html#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb158-2"><a href="Model-building.html#cb158-2" aria-hidden="true" tabindex="-1"></a>index <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(Hitters_dummy), <span class="at">size =</span> <span class="fl">0.8</span><span class="sc">*</span><span class="fu">nrow</span>(Hitters_dummy))</span>
<span id="cb158-3"><a href="Model-building.html#cb158-3" aria-hidden="true" tabindex="-1"></a>train <span class="ot">&lt;-</span> Hitters_dummy[index,]</span>
<span id="cb158-4"><a href="Model-building.html#cb158-4" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> Hitters_dummy[<span class="sc">-</span>index,] </span></code></pre></div>
</div>
</div>
</div>
<div id="深度学习" class="section level2 hasAnchor" number="4.5">
<h2><span class="header-section-number">4.5</span> 深度学习<a href="Model-building.html#深度学习" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="r-中执行keras" class="section level3 hasAnchor" number="4.5.1">
<h3><span class="header-section-number">4.5.1</span> R 中执行keras<a href="Model-building.html#r-中执行keras" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="Model-building.html#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tensorflow)</span>
<span id="cb159-2"><a href="Model-building.html#cb159-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb159-3"><a href="Model-building.html#cb159-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-4"><a href="Model-building.html#cb159-4" aria-hidden="true" tabindex="-1"></a><span class="do">## 第五步：在R中学习使用keras软件分析：####</span></span>
<span id="cb159-5"><a href="Model-building.html#cb159-5" aria-hidden="true" tabindex="-1"></a><span class="do">######### 5.1数据可视化：</span></span>
<span id="cb159-6"><a href="Model-building.html#cb159-6" aria-hidden="true" tabindex="-1"></a>iris_tar <span class="ot">&lt;-</span> iris[,<span class="dv">5</span>]</span>
<span id="cb159-7"><a href="Model-building.html#cb159-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-8"><a href="Model-building.html#cb159-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(iris<span class="sc">$</span>Petal.Length, </span>
<span id="cb159-9"><a href="Model-building.html#cb159-9" aria-hidden="true" tabindex="-1"></a>     iris<span class="sc">$</span>Petal.Width, </span>
<span id="cb159-10"><a href="Model-building.html#cb159-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">pch=</span><span class="dv">21</span>, <span class="at">bg=</span><span class="fu">c</span>(<span class="st">&quot;red&quot;</span>,<span class="st">&quot;green3&quot;</span>,<span class="st">&quot;blue&quot;</span>)[<span class="fu">unclass</span>(iris<span class="sc">$</span>Species)], </span>
<span id="cb159-11"><a href="Model-building.html#cb159-11" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">&quot;Petal Length&quot;</span>, </span>
<span id="cb159-12"><a href="Model-building.html#cb159-12" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">&quot;Petal Width&quot;</span>)</span>
<span id="cb159-13"><a href="Model-building.html#cb159-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-14"><a href="Model-building.html#cb159-14" aria-hidden="true" tabindex="-1"></a><span class="do">########  5.2 数据相关性分析：</span></span>
<span id="cb159-15"><a href="Model-building.html#cb159-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Store the overall correlation in `M`</span></span>
<span id="cb159-16"><a href="Model-building.html#cb159-16" aria-hidden="true" tabindex="-1"></a>M <span class="ot">&lt;-</span> <span class="fu">cor</span>(iris[,<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>])</span>
<span id="cb159-17"><a href="Model-building.html#cb159-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the correlation plot with `M`</span></span>
<span id="cb159-18"><a href="Model-building.html#cb159-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(corrplot)</span>
<span id="cb159-19"><a href="Model-building.html#cb159-19" aria-hidden="true" tabindex="-1"></a><span class="fu">corrplot</span>(M, <span class="at">method=</span><span class="st">&quot;circle&quot;</span>)</span>
<span id="cb159-20"><a href="Model-building.html#cb159-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-21"><a href="Model-building.html#cb159-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-22"><a href="Model-building.html#cb159-22" aria-hidden="true" tabindex="-1"></a><span class="do">########  5.3 数据处理及建模数据准备：</span></span>
<span id="cb159-23"><a href="Model-building.html#cb159-23" aria-hidden="true" tabindex="-1"></a><span class="do">## 将类型数据转为向量分类型数据：</span></span>
<span id="cb159-24"><a href="Model-building.html#cb159-24" aria-hidden="true" tabindex="-1"></a>iris[,<span class="dv">5</span>] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(iris[,<span class="dv">5</span>]) <span class="sc">-</span><span class="dv">1</span></span>
<span id="cb159-25"><a href="Model-building.html#cb159-25" aria-hidden="true" tabindex="-1"></a>iris <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(iris)</span>
<span id="cb159-26"><a href="Model-building.html#cb159-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-27"><a href="Model-building.html#cb159-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Set iris `dimnames` to `NULL`</span></span>
<span id="cb159-28"><a href="Model-building.html#cb159-28" aria-hidden="true" tabindex="-1"></a><span class="fu">dimnames</span>(iris) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb159-29"><a href="Model-building.html#cb159-29" aria-hidden="true" tabindex="-1"></a><span class="co">#  转为矩阵：</span></span>
<span id="cb159-30"><a href="Model-building.html#cb159-30" aria-hidden="true" tabindex="-1"></a>iris <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(iris )</span>
<span id="cb159-31"><a href="Model-building.html#cb159-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-32"><a href="Model-building.html#cb159-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-33"><a href="Model-building.html#cb159-33" aria-hidden="true" tabindex="-1"></a><span class="co"># 第三步：构建训练集和测试集：</span></span>
<span id="cb159-34"><a href="Model-building.html#cb159-34" aria-hidden="true" tabindex="-1"></a>ind <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">2</span>, <span class="fu">nrow</span>(iris), <span class="at">replace=</span><span class="cn">TRUE</span>, <span class="at">prob=</span><span class="fu">c</span>(<span class="fl">0.67</span>, <span class="fl">0.33</span>))</span>
<span id="cb159-35"><a href="Model-building.html#cb159-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Split the `iris` data</span></span>
<span id="cb159-36"><a href="Model-building.html#cb159-36" aria-hidden="true" tabindex="-1"></a>iris.training <span class="ot">&lt;-</span> iris[ind<span class="sc">==</span><span class="dv">1</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]</span>
<span id="cb159-37"><a href="Model-building.html#cb159-37" aria-hidden="true" tabindex="-1"></a>iris.test <span class="ot">&lt;-</span> iris[ind<span class="sc">==</span><span class="dv">2</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]</span>
<span id="cb159-38"><a href="Model-building.html#cb159-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-39"><a href="Model-building.html#cb159-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Split the class attribute</span></span>
<span id="cb159-40"><a href="Model-building.html#cb159-40" aria-hidden="true" tabindex="-1"></a>iris.trainingtarget <span class="ot">&lt;-</span> iris[ind<span class="sc">==</span><span class="dv">1</span>, <span class="dv">5</span>]</span>
<span id="cb159-41"><a href="Model-building.html#cb159-41" aria-hidden="true" tabindex="-1"></a>iris.testtarget <span class="ot">&lt;-</span> iris[ind<span class="sc">==</span><span class="dv">2</span>, <span class="dv">5</span>]</span>
<span id="cb159-42"><a href="Model-building.html#cb159-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-43"><a href="Model-building.html#cb159-43" aria-hidden="true" tabindex="-1"></a><span class="co"># One hot encode training target values</span></span>
<span id="cb159-44"><a href="Model-building.html#cb159-44" aria-hidden="true" tabindex="-1"></a>iris.trainLabels <span class="ot">&lt;-</span> <span class="fu">to_categorical</span>(iris.trainingtarget)</span>
<span id="cb159-45"><a href="Model-building.html#cb159-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-46"><a href="Model-building.html#cb159-46" aria-hidden="true" tabindex="-1"></a><span class="co"># One hot encode test target values</span></span>
<span id="cb159-47"><a href="Model-building.html#cb159-47" aria-hidden="true" tabindex="-1"></a>iris.testLabels <span class="ot">&lt;-</span> <span class="fu">to_categorical</span>(iris.testtarget)</span>
<span id="cb159-48"><a href="Model-building.html#cb159-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-49"><a href="Model-building.html#cb159-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-50"><a href="Model-building.html#cb159-50" aria-hidden="true" tabindex="-1"></a><span class="do">########  5.4 构建模型：</span></span>
<span id="cb159-51"><a href="Model-building.html#cb159-51" aria-hidden="true" tabindex="-1"></a><span class="do">#### 5.4.1 构建初级模型：</span></span>
<span id="cb159-52"><a href="Model-building.html#cb159-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize a sequential model</span></span>
<span id="cb159-53"><a href="Model-building.html#cb159-53" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>() </span>
<span id="cb159-54"><a href="Model-building.html#cb159-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-55"><a href="Model-building.html#cb159-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Add layers to the model</span></span>
<span id="cb159-56"><a href="Model-building.html#cb159-56" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> </span>
<span id="cb159-57"><a href="Model-building.html#cb159-57" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 参数意义：&#39;relu&#39;用于激活隐藏层；&#39;softmax&#39;表示输出层；</span></span>
<span id="cb159-58"><a href="Model-building.html#cb159-58" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 输出值为为3个分类单元；</span></span>
<span id="cb159-59"><a href="Model-building.html#cb159-59" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 假设输入的隐藏层为8个；</span></span>
<span id="cb159-60"><a href="Model-building.html#cb159-60" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 这里的input_shape为4是因为仅有4列参与建模；</span></span>
<span id="cb159-61"><a href="Model-building.html#cb159-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-62"><a href="Model-building.html#cb159-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">8</span>, <span class="at">activation =</span> <span class="st">&#39;relu&#39;</span>, <span class="at">input_shape =</span> <span class="fu">c</span>(<span class="dv">4</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb159-63"><a href="Model-building.html#cb159-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">3</span>, <span class="at">activation =</span> <span class="st">&#39;softmax&#39;</span>)</span>
<span id="cb159-64"><a href="Model-building.html#cb159-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-65"><a href="Model-building.html#cb159-65" aria-hidden="true" tabindex="-1"></a><span class="do">#### 5.4.2 模型评价：</span></span>
<span id="cb159-66"><a href="Model-building.html#cb159-66" aria-hidden="true" tabindex="-1"></a><span class="co"># 模型的评价：</span></span>
<span id="cb159-67"><a href="Model-building.html#cb159-67" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)  </span>
<span id="cb159-68"><a href="Model-building.html#cb159-68" aria-hidden="true" tabindex="-1"></a><span class="co"># 获取模型参数；</span></span>
<span id="cb159-69"><a href="Model-building.html#cb159-69" aria-hidden="true" tabindex="-1"></a><span class="fu">get_config</span>(model)</span>
<span id="cb159-70"><a href="Model-building.html#cb159-70" aria-hidden="true" tabindex="-1"></a><span class="co"># 获取模型的名称：</span></span>
<span id="cb159-71"><a href="Model-building.html#cb159-71" aria-hidden="true" tabindex="-1"></a><span class="fu">get_layer</span>(model, <span class="at">index =</span> <span class="dv">1</span>)</span>
<span id="cb159-72"><a href="Model-building.html#cb159-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-73"><a href="Model-building.html#cb159-73" aria-hidden="true" tabindex="-1"></a><span class="do">#### 5.4.3 编译和拟合模型：</span></span>
<span id="cb159-74"><a href="Model-building.html#cb159-74" aria-hidden="true" tabindex="-1"></a><span class="co"># Compile the model</span></span>
<span id="cb159-75"><a href="Model-building.html#cb159-75" aria-hidden="true" tabindex="-1"></a><span class="co"># 该过程需要两个函数;优化器和损失函数；</span></span>
<span id="cb159-76"><a href="Model-building.html#cb159-76" aria-hidden="true" tabindex="-1"></a><span class="co"># 如果是二元分类的问题应该使用binary_crossentropy</span></span>
<span id="cb159-77"><a href="Model-building.html#cb159-77" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> <span class="fu">compile</span>(</span>
<span id="cb159-78"><a href="Model-building.html#cb159-78" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss =</span> <span class="st">&#39;categorical_crossentropy&#39;</span>,</span>
<span id="cb159-79"><a href="Model-building.html#cb159-79" aria-hidden="true" tabindex="-1"></a>  <span class="at">optimizer =</span> <span class="st">&#39;adam&#39;</span>,</span>
<span id="cb159-80"><a href="Model-building.html#cb159-80" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="st">&#39;accuracy&#39;</span></span>
<span id="cb159-81"><a href="Model-building.html#cb159-81" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb159-82"><a href="Model-building.html#cb159-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-83"><a href="Model-building.html#cb159-83" aria-hidden="true" tabindex="-1"></a><span class="do">#### 5.4.4 可视化模型拟合过程：</span></span>
<span id="cb159-84"><a href="Model-building.html#cb159-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-85"><a href="Model-building.html#cb159-85" aria-hidden="true" tabindex="-1"></a><span class="co"># Store the fitting history in `history` </span></span>
<span id="cb159-86"><a href="Model-building.html#cb159-86" aria-hidden="true" tabindex="-1"></a>history <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> <span class="fu">fit</span>(</span>
<span id="cb159-87"><a href="Model-building.html#cb159-87" aria-hidden="true" tabindex="-1"></a>  iris.training, </span>
<span id="cb159-88"><a href="Model-building.html#cb159-88" aria-hidden="true" tabindex="-1"></a>  iris.trainLabels, </span>
<span id="cb159-89"><a href="Model-building.html#cb159-89" aria-hidden="true" tabindex="-1"></a>  <span class="at">epochs =</span> <span class="dv">200</span>, <span class="do">## 200次迭代；</span></span>
<span id="cb159-90"><a href="Model-building.html#cb159-90" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> <span class="dv">5</span>,  <span class="do">## 每次5个样本；通过这样做，您可以优化效率，</span></span>
<span id="cb159-91"><a href="Model-building.html#cb159-91" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 因为您可以确保不会同时将太多输入模式加载到内存中。</span></span>
<span id="cb159-92"><a href="Model-building.html#cb159-92" aria-hidden="true" tabindex="-1"></a>  <span class="at">validation_split =</span> <span class="fl">0.2</span></span>
<span id="cb159-93"><a href="Model-building.html#cb159-93" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb159-94"><a href="Model-building.html#cb159-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-95"><a href="Model-building.html#cb159-95" aria-hidden="true" tabindex="-1"></a><span class="co"># 可视化在训练过程中准确性和损失函数的变化过程：</span></span>
<span id="cb159-96"><a href="Model-building.html#cb159-96" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(history)</span>
<span id="cb159-97"><a href="Model-building.html#cb159-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-98"><a href="Model-building.html#cb159-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-99"><a href="Model-building.html#cb159-99" aria-hidden="true" tabindex="-1"></a><span class="co"># 5.4.4.1 可视化损失函数的变化过程：</span></span>
<span id="cb159-100"><a href="Model-building.html#cb159-100" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the model loss of the training data</span></span>
<span id="cb159-101"><a href="Model-building.html#cb159-101" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(history<span class="sc">$</span>metrics<span class="sc">$</span>loss, <span class="at">main=</span><span class="st">&quot;Model Loss&quot;</span>, <span class="at">xlab =</span> <span class="st">&quot;epoch&quot;</span>, <span class="at">ylab=</span><span class="st">&quot;loss&quot;</span>, <span class="at">col=</span><span class="st">&quot;blue&quot;</span>, <span class="at">type=</span><span class="st">&quot;l&quot;</span>)</span>
<span id="cb159-102"><a href="Model-building.html#cb159-102" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the model loss of the test data</span></span>
<span id="cb159-103"><a href="Model-building.html#cb159-103" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(history<span class="sc">$</span>metrics<span class="sc">$</span>val_loss, <span class="at">col=</span><span class="st">&quot;green&quot;</span>)</span>
<span id="cb159-104"><a href="Model-building.html#cb159-104" aria-hidden="true" tabindex="-1"></a><span class="co"># Add legend</span></span>
<span id="cb159-105"><a href="Model-building.html#cb159-105" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&quot;topright&quot;</span>, <span class="fu">c</span>(<span class="st">&quot;train&quot;</span>,<span class="st">&quot;test&quot;</span>), <span class="at">col=</span><span class="fu">c</span>(<span class="st">&quot;blue&quot;</span>, <span class="st">&quot;green&quot;</span>), <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb159-106"><a href="Model-building.html#cb159-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-107"><a href="Model-building.html#cb159-107" aria-hidden="true" tabindex="-1"></a><span class="co"># 5.4.4.3 可视化准确性函数的变化过程：</span></span>
<span id="cb159-108"><a href="Model-building.html#cb159-108" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the accuracy of the training data </span></span>
<span id="cb159-109"><a href="Model-building.html#cb159-109" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(history<span class="sc">$</span>metrics<span class="sc">$</span>acc, <span class="at">main=</span><span class="st">&quot;Model Accuracy&quot;</span>, <span class="at">xlab =</span> <span class="st">&quot;epoch&quot;</span>, <span class="at">ylab=</span><span class="st">&quot;accuracy&quot;</span>, <span class="at">col=</span><span class="st">&quot;blue&quot;</span>, <span class="at">type=</span><span class="st">&quot;l&quot;</span>)</span>
<span id="cb159-110"><a href="Model-building.html#cb159-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the accuracy of the validation data</span></span>
<span id="cb159-111"><a href="Model-building.html#cb159-111" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(history<span class="sc">$</span>metrics<span class="sc">$</span>val_acc, <span class="at">col=</span><span class="st">&quot;green&quot;</span>)</span>
<span id="cb159-112"><a href="Model-building.html#cb159-112" aria-hidden="true" tabindex="-1"></a><span class="co"># Add Legend</span></span>
<span id="cb159-113"><a href="Model-building.html#cb159-113" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&quot;bottomright&quot;</span>, <span class="fu">c</span>(<span class="st">&quot;train&quot;</span>,<span class="st">&quot;test&quot;</span>), <span class="at">col=</span><span class="fu">c</span>(<span class="st">&quot;blue&quot;</span>, <span class="st">&quot;green&quot;</span>), <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb159-114"><a href="Model-building.html#cb159-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-115"><a href="Model-building.html#cb159-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-116"><a href="Model-building.html#cb159-116" aria-hidden="true" tabindex="-1"></a><span class="do">##### 5.4.5 基于测试数据进行数据预测并构建混淆矩阵：</span></span>
<span id="cb159-117"><a href="Model-building.html#cb159-117" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict the classes for the test data</span></span>
<span id="cb159-118"><a href="Model-building.html#cb159-118" aria-hidden="true" tabindex="-1"></a>classes <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> <span class="fu">predict_classes</span>(iris.test, <span class="at">batch_size =</span> <span class="dv">128</span>)</span>
<span id="cb159-119"><a href="Model-building.html#cb159-119" aria-hidden="true" tabindex="-1"></a><span class="co"># Confusion matrix</span></span>
<span id="cb159-120"><a href="Model-building.html#cb159-120" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(iris.testtarget, classes)</span>
<span id="cb159-121"><a href="Model-building.html#cb159-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-122"><a href="Model-building.html#cb159-122" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate on test data and labels</span></span>
<span id="cb159-123"><a href="Model-building.html#cb159-123" aria-hidden="true" tabindex="-1"></a>score <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> <span class="fu">evaluate</span>(iris.test, iris.testLabels, <span class="at">batch_size =</span> <span class="dv">128</span>)</span>
<span id="cb159-124"><a href="Model-building.html#cb159-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-125"><a href="Model-building.html#cb159-125" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the score</span></span>
<span id="cb159-126"><a href="Model-building.html#cb159-126" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(score)</span>
<span id="cb159-127"><a href="Model-building.html#cb159-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-128"><a href="Model-building.html#cb159-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-129"><a href="Model-building.html#cb159-129" aria-hidden="true" tabindex="-1"></a><span class="do">##### 5.4.6 模型调参：</span></span>
<span id="cb159-130"><a href="Model-building.html#cb159-130" aria-hidden="true" tabindex="-1"></a><span class="co"># 通过添加层、增加隐藏单元的数量以及通过您自己的优化compile()函数的参数。</span></span>
<span id="cb159-131"><a href="Model-building.html#cb159-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-132"><a href="Model-building.html#cb159-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-133"><a href="Model-building.html#cb159-133" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the sequential model</span></span>
<span id="cb159-134"><a href="Model-building.html#cb159-134" aria-hidden="true" tabindex="-1"></a>model2 <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>() </span>
<span id="cb159-135"><a href="Model-building.html#cb159-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-136"><a href="Model-building.html#cb159-136" aria-hidden="true" tabindex="-1"></a><span class="co"># Add layers to model</span></span>
<span id="cb159-137"><a href="Model-building.html#cb159-137" aria-hidden="true" tabindex="-1"></a>model2 <span class="sc">%&gt;%</span> </span>
<span id="cb159-138"><a href="Model-building.html#cb159-138" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 通过增加二级隐藏层的数量来增加拟合精度：</span></span>
<span id="cb159-139"><a href="Model-building.html#cb159-139" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">28</span>, <span class="at">activation =</span> <span class="st">&#39;relu&#39;</span>, <span class="at">input_shape =</span> <span class="fu">c</span>(<span class="dv">4</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb159-140"><a href="Model-building.html#cb159-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">5</span>, <span class="at">activation =</span> <span class="st">&#39;relu&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb159-141"><a href="Model-building.html#cb159-141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">3</span>, <span class="at">activation =</span> <span class="st">&#39;softmax&#39;</span>)</span>
<span id="cb159-142"><a href="Model-building.html#cb159-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-143"><a href="Model-building.html#cb159-143" aria-hidden="true" tabindex="-1"></a><span class="co"># Compile the model</span></span>
<span id="cb159-144"><a href="Model-building.html#cb159-144" aria-hidden="true" tabindex="-1"></a>model2 <span class="sc">%&gt;%</span> <span class="fu">compile</span>(</span>
<span id="cb159-145"><a href="Model-building.html#cb159-145" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss =</span> <span class="st">&#39;categorical_crossentropy&#39;</span>,</span>
<span id="cb159-146"><a href="Model-building.html#cb159-146" aria-hidden="true" tabindex="-1"></a>  <span class="at">optimizer =</span> <span class="st">&#39;adam&#39;</span>, <span class="do">## 还可以使用sgd；</span></span>
<span id="cb159-147"><a href="Model-building.html#cb159-147" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="st">&#39;accuracy&#39;</span></span>
<span id="cb159-148"><a href="Model-building.html#cb159-148" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb159-149"><a href="Model-building.html#cb159-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-150"><a href="Model-building.html#cb159-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-151"><a href="Model-building.html#cb159-151" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model to the data</span></span>
<span id="cb159-152"><a href="Model-building.html#cb159-152" aria-hidden="true" tabindex="-1"></a>model2 <span class="sc">%&gt;%</span> <span class="fu">fit</span>(</span>
<span id="cb159-153"><a href="Model-building.html#cb159-153" aria-hidden="true" tabindex="-1"></a>  iris.training, iris.trainLabels, </span>
<span id="cb159-154"><a href="Model-building.html#cb159-154" aria-hidden="true" tabindex="-1"></a>  <span class="at">epochs =</span> <span class="dv">200</span>, <span class="at">batch_size =</span> <span class="dv">5</span>, </span>
<span id="cb159-155"><a href="Model-building.html#cb159-155" aria-hidden="true" tabindex="-1"></a>  <span class="at">validation_split =</span> <span class="fl">0.2</span></span>
<span id="cb159-156"><a href="Model-building.html#cb159-156" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb159-157"><a href="Model-building.html#cb159-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-158"><a href="Model-building.html#cb159-158" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate the model</span></span>
<span id="cb159-159"><a href="Model-building.html#cb159-159" aria-hidden="true" tabindex="-1"></a>score2 <span class="ot">&lt;-</span> model2 <span class="sc">%&gt;%</span> <span class="fu">evaluate</span>(iris.test, iris.testLabels, <span class="at">batch_size =</span> <span class="dv">128</span>)</span>
<span id="cb159-160"><a href="Model-building.html#cb159-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-161"><a href="Model-building.html#cb159-161" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the score</span></span>
<span id="cb159-162"><a href="Model-building.html#cb159-162" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(score2)</span>
<span id="cb159-163"><a href="Model-building.html#cb159-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-164"><a href="Model-building.html#cb159-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-165"><a href="Model-building.html#cb159-165" aria-hidden="true" tabindex="-1"></a><span class="do">##### 5.4.7 模型保存和读取：</span></span>
<span id="cb159-166"><a href="Model-building.html#cb159-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-167"><a href="Model-building.html#cb159-167" aria-hidden="true" tabindex="-1"></a><span class="fu">save_model_hdf5</span>(model, <span class="st">&quot;my_model.h5&quot;</span>)</span>
<span id="cb159-168"><a href="Model-building.html#cb159-168" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">load_model_hdf5</span>(<span class="st">&quot;my_model.h5&quot;</span>)</span>
<span id="cb159-169"><a href="Model-building.html#cb159-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-170"><a href="Model-building.html#cb159-170" aria-hidden="true" tabindex="-1"></a><span class="do">## 第六步：在R的pyhton中使用keras软件分析：####</span></span>
<span id="cb159-171"><a href="Model-building.html#cb159-171" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<p>~~~</p>
</div>
</div>
<div id="机器学习" class="section level2 hasAnchor" number="4.6">
<h2><span class="header-section-number">4.6</span> 机器学习<a href="Model-building.html#机器学习" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="机器学习--mlr3包" class="section level3 hasAnchor" number="4.6.1">
<h3><span class="header-section-number">4.6.1</span> 机器学习 -mlr3包<a href="Model-building.html#机器学习--mlr3包" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<pre><code>https://zhuanlan.zhihu.com/p/112845336</code></pre>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="Model-building.html#cb161-1" aria-hidden="true" tabindex="-1"></a>过去：整合机器学习算法的包：</span>
<span id="cb161-2"><a href="Model-building.html#cb161-2" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span> mlr 包</span>
<span id="cb161-3"><a href="Model-building.html#cb161-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-4"><a href="Model-building.html#cb161-4" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span> caret 包</span>
<span id="cb161-5"><a href="Model-building.html#cb161-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-6"><a href="Model-building.html#cb161-6" aria-hidden="true" tabindex="-1"></a>现在：新一代整合机器学习算法的包，也是上面两个的进化版：</span>
<span id="cb161-7"><a href="Model-building.html#cb161-7" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span> mlr3verse 包（首推）</span>
<span id="cb161-8"><a href="Model-building.html#cb161-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-9"><a href="Model-building.html#cb161-9" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span> tidymodels 包</span></code></pre></div>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb162-1"><a href="Model-building.html#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 机器学习书籍在线：</span></span>
<span id="cb162-2"><a href="Model-building.html#cb162-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-3"><a href="Model-building.html#cb162-3" aria-hidden="true" tabindex="-1"></a>https<span class="sc">:</span><span class="er">//</span>mlr3book.mlr<span class="sc">-</span>org.com<span class="sc">/</span></span>
<span id="cb162-4"><a href="Model-building.html#cb162-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-5"><a href="Model-building.html#cb162-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Tidy Modeling with R</span></span>
<span id="cb162-6"><a href="Model-building.html#cb162-6" aria-hidden="true" tabindex="-1"></a>https<span class="sc">:</span><span class="er">//</span>www.tmwr.org<span class="sc">/</span>index.html</span>
<span id="cb162-7"><a href="Model-building.html#cb162-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-8"><a href="Model-building.html#cb162-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Hands-On Machine Learning with R</span></span>
<span id="cb162-9"><a href="Model-building.html#cb162-9" aria-hidden="true" tabindex="-1"></a>Bradley Boehmke <span class="sc">&amp;</span> Brandon Greenwell</span>
<span id="cb162-10"><a href="Model-building.html#cb162-10" aria-hidden="true" tabindex="-1"></a>https<span class="sc">:</span><span class="er">//</span>bradleyboehmke.github.io<span class="sc">/</span>HOML<span class="sc">/</span></span>
<span id="cb162-11"><a href="Model-building.html#cb162-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-12"><a href="Model-building.html#cb162-12" aria-hidden="true" tabindex="-1"></a><span class="do">## 构造R包：</span></span>
<span id="cb162-13"><a href="Model-building.html#cb162-13" aria-hidden="true" tabindex="-1"></a>R <span class="fu">Packages</span> (2e)</span>
<span id="cb162-14"><a href="Model-building.html#cb162-14" aria-hidden="true" tabindex="-1"></a>https<span class="sc">:</span><span class="er">//</span>r<span class="sc">-</span>pkgs.org<span class="sc">/</span></span>
<span id="cb162-15"><a href="Model-building.html#cb162-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-16"><a href="Model-building.html#cb162-16" aria-hidden="true" tabindex="-1"></a><span class="do">## 高效R编程：</span></span>
<span id="cb162-17"><a href="Model-building.html#cb162-17" aria-hidden="true" tabindex="-1"></a>Efficient R programming</span>
<span id="cb162-18"><a href="Model-building.html#cb162-18" aria-hidden="true" tabindex="-1"></a>https<span class="sc">:</span><span class="er">//</span>csgillespie.github.io<span class="sc">/</span>efficientR<span class="sc">/</span></span>
<span id="cb162-19"><a href="Model-building.html#cb162-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-20"><a href="Model-building.html#cb162-20" aria-hidden="true" tabindex="-1"></a><span class="do">## bookdown with R：</span></span>
<span id="cb162-21"><a href="Model-building.html#cb162-21" aria-hidden="true" tabindex="-1"></a>bookdown<span class="sc">:</span> Authoring Books and Technical Documents with R Markdown</span>
<span id="cb162-22"><a href="Model-building.html#cb162-22" aria-hidden="true" tabindex="-1"></a>https<span class="sc">:</span><span class="er">//</span>bookdown.org<span class="sc">/</span>yihui<span class="sc">/</span>bookdown<span class="sc">/</span></span>
<span id="cb162-23"><a href="Model-building.html#cb162-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-24"><a href="Model-building.html#cb162-24" aria-hidden="true" tabindex="-1"></a><span class="do">## Engineering Production-Grade Shiny Apps</span></span>
<span id="cb162-25"><a href="Model-building.html#cb162-25" aria-hidden="true" tabindex="-1"></a>https<span class="sc">:</span><span class="er">//</span>engineering<span class="sc">-</span>shiny.org<span class="sc">/</span></span></code></pre></div>
</div>
<div id="常规机器学习" class="section level3 hasAnchor" number="4.6.2">
<h3><span class="header-section-number">4.6.2</span> 常规机器学习<a href="Model-building.html#常规机器学习" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="支持向量机svm" class="section level4 hasAnchor" number="4.6.2.1">
<h4><span class="header-section-number">4.6.2.1</span> 支持向量机（SVM）<a href="Model-building.html#支持向量机svm" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="Model-building.html#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">&#39;/Users/jerseyshen/Documents/JianShu_Project/20191230&#39;</span>)</span>
<span id="cb163-2"><a href="Model-building.html#cb163-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-3"><a href="Model-building.html#cb163-3" aria-hidden="true" tabindex="-1"></a><span class="do">## 加载数据：</span></span>
<span id="cb163-4"><a href="Model-building.html#cb163-4" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">read.csv</span>(<span class="st">&quot;data.csv&quot;</span>,</span>
<span id="cb163-5"><a href="Model-building.html#cb163-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">header =</span> T)</span>
<span id="cb163-6"><a href="Model-building.html#cb163-6" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> data[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb163-7"><a href="Model-building.html#cb163-7" aria-hidden="true" tabindex="-1"></a>date <span class="ot">=</span> <span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">&#39;2002-01-01&#39;</span>),</span>
<span id="cb163-8"><a href="Model-building.html#cb163-8" aria-hidden="true" tabindex="-1"></a>           <span class="fu">as.Date</span>(<span class="st">&#39;2015-12-01&#39;</span>),</span>
<span id="cb163-9"><a href="Model-building.html#cb163-9" aria-hidden="true" tabindex="-1"></a>           <span class="st">&#39;1 month&#39;</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">165</span>]</span>
<span id="cb163-10"><a href="Model-building.html#cb163-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-11"><a href="Model-building.html#cb163-11" aria-hidden="true" tabindex="-1"></a><span class="do">## 分割数据：</span></span>
<span id="cb163-12"><a href="Model-building.html#cb163-12" aria-hidden="true" tabindex="-1"></a>train <span class="ot">=</span> data[<span class="dv">1</span><span class="sc">:</span><span class="dv">115</span>,]</span>
<span id="cb163-13"><a href="Model-building.html#cb163-13" aria-hidden="true" tabindex="-1"></a>test <span class="ot">=</span> data[<span class="dv">116</span><span class="sc">:</span><span class="dv">165</span>,]</span>
<span id="cb163-14"><a href="Model-building.html#cb163-14" aria-hidden="true" tabindex="-1"></a>date_train <span class="ot">=</span> date[<span class="dv">1</span><span class="sc">:</span><span class="dv">115</span>]</span>
<span id="cb163-15"><a href="Model-building.html#cb163-15" aria-hidden="true" tabindex="-1"></a>date_test <span class="ot">=</span> date[<span class="dv">116</span><span class="sc">:</span><span class="dv">165</span>]</span>
<span id="cb163-16"><a href="Model-building.html#cb163-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-17"><a href="Model-building.html#cb163-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-18"><a href="Model-building.html#cb163-18" aria-hidden="true" tabindex="-1"></a><span class="do">## 构建模型：</span></span>
<span id="cb163-19"><a href="Model-building.html#cb163-19" aria-hidden="true" tabindex="-1"></a>model_init <span class="ot">=</span> <span class="fu">svm</span>(shortwave <span class="sc">~</span> temper<span class="sc">+</span>evap,</span>
<span id="cb163-20"><a href="Model-building.html#cb163-20" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> train,</span>
<span id="cb163-21"><a href="Model-building.html#cb163-21" aria-hidden="true" tabindex="-1"></a>                 <span class="at">kernel =</span> <span class="st">&#39;radial&#39;</span>)</span>
<span id="cb163-22"><a href="Model-building.html#cb163-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-23"><a href="Model-building.html#cb163-23" aria-hidden="true" tabindex="-1"></a><span class="do">## 5. 模型训练结果与实测数据相关性及RMSE分析（图1）</span></span>
<span id="cb163-24"><a href="Model-building.html#cb163-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-25"><a href="Model-building.html#cb163-25" aria-hidden="true" tabindex="-1"></a>train_simu <span class="ot">=</span> <span class="fu">as.numeric</span>(model_init<span class="sc">$</span>fitted)</span>
<span id="cb163-26"><a href="Model-building.html#cb163-26" aria-hidden="true" tabindex="-1"></a>pl_point_df <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">SIMU =</span> <span class="fu">as.numeric</span>(train_simu),</span>
<span id="cb163-27"><a href="Model-building.html#cb163-27" aria-hidden="true" tabindex="-1"></a>                         <span class="at">TRAIN =</span> train<span class="sc">$</span>shortwave)</span>
<span id="cb163-28"><a href="Model-building.html#cb163-28" aria-hidden="true" tabindex="-1"></a>label_df <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb163-29"><a href="Model-building.html#cb163-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.5</span>,<span class="sc">-</span><span class="fl">0.5</span>,<span class="sc">-</span><span class="fl">0.5</span>),</span>
<span id="cb163-30"><a href="Model-building.html#cb163-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="fu">c</span>(<span class="fl">0.3</span>,<span class="fl">0.25</span>,<span class="fl">0.2</span>),</span>
<span id="cb163-31"><a href="Model-building.html#cb163-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">label =</span> <span class="fu">c</span>(<span class="fu">paste0</span>(<span class="st">&quot;COR = &quot;</span>, <span class="fu">round</span>(<span class="fu">cor</span>(train_simu,train<span class="sc">$</span>shortwave),<span class="dv">2</span>)),</span>
<span id="cb163-32"><a href="Model-building.html#cb163-32" aria-hidden="true" tabindex="-1"></a>            <span class="fu">paste0</span>(<span class="st">&quot;p = &quot;</span>, <span class="fu">formatC</span>(<span class="fu">cor.test</span>(train_simu,train<span class="sc">$</span>shortwave)<span class="sc">$</span>p.value)),</span>
<span id="cb163-33"><a href="Model-building.html#cb163-33" aria-hidden="true" tabindex="-1"></a>            <span class="fu">paste0</span>(<span class="st">&quot;RMSE = &quot;</span>, <span class="fu">round</span>(<span class="fu">rmse</span>(train_simu,train<span class="sc">$</span>shortwave),<span class="dv">3</span>)))</span>
<span id="cb163-34"><a href="Model-building.html#cb163-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb163-35"><a href="Model-building.html#cb163-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-36"><a href="Model-building.html#cb163-36" aria-hidden="true" tabindex="-1"></a>p1_cor <span class="ot">=</span> <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb163-37"><a href="Model-building.html#cb163-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> pl_point_df,</span>
<span id="cb163-38"><a href="Model-building.html#cb163-38" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> SIMU, <span class="at">y=</span> TRAIN),</span>
<span id="cb163-39"><a href="Model-building.html#cb163-39" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="dv">5</span>,</span>
<span id="cb163-40"><a href="Model-building.html#cb163-40" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">&#39;blue&#39;</span>,</span>
<span id="cb163-41"><a href="Model-building.html#cb163-41" aria-hidden="true" tabindex="-1"></a>             <span class="at">shape =</span> <span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb163-42"><a href="Model-building.html#cb163-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>,<span class="at">slope =</span> <span class="dv">1</span>,<span class="at">size =</span> <span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb163-43"><a href="Model-building.html#cb163-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> label_df,<span class="fu">aes</span>(<span class="at">x =</span> x,<span class="at">y =</span> y,<span class="at">label =</span> label),<span class="at">size =</span> <span class="dv">6</span>,<span class="at">color =</span> <span class="st">&#39;black&#39;</span>,</span>
<span id="cb163-44"><a href="Model-building.html#cb163-44" aria-hidden="true" tabindex="-1"></a>            <span class="at">hjust =</span> <span class="dv">0</span>)<span class="sc">+</span></span>
<span id="cb163-45"><a href="Model-building.html#cb163-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb163-46"><a href="Model-building.html#cb163-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb163-47"><a href="Model-building.html#cb163-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span>  <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">&#39;bold&#39;</span>,<span class="at">color =</span> <span class="st">&#39;black&#39;</span>,<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb163-48"><a href="Model-building.html#cb163-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span>  <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">&#39;bold&#39;</span>,<span class="at">color =</span> <span class="st">&#39;black&#39;</span>,<span class="at">size =</span> <span class="dv">14</span>, <span class="at">hjust =</span> .<span class="dv">5</span>)</span>
<span id="cb163-49"><a href="Model-building.html#cb163-49" aria-hidden="true" tabindex="-1"></a>  )<span class="sc">+</span></span>
<span id="cb163-50"><a href="Model-building.html#cb163-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&#39;SIMULATION RESULT&#39;</span>)<span class="sc">+</span></span>
<span id="cb163-51"><a href="Model-building.html#cb163-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&#39;REAL SHORTWAVE&#39;</span>)</span>
<span id="cb163-52"><a href="Model-building.html#cb163-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-53"><a href="Model-building.html#cb163-53" aria-hidden="true" tabindex="-1"></a><span class="fu">png</span>(<span class="st">&#39;plot1.png&#39;</span>,</span>
<span id="cb163-54"><a href="Model-building.html#cb163-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">height =</span> <span class="dv">20</span>,</span>
<span id="cb163-55"><a href="Model-building.html#cb163-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">width =</span> <span class="dv">20</span>,</span>
<span id="cb163-56"><a href="Model-building.html#cb163-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">units =</span> <span class="st">&#39;cm&#39;</span>,</span>
<span id="cb163-57"><a href="Model-building.html#cb163-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">res =</span> <span class="dv">800</span>)</span>
<span id="cb163-58"><a href="Model-building.html#cb163-58" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p1_cor)</span>
<span id="cb163-59"><a href="Model-building.html#cb163-59" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb163-60"><a href="Model-building.html#cb163-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-61"><a href="Model-building.html#cb163-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-62"><a href="Model-building.html#cb163-62" aria-hidden="true" tabindex="-1"></a><span class="do">## 6、剩下还包含两步，第一是与时间序列分析一致；</span></span>
<span id="cb163-63"><a href="Model-building.html#cb163-63" aria-hidden="true" tabindex="-1"></a><span class="do">## 7、还需要对测试集进行相同的分析操作，观察数据建模的一致性关系；</span></span>
<span id="cb163-64"><a href="Model-building.html#cb163-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-65"><a href="Model-building.html#cb163-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-66"><a href="Model-building.html#cb163-66" aria-hidden="true" tabindex="-1"></a><span class="do">## 8、模型模拟残差分析(图5)</span></span>
<span id="cb163-67"><a href="Model-building.html#cb163-67" aria-hidden="true" tabindex="-1"></a>TRAIN_RES <span class="ot">=</span> model_init<span class="sc">$</span>fitted <span class="sc">-</span> train<span class="sc">$</span>shortwave</span>
<span id="cb163-68"><a href="Model-building.html#cb163-68" aria-hidden="true" tabindex="-1"></a>TEST_RES <span class="ot">=</span> test_simu <span class="sc">-</span> test<span class="sc">$</span>shortwave</span>
<span id="cb163-69"><a href="Model-building.html#cb163-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-70"><a href="Model-building.html#cb163-70" aria-hidden="true" tabindex="-1"></a>df_res1 <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">RES =</span> TRAIN_RES, <span class="at">Type =</span> <span class="st">&quot;TRAIN_RES&quot;</span>)</span>
<span id="cb163-71"><a href="Model-building.html#cb163-71" aria-hidden="true" tabindex="-1"></a>df_res2 <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">RES =</span> TEST_RES, <span class="at">Type =</span> <span class="st">&quot;TEST_RES&quot;</span>)</span>
<span id="cb163-72"><a href="Model-building.html#cb163-72" aria-hidden="true" tabindex="-1"></a>df_res <span class="ot">=</span> <span class="fu">rbind</span>(df_res1,df_res2)</span>
<span id="cb163-73"><a href="Model-building.html#cb163-73" aria-hidden="true" tabindex="-1"></a>label_df_res <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb163-74"><a href="Model-building.html#cb163-74" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">c</span>(<span class="fl">0.3</span>,<span class="fl">0.3</span>,<span class="fl">0.3</span>,<span class="fl">0.3</span>),</span>
<span id="cb163-75"><a href="Model-building.html#cb163-75" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">500</span>,<span class="dv">450</span>,<span class="dv">400</span>,<span class="dv">350</span>),</span>
<span id="cb163-76"><a href="Model-building.html#cb163-76" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb163-77"><a href="Model-building.html#cb163-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(<span class="st">&#39;TRAIN_MEAN = &#39;</span>,<span class="fu">round</span>(<span class="fu">mean</span>(TRAIN_RES),<span class="dv">2</span>)),</span>
<span id="cb163-78"><a href="Model-building.html#cb163-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(<span class="st">&#39;TRAIN_SD = &#39;</span>,<span class="fu">round</span>(<span class="fu">sd</span>(TRAIN_RES),<span class="dv">2</span>)),</span>
<span id="cb163-79"><a href="Model-building.html#cb163-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(<span class="st">&#39;TEST_MEAN = &#39;</span>,<span class="fu">round</span>(<span class="fu">mean</span>(TEST_RES),<span class="dv">2</span>)),</span>
<span id="cb163-80"><a href="Model-building.html#cb163-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(<span class="st">&#39;TEST_SD = &#39;</span>,<span class="fu">round</span>(<span class="fu">sd</span>(TEST_RES),<span class="dv">2</span>))</span>
<span id="cb163-81"><a href="Model-building.html#cb163-81" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb163-82"><a href="Model-building.html#cb163-82" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb163-83"><a href="Model-building.html#cb163-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-84"><a href="Model-building.html#cb163-84" aria-hidden="true" tabindex="-1"></a>p5 <span class="ot">=</span> <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb163-85"><a href="Model-building.html#cb163-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">data =</span> df_res,<span class="fu">aes</span>(<span class="at">x =</span> RES, <span class="at">y =</span> ..count..,<span class="at">fill =</span> Type))<span class="sc">+</span></span>
<span id="cb163-86"><a href="Model-building.html#cb163-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> label_df_res,<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">label =</span> labels),</span>
<span id="cb163-87"><a href="Model-building.html#cb163-87" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">&#39;black&#39;</span>,<span class="at">fontface=</span> <span class="st">&#39;bold&#39;</span>,<span class="at">size =</span> <span class="dv">5</span>,<span class="at">hjust=</span> <span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb163-88"><a href="Model-building.html#cb163-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb163-89"><a href="Model-building.html#cb163-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb163-90"><a href="Model-building.html#cb163-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span>  <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">&#39;bold&#39;</span>,<span class="at">color =</span> <span class="st">&#39;black&#39;</span>,<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb163-91"><a href="Model-building.html#cb163-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span>  <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">&#39;bold&#39;</span>,<span class="at">color =</span> <span class="st">&#39;black&#39;</span>,<span class="at">size =</span> <span class="dv">14</span>, <span class="at">hjust =</span> .<span class="dv">5</span>),</span>
<span id="cb163-92"><a href="Model-building.html#cb163-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">&#39;bold&#39;</span>,<span class="at">color =</span> <span class="st">&#39;black&#39;</span>,<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb163-93"><a href="Model-building.html#cb163-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb163-94"><a href="Model-building.html#cb163-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&#39;bottom&#39;</span>,</span>
<span id="cb163-95"><a href="Model-building.html#cb163-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.direction =</span> <span class="st">&#39;horizontal&#39;</span></span>
<span id="cb163-96"><a href="Model-building.html#cb163-96" aria-hidden="true" tabindex="-1"></a>  )<span class="sc">+</span></span>
<span id="cb163-97"><a href="Model-building.html#cb163-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&#39;RES&#39;</span>)<span class="sc">+</span></span>
<span id="cb163-98"><a href="Model-building.html#cb163-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&#39;Count&#39;</span>)</span>
<span id="cb163-99"><a href="Model-building.html#cb163-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-100"><a href="Model-building.html#cb163-100" aria-hidden="true" tabindex="-1"></a><span class="fu">png</span>(<span class="st">&#39;plot5.png&#39;</span>,</span>
<span id="cb163-101"><a href="Model-building.html#cb163-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">height =</span> <span class="dv">20</span>,</span>
<span id="cb163-102"><a href="Model-building.html#cb163-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">width =</span> <span class="dv">20</span>, </span>
<span id="cb163-103"><a href="Model-building.html#cb163-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">units =</span> <span class="st">&#39;cm&#39;</span>,</span>
<span id="cb163-104"><a href="Model-building.html#cb163-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">res=</span> <span class="dv">800</span>)</span>
<span id="cb163-105"><a href="Model-building.html#cb163-105" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p5)</span>
<span id="cb163-106"><a href="Model-building.html#cb163-106" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span></code></pre></div>
</div>
<div id="随机森林" class="section level4 hasAnchor" number="4.6.2.2">
<h4><span class="header-section-number">4.6.2.2</span> 随机森林<a href="Model-building.html#随机森林" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb164-1"><a href="Model-building.html#cb164-1" aria-hidden="true" tabindex="-1"></a>gx.rf<span class="ot">&lt;-</span><span class="fu">randomForest</span>(gdp<span class="sc">~</span>.,<span class="at">data=</span>gxdata_without_x,<span class="at">importance=</span><span class="cn">TRUE</span>, <span class="at">ntree=</span><span class="dv">1000</span>)</span>
<span id="cb164-2"><a href="Model-building.html#cb164-2" aria-hidden="true" tabindex="-1"></a><span class="fu">importance</span>(gx.rf)</span>
<span id="cb164-3"><a href="Model-building.html#cb164-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-4"><a href="Model-building.html#cb164-4" aria-hidden="true" tabindex="-1"></a><span class="fu">varImpPlot</span>(gx.rf)</span></code></pre></div>
</div>
</div>
<div id="朴素贝叶斯" class="section level3 hasAnchor" number="4.6.3">
<h3><span class="header-section-number">4.6.3</span> 朴素贝叶斯<a href="Model-building.html#朴素贝叶斯" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>待添加</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="Data-preprocessing.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="Model-performance.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/yihui/bookdown-chinese/edit/master/04-Model-building.Rmd",
"text": "编辑"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["bookdown.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

</body>

</html>
